# Viper Codebase Issues Report â€” 2026-02-18

Generated by deep static scan of the Viper C++ source tree (555,838 total lines).

**Status legend:** âœ… Fixed | ğŸ”¨ In Progress | ğŸ“‹ Deferred | âš ï¸ High Risk (flag only)

---

## Category A â€” Files > 1,000 Lines

These files exceed the recommended single-file limit and should be considered for
split/decomposition in future development cycles.

| Status | Lines | File | Primary Concern |
|--------|-------|------|-----------------|
| ğŸ“‹ | 3,457 | `src/bytecode/BytecodeVM.cpp` | `run()` (1183L), `runThreaded()` (1382L) â€” see Cat B |
| ğŸ“‹ | 2,742 | `src/runtime/rt_network_http.c` | `do_http_request` (238L), `parse_url_full` (222L) |
| ğŸ“‹ | 2,721 | `src/il/runtime/RuntimeSignatures.cpp` | Single `kDescriptorRows` constexpr array + support code |
| ğŸ“‹ | 2,701 | `src/runtime/rt_graphics.c` | `rt_canvas_flood_fill` (109L), many medium-sized functions |
| ğŸ“‹ | 2,327 | `src/runtime/rt_string_ops.c` | Dense string algorithm implementations, acceptable density |
| ğŸ“‹ | 2,002 | `src/runtime/rt_seq.c` | Many medium functions; acceptable |
| ğŸ“‹ | 1,912 | `src/runtime/rt_network.c` | `rt_tcp_connect_for` (145L) |
| ğŸ“‹ | 1,897 | `src/codegen/aarch64/Peephole.cpp` | `updateKnownConsts` (232L), `propagateCopies` (320L) |
| ğŸ“‹ | 1,836 | `src/runtime/rt_xml.c` | `parse_element` (154L) |
| ğŸ“‹ | 1,669 | `src/runtime/rt_bigint.c` | `rt_bigint_divmod` (308L) |
| ğŸ“‹ | 1,638 | `src/runtime/rt_regex.c` | `match_node_groups` (112L) |
| ğŸ“‹ | 1,586 | `src/tools/rtgen/rtgen.cpp` | Entire tool in single `main()` |
| ğŸ“‹ | 1,546 | `src/codegen/aarch64/InstrLowering.cpp` | `materializeValueToVReg` (275L), `lowerCallWithArgs` (148L) |
| ğŸ“‹ | 1,502 | `src/il/transform/SCCP.cpp` | `SCCPSolver` class (673L inline) |
| ğŸ“‹ | 1,493 | `src/runtime/rt_json.c` | `parse_string` (196L) |
| ğŸ“‹ | 1,451 | `src/codegen/aarch64/RegAllocLinear.cpp` | `allocateInstruction` (complex), liveness tracking |
| ğŸ“‹ | 1,435 | `src/bytecode/BytecodeCompiler.cpp` | Multiple 100â€“200 line emission functions |
| ğŸ“‹ | 1,432 | `src/frontends/basic/Lowerer.hpp` | Monolithic lowerer header |
| ğŸ“‹ | 1,404 | `src/runtime/rt_input.c` | `rt_keyboard_key_name` (212L lookup table) |
| ğŸ“‹ | 1,364 | `src/runtime/rt_input_pad.c` | `mac_scan_devices` (134L), `platform_pad_poll` (120L) |
| ğŸ“‹ | 1,320 | `src/il/verify/EhChecks.cpp` | EH verification DFS â€” many 50â€“100L helpers |
| ğŸ“‹ | 1,312 | `src/runtime/rt_archive.c` | ZIP read/write implementations |
| ğŸ“‹ | 1,256 | `src/codegen/x86_64/Peephole.cpp` | Duplication with aarch64 (see Cat C) |

---

## Category B â€” Individual Functions > 100 Lines

These functions should be decomposed in future work. Ordered by size descending.

| Status | Lines | File:Line | Function |
|--------|-------|-----------|----------|
| âš ï¸ | **1,382** | `bytecode/BytecodeVM.cpp:1772` | `BytecodeVM::runThreaded()` â€” monolithic threaded opcode dispatch |
| âš ï¸ | **1,183** | `bytecode/BytecodeVM.cpp:242` | `BytecodeVM::run()` â€” monolithic opcode dispatch (114 cases) |
| ğŸ“‹ | 461 | `vm/ops/Op_CallRet.cpp:46` | Opcode call/return handler (entire namespace block) |
| ğŸ“‹ | 308 | `runtime/rt_bigint.c:750` | `rt_bigint_divmod` â€” combined divide-and-modulo with slow path |
| ğŸ“‹ | 262 | `runtime/rt_lazyseq.c:238` | `rt_lazyseq_next` â€” stateful lazy generator |
| ğŸ“‹ | 238 | `runtime/rt_network_http.c:800` | `do_http_request` â€” full HTTP request/response cycle |
| ğŸ“‹ | 222 | `runtime/rt_network_http.c:1636` | `parse_url_full` â€” URL parser |
| ğŸ“‹ | 212 | `runtime/rt_input.c:351` | `rt_keyboard_key_name` â€” key-name lookup table (data, not logic) |
| ğŸ“‹ | 205 | `runtime/rt_pixels.c:838` | `rt_pixels_save_png` â€” PNG encoder |
| ğŸ“‹ | 196 | `runtime/rt_json.c:165` | `parse_string` â€” JSON string parser with escape handling |
| ğŸ“‹ | 189 | `tools/viper/cmd_il_opt.cpp:57` | `cmdILOpt` â€” command entry point (acceptable for tool) |
| ğŸ“‹ | 182 | `runtime/rt_action.c:910` | `rt_action_bindings_str` |
| ğŸ“‹ | 154 | `runtime/rt_xml.c:647` | `parse_element` |
| ğŸ“‹ | 148 | `runtime/rt_yaml.c:830` | `format_value` |
| ğŸ“‹ | 145 | `runtime/rt_network.c:309` | `rt_tcp_connect_for` |
| ğŸ“‹ | 143 | `runtime/rt_json_stream.c:340` | `rt_json_stream_next` |
| ğŸ“‹ | 143 | `runtime/rt_markdown.c:171` | `rt_markdown_to_html` |

### Notes on BytecodeVM::run() / runThreaded()

`BytecodeVM::run()` (lines 242â€“1424) and `BytecodeVM::runThreaded()` (lines 1772â€“3153) share
approximately 90% of their opcode-handling code but are maintained as two separate copies.
The canonical decomposition pattern is:

```cpp
// Extract opcode handling into a shared template dispatch core:
template <bool IsThreaded>
void BytecodeVM::dispatchCore() {
    // shared switch over 114 BCOpcode cases
}

void BytecodeVM::run() { dispatchCore<false>(); }
void BytecodeVM::runThreaded() { dispatchCore<true>(); }
```

**This is high-risk** because these are hot inner dispatch loops â€” any regression would
affect all program execution. This decomposition is strongly recommended for the next
major VM development cycle, with full test coverage of all opcodes.

---

## Category C â€” Duplicate Code

### C-01: `removeMarkedInstructions` â€” identical in both peephole backends âœ… Fixed

**Files:**
- `src/codegen/aarch64/Peephole.cpp:704`
- `src/codegen/x86_64/Peephole.cpp:1047` (definition; also has a forward declaration at line 707)

**Problem:** 15-line function with identical body in both backends.

**Fix:** Extracted to `src/codegen/common/PeepholeUtil.hpp` as an `inline` helper.
Both backends now `#include "codegen/common/PeepholeUtil.hpp"` and reference the shared copy.

---

### C-02: `updateKnownConsts` â€” logically duplicate, but different MIR APIs ğŸ“‹ Deferred

**Files:**
- `src/codegen/aarch64/Peephole.cpp:472` (~232 lines)
- `src/codegen/x86_64/Peephole.cpp:225` (~260 lines)

**Problem:** Both functions track which registers hold known constant values and invalidate
on writes. The logic is equivalent but the MIR representation differs:
- AArch64: `instr.ops[i]`, `instr.ops[i].kind == MOperand::Kind::Imm`, `instr.ops[i].imm`
- x86-64: `std::get_if<OpReg>(&instr.operands[i])`, `std::get_if<OpImm>(&instr.operands[i])`

**Why deferred:** Unification requires a common MIR abstraction layer that does not exist.
Creating a `CommonMIR` adapter type is a significant architectural change.

**Recommendation:** When the two backends are eventually unified on a shared MIR type,
this function should be the first candidate for extraction to `codegen/common/`.

---

### C-03: Analysis ID magic strings â€” scattered across 39 call sites âœ… Fixed

**Files:** `il/transform/CheckOpt.cpp`, `IndVarSimplify.cpp`, `GVN.cpp`, `LoopUnroll.cpp`,
`DSE.cpp`, `LICM.cpp`, `EarlyCSE.cpp`, `PassRegistry.cpp`, and others.

**Problem:** String literals `"cfg"`, `"dominators"`, `"post-dominators"`, `"memory-ssa"`,
`"loop-info"`, `"liveness"`, `"basic-aa"` appear in 39 in-tree call sites. A typo
silently causes an analysis to be re-computed on every access (cache miss with no error).

**Fix:** Created `src/il/transform/AnalysisIDs.hpp` with named `constexpr std::string_view`
constants. All non-test call sites updated to use the constants.

---

## Category D â€” Missing Doc-Comments âœ… Fixed

### D-01: `src/il/transform/SCCP.cpp` â€” internal API documentation

30 internal functions and methods lacked `///` doc-comments:
- `ValueLattice` struct methods: `isUnknown`, `isConstant`, `isOverdefined`, `isTrap`,
  `set`, `merge`
- `FoldResult` struct and methods
- `FoldContext` struct methods: `getConstIntOperand`, `getConstUIntOperand`,
  `getConstFloatOperand`
- `checkedAdd` (siblings `checkedSub`/`checkedMul` already had comments)
- `SCCPSolver` private methods: `initialiseStates`, `process`, `visitBlock`,
  `visitInstruction`, `visitBr`, `visitCBr`, `visitSwitch`, `visitCall`,
  `visitPhi`, `rewriteConstants`, `foldTerminators`, `markBlockExecutable`,
  `queueSuccessors`, `mergeValue`, `markOverdefined`

### D-02: `src/il/transform/AnalysisManager.cpp` â€” implementation docs

- `AnalysisManager` constructor
- `invalidateModuleCache()`
- `invalidateFunctionCacheForModulePass()`
- `assertWellFormed()`

### D-03: `src/il/transform/AnalysisManager.hpp` â€” template method docs

- `AnalysisRegistry::registerModuleAnalysis<Result>()`
- `AnalysisRegistry::registerFunctionAnalysis<Result>()`

### D-04: `src/il/transform/PassManager.hpp` â€” delegation method docs

- `PassManager::registerModuleAnalysis` (line 88)
- `PassManager::registerFunctionAnalysis` (line 98)

### D-05: `src/il/transform/PipelineExecutor.hpp`

- `PipelineExecutor::run()` (line 70)

### D-06: `src/il/transform/Inline.cpp`

- `withinBudget()` helper (line 95)

### D-07: `src/il/analysis/BasicAA.hpp`

- `BasicAA::collectFunctionInfo()` (line 127)

### D-08: `src/vm/DispatchStrategy.cpp`

- `runSharedDispatchLoop()` (line 67)
- `createDispatchStrategy()` (line 301)
- `handlesFinalizationInternally()` override (line 211)
- `requiresTrapCatch()` override (line 276)

### D-09: `src/vm/Runner.cpp`

- `resetOpcodeCounts()` (line 123)
- `setBreakpoint()` (line 187)
- `clearBreakpoints()` (line 196)
- `setMaxSteps()` (line 206)
- `addMemWatch()` (line 211)

### D-10: `src/vm/VM.hpp`

- `VM::init()` (line 683)

---

## Category E â€” Performance Notes (deferred)

### E-01: Linear block-label searches in SimplifyCFG

**Files:**
- `il/transform/SimplifyCFG/BlockMerging.cpp:59` â€” `std::find_if` over `fn.blocks`
- `il/transform/SimplifyCFG/ForwardingElimination.cpp:218,234` â€” two `std::find_if` over `fn.blocks`

**Problem:** O(n) labelâ†’block lookup per search. For typical small functions this is fine,
but functions with hundreds of blocks (e.g., deeply nested BASIC programs) will suffer
quadratic behavior.

**Recommendation:** Build a `std::unordered_map<std::string_view, size_t>` label-to-index
map once at the start of each pass and reuse it. The AnalysisManager's CFGInfo already
provides predecessor/successor maps; a block-index map could be added there.

**Why deferred:** Requires augmenting CFGInfo or adding a new analysis, and requires
verifying that passes correctly invalidate the map on structural changes.

---

## Summary

| Category | Total Issues | Fixed in This Pass | Deferred |
|----------|-------------|-------------------|----------|
| A â€” Large files | 23 | 0 (report only) | 23 |
| B â€” Large functions | 17 | 0 (report only) | 17 |
| C â€” Duplicate code | 3 | 2 | 1 |
| D â€” Missing doc-comments | ~50 | ~50 | 0 |
| E â€” Performance | 1 | 0 | 1 |
| **Total** | **~94** | **~52** | **~42** |

---

*Last updated: 2026-02-18. Re-run the scan after major refactoring passes.*
