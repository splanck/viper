module TestGenerics;

// Test: Generic types

var passed: Integer = 0;
var failed: Integer = 0;

func check(name: String, actual: Integer, expected: Integer) {
    if (actual == expected) {
        passed = passed + 1;
    } else {
        failed = failed + 1;
        Viper.Terminal.Say("FAIL: " + name + " - expected " + Viper.Strings.FromInt(expected) + ", got " + Viper.Strings.FromInt(actual));
    }
}

func checkStr(name: String, actual: String, expected: String) {
    if (actual == expected) {
        passed = passed + 1;
    } else {
        failed = failed + 1;
        Viper.Terminal.Say("FAIL: " + name + " - expected '" + expected + "', got '" + actual + "'");
    }
}

// Generic entity
entity Container[T] {
    expose T value;

    expose func init(v: T) {
        value = v;
    }

    expose func getValue() -> T {
        return value;
    }
}

// Generic function
func identity[T](x: T) -> T {
    return x;
}

func swap[T](a: T, b: T) -> T {
    // Just return a for testing
    return a;
}

func start() {
    Viper.Terminal.Say("=== Generic Type Tests ===");

    // Generic entity with Integer
    var intBox: Container[Integer] = new Container[Integer](42);
    check("Generic entity Integer", intBox.getValue(), 42);

    // Generic entity with String
    var strBox: Container[String] = new Container[String]("hello");
    checkStr("Generic entity String", strBox.getValue(), "hello");

    // Generic function with Integer
    var i: Integer = identity[Integer](100);
    check("Generic function Integer", i, 100);

    // Generic function with String
    var s: String = identity[String]("world");
    checkStr("Generic function String", s, "world");

    // Nested generic entity
    var nested: Container[Container[Integer]] = new Container[Container[Integer]](new Container[Integer](999));
    check("Nested generic", nested.getValue().getValue(), 999);

    // Report results
    Viper.Terminal.Say("=== Results ===");
    Viper.Terminal.Say("Passed: " + Viper.Strings.FromInt(passed));
    Viper.Terminal.Say("Failed: " + Viper.Strings.FromInt(failed));

    if (failed == 0) {
        Viper.Terminal.Say("RESULT: ok");
    } else {
        Viper.Terminal.Say("RESULT: fail");
    }
}
