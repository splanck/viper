module TestGenericConstraints;

// Tests for generic function type constraints (Phase 5)
// This tests that type parameters can be constrained to implement interfaces

var passed: Integer = 0;
var failed: Integer = 0;

func check(name: String, actual: Integer, expected: Integer) {
    if (actual == expected) {
        passed = passed + 1;
    } else {
        failed = failed + 1;
        Viper.Terminal.Say("FAIL: " + name + " - expected " + Viper.String.FromInt(expected) + ", got " + Viper.String.FromInt(actual));
    }
}

// Define a simple interface
interface Identifiable {
    func getId() -> Integer;
}

// An entity implementing Identifiable
entity User implements Identifiable {
    expose Integer id;
    expose String name;

    expose func init(userId: Integer, userName: String) {
        id = userId;
        name = userName;
    }

    expose func getId() -> Integer {
        return id;
    }
}

// Another entity implementing Identifiable
entity Product implements Identifiable {
    expose Integer id;
    expose String title;

    expose func init(productId: Integer, productTitle: String) {
        id = productId;
        title = productTitle;
    }

    expose func getId() -> Integer {
        return id;
    }
}

// Generic function with constraint - simple identity
func processIdentifiable[T: Identifiable](item: T) -> T {
    return item;
}

// Unconstrained identity for comparison
func identity[T](item: T) -> T {
    return item;
}

func start() {
    Viper.Terminal.Say("=== Generic Type Constraints Tests ===");

    // Test that constrained generic function works with User
    var u1: User = new User(1, "Alice");
    var u2: User = processIdentifiable[User](u1);
    check("User constraint", u2.id, 1);

    // Test that constrained generic function works with Product
    var p1: Product = new Product(100, "Widget");
    var p2: Product = processIdentifiable[Product](p1);
    check("Product constraint", p2.id, 100);

    // Test unconstrained identity with User
    var u3: User = new User(5, "Bob");
    var u4: User = identity[User](u3);
    check("Unconstrained identity", u4.id, 5);

    // Report results
    Viper.Terminal.Say("=== Results ===");
    Viper.Terminal.Say("Passed: " + Viper.String.FromInt(passed));
    Viper.Terminal.Say("Failed: " + Viper.String.FromInt(failed));

    if (failed == 0) {
        Viper.Terminal.Say("RESULT: ok");
    } else {
        Viper.Terminal.Say("RESULT: fail");
    }
}
