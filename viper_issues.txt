# VIPER BASIC Frontend Refactoring Plan
# Generated: 2025-11-12
# Total Files Analyzed: 111 (29K LOC)
# Estimated Improvement Potential: 400-500 lines of duplication eliminated

================================================================================
STATUS LEGEND:
[ ] TODO
[>] IN PROGRESS
[X] DONE
[!] BLOCKED
================================================================================

## PHASE 1: CRITICAL REFACTORINGS (P0)
## Estimated time: 3-4 hours | Impact: HIGH

### 1.1 Parser Error Reporting Consolidation [CRITICAL]
[ ] Refactor all Parser files to use existing emitError/emitWarning helpers
    - Impact: Eliminate 50-60 duplicated if/else blocks across 10 files
    - Files to modify:
      [ ] src/frontends/basic/Parser_Stmt_Jump.cpp (3 instances)
      [ ] src/frontends/basic/Parser_Stmt_Loop.cpp (5 instances)
      [ ] src/frontends/basic/Parser_Stmt_If.cpp (4 instances)
      [ ] src/frontends/basic/Parser_Stmt_IO.cpp (7 instances)
      [ ] src/frontends/basic/Parser_Stmt_Select.cpp (7 instances)
      [ ] src/frontends/basic/Parser_Stmt_Core.cpp (3 instances)
      [ ] src/frontends/basic/Parser_Stmt_OOP.cpp (4 instances)
      [ ] src/frontends/basic/Parser_Expr.cpp (8 instances)
      [ ] src/frontends/basic/Parser_Stmt.cpp (4 instances)
      [ ] src/frontends/basic/Parser.cpp (5 instances)
    - Pattern to eliminate:
      ```cpp
      if (emitter_) {
          emitter_->emit(Severity::Error, "BXXXX", loc, len, msg);
      } else {
          std::fprintf(stderr, "error message\n");
      }
      ```
    - Replace with:
      ```cpp
      emitError("BXXXX", token, "error message");
      ```
    - Helpers already exist in Parser.hpp:576-592

================================================================================

## PHASE 2: HIGH-VALUE REFACTORINGS (P1)
## Estimated time: 3-4 hours | Impact: HIGH

### 2.1 Lowerer LocationScope RAII Helper
[X] Create LocationScope RAII helper class
    - Impact: Eliminate 106 manual `curLoc = stmt.loc;` assignments
    - New file: src/frontends/basic/LocationScope.hpp
    - Implementation:
      ```cpp
      class LocationScope {
          Lowerer& lowerer_;
          il::support::SourceLoc previous_;
      public:
          LocationScope(Lowerer& l, il::support::SourceLoc loc);
          ~LocationScope();
          LocationScope(const LocationScope&) = delete;
          LocationScope& operator=(const LocationScope&) = delete;
      };
      ```
    - Files to refactor:
      [X] src/frontends/basic/LowerStmt_IO.cpp (31 instances removed, 2 arg->loc kept)
      [X] src/frontends/basic/lower/Lower_Loops.cpp (27 instances removed)
      [X] src/frontends/basic/LowerStmt_Runtime.cpp (11 instances removed)
      [X] src/frontends/basic/LowerStmt_Control.cpp (9 instances removed)
      [ ] src/frontends/basic/LowerExpr.cpp (14 instances)
      [ ] src/frontends/basic/Lower_OOP_Expr.cpp (9 instances)
      [ ] src/frontends/basic/Lower_OOP_Stmt.cpp (4 instances)
      [ ] src/frontends/basic/LowerExprNumeric.cpp (7 instances)
      [ ] src/frontends/basic/LowerExprBuiltin.cpp (14 instances)

### 2.2 Runtime Helper Call Consolidation
[X] Add emitRuntimeHelper() wrapper method to Lowerer
    - Impact: Simplify 9+ call sites in LowerStmt_Runtime.cpp
    - Add to Lowerer.hpp:
      ```cpp
      Value emitRuntimeHelper(il::runtime::RuntimeFeature feature,
                             const char* funcName,
                             Type returnType,
                             std::vector<Value> args);
      ```
    - Implementation in Lowerer.cpp:
      ```cpp
      Value Lowerer::emitRuntimeHelper(RuntimeFeature feature,
                                       const char* funcName,
                                       Type returnType,
                                       std::vector<Value> args) {
          requestHelper(feature);
          return emitCallRet(returnType, funcName, std::move(args));
      }
      ```
    - Files to refactor:
      [ ] src/frontends/basic/LowerStmt_Runtime.cpp (primary)

### 2.3 Remove Semantic Analyzer Trivial Wrappers
[X] Remove indirection layer in semantic analysis
    - Impact: Eliminate 10+ trivial wrapper methods
    - Files to modify:
      [ ] src/frontends/basic/SemanticAnalyzer.Stmts.IO.cpp
          - Remove: analyzeCls(), analyzeColor(), analyzeSleep(), etc.
          - Call visit() directly instead
      [ ] src/frontends/basic/SemanticAnalyzer.Stmts.Runtime.cpp
          - Remove: analyzeBeep(), etc.
    - Update call sites to use visit() directly

### 2.4 Add narrow32() Helper for I32 Narrowing
[X] Extract repeated narrowing pattern
    - Impact: Simplify 8+ call sites
    - Add to EmitCommon or Lowerer:
      ```cpp
      Value narrow32(RVal value, il::support::SourceLoc loc);
      ```
    - Files to refactor:
      [ ] src/frontends/basic/LowerStmt_Runtime.cpp (4 locations)

================================================================================

## PHASE 3: CODE ORGANIZATION (P2)
## Estimated time: 2-3 hours | Impact: MEDIUM

### 3.1 Split Oversized Files
[ ] Split Lowerer.Procedure.cpp (1141 lines)
    - Current: Single 1141-line file
    - Proposal:
      - Lowerer.Procedure.Scan.cpp (scanning phase)
      - Lowerer.Procedure.Emit.cpp (emission phase)
    - Update build system (CMakeLists.txt)

### 3.2 Reorganize lower/ Directory Structure
[ ] Consolidate lowering organization
    - Current structure is fragmented:
      - Some in src/frontends/basic/Lower*.cpp
      - Some in src/frontends/basic/lower/*.cpp
      - Some in src/frontends/basic/lower/builtins/*.cpp
    - Proposed structure:
      ```
      lower/
        stmt/        (statement lowering - consolidate Lower*.cpp)
        expr/        (expression lowering)
        builtins/    (existing - keep)
        common/      (existing - keep)
        oop/         (OOP-related lowering - consolidate Lower_OOP_*.cpp)
      ```
    - Files to reorganize:
      [ ] LowerStmt_IO.cpp → lower/stmt/IO.cpp
      [ ] LowerStmt_Runtime.cpp → lower/stmt/Runtime.cpp
      [ ] LowerStmt_Control.cpp → lower/stmt/Control.cpp
      [ ] LowerExpr.cpp → lower/expr/Basic.cpp
      [ ] LowerExprNumeric.cpp → lower/expr/Numeric.cpp
      [ ] LowerExprLogical.cpp → lower/expr/Logical.cpp
      [ ] LowerExprBuiltin.cpp → lower/expr/Builtin.cpp
      [ ] Lower_OOP_*.cpp → lower/oop/
    - Update #includes across codebase
    - Update CMakeLists.txt

### 3.3 Reduce Header Coupling in Lowerer.hpp
[ ] Move implementation includes to CPP files
    - Current: Lowerer.hpp includes 6+ sub-headers inline
    - Move to Lowerer.cpp where possible:
      - LowerStmt_Core.hpp
      - LowerStmt_Runtime.hpp
      - LowerStmt_IO.hpp
      - LowerStmt_Control.hpp
      - LowerScan.hpp
    - Keep only interface declarations in Lowerer.hpp

================================================================================

## PHASE 4: DOCUMENTATION IMPROVEMENTS (P3)
## Estimated time: 2-3 hours | Impact: MEDIUM

### 4.1 Add Missing Function Documentation
[ ] Document underdocumented functions in constfold/ files
    - Files needing better algorithm documentation:
      [ ] src/frontends/basic/constfold/FoldArith.cpp
      [ ] src/frontends/basic/constfold/FoldCompare.cpp
      [ ] src/frontends/basic/constfold/FoldStrings.cpp
      [ ] src/frontends/basic/constfold/FoldLogical.cpp
      [ ] src/frontends/basic/constfold/FoldCasts.cpp

### 4.2 Document Builtin Implementations
[ ] Add semantic documentation to builtin lowering
    - Files needing better semantics docs:
      [ ] src/frontends/basic/lower/builtins/String.cpp
      [ ] src/frontends/basic/lower/builtins/Math.cpp
      [ ] src/frontends/basic/lower/builtins/Array.cpp
      [ ] src/frontends/basic/lower/builtins/IO.cpp
      [ ] src/frontends/basic/lower/builtins/Common.cpp

### 4.3 Standardize Documentation Style
[ ] Ensure consistent use of /// doc comments
[ ] Add @brief, @param, @return tags where missing
[ ] Document invariants in complex classes

================================================================================

## PHASE 5: ADDITIONAL IMPROVEMENTS (P3 - Nice to Have)
## Estimated time: 1-2 hours | Impact: LOW-MEDIUM

### 5.1 Add visitExprs() Variadic Helper
[ ] Simplify multi-expression visitation in semantic analysis
    - Add to SemanticAnalyzer.hpp:
      ```cpp
      template<typename... Exprs>
      void visitExprs(Exprs&... exprs) {
          (visitExpr(exprs), ...);
      }
      ```
    - Refactor call sites in:
      [ ] SemanticAnalyzer.Stmts.IO.cpp

### 5.2 Extract SELECT CASE Parsing Helpers
[ ] Refactor Parser_Stmt_Select.cpp (726 lines)
    - Extract helper methods for:
      - Case range parsing
      - Case condition collection
      - State management
    - Reduce file size to <500 lines

### 5.3 Add Utility Methods for Common Patterns
[ ] Consider adding helpers for:
    - Token type checking patterns
    - AST node creation boilerplate
    - Common type checking sequences

================================================================================

## TESTING REQUIREMENTS (ALL PHASES)

After each phase:
[ ] Build succeeds: cmake --build build -j
[ ] All unit tests pass: ctest --test-dir build -R "test_basic_*"
[ ] All golden tests pass: ctest --test-dir build -R "golden_basic_*"
[ ] All e2e tests pass: ctest --test-dir build -R "e2e_basic_*"
[ ] No new compiler warnings introduced
[ ] Code formatted with clang-format

================================================================================

## STATISTICS & METRICS

### Code Quality Metrics:
- Total files analyzed: 111
- Total lines of code: ~29,000
- Documentation coverage: ~95% (excellent)
- Duplicated error reporting blocks: ~50-60
- Manual location assignments: 106
- Trivial wrapper methods: ~10+
- Oversized files (>600 LOC): 5

### Expected Improvements After Completion:
- Lines of code eliminated: 400-500
- Reduced duplication: ~60%
- Improved maintainability: HIGH
- Better test coverage: (maintain 100%)
- Reduced compile times: MEDIUM (from reduced header coupling)

### Files Requiring Immediate Attention (by priority):
1. Parser_Stmt_*.cpp files (10 files) - Error reporting
2. Lower*.cpp files (13 files) - Location tracking
3. Lowerer.Procedure.cpp (1 file) - Size reduction
4. SemanticAnalyzer.Stmts.*.cpp (3 files) - Remove wrappers

================================================================================

## COMMIT STRATEGY

Each phase should be committed separately with conventional commit format:

Phase 1:
  refactor(frontends/basic): consolidate parser error reporting

Phase 2.1:
  refactor(frontends/basic): add LocationScope RAII helper for Lowerer

Phase 2.2:
  refactor(frontends/basic): consolidate runtime helper calls

Phase 2.3:
  refactor(frontends/basic): remove semantic analyzer wrapper methods

Phase 3.1:
  refactor(frontends/basic): split Lowerer.Procedure into focused files

Phase 3.2:
  refactor(frontends/basic): reorganize lower/ directory structure

Phase 4:
  docs(frontends/basic): improve documentation coverage

================================================================================

## NOTES & OBSERVATIONS

### Positive Patterns Observed:
✓ Excellent separation of concerns (Parser/Semantic/Lowerer)
✓ Consistent visitor pattern usage for AST traversal
✓ Good type safety with explicit coercion helpers (87 uses)
✓ Well-organized constfold/ and sem/ subdirectories
✓ Strong documentation culture (95% coverage)

### Anti-Patterns Identified:
✗ Duplicated error reporting logic (50-60 instances)
✗ Manual resource tracking where RAII would help (106 instances)
✗ Unnecessary indirection layers (10+ wrapper methods)
✗ Inconsistent file organization in lower/ subdirectory
✗ Some files exceeding reasonable size limits (>700 LOC)

### Architectural Notes:
- Parser error helpers exist but are underutilized
- Type coercion system is well-designed and consistent
- AST visitor framework is solid foundation
- Lowering pipeline follows clear phases (scan → emit)

================================================================================
## END OF REFACTORING PLAN
================================================================================
