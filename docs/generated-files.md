# Generated Files Guide

This document describes auto-generated C++ files in the Viper project, their sources of truth, and how to maintain them.

## Overview

Viper uses two generation models:

1. **Manually Maintained Tables** — Committed files synchronized with source enums/APIs
2. **CMake-Generated Tables** — Built at configure time from JSON specifications

All generated files are committed to the repository (not build-time only) to ensure reproducible builds without external
dependencies.

---

## Opcode Schema & VM Dispatch Tables

### Source of Truth

| File                     | Purpose                               |
|--------------------------|---------------------------------------|
| `src/il/core/Opcode.def` | X-macro opcode definitions            |
| `src/il/core/Opcode.hpp` | Opcode enum generated from Opcode.def |

### Generated Files

Located in `src/vm/ops/generated/`:

| File                     | Purpose                                                      |
|--------------------------|--------------------------------------------------------------|
| `OpSchema.hpp`           | Compile-time opcode metadata (mnemonic, arity, types, flags) |
| `HandlerTable.hpp`       | Function table mapping opcodes to handlers                   |
| `InlineHandlersDecl.inc` | Forward declarations for inline handlers                     |
| `InlineHandlersImpl.inc` | Inline handler implementations                               |
| `SwitchDispatchDecl.inc` | Switch-based dispatch declaration                            |
| `SwitchDispatchImpl.inc` | Switch-based dispatch implementation                         |
| `ThreadedLabels.inc`     | Computed-goto label address table                            |
| `ThreadedCases.inc`      | Computed-goto case labels and handler bodies                 |

### Regeneration

These files are **manually maintained** but must stay synchronized with `Opcode.def`:

```bash
# When adding/removing/reordering opcodes:
1. Edit src/il/core/Opcode.def
2. Update each file in src/vm/ops/generated/ to match
3. Ensure table sizes equal il::core::kNumOpcodes
4. Run tests: ctest --test-dir build -R vm
```

### Key Invariants

- Table entry count MUST equal `il::core::kNumOpcodes`
- Entry order MUST match `Opcode` enum declaration order
- Handler signatures must match expected ExecState-based API

---

## Runtime Signature Tables

### Source of Truth

| File                                             | Purpose                                      |
|--------------------------------------------------|----------------------------------------------|
| `src/il/runtime/runtime.def`                     | Canonical runtime function registry          |
| `src/il/runtime/RuntimeSigs.def`                 | Runtime signature enum + spec declarations   |
| `src/il/runtime/RuntimeSignaturesData.hpp`       | Signature metadata table                     |
| `src/runtime/*.c`                                | C runtime implementations                    |
| `include/viper/runtime/*.h`                      | Public C runtime API headers                 |

### Generated Files

| File                                                 | Purpose                                         |
|------------------------------------------------------|-------------------------------------------------|
| `build/generated/il/runtime/RuntimeSignatures.inc`   | DescriptorRow entries for runtime functions     |
| `build/generated/il/runtime/RuntimeClasses.inc`      | Class/method/property catalog for OOP dispatch  |
| `build/generated/il/runtime/RuntimeNameMap.inc`      | Maps canonical names to C symbols               |
| `build/generated/il/runtime/RuntimeNames.hpp`        | Runtime name constants                          |
| `build/generated/il/runtime/ZiaRuntimeExterns.inc`   | Extern declarations for the Zia frontend        |

### Regeneration

Runtime signatures are generated by `rtgen` from `runtime.def` and the runtime C headers:

```bash
# Configure/build to refresh build/generated outputs
cmake -S . -B build
cmake --build build -j --target generate_runtime_registry

# Validate
ctest --test-dir build -R runtime
```

### Key Invariants

- Each DescriptorRow must have a unique canonical name
- Handler function pointers must match declared signatures
- `VIPER_RUNTIME_NS_DUAL` controls legacy `rt_*` naming compatibility

---

## IL Verifier Specification Tables

### Source of Truth

| File                     | Purpose                                     |
|--------------------------|---------------------------------------------|
| `src/il/core/Opcode.def` | Opcode definitions with arity/type metadata |

### Generated Files

| File                                     | Purpose                                 |
|------------------------------------------|-----------------------------------------|
| `src/il/verify/generated/SpecTables.cpp` | InstructionSpec entries for each opcode |

### Regeneration

```bash
# When adding/modifying opcode verification rules:
1. Update the InstructionSpec entry in SpecTables.cpp
2. Ensure entry order matches Opcode enum
3. Run tests: ctest --test-dir build -R il_verify
```

---

## Codegen Encoding Tables (CMake-Generated)

### Source of Truth

| File                               | Purpose                       |
|------------------------------------|-------------------------------|
| `docs/spec/x86_64_encodings.json`  | x86-64 instruction encodings  |
| `docs/spec/aarch64_encodings.json` | AArch64 instruction encodings |

### Generated Files

| Directory                        | Files                                 |
|----------------------------------|---------------------------------------|
| `src/codegen/x86_64/generated/`  | `EncodingTable.inc`, `OpFmtTable.inc` |
| `src/codegen/aarch64/generated/` | `OpcodeDispatch.inc`                  |

### Generators

| Script                           | Output                  |
|----------------------------------|-------------------------|
| `cmake/GenX86Encodings.cmake`    | x86-64 encoding tables  |
| `cmake/GenAArch64Dispatch.cmake` | AArch64 dispatch switch |

### Regeneration

These files are **automatically regenerated** during CMake build when specs change:

```bash
# Regenerate manually (if needed):
cmake --build build --target gen_x86_64_encodings
cmake --build build --target gen_aarch64_dispatch

# Or simply rebuild after editing JSON specs:
cmake --build build
```

---

## BASIC Frontend Builtin Table

### Source of Truth

| File                                       | Purpose                          |
|--------------------------------------------|----------------------------------|
| `src/frontends/basic/builtin_registry.inc` | Macro-based builtin declarations |

This file uses X-macro techniques and is included multiple times with different macro definitions. It is **intentionally
macro-based** for fast iteration.

---

## Runtime Class Catalog

### Source of Truth

| File                                          | Purpose                                |
|-----------------------------------------------|----------------------------------------|
| `build/generated/il/runtime/RuntimeClasses.inc` | Macro-based runtime class declarations |

This file defines runtime class descriptors (String, Array, Object, etc.) using macros. It can be replaced by a
YAML-driven generator in the future.

---

## Adding a New Generated File

When creating a new generated artifact:

1. Place it in a `generated/` subdirectory
2. Add a standard header comment:
   ```cpp
   //===----------------------------------------------------------------------===//
   // IMPORTANT: This file is auto-generated. Do not edit manually.
   //
   // File: <relative/path>
   // Purpose: <brief description>
   // Generator: <script or "Manually maintained">
   // Regenerate: <instructions>
   //===----------------------------------------------------------------------===//
   ```
3. Document it in this file
4. Add tests that verify the generated content matches expectations

---

## Related Documentation

- [Architecture](architecture.md) — System design and layering
- [Code Map](codemap.md) — Source directory layout
- [IL Guide](il-guide.md) — IL specification and opcode reference
- [VM](vm.md) — Virtual machine implementation details
