// =============================================================================
// PAC-MAN - Fruit Entity
// =============================================================================
// Uses new Viper runtime features:
// - Viper.Game.Timer for fruit visibility and points display duration
// - Viper.Game.Tween for floating points animation
// =============================================================================

module fruit;

bind "./config";
bind "./utils";

// =============================================================================
// FRUIT ENTITY - Bonus item that appears in the maze
// =============================================================================

entity Fruit {
    hide Integer fruitType;
    hide Integer gridX;
    hide Integer gridY;
    hide Integer screenX;
    hide Integer screenY;
    hide Boolean active;
    hide Integer lastPoints;

    // Use Timer for fruit visibility
    hide Viper.Game.Timer visibilityTimer;

    // Use Timer and Tween for points display
    hide Viper.Game.Timer displayTimer;
    hide Viper.Game.Tween pointsTween;
    hide Boolean showingPoints;

    expose func init() {
        fruitType = config.FRUIT_NONE;
        gridX = 14;
        gridY = 17;
        screenX = utils.gridToScreenX(gridX);
        screenY = utils.gridToScreenY(gridY);
        active = false;
        lastPoints = 0;
        showingPoints = false;

        visibilityTimer = Viper.Game.Timer.New();
        displayTimer = Viper.Game.Timer.New();
        pointsTween = Viper.Game.Tween.New();
    }

    expose func spawn(level: Integer) {
        fruitType = utils.getFruitForLevel(level);
        active = true;
        visibilityTimer.Start(config.FRUIT_DURATION);
        showingPoints = false;
    }

    expose func update() {
        if active {
            visibilityTimer.Update();
            if visibilityTimer.IsExpired {
                active = false;
                fruitType = config.FRUIT_NONE;
            }
        }

        if showingPoints {
            displayTimer.Update();
            pointsTween.Update();
            if displayTimer.IsExpired {
                showingPoints = false;
            }
        }
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func collect() -> Integer {
        if active {
            active = false;
            lastPoints = utils.getFruitPoints(fruitType);

            // Start points display animation
            showingPoints = true;
            displayTimer.Start(config.POINTS_DISPLAY_TIME);
            pointsTween.StartI64(0, 30, config.POINTS_DISPLAY_TIME, config.EASE_OUT_QUAD);

            return lastPoints;
        }
        return 0;
    }

    expose func collidesWithPacman(pacmanX: Integer, pacmanY: Integer) -> Boolean {
        if !active { return false; }
        return gridX == pacmanX && gridY == pacmanY;
    }

    expose func reset() {
        active = false;
        fruitType = config.FRUIT_NONE;
        visibilityTimer.Stop();
        displayTimer.Stop();
        showingPoints = false;
    }

    expose func draw(canvas: Viper.Graphics.Canvas) {
        if active {
            var color = utils.getFruitColor(fruitType);
            var centerX = screenX + config.TILE_SIZE / 2;
            var centerY = screenY + config.TILE_SIZE / 2;

            // Draw fruit body
            canvas.Disc(centerX, centerY, 8, color);
            // Draw stem
            canvas.Box(centerX - 1, centerY - 10, 3, 4, 0x00008800);
        }

        // Show floating points when collected
        if showingPoints {
            var pointsText = Viper.Fmt.Int(lastPoints);
            var floatOffset = pointsTween.ValueI64;
            canvas.Text(screenX, screenY - floatOffset, pointsText, config.COLOR_WHITE);
        }
    }
}

