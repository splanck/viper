module fireworks;

// ============================================================================
// FIREWORKS.VIPER - Fireworks Animation
// ============================================================================
// Beautiful fireworks display with rockets, explosions, and sparkles.
// Features multiple explosion patterns and colors.
// ============================================================================

bind "./colors";

bind Viper.Random;
bind Viper.Graphics;
bind Viper.Graphics.Color;
bind Viper.Math;
bind Viper.Time;

var PI: Number;

func initConstants() {
    PI = 3.14159265358979;
}

// Sparkle particle from explosion
entity Sparkle {
    expose Number x;
    expose Number y;
    expose Number vx;
    expose Number vy;
    expose Integer life;
    expose Integer maxLife;
    expose Integer color;
    expose Boolean trail;

    expose func init(px: Number, py: Number, angle: Number, speed: Number, c: Integer) {
        x = px;
        y = py;
        vx = Cos(angle) * speed;
        vy = Sin(angle) * speed;
        color = c;
        maxLife = 40 + NextInt(40);
        life = maxLife;
        trail = NextInt(3) == 0;
    }

    expose func update(gravity: Number) {
        vy = vy + gravity;
        vx = vx * 0.98;
        vy = vy * 0.98;

        x = x + vx;
        y = y + vy;

        life = life - 1;
    }

    expose func isAlive() -> Boolean {
        return life > 0;
    }

    expose func draw(canvas: Canvas) {
        if life <= 0 {
            return;
        }

        var fade = life / maxLife;
        var drawColor = colors.fadeColor(color, fade);

        var px = Floor(x);
        var py = Floor(y);

        if trail {
            // Draw with trail
            var oldX = Floor(x - vx * 2);
            var oldY = Floor(y - vy * 2);
            canvas.Line(oldX, oldY, px, py, colors.fadeColor(drawColor, 0.5));
        }

        canvas.Plot(px, py, drawColor);

        // Extra brightness at center
        if life > maxLife / 2 {
            canvas.Plot(px + 1, py, drawColor);
            canvas.Plot(px, py + 1, drawColor);
        }
    }
}

// Rocket that shoots upward before exploding
entity Rocket {
    expose Number x;
    expose Number y;
    expose Number vx;
    expose Number vy;
    expose Integer color;
    expose Boolean exploded;
    expose Number targetY;
    expose List[Integer] trail;  // Packed x,y positions

    expose func init(startX: Number, screenHeight: Integer) {
        x = startX;
        y = screenHeight;
        vx = (Next() - 0.5) * 2.0;
        vy = -10.0 - Next() * 5.0;
        color = colors.rainbowPhase(NextInt(360));
        exploded = false;
        targetY = 100.0 + Next() * 200.0;
        trail = [];
    }

    expose func update() {
        if exploded {
            return;
        }

        // Store trail
        var trailPos = Floor(x) * 10000 + Floor(y);
        trail.add(trailPos);
        if trail.count() > 15 {
            trail.removeAt(0);
        }

        vy = vy + 0.15;  // Gravity slows it
        x = x + vx;
        y = y + vy;

        // Explode when slowing down or reaching target height
        if vy >= -2.0 {
            exploded = true;
        }
        if y <= targetY {
            exploded = true;
        }
    }

    expose func shouldExplode() -> Boolean {
        return exploded;
    }

    expose func draw(canvas: Canvas) {
        if exploded {
            return;
        }

        // Draw trail
        var i = 0;
        while i < trail.count() {
            var pos = trail.get(i);
            var tx = pos / 10000;
            var ty = pos - (tx * 10000);
            var fade = i / trail.count();
            var trailColor = colors.fadeColor(color, fade * 0.5);
            canvas.Plot(tx, ty, trailColor);
            i = i + 1;
        }

        // Draw rocket
        var px = Floor(x);
        var py = Floor(y);
        canvas.Disc(px, py, 2, color);
        canvas.Disc(px, py, 1, colors.WHITE);
    }
}

// Explosion containing many sparkles
entity Explosion {
    expose List[Sparkle] sparkles;
    expose Integer pattern;  // 0=circle, 1=star, 2=ring, 3=willow

    expose func init(x: Number, y: Number, color: Integer) {
        sparkles = [];
        pattern = NextInt(4);

        var numSparkles: Integer;
        if pattern == 0 {
            // Circle explosion
            numSparkles = 80 + NextInt(40);
            createCircle(x, y, color, numSparkles);
        } else if pattern == 1 {
            // Star pattern
            createStar(x, y, color);
        } else if pattern == 2 {
            // Double ring
            createRing(x, y, color);
        } else {
            // Willow (drooping)
            createWillow(x, y, color);
        }
    }

    expose func createCircle(x: Number, y: Number, color: Integer, count: Integer) {
        var i = 0;
        while i < count {
            var angle = Next() * 2.0 * PI;
            var speed = 2.0 + Next() * 6.0;
            var sparkle = new Sparkle();
            sparkle.init(x, y, angle, speed, color);
            sparkles.add(sparkle);
            i = i + 1;
        }
    }

    expose func createStar(x: Number, y: Number, color: Integer) {
        var points = 5 + NextInt(3);
        var i = 0;
        while i < points {
            var baseAngle = (i * 2.0 * PI) / points;

            // Create spray at each point
            var j = 0;
            while j < 15 {
                var angle = baseAngle + (Next() - 0.5) * 0.3;
                var speed = 4.0 + Next() * 4.0;
                var sparkle = new Sparkle();
                sparkle.init(x, y, angle, speed, color);
                sparkles.add(sparkle);
                j = j + 1;
            }
            i = i + 1;
        }
    }

    expose func createRing(x: Number, y: Number, color: Integer) {
        // Inner ring
        var i = 0;
        while i < 40 {
            var angle = (i * 2.0 * PI) / 40.0;
            var speed = 3.0 + Next() * 0.5;
            var sparkle = new Sparkle();
            sparkle.init(x, y, angle, speed, color);
            sparkles.add(sparkle);
            i = i + 1;
        }

        // Outer ring with different color
        var outerColor = colors.rainbowPhase((NextInt(360) + 180) - ((NextInt(360) + 180) / 360) * 360);
        i = 0;
        while i < 50 {
            var angle = (i * 2.0 * PI) / 50.0;
            var speed = 5.5 + Next() * 0.5;
            var sparkle = new Sparkle();
            sparkle.init(x, y, angle, speed, outerColor);
            sparkles.add(sparkle);
            i = i + 1;
        }
    }

    expose func createWillow(x: Number, y: Number, color: Integer) {
        var i = 0;
        while i < 100 {
            var angle = Next() * 2.0 * PI;
            var speed = 1.0 + Next() * 3.0;
            var sparkle = new Sparkle();
            sparkle.init(x, y, angle, speed, color);
            sparkle.maxLife = 80 + NextInt(40);  // Longer life
            sparkle.life = sparkle.maxLife;
            sparkle.trail = true;
            sparkles.add(sparkle);
            i = i + 1;
        }
    }

    expose func update(gravity: Number) {
        var i = 0;
        while i < sparkles.count() {
            var s = sparkles.get(i);
            s.update(gravity);
            i = i + 1;
        }

        // Remove dead sparkles
        i = sparkles.count() - 1;
        while i >= 0 {
            var s = sparkles.get(i);
            if not s.isAlive() {
                sparkles.removeAt(i);
            }
            i = i - 1;
        }
    }

    expose func isFinished() -> Boolean {
        return sparkles.count() == 0;
    }

    expose func draw(canvas: Canvas) {
        var i = 0;
        while i < sparkles.count() {
            var s = sparkles.get(i);
            s.draw(canvas);
            i = i + 1;
        }
    }
}

// Fireworks show manager
entity FireworksShow {
    expose List[Rocket] rockets;
    expose List[Explosion] explosions;
    expose Integer launchTimer;
    expose Integer launchInterval;
    expose Boolean autoLaunch;
    expose Number gravity;
    expose Integer screenWidth;
    expose Integer screenHeight;

    expose func init(w: Integer, h: Integer) {
        rockets = [];
        explosions = [];
        launchTimer = 0;
        launchInterval = 40;
        autoLaunch = true;
        gravity = 0.08;
        screenWidth = w;
        screenHeight = h;
    }

    expose func launch(x: Number) {
        var rocket = new Rocket();
        rocket.init(x, screenHeight);
        rockets.add(rocket);
    }

    expose func launchRandom() {
        var x = 100.0 + Next() * (screenWidth - 200);
        launch(x);
    }

    expose func update() {
        // Auto-launch
        if autoLaunch {
            launchTimer = launchTimer + 1;
            if launchTimer >= launchInterval {
                launchTimer = 0;
                launchRandom();
                // Occasionally launch multiple
                if NextInt(4) == 0 {
                    launchRandom();
                }
            }
        }

        // Update rockets
        var i = 0;
        while i < rockets.count() {
            var r = rockets.get(i);
            r.update();
            i = i + 1;
        }

        // Check for explosions
        i = rockets.count() - 1;
        while i >= 0 {
            var r = rockets.get(i);
            if r.shouldExplode() {
                var exp = new Explosion();
                exp.init(r.x, r.y, r.color);
                explosions.add(exp);
                rockets.removeAt(i);
            }
            i = i - 1;
        }

        // Update explosions
        i = 0;
        while i < explosions.count() {
            var e = explosions.get(i);
            e.update(gravity);
            i = i + 1;
        }

        // Remove finished explosions
        i = explosions.count() - 1;
        while i >= 0 {
            var e = explosions.get(i);
            if e.isFinished() {
                explosions.removeAt(i);
            }
            i = i - 1;
        }
    }

    expose func draw(canvas: Canvas) {
        // Draw rockets
        var i = 0;
        while i < rockets.count() {
            var r = rockets.get(i);
            r.draw(canvas);
            i = i + 1;
        }

        // Draw explosions
        i = 0;
        while i < explosions.count() {
            var e = explosions.get(i);
            e.draw(canvas);
            i = i + 1;
        }
    }

    expose func toggleAuto() {
        autoLaunch = not autoLaunch;
    }
}

// Run the fireworks demo
func run(canvas: Canvas) {
    var width = canvas.Width;
    var height = canvas.Height;

    colors.initColors();
    initConstants();

    var show = new FireworksShow();
    show.init(width, height);

    var running = true;
    var spaceHeld = false;

    while running {
        canvas.Poll();

        if canvas.ShouldClose != 0 {
            running = false;
        }

        // ESC or Q to exit
        if canvas.KeyHeld(27) != 0 {
            running = false;
        }
        if canvas.KeyHeld(81) != 0 {
            running = false;
        }

        // Space to launch manually
        if canvas.KeyHeld(32) != 0 {
            if not spaceHeld {
                show.launchRandom();
                spaceHeld = true;
            }
        } else {
            spaceHeld = false;
        }

        // A toggles auto-launch
        if canvas.KeyHeld(65) != 0 {
            show.toggleAuto();
            Viper.Time.SleepMs(200);  // Debounce
        }

        // Up/Down adjusts launch frequency
        if canvas.KeyHeld(265) != 0 {
            show.launchInterval = show.launchInterval - 2;
            if show.launchInterval < 10 {
                show.launchInterval = 10;
            }
        }
        if canvas.KeyHeld(264) != 0 {
            show.launchInterval = show.launchInterval + 2;
            if show.launchInterval > 100 {
                show.launchInterval = 100;
            }
        }

        // Update show
        show.update();

        // Draw background (dark night sky with slight fade)
        canvas.Clear(RGB(5, 5, 15));

        // Draw ground
        canvas.Box(0, height - 20, width, 20, RGB(20, 30, 20));

        // Draw cityscape silhouette
        var bx = 0;
        while bx < width {
            var bh = 30 + NextInt(60);
            var bw = 20 + NextInt(30);
            canvas.Box(bx, height - 20 - bh, bw, bh, RGB(15, 20, 25));

            // Windows
            var wy = height - 20 - bh + 5;
            while wy < height - 25 {
                var wx = bx + 3;
                while wx < bx + bw - 3 {
                    if NextInt(3) != 0 {
                        var wc = RGB(255, 255, 150);
                        canvas.Box(wx, wy, 3, 4, wc);
                    }
                    wx = wx + 6;
                }
                wy = wy + 8;
            }

            bx = bx + bw + 5;
        }

        // Draw fireworks
        show.draw(canvas);

        // Draw UI
        canvas.TextBg(10, 10, "FIREWORKS", colors.WHITE, colors.BLACK);

        if show.autoLaunch {
            canvas.TextBg(10, 28, "Auto: ON", colors.GREEN, colors.BLACK);
        } else {
            canvas.TextBg(10, 28, "Auto: OFF", colors.RED, colors.BLACK);
        }

        canvas.TextBg(10, height - 45, "SPACE: Launch | A: Toggle Auto | UP/DOWN: Speed | ESC: Exit", colors.DARK_GRAY, colors.BLACK);

        canvas.Flip();
        Viper.Time.SleepMs(16);
    }
}
