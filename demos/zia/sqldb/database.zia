// database.zia â€” Database Container
// Part of ViperSQL

module database;

bind "./table";

//=============================================================================
// DATABASE ENTITY
//=============================================================================

entity Database {
    expose String name;
    expose List[Table] tables;
    expose List[String] viewNames;
    expose List[String] viewDefs;

    expose func init() {
        name = "default";
        tables = [];
        viewNames = [];
        viewDefs = [];
    }

    expose func initWithName(dbName: String) {
        name = dbName;
        tables = [];
        viewNames = [];
        viewDefs = [];
    }

    expose func tableCount() -> Integer {
        return tables.count();
    }

    expose func getTable(index: Integer) -> Table? {
        if index < 0 || index >= tables.count() {
            return null;
        }
        return tables.get(index);
    }

    expose func findTable(tableName: String) -> Table? {
        var i = 0;
        while i < tables.count() {
            var t = tables.get(i);
            if t.name == tableName {
                return t;
            }
            i = i + 1;
        }
        return null;
    }

    expose func addTable(table: Table) {
        tables.add(table);
    }

    expose func dropTable(tableName: String) -> Boolean {
        var i = 0;
        while i < tables.count() {
            if tables.get(i).name == tableName {
                tables.removeAt(i);
                return true;
            }
            i = i + 1;
        }
        return false;
    }

    expose func addView(viewName: String, sql: String) {
        viewNames.add(viewName);
        viewDefs.add(sql);
    }

    expose func findView(viewName: String) -> String {
        var i = 0;
        while i < viewNames.count() {
            if viewNames.get(i) == viewName {
                return viewDefs.get(i);
            }
            i = i + 1;
        }
        return "";
    }

    expose func dropView(viewName: String) -> Boolean {
        var i = 0;
        while i < viewNames.count() {
            if viewNames.get(i) == viewName {
                viewNames.removeAt(i);
                viewDefs.removeAt(i);
                return true;
            }
            i = i + 1;
        }
        return false;
    }

    expose func isView(name: String) -> Boolean {
        var i = 0;
        while i < viewNames.count() {
            if viewNames.get(i) == name {
                return true;
            }
            i = i + 1;
        }
        return false;
    }

    expose func listTables() -> String {
        var result = "";
        var i = 0;
        while i < tables.count() {
            if i > 0 {
                result = result + "\n";
            }
            result = result + tables.get(i).name;
            i = i + 1;
        }
        return result;
    }
}

// Factory function
func makeDatabase(name: String) -> Database {
    var db = new Database();
    db.initWithName(name);
    return db;
}
