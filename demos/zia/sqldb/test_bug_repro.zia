module test_bug_repro;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind String = Viper.String;
bind IO = Viper.IO;

bind "./storage/page";
bind "./storage/serializer";
bind "./storage/wal";
bind "./types";
bind "./table";
bind "./schema";

// Test BUG-FE-005: Complex function with 15+ locals
// Test BUG-FE-006: List parameter method calls
// Test BUG-FE-007: Entity field method dispatch

entity RecoveryEngine {
    expose WALManager wal;
    expose Boolean isPersistent;
    expose Integer nextTxnId;
    expose String filename;
    expose List[String] tableNames;
    expose List[Integer] tableCounts;
    
    expose func init() {
        wal = new WALManager();
        wal.init();
        isPersistent = false;
        nextTxnId = 0;
        filename = "";
        tableNames = [];
        tableCounts = [];
    }
    
    // Complex recovery function with many locals (BUG-FE-005 pattern)
    expose func performRecovery() -> Integer {
        var totalRecovered = 0;
        var totalSkipped = 0;
        var currentTxn = -1;
        var inTransaction = false;
        var insertCount = 0;
        var updateCount = 0;
        var deleteCount = 0;
        var commitCount = 0;
        var abortCount = 0;
        var checkpointCount = 0;
        var unknownCount = 0;
        var lastTableId = -1;
        var lastPageId = -1;
        var lastSlotId = -1;
        var status = "idle";
        var phase = "analysis";
        
        // BUG-FE-007: call method on entity field
        if wal.isEnabled() {
            phase = "wal-recovery";
            
            // Simulate analyzing WAL records
            var i = 0;
            while i < 10 {
                var recordType = (i % 4) + 1;
                
                if recordType == 1 {
                    // BEGIN
                    currentTxn = i;
                    inTransaction = true;
                    status = "active";
                } else if recordType == 2 {
                    // COMMIT
                    if inTransaction {
                        commitCount = commitCount + 1;
                        totalRecovered = totalRecovered + insertCount + updateCount;
                    }
                    inTransaction = false;
                    insertCount = 0;
                    updateCount = 0;
                    deleteCount = 0;
                    status = "idle";
                } else if recordType == 3 {
                    // ABORT
                    if inTransaction {
                        abortCount = abortCount + 1;
                        totalSkipped = totalSkipped + insertCount + updateCount;
                    }
                    inTransaction = false;
                    insertCount = 0;
                    updateCount = 0;
                    deleteCount = 0;
                    status = "idle";
                } else if recordType == 4 {
                    // INSERT
                    insertCount = insertCount + 1;
                    lastTableId = i;
                    lastPageId = i * 2;
                    lastSlotId = i * 3;
                }
                
                i = i + 1;
            }
            
            phase = "complete";
        }
        
        return totalRecovered + commitCount + abortCount;
    }
    
    // BUG-FE-006: pass lists as parameters and call .add() on them
    expose func categorizeItems(items: List[Integer], evens: List[Integer], odds: List[Integer]) {
        var i = 0;
        var evenCount = 0;
        var oddCount = 0;
        var total = items.count();
        var sum = 0;
        var maxVal = 0;
        var minVal = 0;
        var avgVal = 0;
        var filtered = 0;
        
        while i < total {
            var val = items.get(i);
            sum = sum + val;
            
            if val > maxVal { maxVal = val; }
            if val < minVal || i == 0 { minVal = val; }
            
            if val % 2 == 0 {
                evens.add(val);
                evenCount = evenCount + 1;
            } else {
                odds.add(val);
                oddCount = oddCount + 1;
            }
            
            if val > 5 {
                filtered = filtered + 1;
            }
            
            i = i + 1;
        }
        
        if total > 0 {
            avgVal = sum / total;
        }
    }
}

func main() {
    var engine = new RecoveryEngine();
    engine.init();
    
    // Test entity field method dispatch
    var result = engine.performRecovery();
    Terminal.Say("recovery (wal disabled): " + Fmt.Int(result));
    
    // Test list parameter methods
    var items: List[Integer] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    var evens: List[Integer] = [];
    var odds: List[Integer] = [];
    engine.categorizeItems(items, evens, odds);
    Terminal.Say("evens: " + Fmt.Int(evens.count()));
    Terminal.Say("odds: " + Fmt.Int(odds.count()));
    
    // Test chained entity method dispatch from free function
    Terminal.Say("wal enabled from main: " + engine.wal.isEnabled());
    engine.wal.initWithDir("/tmp/test_wal_bugrepro");
    Terminal.Say("wal enabled after init: " + engine.wal.isEnabled());
    result = engine.performRecovery();
    Terminal.Say("recovery (wal enabled): " + Fmt.Int(result));
    
    Terminal.Say("ALL PASSED");
}
