// test_stress2.zia - Comprehensive stress tests for persistent storage
module test_stress2;

bind Terminal = Viper.Terminal;
bind IO = Viper.IO;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "./executor";

//=============================================================================
// TEST UTILITIES
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func check(name: String, condition: Boolean) {
    if condition {
        Terminal.Say("  PASS: " + name);
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + name);
        failed = failed + 1;
    }
}

//=============================================================================
// STRESS TESTS
//=============================================================================

func stressBulkInsertReopen() {
    Terminal.Say("--- Stress 1: Bulk INSERT + reopen ---");
    var dbPath = "/tmp/stress2_bulk.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Session 1: Bulk insert 100 rows
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE bulk (id INTEGER PRIMARY KEY AUTOINCREMENT, val TEXT)");

    var i = 0;
    while i < 100 {
        exec1.executeSql("INSERT INTO bulk VALUES (NULL, 'item_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    var r1 = exec1.executeSql("SELECT * FROM bulk");
    check("100 rows inserted", r1.rowCount() == 100);
    exec1.executeSql("CLOSE");

    // Session 2: Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r2 = exec2.executeSql("SELECT * FROM bulk");
    check("100 rows after reopen", r2.rowCount() == 100);

    var r3 = exec2.executeSql("SELECT val FROM bulk WHERE id = 50");
    check("row 50 exists", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT id FROM bulk WHERE id = 100");
    check("row 100 exists (autoincrement)", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressBulkUpdateReopen() {
    Terminal.Say("--- Stress 2: Bulk UPDATE + reopen ---");
    var dbPath = "/tmp/stress2_update.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE scores (id INTEGER, score INTEGER)");

    var i = 0;
    while i < 50 {
        exec1.executeSql("INSERT INTO scores VALUES (" + Fmt.Int(i) + ", 0)");
        i = i + 1;
    }

    // Update all rows
    exec1.executeSql("UPDATE scores SET score = 100 WHERE id >= 0");
    exec1.executeSql("CLOSE");

    // Verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r1 = exec2.executeSql("SELECT * FROM scores WHERE score = 100");
    check("all 50 rows updated to 100", r1.rowCount() == 50);

    var r2 = exec2.executeSql("SELECT * FROM scores WHERE score = 0");
    check("no rows with old value", r2.rowCount() == 0);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressDeleteHalfReopen() {
    Terminal.Say("--- Stress 3: Delete half the rows + reopen ---");
    var dbPath = "/tmp/stress2_delhalf.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE numbers (id INTEGER, even INTEGER)");

    var i = 0;
    while i < 40 {
        var isEven = 0;
        if i % 2 == 0 { isEven = 1; }
        exec1.executeSql("INSERT INTO numbers VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(isEven) + ")");
        i = i + 1;
    }

    // Delete odd numbers
    exec1.executeSql("DELETE FROM numbers WHERE even = 0");
    var r1 = exec1.executeSql("SELECT * FROM numbers");
    check("20 even rows remain", r1.rowCount() == 20);
    exec1.executeSql("CLOSE");

    // Reopen
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r2 = exec2.executeSql("SELECT * FROM numbers");
    check("20 rows after reopen", r2.rowCount() == 20);

    var r3 = exec2.executeSql("SELECT * FROM numbers WHERE even = 0");
    check("no odd rows after reopen", r3.rowCount() == 0);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressInsertAfterDelete() {
    Terminal.Say("--- Stress 4: INSERT after DELETE cycle ---");
    var dbPath = "/tmp/stress2_insdel.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE cycling (id INTEGER, gen INTEGER)");

    // Generation 1: insert 20 rows
    var i = 0;
    while i < 20 {
        exec1.executeSql("INSERT INTO cycling VALUES (" + Fmt.Int(i) + ", 1)");
        i = i + 1;
    }

    // Delete all
    exec1.executeSql("DELETE FROM cycling WHERE gen = 1");

    // Generation 2: insert 30 rows
    i = 0;
    while i < 30 {
        exec1.executeSql("INSERT INTO cycling VALUES (" + Fmt.Int(100 + i) + ", 2)");
        i = i + 1;
    }

    var r1 = exec1.executeSql("SELECT * FROM cycling");
    check("30 gen-2 rows", r1.rowCount() == 30);
    exec1.executeSql("CLOSE");

    // Reopen
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r2 = exec2.executeSql("SELECT * FROM cycling");
    check("30 rows after reopen", r2.rowCount() == 30);

    var r3 = exec2.executeSql("SELECT * FROM cycling WHERE gen = 1");
    check("no gen-1 rows", r3.rowCount() == 0);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressMultiTableCRUD() {
    Terminal.Say("--- Stress 5: Multi-table CRUD + reopen ---");
    var dbPath = "/tmp/stress2_multi.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");

    // Create 5 tables
    exec1.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec1.executeSql("CREATE TABLE t2 (id INTEGER, val TEXT)");
    exec1.executeSql("CREATE TABLE t3 (id INTEGER, val TEXT)");
    exec1.executeSql("CREATE TABLE t4 (id INTEGER, val TEXT)");
    exec1.executeSql("CREATE TABLE t5 (id INTEGER, val TEXT)");

    // Insert into each
    exec1.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec1.executeSql("INSERT INTO t2 VALUES (1, 'b')");
    exec1.executeSql("INSERT INTO t2 VALUES (2, 'c')");
    exec1.executeSql("INSERT INTO t3 VALUES (1, 'd')");
    exec1.executeSql("INSERT INTO t3 VALUES (2, 'e')");
    exec1.executeSql("INSERT INTO t3 VALUES (3, 'f')");
    exec1.executeSql("INSERT INTO t4 VALUES (1, 'g')");
    exec1.executeSql("INSERT INTO t5 VALUES (1, 'h')");

    // Update t2
    exec1.executeSql("UPDATE t2 SET val = 'updated' WHERE id = 1");

    // Delete from t4
    exec1.executeSql("DELETE FROM t4 WHERE id = 1");

    // Drop t5
    exec1.executeSql("DROP TABLE t5");

    exec1.executeSql("CLOSE");

    // Reopen and verify everything
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r1 = exec2.executeSql("SELECT * FROM t1");
    check("t1: 1 row", r1.rowCount() == 1);

    var r2 = exec2.executeSql("SELECT * FROM t2");
    check("t2: 2 rows", r2.rowCount() == 2);

    var r3 = exec2.executeSql("SELECT * FROM t3");
    check("t3: 3 rows", r3.rowCount() == 3);

    var r4 = exec2.executeSql("SELECT * FROM t4");
    check("t4: 0 rows (deleted)", r4.rowCount() == 0);

    var r5 = exec2.executeSql("SELECT * FROM t5");
    check("t5: dropped (error)", r5.success == false);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressLongStrings() {
    Terminal.Say("--- Stress 6: Long strings ---");
    var dbPath = "/tmp/stress2_long.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE docs (id INTEGER, content TEXT)");

    // Build a moderately long string (200 chars)
    var longStr = "";
    var i = 0;
    while i < 20 {
        longStr = longStr + "ABCDEFGHIJ";
        i = i + 1;
    }

    exec1.executeSql("INSERT INTO docs VALUES (1, '" + longStr + "')");
    exec1.executeSql("INSERT INTO docs VALUES (2, 'short')");

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r1 = exec2.executeSql("SELECT * FROM docs");
    check("2 docs", r1.rowCount() == 2);

    var r2 = exec2.executeSql("SELECT content FROM docs WHERE id = 2");
    check("short string ok", r2.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressMultiDbPersistence() {
    Terminal.Say("--- Stress 7: Multi-database persistence ---");
    var dbPath1 = "/tmp/stress2_mdb1.vdb";
    var dbPath2 = "/tmp/stress2_mdb2.vdb";
    if IO.File.Exists(dbPath1) { IO.File.Delete(dbPath1); }
    if IO.File.Exists(dbPath2) { IO.File.Delete(dbPath2); }

    // Session 1: create two persistent databases
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("CREATE DATABASE alpha FILE '" + dbPath1 + "'");
    exec1.executeSql("CREATE DATABASE beta FILE '" + dbPath2 + "'");

    exec1.executeSql("USE alpha");
    exec1.executeSql("CREATE TABLE users (id INTEGER, name TEXT)");
    exec1.executeSql("INSERT INTO users VALUES (1, 'Alice')");
    exec1.executeSql("INSERT INTO users VALUES (2, 'Bob')");

    exec1.executeSql("USE beta");
    exec1.executeSql("CREATE TABLE orders (id INTEGER, user_id INTEGER, total INTEGER)");
    exec1.executeSql("INSERT INTO orders VALUES (1, 1, 100)");
    exec1.executeSql("INSERT INTO orders VALUES (2, 2, 200)");
    exec1.executeSql("INSERT INTO orders VALUES (3, 1, 150)");

    // Verify before close
    var r1 = exec1.executeSql("SELECT * FROM orders");
    check("beta: 3 orders", r1.rowCount() == 3);

    exec1.executeSql("USE alpha");
    var r2 = exec1.executeSql("SELECT * FROM users");
    check("alpha: 2 users", r2.rowCount() == 2);

    // Close both databases before ending session 1
    exec1.executeSql("USE beta");
    exec1.executeSql("CLOSE");
    exec1.executeSql("USE alpha");
    exec1.executeSql("CLOSE");

    // Session 2: fresh executor, reopen via OPEN
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath1 + "'");
    var r3 = exec2.executeSql("SELECT * FROM users");
    check("alpha reopened: 2 users", r3.rowCount() == 2);
    exec2.executeSql("CLOSE");

    var exec3 = new Executor();
    exec3.init();
    exec3.executeSql("OPEN '" + dbPath2 + "'");
    var r4 = exec3.executeSql("SELECT * FROM orders");
    check("beta reopened: 3 orders", r4.rowCount() == 3);
    exec3.executeSql("CLOSE");

    if IO.File.Exists(dbPath1) { IO.File.Delete(dbPath1); }
    if IO.File.Exists(dbPath2) { IO.File.Delete(dbPath2); }
}

func stressRepeatedOpenClose() {
    Terminal.Say("--- Stress 8: Repeated open/close cycles ---");
    var dbPath = "/tmp/stress2_cycles.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Create database
    var exec0 = new Executor();
    exec0.init();
    exec0.executeSql("OPEN '" + dbPath + "'");
    exec0.executeSql("CREATE TABLE counter (id INTEGER, val INTEGER)");
    exec0.executeSql("INSERT INTO counter VALUES (1, 0)");
    exec0.executeSql("CLOSE");

    // Do 5 open/update/close cycles
    var cycle = 0;
    while cycle < 5 {
        var exec = new Executor();
        exec.init();
        exec.executeSql("OPEN '" + dbPath + "'");
        exec.executeSql("UPDATE counter SET val = " + Fmt.Int(cycle + 1) + " WHERE id = 1");
        exec.executeSql("CLOSE");
        cycle = cycle + 1;
    }

    // Verify final value
    var execFinal = new Executor();
    execFinal.init();
    execFinal.executeSql("OPEN '" + dbPath + "'");
    var r1 = execFinal.executeSql("SELECT * FROM counter");
    check("counter has 1 row", r1.rowCount() == 1);
    execFinal.executeSql("CLOSE");

    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressComplexQueries() {
    Terminal.Say("--- Stress 9: Complex queries on persistent data ---");
    var dbPath = "/tmp/stress2_complex.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE employees (id INTEGER, name TEXT, dept TEXT, salary INTEGER)");
    exec1.executeSql("INSERT INTO employees VALUES (1, 'Alice', 'eng', 100)");
    exec1.executeSql("INSERT INTO employees VALUES (2, 'Bob', 'eng', 120)");
    exec1.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 'sales', 90)");
    exec1.executeSql("INSERT INTO employees VALUES (4, 'Diana', 'sales', 95)");
    exec1.executeSql("INSERT INTO employees VALUES (5, 'Eve', 'eng', 110)");
    exec1.executeSql("CLOSE");

    // Reopen and run complex queries
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r1 = exec2.executeSql("SELECT * FROM employees ORDER BY salary DESC LIMIT 3");
    check("top 3 by salary", r1.rowCount() == 3);

    var r2 = exec2.executeSql("SELECT dept, COUNT(*) FROM employees GROUP BY dept");
    check("group by dept: 2 groups", r2.rowCount() == 2);

    var r3 = exec2.executeSql("SELECT * FROM employees WHERE salary > 95 AND dept = 'eng'");
    check("filtered eng high salary", r3.rowCount() == 3);

    var r4 = exec2.executeSql("SELECT * FROM employees WHERE name LIKE 'A%' OR name LIKE 'E%'");
    check("LIKE filter: A* or E*", r4.rowCount() == 2);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressSpecialValues() {
    Terminal.Say("--- Stress 10: Special values + edge cases ---");
    var dbPath = "/tmp/stress2_special.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE special (id INTEGER, txt TEXT, num INTEGER)");

    // Empty string
    exec1.executeSql("INSERT INTO special VALUES (1, '', 0)");
    // NULL values
    exec1.executeSql("INSERT INTO special VALUES (2, NULL, NULL)");
    // Negative numbers
    exec1.executeSql("INSERT INTO special VALUES (3, 'neg', -42)");
    // Large number
    exec1.executeSql("INSERT INTO special VALUES (4, 'big', 999999)");

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r1 = exec2.executeSql("SELECT * FROM special");
    check("4 special rows", r1.rowCount() == 4);

    var r2 = exec2.executeSql("SELECT * FROM special WHERE num IS NULL");
    check("NULL num found", r2.rowCount() == 1);

    var r3 = exec2.executeSql("SELECT * FROM special WHERE num < 0");
    check("negative num found", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT * FROM special WHERE num = 999999");
    check("large num found", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressNoExplicitClose() {
    Terminal.Say("--- Stress 11: Data survives without explicit CLOSE ---");
    var dbPath = "/tmp/stress2_noclose.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Session 1: insert data but do NOT call CLOSE
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE items (id INTEGER, name TEXT)");
    exec1.executeSql("INSERT INTO items VALUES (1, 'Alpha')");
    exec1.executeSql("INSERT INTO items VALUES (2, 'Beta')");
    exec1.executeSql("INSERT INTO items VALUES (3, 'Gamma')");
    // No CLOSE â€” relies on flushAll() updating the header

    // Session 2: reopen and verify data survived
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r1 = exec2.executeSql("SELECT * FROM items");
    check("no-close: 3 rows survived", r1.rowCount() == 3);
    exec2.executeSql("CLOSE");

    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressNegativeIntegers() {
    Terminal.Say("--- Stress 12: Negative integer round-trip ---");
    var dbPath = "/tmp/stress2_negint.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE temps (id INTEGER, celsius INTEGER)");
    exec1.executeSql("INSERT INTO temps VALUES (1, -40)");
    exec1.executeSql("INSERT INTO temps VALUES (2, -1)");
    exec1.executeSql("INSERT INTO temps VALUES (3, 0)");
    exec1.executeSql("INSERT INTO temps VALUES (4, 100)");
    exec1.executeSql("INSERT INTO temps VALUES (5, -273)");
    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r1 = exec2.executeSql("SELECT * FROM temps");
    check("negint: 5 rows", r1.rowCount() == 5);

    var r2 = exec2.executeSql("SELECT * FROM temps WHERE celsius < 0");
    check("negint: 3 negative values", r2.rowCount() == 3);

    var r3 = exec2.executeSql("SELECT * FROM temps WHERE celsius = -273");
    check("negint: -273 found", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT * FROM temps WHERE celsius > -2 AND celsius < 1");
    check("negint: -1 and 0 in range", r4.rowCount() == 2);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func stressLargeRowCount() {
    Terminal.Say("--- Stress 13: 500 row insert + reopen ---");
    var dbPath = "/tmp/stress2_500rows.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE big (id INTEGER, val INTEGER)");

    var i = 0;
    while i < 500 {
        exec1.executeSql("INSERT INTO big VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i * 3) + ")");
        i = i + 1;
    }

    var r1 = exec1.executeSql("SELECT * FROM big");
    check("500 rows inserted", r1.rowCount() == 500);
    exec1.executeSql("CLOSE");

    // Reopen
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");
    var r2 = exec2.executeSql("SELECT * FROM big");
    check("500 rows after reopen", r2.rowCount() == 500);

    var r3 = exec2.executeSql("SELECT * FROM big WHERE id = 499");
    check("row 499 exists", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT * FROM big WHERE val = 750");
    check("val 750 (id=250) found", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Persistent Storage Stress Tests ===");
    Terminal.Say("");

    stressBulkInsertReopen();
    stressBulkUpdateReopen();
    stressDeleteHalfReopen();
    stressInsertAfterDelete();
    stressMultiTableCRUD();
    stressLongStrings();
    stressMultiDbPersistence();
    stressRepeatedOpenClose();
    stressComplexQueries();
    stressSpecialValues();
    stressNoExplicitClose();
    stressNegativeIntegers();
    stressLargeRowCount();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    } else {
        Terminal.Say("SOME TESTS FAILED");
    }
}
