// test_btree.zia - B-Tree Implementation Tests
// Part of ViperSQL - Phase 3 Testing

module test_btree;

bind Viper.Terminal;
bind Viper.Fmt;

bind "./storage/page";
bind "./storage/serializer";
bind "./storage/pager";
bind "./storage/buffer";
bind "./storage/btree_node";
bind "./storage/btree";
bind "./types";

//=============================================================================
// TEST HARNESS
//=============================================================================

var testsPassed = 0;
var testsFailed = 0;

func assert(condition: Boolean, testName: String) {
    if condition {
        testsPassed = testsPassed + 1;
        Terminal.Say("[PASS] " + testName);
    } else {
        testsFailed = testsFailed + 1;
        Terminal.Say("[FAIL] " + testName);
    }
}

func printSummary() {
    Terminal.Say("");
    Terminal.Say("===========================================");
    Terminal.Say("B-TREE TEST SUMMARY");
    Terminal.Say("===========================================");
    Terminal.Say("Passed: " + Fmt.Int(testsPassed));
    Terminal.Say("Failed: " + Fmt.Int(testsFailed));
    Terminal.Say("Total:  " + Fmt.Int(testsPassed + testsFailed));
    Terminal.Say("===========================================");
}

//=============================================================================
// BTREE KEY TESTS
//=============================================================================

func testBTreeKeyInit() {
    Terminal.Say("");
    Terminal.Say("--- BTreeKey Tests ---");

    var key = new BTreeKey();
    key.init();

    assert(key.dataPageId == INVALID_PAGE_ID, "BTreeKey init sets invalid page ID");
    assert(key.dataSlotId == -1, "BTreeKey init sets slot to -1");
    assert(key.keyValue.kind == SQL_NULL, "BTreeKey init sets null key value");
}

func testBTreeKeyWithValue() {
    var val = sqlInteger(42);
    var key = new BTreeKey();
    key.initWithValue(val, 10, 5);

    assert(key.dataPageId == 10, "BTreeKey stores page ID");
    assert(key.dataSlotId == 5, "BTreeKey stores slot ID");
    assert(key.keyValue.intValue == 42, "BTreeKey stores key value");
}

func testBTreeKeyCompare() {
    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(10), 1, 0);

    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(20), 2, 0);

    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(10), 3, 0);

    assert(key1.compareTo(key2) < 0, "BTreeKey compare: 10 < 20");
    assert(key2.compareTo(key1) > 0, "BTreeKey compare: 20 > 10");
    assert(key1.compareTo(key3) == 0, "BTreeKey compare: 10 == 10");
}

//=============================================================================
// BTREE NODE TESTS
//=============================================================================

func testBTreeNodeInit() {
    Terminal.Say("");
    Terminal.Say("--- BTreeNode Tests ---");

    var node = new BTreeNode();
    node.init();

    assert(node.pageId == INVALID_PAGE_ID, "BTreeNode init sets invalid page ID");
    assert(node.isLeaf == true, "BTreeNode init is leaf by default");
    assert(node.keyCount() == 0, "BTreeNode init has 0 keys");
    assert(node.children.count() == 0, "BTreeNode init has 0 children");
}

func testBTreeNodeInitAsLeaf() {
    var node = new BTreeNode();
    node.initAsLeaf(100, 1);

    assert(node.pageId == 100, "BTreeNode leaf has page ID");
    assert(node.indexId == 1, "BTreeNode leaf has index ID");
    assert(node.isLeaf == true, "BTreeNode leaf is leaf");
}

func testBTreeNodeInitAsInternal() {
    var node = new BTreeNode();
    node.initAsInternal(200, 2);

    assert(node.pageId == 200, "BTreeNode internal has page ID");
    assert(node.indexId == 2, "BTreeNode internal has index ID");
    assert(node.isLeaf == false, "BTreeNode internal is not leaf");
}

func testBTreeNodeInsertKey() {
    var node = new BTreeNode();
    node.initAsLeaf(1, 1);

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(50), 1, 0);

    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(30), 2, 0);

    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(70), 3, 0);

    node.insertKey(key1);
    assert(node.keyCount() == 1, "BTreeNode has 1 key after first insert");

    node.insertKey(key2);
    assert(node.keyCount() == 2, "BTreeNode has 2 keys after second insert");
    assert(node.keys.get(0).keyValue.intValue == 30, "Keys sorted: first is 30");
    assert(node.keys.get(1).keyValue.intValue == 50, "Keys sorted: second is 50");

    node.insertKey(key3);
    assert(node.keyCount() == 3, "BTreeNode has 3 keys after third insert");
    assert(node.keys.get(2).keyValue.intValue == 70, "Keys sorted: third is 70");
}

func testBTreeNodeRemoveKey() {
    var node = new BTreeNode();
    node.initAsLeaf(1, 1);

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(10), 1, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(20), 2, 0);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(30), 3, 0);

    node.insertKey(key1);
    node.insertKey(key2);
    node.insertKey(key3);

    var removed = node.removeKeyAt(1);
    assert(removed != null, "RemoveKeyAt returns removed key");
    assert(node.keyCount() == 2, "BTreeNode has 2 keys after remove");
    assert(node.keys.get(0).keyValue.intValue == 10, "First key is 10");
    assert(node.keys.get(1).keyValue.intValue == 30, "Second key is 30 after removing 20");
}

func testBTreeNodeFindKey() {
    var node = new BTreeNode();
    node.initAsLeaf(1, 1);

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(10), 1, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(20), 2, 0);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(30), 3, 0);

    node.insertKey(key1);
    node.insertKey(key2);
    node.insertKey(key3);

    assert(node.findKey(sqlInteger(10)) == 0, "FindKey finds 10 at index 0");
    assert(node.findKey(sqlInteger(20)) == 1, "FindKey finds 20 at index 1");
    assert(node.findKey(sqlInteger(30)) == 2, "FindKey finds 30 at index 2");
    assert(node.findKey(sqlInteger(15)) == -1, "FindKey returns -1 for missing key");
    assert(node.findKey(sqlInteger(5)) == -1, "FindKey returns -1 for key < min");
    assert(node.findKey(sqlInteger(35)) == -1, "FindKey returns -1 for key > max");
}

func testBTreeNodeFindChildIndex() {
    var node = new BTreeNode();
    node.initAsInternal(1, 1);

    // Add keys 10, 20, 30
    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(10), 1, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(20), 2, 0);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(30), 3, 0);

    node.insertKey(key1);
    node.insertKey(key2);
    node.insertKey(key3);

    // Children: [<10], [10-20), [20-30), [>=30]
    assert(node.findChildIndex(sqlInteger(5)) == 0, "FindChildIndex: 5 -> child 0");
    assert(node.findChildIndex(sqlInteger(10)) == 1, "FindChildIndex: 10 -> child 1");
    assert(node.findChildIndex(sqlInteger(15)) == 1, "FindChildIndex: 15 -> child 1");
    assert(node.findChildIndex(sqlInteger(20)) == 2, "FindChildIndex: 20 -> child 2");
    assert(node.findChildIndex(sqlInteger(25)) == 2, "FindChildIndex: 25 -> child 2");
    assert(node.findChildIndex(sqlInteger(30)) == 3, "FindChildIndex: 30 -> child 3");
    assert(node.findChildIndex(sqlInteger(100)) == 3, "FindChildIndex: 100 -> child 3");
}

func testBTreeNodeIsFull() {
    var node = new BTreeNode();
    node.initAsLeaf(1, 1);

    assert(node.isFull() == false, "Empty node is not full");

    // Add keys up to max (2 * BTREE_MIN_DEGREE - 1 = 99)
    var i = 0;
    while i < 99 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i), i, 0);
        node.insertKey(key);
        i = i + 1;
    }

    assert(node.isFull() == true, "Node with 99 keys is full");
}

//=============================================================================
// BTREE NODE SERIALIZATION TESTS
//=============================================================================

func testBTreeNodeSerialization() {
    Terminal.Say("");
    Terminal.Say("--- BTreeNode Serialization Tests ---");

    // Create a leaf node with some keys (all integers for consistent sort order)
    var node = new BTreeNode();
    node.initAsLeaf(42, 7);
    node.parentPageId = 10;
    node.rightSiblingPageId = 43;

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(100), 5, 2);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(200), 6, 3);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(300), 7, 4);

    node.insertKey(key1);
    node.insertKey(key2);
    node.insertKey(key3);

    // Serialize
    var serializer = new BTreeNodeSerializer();
    serializer.init();

    var page = new Page();
    page.initWithId(42, PAGE_TYPE_INDEX);

    serializer.serializeNode(node, page);

    // Deserialize
    var restored = serializer.deserializeNode(page);

    assert(restored.pageId == 42, "Serialization preserves page ID");
    assert(restored.indexId == 7, "Serialization preserves index ID");
    assert(restored.isLeaf == true, "Serialization preserves isLeaf");
    assert(restored.parentPageId == 10, "Serialization preserves parent page ID");
    assert(restored.rightSiblingPageId == 43, "Serialization preserves right sibling");
    assert(restored.keyCount() == 3, "Serialization preserves key count");
    assert(restored.keys.get(0).keyValue.intValue == 100, "Serialization preserves key 1");
    assert(restored.keys.get(1).keyValue.intValue == 200, "Serialization preserves key 2");
    assert(restored.keys.get(2).keyValue.intValue == 300, "Serialization preserves key 3");
}

func testBTreeInternalNodeSerialization() {
    // Create an internal node with children
    var node = new BTreeNode();
    node.initAsInternal(50, 3);

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(100), 1, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(200), 2, 0);

    node.insertKey(key1);
    node.insertKey(key2);

    // Add children
    node.children.add(10);
    node.children.add(20);
    node.children.add(30);

    // Serialize
    var serializer = new BTreeNodeSerializer();
    serializer.init();

    var page = new Page();
    page.initWithId(50, PAGE_TYPE_INDEX);

    serializer.serializeNode(node, page);

    // Deserialize
    var restored = serializer.deserializeNode(page);

    assert(restored.isLeaf == false, "Internal node serialization preserves isLeaf=false");
    assert(restored.keyCount() == 2, "Internal node serialization preserves key count");
    assert(restored.children.count() == 3, "Internal node serialization preserves children count");
    assert(restored.children.get(0) == 10, "Internal node serialization preserves child 0");
    assert(restored.children.get(1) == 20, "Internal node serialization preserves child 1");
    assert(restored.children.get(2) == 30, "Internal node serialization preserves child 2");
}

//=============================================================================
// BTREE INTEGRATION TESTS
//=============================================================================

func testBTreeCreate() {
    Terminal.Say("");
    Terminal.Say("--- BTree Integration Tests ---");

    // Create a pager and buffer pool
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    // Create a B-tree
    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_test", 1, "id", false);

    assert(tree.rootPageId != INVALID_PAGE_ID, "BTree create sets root page ID");
    assert(tree.indexName == "idx_test", "BTree create sets index name");
    assert(tree.isUnique == false, "BTree create sets uniqueness");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeInsertAndSearch() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_insert_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_test", 1, "id", false);

    // Insert some keys
    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(50), 10, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(30), 11, 1);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlInteger(70), 12, 2);
    var key4 = new BTreeKey();
    key4.initWithValue(sqlInteger(20), 13, 3);
    var key5 = new BTreeKey();
    key5.initWithValue(sqlInteger(40), 14, 4);

    assert(tree.insert(key1) == true, "Insert key 50 succeeds");
    assert(tree.insert(key2) == true, "Insert key 30 succeeds");
    assert(tree.insert(key3) == true, "Insert key 70 succeeds");
    assert(tree.insert(key4) == true, "Insert key 20 succeeds");
    assert(tree.insert(key5) == true, "Insert key 40 succeeds");

    // Search for keys
    var found1 = tree.search(sqlInteger(50));
    assert(found1 != null, "Search finds key 50");
    if found1 != null {
        var f1 = found1;
        assert(f1.dataPageId == 10, "Search returns correct page ID for 50");
    }

    var found2 = tree.search(sqlInteger(30));
    assert(found2 != null, "Search finds key 30");

    var found3 = tree.search(sqlInteger(70));
    assert(found3 != null, "Search finds key 70");

    var notFound = tree.search(sqlInteger(99));
    assert(notFound == null, "Search returns null for missing key");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeUniqueConstraint() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_unique_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_unique", 1, "id", true);  // Unique index

    var key1 = new BTreeKey();
    key1.initWithValue(sqlInteger(100), 10, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlInteger(100), 11, 1);  // Duplicate key value

    assert(tree.insert(key1) == true, "First insert of unique key succeeds");
    assert(tree.insert(key2) == false, "Duplicate insert on unique index fails");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeDelete() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_delete_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_delete", 1, "id", false);

    // Insert keys
    var i = 1;
    while i <= 10 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i * 10), i, 0);
        tree.insert(key);
        i = i + 1;
    }

    // Delete a key
    assert(tree.delete(sqlInteger(50)) == true, "Delete existing key succeeds");
    assert(tree.search(sqlInteger(50)) == null, "Deleted key is not found");
    assert(tree.search(sqlInteger(40)) != null, "Other keys still exist (40)");
    assert(tree.search(sqlInteger(60)) != null, "Other keys still exist (60)");

    // Delete non-existent key
    assert(tree.delete(sqlInteger(999)) == false, "Delete non-existent key fails");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeRangeSearch() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_range_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_range", 1, "id", false);

    // Insert keys 10, 20, 30, 40, 50
    var i = 1;
    while i <= 5 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i * 10), i, 0);
        tree.insert(key);
        i = i + 1;
    }

    // Range search [25, 45]
    var results = tree.rangeSearch(sqlInteger(25), sqlInteger(45));
    assert(results.count() == 2, "Range search [25,45] returns 2 keys (30, 40)");

    // Range search [10, 50]
    var allResults = tree.rangeSearch(sqlInteger(10), sqlInteger(50));
    assert(allResults.count() == 5, "Range search [10,50] returns all 5 keys");

    // Range search [100, 200] (no matches)
    var noResults = tree.rangeSearch(sqlInteger(100), sqlInteger(200));
    assert(noResults.count() == 0, "Range search with no matches returns empty");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeHeight() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_height_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_height", 1, "id", false);

    assert(tree.height() == 1, "Empty tree has height 1 (root node)");

    // Insert a few keys
    var i = 1;
    while i <= 10 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i), i, 0);
        tree.insert(key);
        i = i + 1;
    }

    assert(tree.height() >= 1, "Tree with 10 keys has height >= 1");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeCountKeys() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_count_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_count", 1, "id", false);

    assert(tree.countKeys() == 0, "Empty tree has 0 keys");

    // Insert 20 keys
    var i = 1;
    while i <= 20 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i * 5), i, 0);
        tree.insert(key);
        i = i + 1;
    }

    assert(tree.countKeys() == 20, "Tree has 20 keys after 20 inserts");

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeManyInserts() {
    Terminal.Say("");
    Terminal.Say("--- BTree Stress Test ---");

    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_stress_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_stress", 1, "id", false);

    // Insert 200 keys (will cause splits)
    var i = 0;
    while i < 200 {
        var key = new BTreeKey();
        key.initWithValue(sqlInteger(i * 3), i, i % 10);
        tree.insert(key);
        i = i + 1;
    }

    assert(tree.countKeys() == 200, "Stress test: 200 keys inserted");

    // Verify some searches
    var found1 = tree.search(sqlInteger(0));
    assert(found1 != null, "Stress test: first key found");

    var found2 = tree.search(sqlInteger(300));
    assert(found2 != null, "Stress test: middle key found");

    var found3 = tree.search(sqlInteger(597));
    assert(found3 != null, "Stress test: last key found");

    // Height should be reasonable
    var h = tree.height();
    assert(h >= 1 && h <= 4, "Stress test: height is reasonable (1-4)");
    Terminal.Say("Tree height after 200 inserts: " + Fmt.Int(h));

    pool.flushAll();
    pager.closeDatabase();
}

func testBTreeStringKeys() {
    var pager = new Pager();
    pager.init();

    var testFile = "/tmp/btree_string_test.db";
    pager.createDatabase(testFile);

    var pool = new BufferPool();
    pool.initWithPager(pager);

    var tree = new BTree();
    tree.initWithPool(pool);
    tree.create("idx_string", 1, "name", false);

    // Insert string keys
    var key1 = new BTreeKey();
    key1.initWithValue(sqlText("alice"), 1, 0);
    var key2 = new BTreeKey();
    key2.initWithValue(sqlText("bob"), 2, 0);
    var key3 = new BTreeKey();
    key3.initWithValue(sqlText("charlie"), 3, 0);

    tree.insert(key1);
    tree.insert(key2);
    tree.insert(key3);

    var foundAlice = tree.search(sqlText("alice"));
    assert(foundAlice != null, "String key 'alice' found");

    var foundBob = tree.search(sqlText("bob"));
    assert(foundBob != null, "String key 'bob' found");

    var notFound = tree.search(sqlText("dave"));
    assert(notFound == null, "String key 'dave' not found");

    pool.flushAll();
    pager.closeDatabase();
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("===========================================");
    Terminal.Say("VIPERSQL B-TREE TESTS");
    Terminal.Say("===========================================");

    // BTreeKey tests
    testBTreeKeyInit();
    testBTreeKeyWithValue();
    testBTreeKeyCompare();

    // BTreeNode tests
    testBTreeNodeInit();
    testBTreeNodeInitAsLeaf();
    testBTreeNodeInitAsInternal();
    testBTreeNodeInsertKey();
    testBTreeNodeRemoveKey();
    testBTreeNodeFindKey();
    testBTreeNodeFindChildIndex();
    testBTreeNodeIsFull();

    // Serialization tests
    testBTreeNodeSerialization();
    testBTreeInternalNodeSerialization();

    // Integration tests
    testBTreeCreate();
    testBTreeInsertAndSearch();
    testBTreeUniqueConstraint();
    testBTreeDelete();
    testBTreeRangeSearch();
    testBTreeHeight();
    testBTreeCountKeys();
    testBTreeManyInserts();
    testBTreeStringKeys();

    printSummary();
}
