// test_stress3.zia - Phase 3-5 stress tests
// Tests: multi-database persistence, incremental UPDATE/DELETE, WAL integration
module test_stress3;

bind Terminal = Viper.Terminal;
bind IO = Viper.IO;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "./executor";

//=============================================================================
// TEST UTILITIES
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func check(name: String, condition: Boolean) {
    if condition {
        Terminal.Say("  PASS: " + name);
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + name);
        failed = failed + 1;
    }
}

func cleanup(path: String) {
    if IO.File.Exists(path) { IO.File.Delete(path); }
    // Clean up WAL files
    var walDir = path + ".wal";
    var i = 0;
    while i < 10 {
        var walFile = walDir + "/wal_" + Fmt.Int(i) + ".log";
        if IO.File.Exists(walFile) { IO.File.Delete(walFile); }
        i = i + 1;
    }
}

//=============================================================================
// STRESS TEST 1: Multi-database with interleaved DML
//=============================================================================

func stress1() {
    Terminal.Say("--- Stress 1: Multi-database interleaved DML ---");
    var exec = new Executor();
    exec.init();

    cleanup("/tmp/stress3_db1.vdb");
    cleanup("/tmp/stress3_db2.vdb");

    exec.executeSql("CREATE DATABASE db1 FILE '/tmp/stress3_db1.vdb'");
    exec.executeSql("CREATE DATABASE db2 FILE '/tmp/stress3_db2.vdb'");

    // Work on db1
    exec.executeSql("USE db1");
    exec.executeSql("CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)");
    var i = 0;
    while i < 20 {
        exec.executeSql("INSERT INTO users VALUES (" + Fmt.Int(i) + ", 'user_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // Switch to db2
    exec.executeSql("USE db2");
    exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, price INTEGER)");
    i = 0;
    while i < 15 {
        exec.executeSql("INSERT INTO products VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i * 100) + ")");
        i = i + 1;
    }

    // Switch back to db1 and update
    exec.executeSql("USE db1");
    exec.executeSql("UPDATE users SET name = 'updated' WHERE id < 5");

    // Switch to db2 and delete
    exec.executeSql("USE db2");
    exec.executeSql("DELETE FROM products WHERE id >= 10");

    // Verify db2
    var r2 = exec.executeSql("SELECT * FROM products");
    check("db2: 10 products remain", r2.rowCount() == 10);

    // Switch to db1 and verify
    exec.executeSql("USE db1");
    var r1 = exec.executeSql("SELECT * FROM users WHERE name = 'updated'");
    check("db1: 5 updated users", r1.rowCount() == 5);

    var r1b = exec.executeSql("SELECT * FROM users");
    check("db1: 20 total users", r1b.rowCount() == 20);

    // Close both databases
    exec.executeSql("USE db1");
    exec.executeSql("CLOSE");
    exec.executeSql("USE db2");
    exec.executeSql("CLOSE");

    cleanup("/tmp/stress3_db1.vdb");
    cleanup("/tmp/stress3_db2.vdb");
}

//=============================================================================
// STRESS TEST 2: Incremental UPDATE persistence
//=============================================================================

func stress2() {
    Terminal.Say("--- Stress 2: Incremental UPDATE persistence ---");
    cleanup("/tmp/stress3_update.vdb");

    // Create and populate
    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_update.vdb'");
    exec.executeSql("CREATE TABLE items (id INTEGER PRIMARY KEY, val TEXT, score INTEGER)");
    var i = 0;
    while i < 20 {
        exec.executeSql("INSERT INTO items VALUES (" + Fmt.Int(i) + ", 'orig_" + Fmt.Int(i) + "', " + Fmt.Int(i * 10) + ")");
        i = i + 1;
    }

    // Update single row
    exec.executeSql("UPDATE items SET val = 'modified', score = 999 WHERE id = 5");
    // Update range
    exec.executeSql("UPDATE items SET score = 0 WHERE id >= 15");
    exec.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_update.vdb'");

    var r1 = exec2.executeSql("SELECT * FROM items WHERE id = 5");
    check("update: row 5 exists", r1.rowCount() == 1);

    // Verify row 5 val = 'modified' via WHERE clause (avoids BUG-FE-006 chain issue)
    var r1val = exec2.executeSql("SELECT * FROM items WHERE id = 5 AND val = 'modified'");
    check("update: row 5 val = modified", r1val.rowCount() == 1);

    // Verify row 5 score = 999 via WHERE clause
    var r1score = exec2.executeSql("SELECT * FROM items WHERE id = 5 AND score = 999");
    check("update: row 5 score = 999", r1score.rowCount() == 1);

    // Note: 6 rows have score=0: id=0 (initial 0*10=0) + ids 15-19 (SET score=0)
    var r2 = exec2.executeSql("SELECT * FROM items WHERE score = 0");
    check("update: 6 rows with score=0", r2.rowCount() == 6);

    var r3 = exec2.executeSql("SELECT * FROM items");
    check("update: 20 total rows", r3.rowCount() == 20);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_update.vdb");
}

//=============================================================================
// STRESS TEST 3: Incremental DELETE persistence
//=============================================================================

func stress3() {
    Terminal.Say("--- Stress 3: Incremental DELETE persistence ---");
    cleanup("/tmp/stress3_delete.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_delete.vdb'");
    exec.executeSql("CREATE TABLE data (id INTEGER PRIMARY KEY, cat TEXT)");
    var i = 0;
    while i < 30 {
        var cat = "even";
        if i % 2 == 1 { cat = "odd"; }
        exec.executeSql("INSERT INTO data VALUES (" + Fmt.Int(i) + ", '" + cat + "')");
        i = i + 1;
    }

    // Delete odd rows
    exec.executeSql("DELETE FROM data WHERE cat = 'odd'");

    var r1 = exec.executeSql("SELECT * FROM data");
    check("delete: 15 rows remain in-memory", r1.rowCount() == 15);

    exec.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_delete.vdb'");

    var r2 = exec2.executeSql("SELECT * FROM data");
    check("delete: 15 rows after reopen", r2.rowCount() == 15);

    var r3 = exec2.executeSql("SELECT * FROM data WHERE cat = 'odd'");
    check("delete: no odd rows", r3.rowCount() == 0);

    var r4 = exec2.executeSql("SELECT * FROM data WHERE id = 0");
    check("delete: id=0 still exists", r4.rowCount() == 1);

    var r5 = exec2.executeSql("SELECT * FROM data WHERE id = 28");
    check("delete: id=28 still exists", r5.rowCount() == 1);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_delete.vdb");
}

//=============================================================================
// STRESS TEST 4: Mixed INSERT/UPDATE/DELETE cycle
//=============================================================================

func stress4() {
    Terminal.Say("--- Stress 4: Mixed INSERT/UPDATE/DELETE cycle ---");
    cleanup("/tmp/stress3_mixed.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_mixed.vdb'");
    exec.executeSql("CREATE TABLE log (id INTEGER PRIMARY KEY, status TEXT, val INTEGER)");

    // Insert 20 rows
    var i = 0;
    while i < 20 {
        exec.executeSql("INSERT INTO log VALUES (" + Fmt.Int(i) + ", 'active', " + Fmt.Int(i) + ")");
        i = i + 1;
    }

    // Update first 8 to 'archived'
    exec.executeSql("UPDATE log SET status = 'archived' WHERE id < 8");

    // Delete archived rows
    exec.executeSql("DELETE FROM log WHERE status = 'archived'");

    // Insert 5 more
    i = 20;
    while i < 25 {
        exec.executeSql("INSERT INTO log VALUES (" + Fmt.Int(i) + ", 'active', " + Fmt.Int(i) + ")");
        i = i + 1;
    }

    var r1 = exec.executeSql("SELECT * FROM log");
    check("mixed: 17 rows in-memory", r1.rowCount() == 17);

    exec.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_mixed.vdb'");

    var r2 = exec2.executeSql("SELECT * FROM log");
    check("mixed: 17 rows after reopen", r2.rowCount() == 17);

    var r3 = exec2.executeSql("SELECT * FROM log WHERE status = 'archived'");
    check("mixed: no archived rows", r3.rowCount() == 0);

    var r4 = exec2.executeSql("SELECT * FROM log WHERE id = 22");
    check("mixed: new row id=22 exists", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_mixed.vdb");
}

//=============================================================================
// STRESS TEST 5: Large UPDATE (many rows updated)
//=============================================================================

func stress5() {
    Terminal.Say("--- Stress 5: Large UPDATE (30 rows) ---");
    cleanup("/tmp/stress3_bigupd.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_bigupd.vdb'");
    exec.executeSql("CREATE TABLE scores (id INTEGER PRIMARY KEY, val INTEGER)");

    var i = 0;
    while i < 30 {
        exec.executeSql("INSERT INTO scores VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i) + ")");
        i = i + 1;
    }

    // Update all rows
    exec.executeSql("UPDATE scores SET val = val + 1000");
    exec.executeSql("CLOSE");

    // Reopen
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_bigupd.vdb'");

    // Verify id=0 has val=1000 via WHERE clause
    var r1 = exec2.executeSql("SELECT * FROM scores WHERE id = 0 AND val = 1000");
    check("bigupd: id=0 val=1000", r1.rowCount() == 1);

    // Verify id=29 has val=1029 via WHERE clause
    var r2 = exec2.executeSql("SELECT * FROM scores WHERE id = 29 AND val = 1029");
    check("bigupd: id=29 val=1029", r2.rowCount() == 1);

    var r3 = exec2.executeSql("SELECT * FROM scores");
    check("bigupd: 30 rows remain", r3.rowCount() == 30);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_bigupd.vdb");
}

//=============================================================================
// STRESS TEST 6: Rapid open/close cycles
//=============================================================================

func stress6() {
    Terminal.Say("--- Stress 6: Rapid open/close cycles ---");
    cleanup("/tmp/stress3_cycles.vdb");

    // Create initial data
    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_cycles.vdb'");
    exec.executeSql("CREATE TABLE counter (id INTEGER PRIMARY KEY, val INTEGER)");
    exec.executeSql("INSERT INTO counter VALUES (1, 0)");
    exec.executeSql("CLOSE");

    // Open/update/close 10 times
    var cycle = 0;
    while cycle < 10 {
        var ex = new Executor();
        ex.init();
        ex.executeSql("OPEN '/tmp/stress3_cycles.vdb'");
        ex.executeSql("UPDATE counter SET val = " + Fmt.Int(cycle + 1) + " WHERE id = 1");
        ex.executeSql("CLOSE");
        cycle = cycle + 1;
    }

    // Final check - verify val = 10 via WHERE clause (avoids BUG-FE-006 chain issue)
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_cycles.vdb'");
    var r = exec2.executeSql("SELECT * FROM counter WHERE id = 1 AND val = 10");
    check("cycles: val = 10 after 10 cycles", r.rowCount() == 1);
    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_cycles.vdb");
}

//=============================================================================
// STRESS TEST 7: DELETE all then INSERT again
//=============================================================================

func stress7() {
    Terminal.Say("--- Stress 7: DELETE all then INSERT ---");
    cleanup("/tmp/stress3_delall.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_delall.vdb'");
    exec.executeSql("CREATE TABLE temp (id INTEGER PRIMARY KEY, val TEXT)");

    // Insert 10 rows
    var i = 0;
    while i < 10 {
        exec.executeSql("INSERT INTO temp VALUES (" + Fmt.Int(i) + ", 'v" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // Delete all
    exec.executeSql("DELETE FROM temp WHERE id >= 0");

    var r0 = exec.executeSql("SELECT * FROM temp");
    check("delall: 0 rows after delete", r0.rowCount() == 0);

    // Insert new rows
    i = 100;
    while i < 105 {
        exec.executeSql("INSERT INTO temp VALUES (" + Fmt.Int(i) + ", 'new_" + Fmt.Int(i) + "')");
        i = i + 1;
    }
    exec.executeSql("CLOSE");

    // Reopen
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_delall.vdb'");

    var r1 = exec2.executeSql("SELECT * FROM temp");
    check("delall: 5 rows after reopen", r1.rowCount() == 5);

    var r2 = exec2.executeSql("SELECT * FROM temp WHERE id = 103");
    check("delall: id=103 exists", r2.rowCount() == 1);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_delall.vdb");
}

//=============================================================================
// STRESS TEST 8: Multiple tables, mixed operations
//=============================================================================

func stress8() {
    Terminal.Say("--- Stress 8: Multi-table mixed ops ---");
    cleanup("/tmp/stress3_multi.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_multi.vdb'");

    exec.executeSql("CREATE TABLE t1 (id INTEGER PRIMARY KEY, val TEXT)");
    exec.executeSql("CREATE TABLE t2 (id INTEGER PRIMARY KEY, num INTEGER)");
    exec.executeSql("CREATE TABLE t3 (id INTEGER PRIMARY KEY, flag TEXT)");

    // Populate all tables
    var i = 0;
    while i < 10 {
        exec.executeSql("INSERT INTO t1 VALUES (" + Fmt.Int(i) + ", 'a" + Fmt.Int(i) + "')");
        exec.executeSql("INSERT INTO t2 VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i * 10) + ")");
        if i < 5 {
            exec.executeSql("INSERT INTO t3 VALUES (" + Fmt.Int(i) + ", 'yes')");
        } else {
            exec.executeSql("INSERT INTO t3 VALUES (" + Fmt.Int(i) + ", 'no')");
        }
        i = i + 1;
    }

    // Update t2
    exec.executeSql("UPDATE t2 SET num = -1 WHERE id < 3");

    // Delete from t3
    exec.executeSql("DELETE FROM t3 WHERE flag = 'no'");

    // Drop t1
    exec.executeSql("DROP TABLE t1");

    exec.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_multi.vdb'");

    // t1 should be gone
    var r1 = exec2.executeSql("SELECT * FROM t1");
    check("multi: t1 dropped", r1.success == false);

    // t2 should have 10 rows, 3 with num=-1
    var r2 = exec2.executeSql("SELECT * FROM t2");
    check("multi: t2 has 10 rows", r2.rowCount() == 10);

    var r2b = exec2.executeSql("SELECT * FROM t2 WHERE num = -1");
    check("multi: t2 has 3 updated rows", r2b.rowCount() == 3);

    // t3 should have 5 rows (only 'yes' rows)
    var r3 = exec2.executeSql("SELECT * FROM t3");
    check("multi: t3 has 5 rows", r3.rowCount() == 5);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_multi.vdb");
}

//=============================================================================
// STRESS TEST 9: Text data with special characters
//=============================================================================

func stress9() {
    Terminal.Say("--- Stress 9: Text with special chars ---");
    cleanup("/tmp/stress3_text.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/stress3_text.vdb'");
    exec.executeSql("CREATE TABLE texts (id INTEGER PRIMARY KEY, content TEXT)");

    exec.executeSql("INSERT INTO texts VALUES (1, 'hello world')");
    exec.executeSql("INSERT INTO texts VALUES (2, 'line1')");
    exec.executeSql("INSERT INTO texts VALUES (3, '')");
    exec.executeSql("INSERT INTO texts VALUES (4, 'a longer string with many words in it to test buffer handling')");
    exec.executeSql("INSERT INTO texts VALUES (5, '12345')");
    exec.executeSql("CLOSE");

    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_text.vdb'");

    // Verify text values via WHERE clause (avoids BUG-FE-006 chain issue)
    var r1 = exec2.executeSql("SELECT * FROM texts WHERE id = 1 AND content = 'hello world'");
    check("text: hello world", r1.rowCount() == 1);

    var r3 = exec2.executeSql("SELECT * FROM texts WHERE id = 3 AND content = ''");
    check("text: empty string", r3.rowCount() == 1);

    // For long string, just verify the row exists (cannot easily check length via WHERE)
    var r4 = exec2.executeSql("SELECT * FROM texts WHERE id = 4 AND content = 'a longer string with many words in it to test buffer handling'");
    check("text: long string", r4.rowCount() == 1);

    var r5 = exec2.executeSql("SELECT * FROM texts");
    check("text: 5 rows", r5.rowCount() == 5);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_text.vdb");
}

//=============================================================================
// STRESS TEST 10: CREATE DATABASE FILE + USE + DML + reopen
//=============================================================================

func stress10() {
    Terminal.Say("--- Stress 10: CREATE DATABASE FILE round-trip ---");
    cleanup("/tmp/stress3_createdb.vdb");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE DATABASE mydb FILE '/tmp/stress3_createdb.vdb'");
    exec.executeSql("USE mydb");
    exec.executeSql("CREATE TABLE kv (k TEXT, v INTEGER)");
    exec.executeSql("INSERT INTO kv VALUES ('alpha', 1)");
    exec.executeSql("INSERT INTO kv VALUES ('beta', 2)");
    exec.executeSql("INSERT INTO kv VALUES ('gamma', 3)");

    // Update one
    exec.executeSql("UPDATE kv SET v = 99 WHERE k = 'beta'");
    exec.executeSql("CLOSE");

    // Use new executor to reopen via OPEN
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/stress3_createdb.vdb'");

    var r1 = exec2.executeSql("SELECT * FROM kv");
    check("createdb: 3 rows", r1.rowCount() == 3);

    // Verify beta has v=99 via WHERE clause (avoids BUG-FE-006 chain issue)
    var r2 = exec2.executeSql("SELECT * FROM kv WHERE k = 'beta' AND v = 99");
    check("createdb: beta v=99", r2.rowCount() == 1);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/stress3_createdb.vdb");
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Phase 3-5 Stress Tests ===");
    Terminal.Say("");

    stress1();
    stress2();
    stress3();
    stress4();
    stress5();
    stress6();
    stress7();
    stress8();
    stress9();
    stress10();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    } else {
        Terminal.Say("SOME TESTS FAILED");
    }
}
