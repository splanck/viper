// test_storage.zia - Tests for Phase 2: Binary Storage Engine
// Part of ViperSQL - Production Database Server

module test_storage;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./storage/page";
bind "./storage/serializer";
bind "./storage/pager";
bind "./storage/buffer";
bind "./storage/data_page";
bind "./storage/schema_page";
bind "./types";
bind "./table";
bind "./schema";

//=============================================================================
// TEST UTILITIES
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func assertTrue(cond: Boolean, desc: String) {
    if cond {
        Terminal.Say("  PASS: " + desc);
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + desc);
        failed = failed + 1;
    }
}

func assertFalse(cond: Boolean, desc: String) {
    assertTrue(cond == false, desc);
}

//=============================================================================
// TESTS
//=============================================================================

func testBinaryBuffer() {
    Terminal.Say("Testing BinaryBuffer...");

    var buf = new BinaryBuffer();
    buf.init();

    // Test byte write/read
    buf.writeByte(42);
    buf.writeByte(255);
    buf.resetPosition();
    assertTrue(buf.readByte() == 42, "Read byte 42");
    assertTrue(buf.readByte() == 255, "Read byte 255");

    // Test int16 write/read
    buf = new BinaryBuffer();
    buf.init();
    buf.writeInt16(1234);
    buf.resetPosition();
    assertTrue(buf.readInt16() == 1234, "Read int16 1234");

    // Test int32 write/read
    buf = new BinaryBuffer();
    buf.init();
    buf.writeInt32(123456789);
    buf.resetPosition();
    assertTrue(buf.readInt32() == 123456789, "Read int32 123456789");

    // Test string write/read
    buf = new BinaryBuffer();
    buf.init();
    buf.writeString("Hello, World!");
    buf.resetPosition();
    assertTrue(buf.readString() == "Hello, World!", "Read string 'Hello, World!'");
}

func testValueSerializer() {
    Terminal.Say("Testing ValueSerializer...");

    var ser = new ValueSerializer();
    ser.init();
    var buf = new BinaryBuffer();
    buf.init();

    // Test NULL
    ser.serializeValue(sqlNull(), buf);
    buf.resetPosition();
    var val = ser.deserializeValue(buf);
    assertTrue(val.kind == SQL_NULL, "Deserialize NULL");

    // Test INTEGER
    buf = new BinaryBuffer();
    buf.init();
    ser.serializeValue(sqlInteger(42), buf);
    buf.resetPosition();
    val = ser.deserializeValue(buf);
    assertTrue(val.kind == SQL_INTEGER, "Deserialize INTEGER type");
    assertTrue(val.intValue == 42, "Deserialize INTEGER value 42");

    // Test TEXT
    buf = new BinaryBuffer();
    buf.init();
    ser.serializeValue(sqlText("Hello"), buf);
    buf.resetPosition();
    val = ser.deserializeValue(buf);
    assertTrue(val.kind == SQL_TEXT, "Deserialize TEXT type");
    assertTrue(val.textValue == "Hello", "Deserialize TEXT value 'Hello'");
}

func testRowSerializer() {
    Terminal.Say("Testing RowSerializer...");

    var ser = new RowSerializer();
    ser.init();
    var buf = new BinaryBuffer();
    buf.init();

    // Create a row
    var row = new Row();
    row.init();
    row.addValue(sqlInteger(1));
    row.addValue(sqlText("Alice"));
    row.addValue(sqlNull());

    // Serialize
    ser.serializeRow(row, buf);

    // Deserialize
    buf.resetPosition();
    var row2 = ser.deserializeRow(buf);

    assertTrue(row2.columnCount() == 3, "Row has 3 columns");
    assertTrue(row2.getValue(0).intValue == 1, "Column 0 = 1");
    assertTrue(row2.getValue(1).textValue == "Alice", "Column 1 = 'Alice'");
    assertTrue(row2.getValue(2).kind == SQL_NULL, "Column 2 = NULL");
}

func testPagerCreateOpen() {
    Terminal.Say("Testing Pager create/open...");

    var pager = new Pager();
    pager.init();

    // Create new database
    var filename = "/tmp/test_vipersql.db";
    assertTrue(pager.createDatabase(filename), "Create database");
    assertTrue(pager.isOpen, "Database is open after create");
    assertTrue(pager.pageCount == 2, "Initial page count is 2 (header + schema)");

    pager.closeDatabase();

    // Reopen database
    pager = new Pager();
    pager.init();
    assertTrue(pager.openDatabase(filename), "Open database");
    assertTrue(pager.isOpen, "Database is open after open");
    assertTrue(pager.pageCount == 2, "Page count preserved after reopen");

    pager.closeDatabase();
}

func testPageAllocation() {
    Terminal.Say("Testing page allocation...");

    var pager = new Pager();
    pager.init();

    var filename = "/tmp/test_vipersql_alloc.db";
    pager.createDatabase(filename);

    var initialCount = pager.pageCount;
    var newPageId = pager.allocatePage();
    assertTrue(newPageId == initialCount, "New page ID equals initial count");
    assertTrue(pager.pageCount == initialCount + 1, "Page count increased");

    pager.closeDatabase();
}

func testBufferPool() {
    Terminal.Say("Testing BufferPool...");

    var pool = new BufferPool();
    pool.init();

    var filename = "/tmp/test_vipersql_buffer.db";
    assertTrue(pool.createDatabase(filename), "Create database via buffer pool");

    // Create a new page
    var page = pool.newPage(PAGE_TYPE_DATA);
    assertTrue(page.pageId >= 0, "New page has valid ID");
    assertTrue(page.pageType == PAGE_TYPE_DATA, "New page has correct type");

    var pageId = page.pageId;
    pool.unpinPage(pageId, true);

    // Fetch the page back
    var maybePage = pool.fetchPage(pageId);
    assertTrue(maybePage != null, "Can fetch page from pool");
    if maybePage != null {
        var p = maybePage;
        assertTrue(p.pageId == pageId, "Fetched page has correct ID");
        pool.unpinPage(pageId, false);
    }

    pool.closeDatabase();
}

func testDataPage() {
    Terminal.Say("Testing DataPage operations...");

    var mgr = new DataPageManager();
    mgr.init();

    // Create a test page
    var page = new Page();
    page.init();
    mgr.initDataPage(page, 1);

    // Insert rows
    var row1 = new Row();
    row1.init();
    row1.addValue(sqlInteger(1));
    row1.addValue(sqlText("Alice"));

    var row2 = new Row();
    row2.init();
    row2.addValue(sqlInteger(2));
    row2.addValue(sqlText("Bob"));

    var slot1 = mgr.insertRow(page, row1);
    var slot2 = mgr.insertRow(page, row2);

    assertTrue(slot1 == 0, "First row in slot 0");
    assertTrue(slot2 == 1, "Second row in slot 1");
    assertTrue(mgr.getRowCount(page) == 2, "Row count is 2");

    // Read rows back
    var maybeRow1 = mgr.readRow(page, 0);
    assertTrue(maybeRow1 != null, "Can read row 0");
    if maybeRow1 != null {
        var r = maybeRow1;
        assertTrue(r.getValue(0).intValue == 1, "Row 0 col 0 = 1");
        assertTrue(r.getValue(1).textValue == "Alice", "Row 0 col 1 = 'Alice'");
    }

    // Delete a row
    assertTrue(mgr.deleteRow(page, 0), "Delete row 0");
    var maybeDeleted = mgr.readRow(page, 0);
    assertTrue(maybeDeleted == null, "Deleted row returns null");

    // Compact and verify
    mgr.compactPage(page);
    assertTrue(mgr.getRowCount(page) == 1, "After compact, row count is 1");
}

func testSchemaPage() {
    Terminal.Say("Testing SchemaPage operations...");

    var mgr = new SchemaPageManager();
    mgr.init();

    // Create a test page
    var page = new Page();
    page.init();
    mgr.initSchemaPage(page);

    // Create table metadata
    var table = new Table();
    table.initWithName("users");

    var col1 = new Column();
    col1.initWithName("id", SQL_INTEGER);
    col1.primaryKey = true;
    table.addColumn(col1);

    var col2 = new Column();
    col2.initWithName("name", SQL_TEXT);
    table.addColumn(col2);

    var meta = new TableMeta();
    meta.initFromTable(0, table);

    // Add table to schema
    assertTrue(mgr.addTable(page, meta), "Add table to schema");
    assertTrue(mgr.getTableCount(page) == 1, "Schema has 1 table");

    // Find table
    var maybeMeta = mgr.findTable(page, "users");
    assertTrue(maybeMeta != null, "Find table by name");
    if maybeMeta != null {
        var m = maybeMeta;
        assertTrue(m.tableName == "users", "Table name is 'users'");
        assertTrue(m.columnCount == 2, "Table has 2 columns");
    }

    // Remove table
    assertTrue(mgr.removeTable(page, "users"), "Remove table");
    assertTrue(mgr.getTableCount(page) == 0, "Schema has 0 tables after remove");
}

func testEndToEnd() {
    Terminal.Say("Testing end-to-end storage...");

    var pool = new BufferPool();
    pool.init();

    var filename = "/tmp/test_vipersql_e2e.db";
    pool.createDatabase(filename);

    // Get schema page
    var schemaPageId = pool.getSchemaPageId();
    var maybeSchemaPg = pool.fetchPage(schemaPageId);
    assertTrue(maybeSchemaPg != null, "Can fetch schema page");

    if maybeSchemaPg != null {
        var schemaPg = maybeSchemaPg;
        var schemaMgr = new SchemaPageManager();
        schemaMgr.init();

        // Create a table in schema
        var table = new Table();
        table.initWithName("products");

        var col1 = new Column();
        col1.initWithName("id", SQL_INTEGER);
        table.addColumn(col1);

        var col2 = new Column();
        col2.initWithName("name", SQL_TEXT);
        table.addColumn(col2);

        var meta = new TableMeta();
        meta.initFromTable(0, table);

        // Create a data page for the table
        var dataPage = pool.newPage(PAGE_TYPE_DATA);
        meta.firstDataPage = dataPage.pageId;

        var dataMgr = new DataPageManager();
        dataMgr.init();
        dataMgr.initDataPage(dataPage, meta.tableId);

        // Insert some rows
        var row1 = new Row();
        row1.init();
        row1.addValue(sqlInteger(1));
        row1.addValue(sqlText("Apple"));
        dataMgr.insertRow(dataPage, row1);

        var row2 = new Row();
        row2.init();
        row2.addValue(sqlInteger(2));
        row2.addValue(sqlText("Banana"));
        dataMgr.insertRow(dataPage, row2);

        meta.rowCount = 2;
        pool.unpinPage(dataPage.pageId, true);

        // Add table to schema
        schemaMgr.addTable(schemaPg, meta);
        pool.unpinPage(schemaPageId, true);
    }

    // Close and reopen
    pool.closeDatabase();

    pool = new BufferPool();
    pool.init();
    assertTrue(pool.openDatabase(filename), "Reopen database");

    // Verify data persisted
    schemaPageId = pool.getSchemaPageId();
    maybeSchemaPg = pool.fetchPage(schemaPageId);
    if maybeSchemaPg != null {
        var schemaPg = maybeSchemaPg;
        var schemaMgr = new SchemaPageManager();
        schemaMgr.init();

        var maybeMeta = schemaMgr.findTable(schemaPg, "products");
        assertTrue(maybeMeta != null, "Table persisted after reopen");

        if maybeMeta != null {
            var m = maybeMeta;
            assertTrue(m.rowCount == 2, "Row count persisted");

            // Read data page
            var maybeDataPg = pool.fetchPage(m.firstDataPage);
            if maybeDataPg != null {
                var dataPg = maybeDataPg;
                var dataMgr = new DataPageManager();
                dataMgr.init();

                assertTrue(dataMgr.getRowCount(dataPg) == 2, "Data page has 2 rows");

                var maybeRow = dataMgr.readRow(dataPg, 0);
                if maybeRow != null {
                    var r = maybeRow;
                    assertTrue(r.getValue(0).intValue == 1, "First row id = 1");
                    assertTrue(r.getValue(1).textValue == "Apple", "First row name = 'Apple'");
                }

                pool.unpinPage(dataPg.pageId, false);
            }
        }

        pool.unpinPage(schemaPageId, false);
    }

    pool.closeDatabase();
}

//=============================================================================
// MAIN
//=============================================================================

func start() {
    Terminal.Say("=== Phase 2: Binary Storage Engine Tests ===");
    Terminal.Say("");

    testBinaryBuffer();
    testValueSerializer();
    testRowSerializer();
    testPagerCreateOpen();
    testPageAllocation();
    testBufferPool();
    testDataPage();
    testSchemaPage();
    testEndToEnd();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
}
