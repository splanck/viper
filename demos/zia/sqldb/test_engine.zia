// Test StorageEngine adapter entity
module test_engine;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind IO = Viper.IO;

bind "./storage/page";
bind "./storage/serializer";
bind "./storage/pager";
bind "./storage/buffer";
bind "./storage/schema_page";
bind "./storage/data_page";
bind "./storage/engine";
bind "./types";
bind "./table";
bind "./schema";

Integer passed = 0;
Integer failed = 0;

func assert(cond: Boolean, msg: String) {
    if cond {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

func main() {
    Terminal.Say("=== StorageEngine Test Suite ===");

    var dbPath = "/tmp/test_engine_io.vdb";

    //=====================================================================
    // Test 1: Create and close database
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 1: Create and close database ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine = new StorageEngine();
    engine.init();
    var ok = engine.createDatabase(dbPath);
    assert(ok, "createDatabase succeeds");
    assert(IO.File.Exists(dbPath), "database file exists");
    assert(engine.isPersistent, "engine is persistent");

    engine.closeDatabase();
    assert(engine.isPersistent == false, "engine closed");

    //=====================================================================
    // Test 2: Reopen database
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 2: Reopen database ---");

    var engine2 = new StorageEngine();
    engine2.init();
    var ok2 = engine2.openDatabase(dbPath);
    assert(ok2, "openDatabase succeeds");
    assert(engine2.isPersistent, "engine2 is persistent");
    engine2.closeDatabase();

    //=====================================================================
    // Test 3: Persist table schema
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 3: Persist table schema ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine3 = new StorageEngine();
    engine3.init();
    engine3.createDatabase(dbPath);

    // Create a table with columns
    var col1 = new Column();
    col1.initWithName("id", SQL_INTEGER);
    col1.primaryKey = true;
    col1.autoIncrement = true;

    var col2 = new Column();
    col2.initWithName("name", SQL_TEXT);
    col2.notNull = true;

    var col3 = new Column();
    col3.initWithName("score", SQL_REAL);

    var table = new Table();
    table.initWithName("users");
    table.addColumn(col1);
    table.addColumn(col2);
    table.addColumn(col3);

    var tableId = engine3.persistTable(table);
    assert(tableId > 0, "persistTable returns valid ID (got " + Fmt.Int(tableId) + ")");

    engine3.closeDatabase();

    // Reopen and verify schema persisted
    var engine4 = new StorageEngine();
    engine4.init();
    engine4.openDatabase(dbPath);

    var tables = engine4.loadAllTables();
    assert(tables.count() == 1, "1 table after reopen (got " + Fmt.Int(tables.count()) + ")");

    if tables.count() > 0 {
        var t = tables.get(0);
        assert(t.name == "users", "table name == users (got " + t.name + ")");
        assert(t.columnCount() == 3, "3 columns (got " + Fmt.Int(t.columnCount()) + ")");

        var c1 = t.getColumn(0);
        if c1 != null {
            var cc1 = c1;
            assert(cc1.name == "id", "col0 name == id");
            assert(cc1.typeCode == SQL_INTEGER, "col0 type == INTEGER");
            assert(cc1.primaryKey, "col0 is primary key");
            assert(cc1.autoIncrement, "col0 is autoIncrement");
        } else {
            assert(false, "col0 should not be null");
        }

        var c2 = t.getColumn(1);
        if c2 != null {
            var cc2 = c2;
            assert(cc2.name == "name", "col1 name == name");
            assert(cc2.typeCode == SQL_TEXT, "col1 type == TEXT");
            assert(cc2.notNull, "col1 is notNull");
        } else {
            assert(false, "col1 should not be null");
        }

        var c3 = t.getColumn(2);
        if c3 != null {
            var cc3 = c3;
            assert(cc3.name == "score", "col2 name == score");
            assert(cc3.typeCode == SQL_REAL, "col2 type == REAL");
        } else {
            assert(false, "col2 should not be null");
        }
    }

    engine4.closeDatabase();

    //=====================================================================
    // Test 4: Insert and reload rows
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 4: Insert and reload rows ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine5 = new StorageEngine();
    engine5.init();
    engine5.createDatabase(dbPath);

    // Create table
    var colA = new Column();
    colA.initWithName("id", SQL_INTEGER);
    var colB = new Column();
    colB.initWithName("name", SQL_TEXT);

    var tblPeople = new Table();
    tblPeople.initWithName("people");
    tblPeople.addColumn(colA);
    tblPeople.addColumn(colB);

    engine5.persistTable(tblPeople);

    // Insert rows
    var row1 = new Row();
    row1.init();
    row1.addValue(sqlInteger(1));
    row1.addValue(sqlText("Alice"));

    var row2 = new Row();
    row2.init();
    row2.addValue(sqlInteger(2));
    row2.addValue(sqlText("Bob"));

    var row3 = new Row();
    row3.init();
    row3.addValue(sqlInteger(3));
    row3.addValue(sqlText("Charlie"));

    var ins1 = engine5.insertRowStorage("people", row1);
    assert(ins1, "insert row 1");
    var ins2 = engine5.insertRowStorage("people", row2);
    assert(ins2, "insert row 2");
    var ins3 = engine5.insertRowStorage("people", row3);
    assert(ins3, "insert row 3");

    engine5.closeDatabase();

    // Reopen and verify rows
    var engine6 = new StorageEngine();
    engine6.init();
    engine6.openDatabase(dbPath);

    var tables2 = engine6.loadAllTables();
    assert(tables2.count() == 1, "1 table after row insert reopen");

    if tables2.count() > 0 {
        var tt = tables2.get(0);
        assert(tt.rowCount() == 3, "3 rows after reopen (got " + Fmt.Int(tt.rowCount()) + ")");

        if tt.rowCount() >= 3 {
            var r1 = tt.getRow(0);
            if r1 != null {
                var rr1 = r1;
                var v1 = rr1.getValue(0);
                var v2 = rr1.getValue(1);
                assert(v1.intValue == 1, "row0 id == 1 (got " + Fmt.Int(v1.intValue) + ")");
                assert(v2.textValue == "Alice", "row0 name == Alice (got " + v2.textValue + ")");
            }

            var r3 = tt.getRow(2);
            if r3 != null {
                var rr3 = r3;
                var v5 = rr3.getValue(0);
                var v6 = rr3.getValue(1);
                assert(v5.intValue == 3, "row2 id == 3 (got " + Fmt.Int(v5.intValue) + ")");
                assert(v6.textValue == "Charlie", "row2 name == Charlie (got " + v6.textValue + ")");
            }
        }
    }

    engine6.closeDatabase();

    //=====================================================================
    // Test 5: Rewrite rows (UPDATE/DELETE simulation)
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 5: Rewrite rows (UPDATE/DELETE) ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine7 = new StorageEngine();
    engine7.init();
    engine7.createDatabase(dbPath);

    var colX = new Column();
    colX.initWithName("val", SQL_INTEGER);
    var tblNums = new Table();
    tblNums.initWithName("nums");
    tblNums.addColumn(colX);
    engine7.persistTable(tblNums);

    // Insert 5 rows
    var ri = 0;
    while ri < 5 {
        var r = new Row();
        r.init();
        r.addValue(sqlInteger(ri * 10));
        engine7.insertRowStorage("nums", r);
        ri = ri + 1;
    }

    // Rewrite with only 3 rows (simulating DELETE of rows 1 and 3)
    var newRows: List[Row] = [];
    var nr0 = new Row();
    nr0.init();
    nr0.addValue(sqlInteger(0));
    newRows.add(nr0);
    var nr1 = new Row();
    nr1.init();
    nr1.addValue(sqlInteger(20));
    newRows.add(nr1);
    var nr2 = new Row();
    nr2.init();
    nr2.addValue(sqlInteger(40));
    newRows.add(nr2);

    var rw = engine7.rewriteTableRows("nums", newRows);
    assert(rw, "rewriteTableRows succeeds");

    engine7.closeDatabase();

    // Reopen and verify
    var engine8 = new StorageEngine();
    engine8.init();
    engine8.openDatabase(dbPath);

    var tables3 = engine8.loadAllTables();
    if tables3.count() > 0 {
        var tNums = tables3.get(0);
        assert(tNums.rowCount() == 3, "3 rows after rewrite (got " + Fmt.Int(tNums.rowCount()) + ")");

        if tNums.rowCount() >= 3 {
            var rv0 = tNums.getRow(0);
            var rv2 = tNums.getRow(2);
            if rv0 != null && rv2 != null {
                var rrv0 = rv0;
                var rrv2 = rv2;
                assert(rrv0.getValue(0).intValue == 0, "row0 val == 0");
                assert(rrv2.getValue(0).intValue == 40, "row2 val == 40");
            }
        }
    }

    engine8.closeDatabase();

    //=====================================================================
    // Test 6: Multiple tables
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 6: Multiple tables ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine9 = new StorageEngine();
    engine9.init();
    engine9.createDatabase(dbPath);

    // Table 1: items
    var cItem1 = new Column();
    cItem1.initWithName("id", SQL_INTEGER);
    var cItem2 = new Column();
    cItem2.initWithName("desc", SQL_TEXT);
    var tblItems = new Table();
    tblItems.initWithName("items");
    tblItems.addColumn(cItem1);
    tblItems.addColumn(cItem2);
    engine9.persistTable(tblItems);

    // Table 2: prices
    var cPrice1 = new Column();
    cPrice1.initWithName("item_id", SQL_INTEGER);
    var cPrice2 = new Column();
    cPrice2.initWithName("price", SQL_REAL);
    var tblPrices = new Table();
    tblPrices.initWithName("prices");
    tblPrices.addColumn(cPrice1);
    tblPrices.addColumn(cPrice2);
    engine9.persistTable(tblPrices);

    // Insert into items
    var irow1 = new Row();
    irow1.init();
    irow1.addValue(sqlInteger(100));
    irow1.addValue(sqlText("Widget"));
    engine9.insertRowStorage("items", irow1);

    var irow2 = new Row();
    irow2.init();
    irow2.addValue(sqlInteger(200));
    irow2.addValue(sqlText("Gadget"));
    engine9.insertRowStorage("items", irow2);

    // Insert into prices
    var prow1 = new Row();
    prow1.init();
    prow1.addValue(sqlInteger(100));
    prow1.addValue(sqlReal(9.99, "9.99"));
    engine9.insertRowStorage("prices", prow1);

    engine9.closeDatabase();

    // Reopen and verify both tables
    var engine10 = new StorageEngine();
    engine10.init();
    engine10.openDatabase(dbPath);

    var tables4 = engine10.loadAllTables();
    assert(tables4.count() == 2, "2 tables after reopen (got " + Fmt.Int(tables4.count()) + ")");

    if tables4.count() >= 2 {
        var tItems = tables4.get(0);
        var tPrices = tables4.get(1);

        assert(tItems.name == "items", "table0 == items (got " + tItems.name + ")");
        assert(tPrices.name == "prices", "table1 == prices (got " + tPrices.name + ")");

        assert(tItems.rowCount() == 2, "items has 2 rows (got " + Fmt.Int(tItems.rowCount()) + ")");
        assert(tPrices.rowCount() == 1, "prices has 1 row (got " + Fmt.Int(tPrices.rowCount()) + ")");

        // Check items data
        if tItems.rowCount() >= 2 {
            var ir1 = tItems.getRow(0);
            if ir1 != null {
                var iir1 = ir1;
                assert(iir1.getValue(1).textValue == "Widget", "items row0 desc == Widget");
            }
            var ir2 = tItems.getRow(1);
            if ir2 != null {
                var iir2 = ir2;
                assert(iir2.getValue(1).textValue == "Gadget", "items row1 desc == Gadget");
            }
        }

        // Check prices data
        if tPrices.rowCount() >= 1 {
            var pr1 = tPrices.getRow(0);
            if pr1 != null {
                var ppr1 = pr1;
                assert(ppr1.getValue(0).intValue == 100, "prices row0 item_id == 100");
                assert(ppr1.getValue(1).textValue == "9.99", "prices row0 price text == 9.99");
            }
        }
    }

    engine10.closeDatabase();

    //=====================================================================
    // Test 7: Drop table
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 7: Drop table ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine11 = new StorageEngine();
    engine11.init();
    engine11.createDatabase(dbPath);

    // Create two tables
    var cdrop1 = new Column();
    cdrop1.initWithName("x", SQL_INTEGER);
    var tblA = new Table();
    tblA.initWithName("alpha");
    tblA.addColumn(cdrop1);
    engine11.persistTable(tblA);

    var cdrop2 = new Column();
    cdrop2.initWithName("y", SQL_TEXT);
    var tblB = new Table();
    tblB.initWithName("beta");
    tblB.addColumn(cdrop2);
    engine11.persistTable(tblB);

    // Insert into both
    var dr1 = new Row();
    dr1.init();
    dr1.addValue(sqlInteger(99));
    engine11.insertRowStorage("alpha", dr1);

    var dr2 = new Row();
    dr2.init();
    dr2.addValue(sqlText("hello"));
    engine11.insertRowStorage("beta", dr2);

    // Drop alpha
    var dropped = engine11.dropTableStorage("alpha");
    assert(dropped, "dropTableStorage alpha succeeds");

    engine11.closeDatabase();

    // Reopen and verify only beta remains
    var engine12 = new StorageEngine();
    engine12.init();
    engine12.openDatabase(dbPath);

    var tables5 = engine12.loadAllTables();
    assert(tables5.count() == 1, "1 table after drop (got " + Fmt.Int(tables5.count()) + ")");

    if tables5.count() > 0 {
        var tBeta = tables5.get(0);
        assert(tBeta.name == "beta", "remaining table == beta (got " + tBeta.name + ")");
        assert(tBeta.rowCount() == 1, "beta has 1 row");
        if tBeta.rowCount() > 0 {
            var brow = tBeta.getRow(0);
            if brow != null {
                var bbrow = brow;
                assert(bbrow.getValue(0).textValue == "hello", "beta row0 == hello");
            }
        }
    }

    engine12.closeDatabase();

    //=====================================================================
    // Test 8: NULL values
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 8: NULL values ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine13 = new StorageEngine();
    engine13.init();
    engine13.createDatabase(dbPath);

    var cnull1 = new Column();
    cnull1.initWithName("a", SQL_INTEGER);
    var cnull2 = new Column();
    cnull2.initWithName("b", SQL_TEXT);
    var tblNull = new Table();
    tblNull.initWithName("nullable");
    tblNull.addColumn(cnull1);
    tblNull.addColumn(cnull2);
    engine13.persistTable(tblNull);

    // Row with NULL second column
    var nrow = new Row();
    nrow.init();
    nrow.addValue(sqlInteger(42));
    nrow.addValue(sqlNull());
    engine13.insertRowStorage("nullable", nrow);

    // Row with NULL first column
    var nrow2 = new Row();
    nrow2.init();
    nrow2.addValue(sqlNull());
    nrow2.addValue(sqlText("world"));
    engine13.insertRowStorage("nullable", nrow2);

    engine13.closeDatabase();

    // Reopen and verify NULLs
    var engine14 = new StorageEngine();
    engine14.init();
    engine14.openDatabase(dbPath);

    var tables6 = engine14.loadAllTables();
    if tables6.count() > 0 {
        var tNull = tables6.get(0);
        assert(tNull.rowCount() == 2, "nullable has 2 rows");

        if tNull.rowCount() >= 2 {
            var nr1v = tNull.getRow(0);
            if nr1v != null {
                var nnr1 = nr1v;
                assert(nnr1.getValue(0).kind == SQL_INTEGER, "row0 col0 is INTEGER");
                assert(nnr1.getValue(0).intValue == 42, "row0 col0 == 42");
                assert(nnr1.getValue(1).kind == SQL_NULL, "row0 col1 is NULL");
            }

            var nr2v = tNull.getRow(1);
            if nr2v != null {
                var nnr2 = nr2v;
                assert(nnr2.getValue(0).kind == SQL_NULL, "row1 col0 is NULL");
                assert(nnr2.getValue(1).kind == SQL_TEXT, "row1 col1 is TEXT");
                assert(nnr2.getValue(1).textValue == "world", "row1 col1 == world");
            }
        }
    }

    engine14.closeDatabase();

    //=====================================================================
    // Test 9: AutoIncrement tracking
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("--- Test 9: AutoIncrement tracking ---");

    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    var engine15 = new StorageEngine();
    engine15.init();
    engine15.createDatabase(dbPath);

    var cai = new Column();
    cai.initWithName("id", SQL_INTEGER);
    cai.autoIncrement = true;
    var tblAi = new Table();
    tblAi.initWithName("autoinc");
    tblAi.addColumn(cai);
    engine15.persistTable(tblAi);

    // Simulate autoincrement reaching value 5
    engine15.updateAutoIncrement("autoinc", 5);

    engine15.closeDatabase();

    // Reopen and verify autoincrement value
    var engine16 = new StorageEngine();
    engine16.init();
    engine16.openDatabase(dbPath);

    var tables7 = engine16.loadAllTables();
    if tables7.count() > 0 {
        var tAi = tables7.get(0);
        assert(tAi.autoIncrementValue == 5, "autoIncrement == 5 (got " + Fmt.Int(tAi.autoIncrementValue) + ")");
    }

    engine16.closeDatabase();

    //=====================================================================
    // Summary
    //=====================================================================
    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));

    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    }
}
