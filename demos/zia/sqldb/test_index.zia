// test_index.viper - Test index-based lookups
module test_index;

bind Viper.Terminal;
bind Viper.Fmt;

bind "./executor";

Integer passed = 0;
Integer failed = 0;

func assert(condition: Boolean, msg: String) {
    if condition {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

func main() {
    var exec = new Executor();
    exec.init();

    Terminal.Say("=== Index Lookup Tests ===");
    Terminal.Say("");

    // Create table with data
    exec.executeSql("CREATE TABLE users (id INTEGER, name TEXT, email TEXT)");
    exec.executeSql("INSERT INTO users VALUES (1, 'Alice', 'alice@example.com')");
    exec.executeSql("INSERT INTO users VALUES (2, 'Bob', 'bob@example.com')");
    exec.executeSql("INSERT INTO users VALUES (3, 'Charlie', 'charlie@example.com')");
    exec.executeSql("INSERT INTO users VALUES (4, 'Diana', 'diana@example.com')");
    exec.executeSql("INSERT INTO users VALUES (5, 'Eve', 'eve@example.com')");

    // Create index on name column
    Terminal.Say("Testing CREATE INDEX...");
    var r1 = exec.executeSql("CREATE INDEX idx_name ON users(name)");
    assert(r1.success, "CREATE INDEX should succeed");

    // Test that queries work correctly with index
    Terminal.Say("Testing indexed lookup...");
    var r2 = exec.executeSql("SELECT * FROM users WHERE name = 'Charlie'");
    assert(r2.success, "SELECT with indexed column should work");
    assert(r2.rowCount() == 1, "Should return 1 row for Charlie");

    // Check the actual values
    if r2.rowCount() == 1 {
        var row = r2.getRow(0);
        if row != null {
            var r = row;
            var id = r.getValue(0);
            assert(id.intValue == 3, "Charlie should have id=3");
        }
    }

    // Test lookup on non-indexed column still works (linear scan)
    Terminal.Say("Testing non-indexed lookup...");
    var r3 = exec.executeSql("SELECT * FROM users WHERE id = 4");
    assert(r3.success, "SELECT without index should work");
    assert(r3.rowCount() == 1, "Should return 1 row for id=4");

    // Create index on id and test it
    Terminal.Say("Testing second index...");
    var r4 = exec.executeSql("CREATE INDEX idx_id ON users(id)");
    assert(r4.success, "CREATE INDEX on id should succeed");

    var r5 = exec.executeSql("SELECT name FROM users WHERE id = 2");
    assert(r5.success, "SELECT with id index should work");
    assert(r5.rowCount() == 1, "Should return 1 row for id=2");

    // Insert a new row and verify index is updated
    Terminal.Say("Testing index update after INSERT...");
    exec.executeSql("INSERT INTO users VALUES (6, 'Frank', 'frank@example.com')");
    var r6 = exec.executeSql("SELECT * FROM users WHERE name = 'Frank'");
    assert(r6.success, "SELECT for new row should work");
    assert(r6.rowCount() == 1, "Should find newly inserted row via index");

    // Test lookup for non-existent value
    Terminal.Say("Testing lookup for non-existent value...");
    var r7 = exec.executeSql("SELECT * FROM users WHERE name = 'Zoe'");
    assert(r7.success, "SELECT for non-existent should succeed");
    assert(r7.rowCount() == 0, "Should return 0 rows for non-existent value");

    // Test UNIQUE index
    Terminal.Say("Testing UNIQUE INDEX...");
    exec.executeSql("CREATE TABLE emails (id INTEGER, addr TEXT)");
    var r8 = exec.executeSql("CREATE UNIQUE INDEX idx_email ON emails(addr)");
    assert(r8.success, "CREATE UNIQUE INDEX should succeed");

    exec.executeSql("INSERT INTO emails VALUES (1, 'test@example.com')");
    var r9 = exec.executeSql("SELECT * FROM emails WHERE addr = 'test@example.com'");
    assert(r9.success, "SELECT with unique index should work");
    assert(r9.rowCount() == 1, "Should return exactly 1 row");

    // Print results
    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
}
