// test_multidb.zia - Tests for Phase 1: Multi-Database Support
// Part of ViperSQL - Production Database Server

module test_multidb;

bind Viper.Terminal;
bind Viper.Fmt;

bind "./executor";

//=============================================================================
// TEST UTILITIES
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func assertTrue(cond: Boolean, desc: String) {
    if cond {
        Terminal.Say("  PASS: " + desc);
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + desc);
        failed = failed + 1;
    }
}

func assertFalse(cond: Boolean, desc: String) {
    assertTrue(cond == false, desc);
}

//=============================================================================
// TESTS
//=============================================================================

func testDefaultDatabase() {
    Terminal.Say("Testing default database...");
    var exec = new Executor();
    exec.init();

    // Server should start with 'main' database
    assertTrue(exec.server.currentDbName == "main", "Default database should be 'main'");
    assertTrue(exec.server.databaseCount() == 1, "Should have 1 database initially");
}

func testCreateDatabase() {
    Terminal.Say("Testing CREATE DATABASE...");
    var exec = new Executor();
    exec.init();

    // Create a new database
    var result = exec.executeSql("CREATE DATABASE testdb");
    assertTrue(result.success, "CREATE DATABASE should succeed");
    assertTrue(exec.server.databaseCount() == 2, "Should have 2 databases after create");
    assertTrue(exec.server.databaseExists("testdb"), "Database 'testdb' should exist");

    // Try to create duplicate database
    result = exec.executeSql("CREATE DATABASE testdb");
    assertFalse(result.success, "CREATE duplicate DATABASE should fail");
}

func testUseDatabase() {
    Terminal.Say("Testing USE database...");
    var exec = new Executor();
    exec.init();

    // Create and switch to a new database
    exec.executeSql("CREATE DATABASE mydb");
    var result = exec.executeSql("USE mydb");
    assertTrue(result.success, "USE mydb should succeed");
    assertTrue(exec.server.currentDbName == "mydb", "Current database should be 'mydb'");

    // Try to use non-existent database
    result = exec.executeSql("USE nonexistent");
    assertFalse(result.success, "USE non-existent database should fail");
}

func testDatabaseIsolation() {
    Terminal.Say("Testing database isolation...");
    var exec = new Executor();
    exec.init();

    // Create table in main database
    exec.executeSql("CREATE TABLE users (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO users VALUES (1, 'Alice')");

    // Create new database and switch to it
    exec.executeSql("CREATE DATABASE db2");
    exec.executeSql("USE db2");

    // Create table with same name in db2
    var result = exec.executeSql("CREATE TABLE users (id INTEGER, email TEXT)");
    assertTrue(result.success, "Should be able to create 'users' table in db2");

    exec.executeSql("INSERT INTO users VALUES (100, 'alice@example.com')");

    // Query in db2 should only see db2 data
    result = exec.executeSql("SELECT * FROM users");
    assertTrue(result.rowCount() == 1, "db2 should have 1 row");
    var row = result.getRow(0);
    if row != null {
        var r = row;
        assertTrue(r.getValue(0).intValue == 100, "db2 user id should be 100");
    }

    // Switch back to main and verify its data is intact
    exec.executeSql("USE main");
    result = exec.executeSql("SELECT * FROM users");
    assertTrue(result.rowCount() == 1, "main should have 1 row");
    row = result.getRow(0);
    if row != null {
        var r = row;
        assertTrue(r.getValue(0).intValue == 1, "main user id should be 1");
        assertTrue(r.getValue(1).textValue == "Alice", "main user name should be 'Alice'");
    }
}

func testShowDatabases() {
    Terminal.Say("Testing SHOW DATABASES...");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE DATABASE db1");
    exec.executeSql("CREATE DATABASE db2");

    var result = exec.executeSql("SHOW DATABASES");
    assertTrue(result.success, "SHOW DATABASES should succeed");
    assertTrue(result.rowCount() == 3, "Should show 3 databases (main, db1, db2)");
}

func testDropDatabase() {
    Terminal.Say("Testing DROP DATABASE...");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE DATABASE tempdb");
    assertTrue(exec.server.databaseCount() == 2, "Should have 2 databases");

    // Drop the database
    var result = exec.executeSql("DROP DATABASE tempdb");
    assertTrue(result.success, "DROP DATABASE should succeed");
    assertTrue(exec.server.databaseCount() == 1, "Should have 1 database after drop");
    assertFalse(exec.server.databaseExists("tempdb"), "Database 'tempdb' should not exist");

    // Cannot drop 'main' database
    result = exec.executeSql("DROP DATABASE main");
    assertFalse(result.success, "DROP DATABASE main should fail");

    // Cannot drop current database
    exec.executeSql("CREATE DATABASE currentdb");
    exec.executeSql("USE currentdb");
    result = exec.executeSql("DROP DATABASE currentdb");
    assertFalse(result.success, "DROP current database should fail");

    // Cannot drop non-existent database
    result = exec.executeSql("DROP DATABASE nonexistent");
    assertFalse(result.success, "DROP non-existent database should fail");
}

func testIndexIsolation() {
    Terminal.Say("Testing index isolation...");
    var exec = new Executor();
    exec.init();

    // Create table and index in main database
    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT)");
    exec.executeSql("CREATE INDEX idx_products_name ON products (name)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Apple')");
    exec.executeSql("INSERT INTO products VALUES (2, 'Banana')");

    // Create new database
    exec.executeSql("CREATE DATABASE shop");
    exec.executeSql("USE shop");

    // Create same table and index name in shop database
    exec.executeSql("CREATE TABLE products (id INTEGER, price INTEGER)");
    var result = exec.executeSql("CREATE INDEX idx_products_name ON products (id)");
    assertTrue(result.success, "Should be able to create index with same name in different db");

    // Switch back and verify main's index still works
    exec.executeSql("USE main");
    result = exec.executeSql("SELECT * FROM products WHERE name = 'Apple'");
    assertTrue(result.success, "Query with index should succeed");
}

func testMultipleSwitches() {
    Terminal.Say("Testing multiple database switches...");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE DATABASE db1");
    exec.executeSql("CREATE DATABASE db2");
    exec.executeSql("CREATE DATABASE db3");

    // Create unique data in each database
    exec.executeSql("USE db1");
    exec.executeSql("CREATE TABLE t (val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES (1)");

    exec.executeSql("USE db2");
    exec.executeSql("CREATE TABLE t (val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES (2)");

    exec.executeSql("USE db3");
    exec.executeSql("CREATE TABLE t (val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES (3)");

    // Verify each database has correct data
    exec.executeSql("USE db1");
    var result = exec.executeSql("SELECT val FROM t");
    var row = result.getRow(0);
    if row != null {
        var r = row;
        assertTrue(r.getValue(0).intValue == 1, "db1 should have val=1");
    }

    exec.executeSql("USE db2");
    result = exec.executeSql("SELECT val FROM t");
    row = result.getRow(0);
    if row != null {
        var r = row;
        assertTrue(r.getValue(0).intValue == 2, "db2 should have val=2");
    }

    exec.executeSql("USE db3");
    result = exec.executeSql("SELECT val FROM t");
    row = result.getRow(0);
    if row != null {
        var r = row;
        assertTrue(r.getValue(0).intValue == 3, "db3 should have val=3");
    }
}

//=============================================================================
// MAIN
//=============================================================================

func start() {
    Terminal.Say("=== Phase 1: Multi-Database Support Tests ===");
    Terminal.Say("");

    testDefaultDatabase();
    testCreateDatabase();
    testUseDatabase();
    testDatabaseIsolation();
    testShowDatabases();
    testDropDatabase();
    testIndexIsolation();
    testMultipleSwitches();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
}
