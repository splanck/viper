// test_persistence.zia - End-to-end tests for persistent .vdb storage (Phase 2)
module test_persistence;

bind Terminal = Viper.Terminal;
bind IO = Viper.IO;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "./executor";

//=============================================================================
// TEST UTILITIES
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func check(name: String, condition: Boolean) {
    if condition {
        Terminal.Say("  PASS: " + name);
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + name);
        failed = failed + 1;
    }
}

//=============================================================================
// TESTS
//=============================================================================

func testCreateAndReopen() {
    Terminal.Say("--- Test 1: Create and reopen ---");
    var dbPath = "/tmp/test_p2_create.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Session 1: Create database and table
    var exec1 = new Executor();
    exec1.init();
    var r1 = exec1.executeSql("OPEN '" + dbPath + "'");
    check("OPEN creates new .vdb", r1.success);

    var r2 = exec1.executeSql("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, email TEXT)");
    check("CREATE TABLE users", r2.success);

    exec1.executeSql("INSERT INTO users VALUES (NULL, 'Alice', 'alice@test.com')");
    exec1.executeSql("INSERT INTO users VALUES (NULL, 'Bob', 'bob@test.com')");
    exec1.executeSql("INSERT INTO users VALUES (NULL, 'Charlie', NULL)");

    var r3 = exec1.executeSql("SELECT * FROM users");
    check("3 rows in session 1", r3.rowCount() == 3);

    exec1.executeSql("CLOSE");

    // Session 2: Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    var r4 = exec2.executeSql("OPEN '" + dbPath + "'");
    check("OPEN existing .vdb", r4.success);

    var r5 = exec2.executeSql("SELECT * FROM users");
    check("3 rows after reopen", r5.rowCount() == 3);

    var r6 = exec2.executeSql("SELECT name FROM users WHERE id = 1");
    check("Alice persisted", r6.rowCount() == 1);

    var r7 = exec2.executeSql("SELECT name FROM users WHERE id = 2");
    check("Bob persisted", r7.rowCount() == 1);

    // Verify autoincrement continues
    exec2.executeSql("INSERT INTO users VALUES (NULL, 'Dave', 'dave@test.com')");
    var r8 = exec2.executeSql("SELECT id FROM users WHERE name = 'Dave'");
    check("Dave gets id=4 (autoincrement)", r8.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testUpdatePersistence() {
    Terminal.Say("--- Test 2: UPDATE persistence ---");
    var dbPath = "/tmp/test_p2_update.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Create and populate
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE items (id INTEGER, name TEXT, qty INTEGER)");
    exec1.executeSql("INSERT INTO items VALUES (1, 'Widget', 10)");
    exec1.executeSql("INSERT INTO items VALUES (2, 'Gadget', 20)");
    exec1.executeSql("INSERT INTO items VALUES (3, 'Doohickey', 30)");

    // Update
    var r1 = exec1.executeSql("UPDATE items SET qty = 99 WHERE id = 2");
    check("UPDATE Gadget qty", r1.success);
    check("1 row updated", r1.rowsAffected == 1);

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r2 = exec2.executeSql("SELECT qty FROM items WHERE id = 2");
    check("UPDATE persisted", r2.rowCount() == 1);

    // Verify other rows unchanged
    var r3 = exec2.executeSql("SELECT * FROM items");
    check("3 rows still present", r3.rowCount() == 3);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testDeletePersistence() {
    Terminal.Say("--- Test 3: DELETE persistence ---");
    var dbPath = "/tmp/test_p2_delete.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Create and populate
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE colors (id INTEGER, name TEXT)");
    exec1.executeSql("INSERT INTO colors VALUES (1, 'Red')");
    exec1.executeSql("INSERT INTO colors VALUES (2, 'Green')");
    exec1.executeSql("INSERT INTO colors VALUES (3, 'Blue')");

    // Delete
    var r1 = exec1.executeSql("DELETE FROM colors WHERE id = 2");
    check("DELETE Green", r1.success);

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r2 = exec2.executeSql("SELECT * FROM colors");
    check("2 rows after reopen", r2.rowCount() == 2);

    var r3 = exec2.executeSql("SELECT * FROM colors WHERE name = 'Green'");
    check("Green is gone", r3.rowCount() == 0);

    var r4 = exec2.executeSql("SELECT * FROM colors WHERE name = 'Red'");
    check("Red still exists", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testDropTablePersistence() {
    Terminal.Say("--- Test 4: DROP TABLE persistence ---");
    var dbPath = "/tmp/test_p2_drop.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    // Create two tables
    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");
    exec1.executeSql("CREATE TABLE keep_me (id INTEGER)");
    exec1.executeSql("INSERT INTO keep_me VALUES (42)");
    exec1.executeSql("CREATE TABLE drop_me (id INTEGER)");
    exec1.executeSql("INSERT INTO drop_me VALUES (99)");

    // Drop one
    var r1 = exec1.executeSql("DROP TABLE drop_me");
    check("DROP TABLE drop_me", r1.success);

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r2 = exec2.executeSql("SELECT * FROM drop_me");
    check("drop_me is gone", r2.success == false);

    var r3 = exec2.executeSql("SELECT * FROM keep_me");
    check("keep_me still exists", r3.success);
    check("keep_me has 1 row", r3.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testMultipleTablesAndTypes() {
    Terminal.Say("--- Test 5: Multiple tables + data types ---");
    var dbPath = "/tmp/test_p2_multi.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec1 = new Executor();
    exec1.init();
    exec1.executeSql("OPEN '" + dbPath + "'");

    exec1.executeSql("CREATE TABLE ints (val INTEGER)");
    exec1.executeSql("INSERT INTO ints VALUES (42)");
    exec1.executeSql("INSERT INTO ints VALUES (-7)");
    exec1.executeSql("INSERT INTO ints VALUES (0)");

    exec1.executeSql("CREATE TABLE texts (val TEXT)");
    exec1.executeSql("INSERT INTO texts VALUES ('hello')");
    exec1.executeSql("INSERT INTO texts VALUES ('world')");

    exec1.executeSql("CREATE TABLE nulls (a INTEGER, b TEXT)");
    exec1.executeSql("INSERT INTO nulls VALUES (1, NULL)");
    exec1.executeSql("INSERT INTO nulls VALUES (NULL, 'test')");

    exec1.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '" + dbPath + "'");

    var r1 = exec2.executeSql("SELECT * FROM ints");
    check("ints: 3 rows", r1.rowCount() == 3);

    var r2 = exec2.executeSql("SELECT * FROM texts");
    check("texts: 2 rows", r2.rowCount() == 2);

    var r3 = exec2.executeSql("SELECT * FROM nulls");
    check("nulls: 2 rows", r3.rowCount() == 2);

    var r4 = exec2.executeSql("SELECT b FROM nulls WHERE a = 1");
    check("null text persisted", r4.rowCount() == 1);

    var r5 = exec2.executeSql("SELECT a FROM nulls WHERE b = 'test'");
    check("null int persisted", r5.rowCount() == 1);

    exec2.executeSql("CLOSE");
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testCloseNoDb() {
    Terminal.Say("--- Test 6: CLOSE with no persistent db ---");
    var exec = new Executor();
    exec.init();

    var r = exec.executeSql("CLOSE");
    check("CLOSE with no db is ok", r.success);
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Phase 2: Persistent Storage E2E Tests ===");
    Terminal.Say("");

    testCreateAndReopen();
    testUpdatePersistence();
    testDeletePersistence();
    testDropTablePersistence();
    testMultipleTablesAndTypes();
    testCloseNoDb();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    } else {
        Terminal.Say("SOME TESTS FAILED");
    }
}
