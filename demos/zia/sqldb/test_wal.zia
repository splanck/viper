// test_wal.zia - Write-Ahead Logging Tests
// Part of ViperSQL - Phase 4 Testing

module test_wal;

bind Viper.Terminal;
bind Viper.Fmt;
bind Viper.String;

bind "./storage/page";
bind "./storage/serializer";
bind "./storage/wal";
bind "./types";

//=============================================================================
// TEST HARNESS
//=============================================================================

var testsPassed = 0;
var testsFailed = 0;

func assert(condition: Boolean, testName: String) {
    if condition {
        testsPassed = testsPassed + 1;
        Terminal.Say("[PASS] " + testName);
    } else {
        testsFailed = testsFailed + 1;
        Terminal.Say("[FAIL] " + testName);
    }
}

func printSummary() {
    Terminal.Say("");
    Terminal.Say("===========================================");
    Terminal.Say("WAL TEST SUMMARY");
    Terminal.Say("===========================================");
    Terminal.Say("Passed: " + Fmt.Int(testsPassed));
    Terminal.Say("Failed: " + Fmt.Int(testsFailed));
    Terminal.Say("Total:  " + Fmt.Int(testsPassed + testsFailed));
    Terminal.Say("===========================================");
}

//=============================================================================
// LSN TESTS
//=============================================================================

func testLSNInit() {
    Terminal.Say("");
    Terminal.Say("--- LSN Tests ---");

    var lsn = new LSN();
    lsn.init();

    assert(lsn.fileNumber == 0, "LSN init sets file number to 0");
    assert(lsn.offset == 0, "LSN init sets offset to 0");
}

func testLSNWithValues() {
    var lsn = new LSN();
    lsn.initWith(5, 1024);

    assert(lsn.fileNumber == 5, "LSN stores file number");
    assert(lsn.offset == 1024, "LSN stores offset");
}

func testLSNCompare() {
    var lsn1 = new LSN();
    lsn1.initWith(1, 100);

    var lsn2 = new LSN();
    lsn2.initWith(1, 200);

    var lsn3 = new LSN();
    lsn3.initWith(2, 50);

    var lsn4 = new LSN();
    lsn4.initWith(1, 100);

    assert(lsn1.compare(lsn2) < 0, "LSN compare: same file, lower offset < higher");
    assert(lsn2.compare(lsn1) > 0, "LSN compare: same file, higher offset > lower");
    assert(lsn1.compare(lsn3) < 0, "LSN compare: lower file < higher file");
    assert(lsn3.compare(lsn1) > 0, "LSN compare: higher file > lower file");
    assert(lsn1.compare(lsn4) == 0, "LSN compare: equal LSNs");
}

func testLSNToString() {
    var lsn = new LSN();
    lsn.initWith(3, 512);

    assert(lsn.toString() == "3:512", "LSN toString format");
}

//=============================================================================
// LOG RECORD TESTS
//=============================================================================

func testLogRecordInit() {
    Terminal.Say("");
    Terminal.Say("--- LogRecord Tests ---");

    var record = new LogRecord();
    record.init();

    assert(record.recordType == 0, "LogRecord init sets type to 0");
    assert(record.txnId == 0, "LogRecord init sets txnId to 0");
    assert(record.pageId == INVALID_PAGE_ID, "LogRecord init sets invalid page ID");
}

func testLogRecordBegin() {
    var record = new LogRecord();
    record.initBegin(42);

    assert(record.recordType == LOG_BEGIN, "BEGIN record has correct type");
    assert(record.txnId == 42, "BEGIN record has correct txn ID");
    assert(record.recordTypeString() == "BEGIN", "BEGIN record type string");
}

func testLogRecordCommit() {
    var record = new LogRecord();
    record.initCommit(42);

    assert(record.recordType == LOG_COMMIT, "COMMIT record has correct type");
    assert(record.recordTypeString() == "COMMIT", "COMMIT record type string");
}

func testLogRecordAbort() {
    var record = new LogRecord();
    record.initAbort(42);

    assert(record.recordType == LOG_ABORT, "ABORT record has correct type");
    assert(record.recordTypeString() == "ABORT", "ABORT record type string");
}

func testLogRecordInsert() {
    var rowData = new BinaryBuffer();
    rowData.init();
    rowData.writeString("test row");

    var record = new LogRecord();
    record.initInsert(1, 10, 100, 5, rowData);

    assert(record.recordType == LOG_INSERT, "INSERT record has correct type");
    assert(record.txnId == 1, "INSERT record has txn ID");
    assert(record.tableId == 10, "INSERT record has table ID");
    assert(record.pageId == 100, "INSERT record has page ID");
    assert(record.slotId == 5, "INSERT record has slot ID");
    assert(record.recordTypeString() == "INSERT", "INSERT record type string");
}

func testLogRecordUpdate() {
    var before = new BinaryBuffer();
    before.init();
    before.writeString("old value");

    var after = new BinaryBuffer();
    after.init();
    after.writeString("new value");

    var record = new LogRecord();
    record.initUpdate(2, 20, 200, 10, before, after);

    assert(record.recordType == LOG_UPDATE, "UPDATE record has correct type");
    assert(record.beforeImage.size() > 0, "UPDATE record has before image");
    assert(record.afterImage.size() > 0, "UPDATE record has after image");
    assert(record.recordTypeString() == "UPDATE", "UPDATE record type string");
}

func testLogRecordDelete() {
    var rowData = new BinaryBuffer();
    rowData.init();
    rowData.writeString("deleted row");

    var record = new LogRecord();
    record.initDelete(3, 30, 300, 15, rowData);

    assert(record.recordType == LOG_DELETE, "DELETE record has correct type");
    assert(record.beforeImage.size() > 0, "DELETE record has before image");
    assert(record.recordTypeString() == "DELETE", "DELETE record type string");
}

func testLogRecordCheckpoint() {
    var activeTxns: List[Integer] = [];
    activeTxns.add(1);
    activeTxns.add(5);
    activeTxns.add(10);

    var record = new LogRecord();
    record.initCheckpoint(activeTxns);

    assert(record.recordType == LOG_CHECKPOINT, "CHECKPOINT record has correct type");
    assert(record.afterImage.size() > 0, "CHECKPOINT record stores active txns");
    assert(record.recordTypeString() == "CHECKPOINT", "CHECKPOINT record type string");
}

//=============================================================================
// LOG RECORD SERIALIZATION TESTS
//=============================================================================

func testLogRecordSerialization() {
    Terminal.Say("");
    Terminal.Say("--- LogRecord Serialization Tests ---");

    var serializer = new LogRecordSerializer();
    serializer.init();

    // Create a record
    var rowData = new BinaryBuffer();
    rowData.init();
    rowData.writeString("test data");

    var record = new LogRecord();
    record.initInsert(42, 10, 100, 5, rowData);
    record.lsn.initWith(1, 512);

    // Serialize
    var buf = new BinaryBuffer();
    buf.init();
    serializer.serialize(record, buf);

    assert(buf.size() > 0, "Serialized record has data");

    // Deserialize
    buf.seek(0);
    var restored = serializer.deserialize(buf);

    assert(restored.lsn.fileNumber == 1, "Deserialized LSN file number");
    assert(restored.lsn.offset == 512, "Deserialized LSN offset");
    assert(restored.recordType == LOG_INSERT, "Deserialized record type");
    assert(restored.txnId == 42, "Deserialized txn ID");
    assert(restored.tableId == 10, "Deserialized table ID");
    assert(restored.pageId == 100, "Deserialized page ID");
    assert(restored.slotId == 5, "Deserialized slot ID");
}

func testLogRecordUpdateSerialization() {
    var serializer = new LogRecordSerializer();
    serializer.init();

    var before = new BinaryBuffer();
    before.init();
    before.writeInt64(100);

    var after = new BinaryBuffer();
    after.init();
    after.writeInt64(200);

    var record = new LogRecord();
    record.initUpdate(99, 5, 50, 3, before, after);

    var buf = new BinaryBuffer();
    buf.init();
    serializer.serialize(record, buf);

    buf.seek(0);
    var restored = serializer.deserialize(buf);

    assert(restored.recordType == LOG_UPDATE, "Update record type preserved");
    assert(restored.beforeImage.size() > 0, "Before image preserved");
    assert(restored.afterImage.size() > 0, "After image preserved");
}

//=============================================================================
// WAL MANAGER TESTS
//=============================================================================

func testWALManagerInit() {
    Terminal.Say("");
    Terminal.Say("--- WALManager Tests ---");

    var wal = new WALManager();
    wal.init();

    assert(wal.isEnabled() == false, "WAL disabled by default");
    assert(wal.currentFile == 0, "WAL starts at file 0");
    assert(wal.currentOffset == 0, "WAL starts at offset 0");
}

func testWALManagerWithDir() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test");

    assert(wal.isEnabled() == true, "WAL enabled with dir");
    assert(wal.logDir == "/tmp/wal_test", "WAL stores log dir");
}

func testWALLogBegin() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test");

    var lsn = wal.logBegin(1);

    assert(lsn.fileNumber == 0, "BEGIN LSN file number");
    assert(lsn.offset == 0, "BEGIN LSN offset is 0 for first record");
}

func testWALLogSequence() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test2");

    var lsn1 = wal.logBegin(1);
    var lsn2 = wal.logBegin(2);
    var lsn3 = wal.logCommit(1);

    assert(lsn1.compare(lsn2) < 0, "Second record has higher LSN");
    assert(lsn2.compare(lsn3) < 0, "Third record has higher LSN");
}

func testWALLogOperations() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test3");

    // Begin transaction
    var beginLSN = wal.logBegin(100);

    // Insert
    var insertData = new BinaryBuffer();
    insertData.init();
    insertData.writeString("new row");
    var insertLSN = wal.logInsert(100, 1, 10, 0, insertData);

    // Update
    var before = new BinaryBuffer();
    before.init();
    before.writeString("old");
    var after = new BinaryBuffer();
    after.init();
    after.writeString("new");
    var updateLSN = wal.logUpdate(100, 1, 10, 0, before, after);

    // Delete
    var deleteData = new BinaryBuffer();
    deleteData.init();
    deleteData.writeString("deleted");
    var deleteLSN = wal.logDelete(100, 1, 10, 1, deleteData);

    // Commit
    var commitLSN = wal.logCommit(100);

    assert(beginLSN.compare(insertLSN) < 0, "Insert after begin");
    assert(insertLSN.compare(updateLSN) < 0, "Update after insert");
    assert(updateLSN.compare(deleteLSN) < 0, "Delete after update");
    assert(deleteLSN.compare(commitLSN) < 0, "Commit after delete");
}

func testWALCheckpoint() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test4");

    // Some transactions
    wal.logBegin(1);
    wal.logBegin(2);
    wal.logCommit(1);

    // Checkpoint with active transaction 2
    var activeTxns: List[Integer] = [];
    activeTxns.add(2);
    var checkpointLSN = wal.checkpoint(activeTxns);

    assert(checkpointLSN.fileNumber >= 0, "Checkpoint has valid LSN");
}

func testWALCurrentLSN() {
    var wal = new WALManager();
    wal.initWithDir("/tmp/wal_test5");

    var before = wal.getCurrentLSN();
    wal.logBegin(1);
    var after = wal.getCurrentLSN();

    assert(before.compare(after) < 0, "Current LSN advances after logging");
}

func testWALDisabled() {
    var wal = new WALManager();
    wal.init();  // Not enabled

    var lsn = wal.logBegin(1);

    assert(lsn.fileNumber == 0, "Disabled WAL returns dummy LSN");
    assert(lsn.offset == 0, "Disabled WAL returns zero offset");
}

//=============================================================================
// RECOVERY RESULT TESTS
//=============================================================================

func testRecoveryResultInit() {
    Terminal.Say("");
    Terminal.Say("--- RecoveryResult Tests ---");

    var result = new RecoveryResult();
    result.init();

    assert(result.recoveryComplete == false, "Recovery not complete initially");
    assert(result.committedTxns.count() == 0, "No committed txns initially");
    assert(result.abortedTxns.count() == 0, "No aborted txns initially");
    assert(result.activeTxnsAtCrash.count() == 0, "No active txns initially");
}

func testRecoveryResultToString() {
    var result = new RecoveryResult();
    result.init();
    result.committedTxns.add(1);
    result.committedTxns.add(2);
    result.abortedTxns.add(3);
    result.redoCount = 10;
    result.undoCount = 5;

    var str = result.toString();
    assert(String.Length(str) > 0, "Recovery result has string representation");
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("===========================================");
    Terminal.Say("VIPERSQL WRITE-AHEAD LOGGING TESTS");
    Terminal.Say("===========================================");

    // LSN tests
    testLSNInit();
    testLSNWithValues();
    testLSNCompare();
    testLSNToString();

    // LogRecord tests
    testLogRecordInit();
    testLogRecordBegin();
    testLogRecordCommit();
    testLogRecordAbort();
    testLogRecordInsert();
    testLogRecordUpdate();
    testLogRecordDelete();
    testLogRecordCheckpoint();

    // Serialization tests
    testLogRecordSerialization();
    testLogRecordUpdateSerialization();

    // WALManager tests
    testWALManagerInit();
    testWALManagerWithDir();
    testWALLogBegin();
    testWALLogSequence();
    testWALLogOperations();
    testWALCheckpoint();
    testWALCurrentLSN();
    testWALDisabled();

    // RecoveryResult tests
    testRecoveryResultInit();
    testRecoveryResultToString();

    printSummary();
}
