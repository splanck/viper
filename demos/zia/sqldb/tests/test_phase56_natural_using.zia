// test_phase56_natural_using.zia — Phase 56: NATURAL JOIN and USING clause
// Tests for NATURAL JOIN, NATURAL LEFT JOIN, JOIN ... USING, etc.

module test_phase56_natural_using;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupData() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE departments (id INTEGER, name TEXT, location TEXT)");
    exec.executeSql("INSERT INTO departments VALUES (1, 'Engineering', 'Building A')");
    exec.executeSql("INSERT INTO departments VALUES (2, 'Sales', 'Building B')");
    exec.executeSql("INSERT INTO departments VALUES (3, 'Marketing', 'Building C')");

    exec.executeSql("CREATE TABLE employees (id INTEGER, name TEXT, dept_id INTEGER, salary INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 1, 120)");
    exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 1, 100)");
    exec.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 2, 90)");
    exec.executeSql("INSERT INTO employees VALUES (4, 'Diana', 2, 95)");

    return exec;
}

//=========================================================================
// NATURAL JOIN (common column = id)
//=========================================================================

func testNaturalJoin() {
    section("NATURAL JOIN");

    var exec = new Executor();
    exec.init();

    // Two tables with a common column "id"
    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 'c')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");
    exec.executeSql("INSERT INTO t2 VALUES (4, 400)");

    // NATURAL JOIN matches on common column "id"
    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.score FROM t1 NATURAL JOIN t2");
    assertSuccess(r1, "NATURAL JOIN");
    assertRowCount(r1, 2, "2 matching rows (id 1 and 2)");
    assertEq(val(r1, 0, 0), "1", "id = 1");
    assertEq(val(r1, 0, 1), "a", "val = a");
    assertEq(val(r1, 0, 2), "100", "score = 100");
    assertEq(val(r1, 1, 0), "2", "id = 2");
    assertEq(val(r1, 1, 1), "b", "val = b");
    assertEq(val(r1, 1, 2), "200", "score = 200");
}

//=========================================================================
// NATURAL LEFT JOIN
//=========================================================================

func testNaturalLeftJoin() {
    section("NATURAL LEFT JOIN");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 'c')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");

    // NATURAL LEFT JOIN — t1 row with id=3 has no match
    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.score FROM t1 NATURAL LEFT JOIN t2");
    assertSuccess(r1, "NATURAL LEFT JOIN");
    assertRowCount(r1, 3, "3 rows (left preserves all)");
    assertEq(val(r1, 0, 0), "1", "id = 1");
    assertEq(val(r1, 0, 2), "100", "score = 100");
    assertEq(val(r1, 1, 0), "2", "id = 2");
    assertEq(val(r1, 1, 2), "200", "score = 200");
    assertEq(val(r1, 2, 0), "3", "id = 3");
    assertEq(val(r1, 2, 2), "NULL", "no match = NULL");
}

//=========================================================================
// NATURAL RIGHT JOIN
//=========================================================================

func testNaturalRightJoin() {
    section("NATURAL RIGHT JOIN");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");
    exec.executeSql("INSERT INTO t2 VALUES (3, 300)");

    // NATURAL RIGHT JOIN — t2 row with id=3 has no match in t1
    var r1 = exec.executeSql("SELECT t1.val, t2.id, t2.score FROM t1 NATURAL RIGHT JOIN t2");
    assertSuccess(r1, "NATURAL RIGHT JOIN");
    assertRowCount(r1, 3, "3 rows (right preserves all)");
    assertEq(val(r1, 0, 0), "a", "val = a");
    assertEq(val(r1, 0, 1), "1", "id = 1");
    assertEq(val(r1, 1, 0), "b", "val = b");
    assertEq(val(r1, 1, 1), "2", "id = 2");
    assertEq(val(r1, 2, 0), "NULL", "no match = NULL");
    assertEq(val(r1, 2, 1), "3", "id = 3");
    assertEq(val(r1, 2, 2), "300", "score = 300");
}

//=========================================================================
// JOIN ... USING (single column)
//=========================================================================

func testJoinUsingSingle() {
    section("JOIN USING single column");

    var exec = setupData();

    // JOIN USING (dept_id) — but our tables have different column names
    // Use matching column name: id
    exec.executeSql("CREATE TABLE projects (id INTEGER, project_name TEXT, dept_id INTEGER)");
    exec.executeSql("INSERT INTO projects VALUES (1, 'Alpha', 1)");
    exec.executeSql("INSERT INTO projects VALUES (2, 'Beta', 2)");
    exec.executeSql("INSERT INTO projects VALUES (3, 'Gamma', 1)");

    var r1 = exec.executeSql("SELECT e.name, p.project_name FROM employees e JOIN projects p USING (dept_id)");
    assertSuccess(r1, "JOIN USING single column");
    // Engineering(1): Alice, Bob × Alpha, Gamma; Sales(2): Charlie, Diana × Beta
    // Alice-Alpha, Alice-Gamma, Bob-Alpha, Bob-Gamma, Charlie-Beta, Diana-Beta
    assertRowCount(r1, 6, "6 matching rows");
}

//=========================================================================
// JOIN ... USING (multiple columns)
//=========================================================================

func testJoinUsingMultiple() {
    section("JOIN USING multiple columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE orders (customer_id INTEGER, product_id INTEGER, qty INTEGER)");
    exec.executeSql("INSERT INTO orders VALUES (1, 10, 5)");
    exec.executeSql("INSERT INTO orders VALUES (1, 20, 3)");
    exec.executeSql("INSERT INTO orders VALUES (2, 10, 7)");

    exec.executeSql("CREATE TABLE refunds (customer_id INTEGER, product_id INTEGER, reason TEXT)");
    exec.executeSql("INSERT INTO refunds VALUES (1, 10, 'defective')");
    exec.executeSql("INSERT INTO refunds VALUES (2, 30, 'wrong item')");

    var r1 = exec.executeSql("SELECT o.customer_id, o.product_id, o.qty, r.reason FROM orders o JOIN refunds r USING (customer_id, product_id)");
    assertSuccess(r1, "JOIN USING multiple columns");
    // Only match: customer_id=1, product_id=10
    assertRowCount(r1, 1, "1 matching row");
    assertEq(val(r1, 0, 0), "1", "customer_id = 1");
    assertEq(val(r1, 0, 1), "10", "product_id = 10");
    assertEq(val(r1, 0, 2), "5", "qty = 5");
    assertEq(val(r1, 0, 3), "defective", "reason = defective");
}

//=========================================================================
// LEFT JOIN ... USING
//=========================================================================

func testLeftJoinUsing() {
    section("LEFT JOIN USING");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 'c')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (3, 300)");

    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.score FROM t1 LEFT JOIN t2 USING (id)");
    assertSuccess(r1, "LEFT JOIN USING");
    assertRowCount(r1, 3, "3 rows (left preserves all)");
    assertEq(val(r1, 0, 0), "1", "id = 1");
    assertEq(val(r1, 0, 2), "100", "score = 100");
    assertEq(val(r1, 1, 0), "2", "id = 2");
    assertEq(val(r1, 1, 2), "NULL", "no match = NULL");
    assertEq(val(r1, 2, 0), "3", "id = 3");
    assertEq(val(r1, 2, 2), "300", "score = 300");
}

//=========================================================================
// NATURAL JOIN with multiple common columns
//=========================================================================

func testNaturalMultipleCommon() {
    section("NATURAL JOIN multiple common columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (a INTEGER, b INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 10, 'x')");
    exec.executeSql("INSERT INTO t1 VALUES (1, 20, 'y')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 10, 'z')");

    exec.executeSql("CREATE TABLE t2 (a INTEGER, b INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 10, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 30, 300)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 10, 200)");

    // Common columns: a AND b
    var r1 = exec.executeSql("SELECT t1.a, t1.b, t1.val, t2.score FROM t1 NATURAL JOIN t2");
    assertSuccess(r1, "NATURAL multi-col");
    // Matches: (1,10) and (2,10)
    assertRowCount(r1, 2, "2 matching rows");
    assertEq(val(r1, 0, 0), "1", "a = 1");
    assertEq(val(r1, 0, 1), "10", "b = 10");
    assertEq(val(r1, 0, 2), "x", "val = x");
    assertEq(val(r1, 0, 3), "100", "score = 100");
    assertEq(val(r1, 1, 0), "2", "a = 2");
    assertEq(val(r1, 1, 1), "10", "b = 10");
    assertEq(val(r1, 1, 2), "z", "val = z");
    assertEq(val(r1, 1, 3), "200", "score = 200");
}

//=========================================================================
// NATURAL JOIN with no common columns (acts like CROSS JOIN)
//=========================================================================

func testNaturalNoCommon() {
    section("NATURAL JOIN no common columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (a INTEGER, b TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'x')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'y')");

    exec.executeSql("CREATE TABLE t2 (c INTEGER, d TEXT)");
    exec.executeSql("INSERT INTO t2 VALUES (10, 'p')");
    exec.executeSql("INSERT INTO t2 VALUES (20, 'q')");

    // No common columns: NATURAL JOIN = CROSS JOIN
    var r1 = exec.executeSql("SELECT t1.a, t2.c FROM t1 NATURAL JOIN t2");
    assertSuccess(r1, "NATURAL no common");
    assertRowCount(r1, 4, "4 rows (2 × 2 cross product)");
}

//=========================================================================
// NATURAL INNER JOIN (explicit INNER keyword)
//=========================================================================

func testNaturalInnerJoin() {
    section("NATURAL INNER JOIN");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");
    exec.executeSql("INSERT INTO t2 VALUES (3, 300)");

    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.score FROM t1 NATURAL INNER JOIN t2");
    assertSuccess(r1, "NATURAL INNER JOIN");
    assertRowCount(r1, 2, "2 matching rows");
    assertEq(val(r1, 0, 0), "1", "id = 1");
    assertEq(val(r1, 0, 2), "100", "score = 100");
    assertEq(val(r1, 1, 0), "2", "id = 2");
    assertEq(val(r1, 1, 2), "200", "score = 200");
}

//=========================================================================
// NATURAL FULL JOIN
//=========================================================================

func testNaturalFullJoin() {
    section("NATURAL FULL JOIN");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");
    exec.executeSql("INSERT INTO t2 VALUES (3, 300)");

    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.id, t2.score FROM t1 NATURAL FULL JOIN t2");
    assertSuccess(r1, "NATURAL FULL JOIN");
    // Match: id=2; Left only: id=1; Right only: id=3
    assertRowCount(r1, 3, "3 rows");
}

//=========================================================================
// JOIN USING with WHERE clause
//=========================================================================

func testJoinUsingWhere() {
    section("JOIN USING with WHERE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 'a')");
    exec.executeSql("INSERT INTO t1 VALUES (2, 'b')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 'c')");

    exec.executeSql("CREATE TABLE t2 (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 100)");
    exec.executeSql("INSERT INTO t2 VALUES (2, 200)");
    exec.executeSql("INSERT INTO t2 VALUES (3, 300)");

    var r1 = exec.executeSql("SELECT t1.id, t1.val, t2.score FROM t1 JOIN t2 USING (id) WHERE t2.score > 150");
    assertSuccess(r1, "JOIN USING WHERE");
    assertRowCount(r1, 2, "2 rows with score > 150");
    assertEq(val(r1, 0, 0), "2", "id = 2");
    assertEq(val(r1, 0, 2), "200", "score = 200");
    assertEq(val(r1, 1, 0), "3", "id = 3");
    assertEq(val(r1, 1, 2), "300", "score = 300");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 56: NATURAL JOIN and USING ===");

    testNaturalJoin();
    testNaturalLeftJoin();
    testNaturalRightJoin();
    testJoinUsingSingle();
    testJoinUsingMultiple();
    testLeftJoinUsing();
    testNaturalMultipleCommon();
    testNaturalNoCommon();
    testNaturalInnerJoin();
    testNaturalFullJoin();
    testJoinUsingWhere();

    printResults();
}
