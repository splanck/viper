// test_phase51_regex.zia â€” Phase 51: Regular Expressions
// Tests for ~ operator, SIMILAR TO, REGEXP_MATCH, REGEXP_REPLACE,
// REGEXP_COUNT, REGEXP_SPLIT_TO_ARRAY, REGEXP_LIKE, REGEXP_INSTR.

module test_phase51_regex;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// ~ operator (regex match)
//=========================================================================

func testTildeOperator() {
    section("~ operator");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE emails (id INTEGER, addr TEXT)");
    exec.executeSql("INSERT INTO emails VALUES (1, 'user@example.com')");
    exec.executeSql("INSERT INTO emails VALUES (2, 'admin@test.org')");
    exec.executeSql("INSERT INTO emails VALUES (3, 'noatsign')");

    // Match rows containing @
    var r1 = exec.executeSql("SELECT addr FROM emails WHERE addr ~ '@' ORDER BY id");
    assertSuccess(r1, "tilde match");
    assertRowCount(r1, 2, "2 rows with @");
    assertEq(val(r1, 0, 0), "user@example.com", "first match");
    assertEq(val(r1, 1, 0), "admin@test.org", "second match");

    // Match .com ending
    var r2 = exec.executeSql("SELECT addr FROM emails WHERE addr ~ '\\.com$'");
    assertRowCount(r2, 1, "1 .com row");
    assertEq(val(r2, 0, 0), "user@example.com", ".com match");

    // No match
    var r3 = exec.executeSql("SELECT addr FROM emails WHERE addr ~ '^xyz'");
    assertRowCount(r3, 0, "0 rows for ^xyz");
}

//=========================================================================
// SIMILAR TO
//=========================================================================

func testSimilarTo() {
    section("SIMILAR TO");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE words (id INTEGER, word TEXT)");
    exec.executeSql("INSERT INTO words VALUES (1, 'hello')");
    exec.executeSql("INSERT INTO words VALUES (2, 'world')");
    exec.executeSql("INSERT INTO words VALUES (3, 'help')");
    exec.executeSql("INSERT INTO words VALUES (4, 'hero')");

    // SIMILAR TO with % wildcard (like LIKE but regex-based)
    var r1 = exec.executeSql("SELECT word FROM words WHERE word SIMILAR TO 'hel%' ORDER BY id");
    assertSuccess(r1, "SIMILAR TO %");
    assertRowCount(r1, 2, "2 matches for hel%");
    assertEq(val(r1, 0, 0), "hello", "hello matches");
    assertEq(val(r1, 1, 0), "help", "help matches");

    // SIMILAR TO with _ wildcard
    var r2 = exec.executeSql("SELECT word FROM words WHERE word SIMILAR TO 'he__' ORDER BY id");
    assertRowCount(r2, 2, "2 matches for he__");
    assertEq(val(r2, 0, 0), "help", "help matches he__");
    assertEq(val(r2, 1, 0), "hero", "hero matches he__");

    // NOT SIMILAR TO
    var r3 = exec.executeSql("SELECT word FROM words WHERE word NOT SIMILAR TO 'h%' ORDER BY id");
    assertRowCount(r3, 1, "1 not matching h%");
    assertEq(val(r3, 0, 0), "world", "world does not match h%");
}

//=========================================================================
// REGEXP_MATCH / REGEXP_SUBSTR
//=========================================================================

func testRegexpMatch() {
    section("REGEXP_MATCH");

    var exec = new Executor();
    exec.init();

    // Extract first number from string
    var r1 = exec.executeSql("SELECT REGEXP_MATCH('abc 123 def 456', '[0-9]+')");
    assertSuccess(r1, "REGEXP_MATCH");
    assertEq(val(r1, 0, 0), "123", "first number");

    // No match returns NULL
    var r2 = exec.executeSql("SELECT REGEXP_MATCH('hello world', '[0-9]+')");
    assertEq(val(r2, 0, 0), "NULL", "no match = null");

    // REGEXP_SUBSTR (alias)
    var r3 = exec.executeSql("SELECT REGEXP_SUBSTR('Price: $42.50', '[0-9]+')");
    assertEq(val(r3, 0, 0), "42", "first number from price");
}

//=========================================================================
// REGEXP_REPLACE
//=========================================================================

func testRegexpReplace() {
    section("REGEXP_REPLACE");

    var exec = new Executor();
    exec.init();

    // Replace all digits with #
    var r1 = exec.executeSql("SELECT REGEXP_REPLACE('abc123def456', '[0-9]+', '#')");
    assertSuccess(r1, "REGEXP_REPLACE global");
    assertEq(val(r1, 0, 0), "abc#def#", "digits replaced");

    // Replace first only (no 'g' flag)
    var r2 = exec.executeSql("SELECT REGEXP_REPLACE('abc123def456', '[0-9]+', '#', '')");
    assertEq(val(r2, 0, 0), "abc#def456", "first replacement only");

    // NULL input
    var r3 = exec.executeSql("SELECT REGEXP_REPLACE(NULL, '[0-9]+', '#')");
    assertEq(val(r3, 0, 0), "NULL", "null input");
}

//=========================================================================
// REGEXP_COUNT
//=========================================================================

func testRegexpCount() {
    section("REGEXP_COUNT");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT REGEXP_COUNT('abc 123 def 456 ghi 789', '[0-9]+')");
    assertSuccess(r1, "REGEXP_COUNT");
    assertEq(val(r1, 0, 0), "3", "3 number groups");

    var r2 = exec.executeSql("SELECT REGEXP_COUNT('hello world', '[0-9]+')");
    assertEq(val(r2, 0, 0), "0", "no numbers");
}

//=========================================================================
// REGEXP_SPLIT_TO_ARRAY
//=========================================================================

func testRegexpSplit() {
    section("REGEXP_SPLIT_TO_ARRAY");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT REGEXP_SPLIT_TO_ARRAY('one  two   three', '\\s+')");
    assertSuccess(r1, "REGEXP_SPLIT");
    var v1 = val(r1, 0, 0);
    assertTrue(stringContains(v1, "one"), "contains one");
    assertTrue(stringContains(v1, "two"), "contains two");
    assertTrue(stringContains(v1, "three"), "contains three");
}

//=========================================================================
// REGEXP_LIKE
//=========================================================================

func testRegexpLike() {
    section("REGEXP_LIKE");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT REGEXP_LIKE('hello123', '[a-z]+[0-9]+')");
    assertSuccess(r1, "REGEXP_LIKE");
    assertEq(val(r1, 0, 0), "true", "matches pattern");

    var r2 = exec.executeSql("SELECT REGEXP_LIKE('hello', '^[0-9]+$')");
    assertEq(val(r2, 0, 0), "false", "no match");
}

//=========================================================================
// REGEXP_INSTR
//=========================================================================

func testRegexpInstr() {
    section("REGEXP_INSTR");

    var exec = new Executor();
    exec.init();

    // Find position of first digit (1-based)
    var r1 = exec.executeSql("SELECT REGEXP_INSTR('abc123', '[0-9]+')");
    assertSuccess(r1, "REGEXP_INSTR");
    assertEq(val(r1, 0, 0), "4", "first digit at pos 4 (1-based)");

    // No match returns 0
    var r2 = exec.executeSql("SELECT REGEXP_INSTR('hello', '[0-9]+')");
    assertEq(val(r2, 0, 0), "0", "no match = 0");
}

//=========================================================================
// REGEXP_MATCHES (all matches)
//=========================================================================

func testRegexpMatches() {
    section("REGEXP_MATCHES");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT REGEXP_MATCHES('abc 123 def 456', '[0-9]+')");
    assertSuccess(r1, "REGEXP_MATCHES");
    var v1 = val(r1, 0, 0);
    assertTrue(stringContains(v1, "123"), "contains 123");
    assertTrue(stringContains(v1, "456"), "contains 456");
}

//=========================================================================
// Table usage with regex
//=========================================================================

func testTableRegex() {
    section("Regex with table");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE logs (id INTEGER, msg TEXT)");
    exec.executeSql("INSERT INTO logs VALUES (1, 'ERROR: disk full')");
    exec.executeSql("INSERT INTO logs VALUES (2, 'INFO: user login')");
    exec.executeSql("INSERT INTO logs VALUES (3, 'ERROR: timeout')");
    exec.executeSql("INSERT INTO logs VALUES (4, 'WARN: memory high')");

    // Filter with regex
    var r1 = exec.executeSql("SELECT msg FROM logs WHERE msg ~ '^ERROR' ORDER BY id");
    assertRowCount(r1, 2, "2 error rows");
    assertEq(val(r1, 0, 0), "ERROR: disk full", "first error");
    assertEq(val(r1, 1, 0), "ERROR: timeout", "second error");

    // REGEXP_REPLACE on column
    var r2 = exec.executeSql("SELECT REGEXP_REPLACE(msg, '^[A-Z]+: ', '') FROM logs WHERE id = 1");
    assertEq(val(r2, 0, 0), "disk full", "stripped prefix");
}

//=========================================================================
// NULL handling
//=========================================================================

func testNullHandling() {
    section("Regex NULL handling");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT REGEXP_MATCH(NULL, '[0-9]+')");
    assertEq(val(r1, 0, 0), "NULL", "match null");

    var r2 = exec.executeSql("SELECT REGEXP_COUNT(NULL, '[0-9]+')");
    assertEq(val(r2, 0, 0), "NULL", "count null");

    var r3 = exec.executeSql("SELECT REGEXP_INSTR(NULL, '[0-9]+')");
    assertEq(val(r3, 0, 0), "NULL", "instr null");

    var r4 = exec.executeSql("SELECT REGEXP_LIKE(NULL, '[0-9]+')");
    assertEq(val(r4, 0, 0), "NULL", "like null");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 51: Regular Expressions ===");

    testTildeOperator();
    testSimilarTo();
    testRegexpMatch();
    testRegexpReplace();
    testRegexpCount();
    testRegexpSplit();
    testRegexpLike();
    testRegexpInstr();
    testRegexpMatches();
    testTableRegex();
    testNullHandling();

    printResults();
}
