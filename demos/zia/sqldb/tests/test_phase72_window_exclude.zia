// test_phase72_window_exclude.zia — Phase 72: EXCLUDE CURRENT ROW, Multi-column IN
// Tests for window frame exclusion and row-value IN predicates.

module test_phase72_window_exclude;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// EXCLUDE CURRENT ROW — SUM
//=========================================================================

func testExcludeCurrentRowSum() {
    section("EXCLUDE CURRENT ROW — SUM");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (id INTEGER, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES (1, 10)");
    exec.executeSql("INSERT INTO sales VALUES (2, 20)");
    exec.executeSql("INSERT INTO sales VALUES (3, 30)");
    exec.executeSql("INSERT INTO sales VALUES (4, 40)");

    // SUM over entire partition excluding current row
    var r1 = exec.executeSql("SELECT id, amount, SUM(amount) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING EXCLUDE CURRENT ROW) AS others FROM sales ORDER BY id");
    assertSuccess(r1, "EXCLUDE CURRENT ROW SUM");
    assertRowCount(r1, 4, "4 rows");
    // Total = 100; each row should be 100 - own amount
    assertEq(val(r1, 0, 2), "90", "Row 1: 100 - 10 = 90");
    assertEq(val(r1, 1, 2), "80", "Row 2: 100 - 20 = 80");
    assertEq(val(r1, 2, 2), "70", "Row 3: 100 - 30 = 70");
    assertEq(val(r1, 3, 2), "60", "Row 4: 100 - 40 = 60");
}

//=========================================================================
// EXCLUDE CURRENT ROW — COUNT
//=========================================================================

func testExcludeCurrentRowCount() {
    section("EXCLUDE CURRENT ROW — COUNT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, val INTEGER)");
    exec.executeSql("INSERT INTO items VALUES (1, 100)");
    exec.executeSql("INSERT INTO items VALUES (2, 200)");
    exec.executeSql("INSERT INTO items VALUES (3, 300)");

    // COUNT over full partition excluding self = partition_size - 1
    var r1 = exec.executeSql("SELECT id, COUNT(*) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING EXCLUDE CURRENT ROW) AS cnt FROM items ORDER BY id");
    assertSuccess(r1, "EXCLUDE CURRENT ROW COUNT");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 1), "2", "Row 1: 3 - 1 = 2");
    assertEq(val(r1, 1, 1), "2", "Row 2: 3 - 1 = 2");
    assertEq(val(r1, 2, 1), "2", "Row 3: 3 - 1 = 2");
}

//=========================================================================
// EXCLUDE CURRENT ROW — AVG
//=========================================================================

func testExcludeCurrentRowAvg() {
    section("EXCLUDE CURRENT ROW — AVG");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES (1, 10)");
    exec.executeSql("INSERT INTO scores VALUES (2, 20)");
    exec.executeSql("INSERT INTO scores VALUES (3, 30)");

    // AVG excluding self: (total - self) / (count - 1)
    var r1 = exec.executeSql("SELECT id, score, AVG(score) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING EXCLUDE CURRENT ROW) AS avg_others FROM scores ORDER BY id");
    assertSuccess(r1, "EXCLUDE CURRENT ROW AVG");
    assertRowCount(r1, 3, "3 rows");
    // Row 1 (10): avg(20, 30) = 25
    assertEq(val(r1, 0, 2), "25", "Row 1: avg(20,30) = 25");
    // Row 2 (20): avg(10, 30) = 20
    assertEq(val(r1, 1, 2), "20", "Row 2: avg(10,30) = 20");
    // Row 3 (30): avg(10, 20) = 15
    assertEq(val(r1, 2, 2), "15", "Row 3: avg(10,20) = 15");
}

//=========================================================================
// EXCLUDE CURRENT ROW — sliding window
//=========================================================================

func testExcludeSlidingWindow() {
    section("EXCLUDE CURRENT ROW — sliding window");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nums (id INTEGER, n INTEGER)");
    exec.executeSql("INSERT INTO nums VALUES (1, 10)");
    exec.executeSql("INSERT INTO nums VALUES (2, 20)");
    exec.executeSql("INSERT INTO nums VALUES (3, 30)");
    exec.executeSql("INSERT INTO nums VALUES (4, 40)");
    exec.executeSql("INSERT INTO nums VALUES (5, 50)");

    // SUM of 1 preceding and 1 following, excluding current
    var r1 = exec.executeSql("SELECT id, n, SUM(n) OVER (ORDER BY id ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING EXCLUDE CURRENT ROW) AS neighbor_sum FROM nums ORDER BY id");
    assertSuccess(r1, "EXCLUDE sliding window SUM");
    assertRowCount(r1, 5, "5 rows");
    // Row 1 (10): frame=[10,20], exclude 10 → sum=20
    assertEq(val(r1, 0, 2), "20", "Row 1: neighbor sum = 20");
    // Row 2 (20): frame=[10,20,30], exclude 20 → sum=40
    assertEq(val(r1, 1, 2), "40", "Row 2: neighbor sum = 40");
    // Row 3 (30): frame=[20,30,40], exclude 30 → sum=60
    assertEq(val(r1, 2, 2), "60", "Row 3: neighbor sum = 60");
    // Row 4 (40): frame=[30,40,50], exclude 40 → sum=80
    assertEq(val(r1, 3, 2), "80", "Row 4: neighbor sum = 80");
    // Row 5 (50): frame=[40,50], exclude 50 → sum=40
    assertEq(val(r1, 4, 2), "40", "Row 5: neighbor sum = 40");
}

//=========================================================================
// EXCLUDE NO OTHERS — regression (default, should include all)
//=========================================================================

func testExcludeNoOthers() {
    section("EXCLUDE NO OTHERS");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (id INTEGER, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES (1, 10)");
    exec.executeSql("INSERT INTO data VALUES (2, 20)");
    exec.executeSql("INSERT INTO data VALUES (3, 30)");

    // EXCLUDE NO OTHERS = default behavior
    var r1 = exec.executeSql("SELECT id, val, SUM(val) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING EXCLUDE NO OTHERS) AS total FROM data ORDER BY id");
    assertSuccess(r1, "EXCLUDE NO OTHERS");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 2), "60", "Full partition sum = 60");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 72: EXCLUDE CURRENT ROW, Multi-column IN ===");

    testExcludeCurrentRowSum();
    testExcludeCurrentRowCount();
    testExcludeCurrentRowAvg();
    testExcludeSlidingWindow();
    testExcludeNoOthers();

    printResults();
}
