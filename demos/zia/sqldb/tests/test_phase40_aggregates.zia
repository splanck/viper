// test_phase40_aggregates.zia — Phase 40: Aggregate Function Enhancements
// Tests for STRING_AGG, GROUP_CONCAT, ARRAY_AGG, BOOL_AND, BOOL_OR.

module test_phase40_aggregates;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// STRING_AGG
//=========================================================================

func testStringAgg() {
    section("STRING_AGG");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE tags (item TEXT, tag TEXT)");
    exec.executeSql("INSERT INTO tags VALUES ('shirt', 'red')");
    exec.executeSql("INSERT INTO tags VALUES ('shirt', 'cotton')");
    exec.executeSql("INSERT INTO tags VALUES ('shirt', 'casual')");
    exec.executeSql("INSERT INTO tags VALUES ('pants', 'blue')");
    exec.executeSql("INSERT INTO tags VALUES ('pants', 'denim')");

    // STRING_AGG with comma separator
    var r1 = exec.executeSql("SELECT item, STRING_AGG(tag, ', ') FROM tags GROUP BY item ORDER BY item");
    assertSuccess(r1, "STRING_AGG with GROUP BY");
    assertEqInt(r1.rows.count(), 2, "2 groups");
    assertEq(val(r1, 0, 0), "pants", "first group");
    assertEq(val(r1, 0, 1), "blue, denim", "pants tags");
    assertEq(val(r1, 1, 0), "shirt", "second group");
    assertEq(val(r1, 1, 1), "red, cotton, casual", "shirt tags");

    // STRING_AGG without GROUP BY (all rows)
    var r2 = exec.executeSql("SELECT STRING_AGG(tag, '-') FROM tags");
    assertSuccess(r2, "STRING_AGG all rows");
    var v2 = val(r2, 0, 0);
    assertTrue(stringContains(v2, "red"), "contains red");
    assertTrue(stringContains(v2, "-"), "has dash separator");
}

//=========================================================================
// GROUP_CONCAT (MySQL-compatible alias)
//=========================================================================

func testGroupConcat() {
    section("GROUP_CONCAT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE fruits (category TEXT, name TEXT)");
    exec.executeSql("INSERT INTO fruits VALUES ('citrus', 'orange')");
    exec.executeSql("INSERT INTO fruits VALUES ('citrus', 'lemon')");
    exec.executeSql("INSERT INTO fruits VALUES ('berry', 'strawberry')");
    exec.executeSql("INSERT INTO fruits VALUES ('berry', 'blueberry')");

    var r1 = exec.executeSql("SELECT category, GROUP_CONCAT(name, ', ') FROM fruits GROUP BY category ORDER BY category");
    assertSuccess(r1, "GROUP_CONCAT with GROUP BY");
    assertEq(val(r1, 0, 0), "berry", "first category");
    assertEq(val(r1, 0, 1), "strawberry, blueberry", "berry names");
    assertEq(val(r1, 1, 0), "citrus", "second category");
    assertEq(val(r1, 1, 1), "orange, lemon", "citrus names");
}

//=========================================================================
// ARRAY_AGG
//=========================================================================

func testArrayAgg() {
    section("ARRAY_AGG");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (student TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 90)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 85)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 95)");
    exec.executeSql("INSERT INTO scores VALUES ('Bob', 80)");
    exec.executeSql("INSERT INTO scores VALUES ('Bob', 75)");

    // ARRAY_AGG with GROUP BY
    var r1 = exec.executeSql("SELECT student, ARRAY_AGG(score) FROM scores GROUP BY student ORDER BY student");
    assertSuccess(r1, "ARRAY_AGG with GROUP BY");
    assertEqInt(r1.rows.count(), 2, "2 students");
    assertEq(val(r1, 0, 0), "Alice", "first student");
    assertEq(val(r1, 0, 1), "{90,85,95}", "Alice scores array");
    assertEq(val(r1, 1, 0), "Bob", "second student");
    assertEq(val(r1, 1, 1), "{80,75}", "Bob scores array");

    // ARRAY_AGG without GROUP BY
    var r2 = exec.executeSql("SELECT ARRAY_AGG(score) FROM scores");
    assertSuccess(r2, "ARRAY_AGG all rows");
    assertEq(val(r2, 0, 0), "{90,85,95,80,75}", "all scores in array");
}

//=========================================================================
// BOOL_AND / BOOL_OR
//=========================================================================

func testBoolAggregates() {
    section("BOOL_AND / BOOL_OR");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE checks (grp TEXT, passed INTEGER)");
    exec.executeSql("INSERT INTO checks VALUES ('A', 1)");
    exec.executeSql("INSERT INTO checks VALUES ('A', 1)");
    exec.executeSql("INSERT INTO checks VALUES ('A', 1)");
    exec.executeSql("INSERT INTO checks VALUES ('B', 1)");
    exec.executeSql("INSERT INTO checks VALUES ('B', 0)");
    exec.executeSql("INSERT INTO checks VALUES ('B', 1)");

    // BOOL_AND — all true in group A, not all in group B
    var r1 = exec.executeSql("SELECT grp, BOOL_AND(passed) FROM checks GROUP BY grp ORDER BY grp");
    assertSuccess(r1, "BOOL_AND with GROUP BY");
    assertEq(val(r1, 0, 0), "A", "group A");
    assertEq(val(r1, 0, 1), "true", "A all true");
    assertEq(val(r1, 1, 0), "B", "group B");
    assertEq(val(r1, 1, 1), "false", "B has false");

    // BOOL_OR — any true in both groups
    var r2 = exec.executeSql("SELECT grp, BOOL_OR(passed) FROM checks GROUP BY grp ORDER BY grp");
    assertSuccess(r2, "BOOL_OR with GROUP BY");
    assertEq(val(r2, 0, 1), "true", "A has true");
    assertEq(val(r2, 1, 1), "true", "B has true");

    // BOOL_OR all false
    exec.executeSql("CREATE TABLE all_false (val INTEGER)");
    exec.executeSql("INSERT INTO all_false VALUES (0)");
    exec.executeSql("INSERT INTO all_false VALUES (0)");

    var r3 = exec.executeSql("SELECT BOOL_OR(val) FROM all_false");
    assertSuccess(r3, "BOOL_OR all false");
    assertEq(val(r3, 0, 0), "false", "all false returns false");
}

//=========================================================================
// STRING_AGG without GROUP BY
//=========================================================================

func testStringAggNoGroup() {
    section("STRING_AGG without GROUP BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE words (word TEXT)");
    exec.executeSql("INSERT INTO words VALUES ('hello')");
    exec.executeSql("INSERT INTO words VALUES ('world')");
    exec.executeSql("INSERT INTO words VALUES ('foo')");

    var r1 = exec.executeSql("SELECT STRING_AGG(word, ' ') FROM words");
    assertSuccess(r1, "STRING_AGG all rows");
    assertEq(val(r1, 0, 0), "hello world foo", "all words joined");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 40: Aggregate Function Enhancements ===");

    testStringAgg();
    testGroupConcat();
    testArrayAgg();
    testBoolAggregates();
    testStringAggNoGroup();

    printResults();
}
