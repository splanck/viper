// test_phase3.zia â€” Phase 3: Per-database persistence via DatabaseServer
// Part of ViperSQL
module test_phase3;

bind Terminal = Viper.Terminal;
bind IO = Viper.IO;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "../executor";
bind "./test_common";

//=============================================================================
// TESTS
//=============================================================================

func testCreateDatabaseWithFile() {
    Terminal.Say("--- Test 1: CREATE DATABASE ... FILE ---");
    var dbPath = "/tmp/test_p3_db1.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec = new Executor();
    exec.init();

    // Create a persistent database
    var r1 = exec.executeSql("CREATE DATABASE testdb FILE '" + dbPath + "'");
    check("CREATE DATABASE FILE succeeds", r1.success);

    // Switch to it
    var r2 = exec.executeSql("USE testdb");
    check("USE testdb succeeds", r2.success);

    // Create table and insert data
    var r3 = exec.executeSql("CREATE TABLE items (id INTEGER, name TEXT)");
    check("CREATE TABLE in testdb", r3.success);

    exec.executeSql("INSERT INTO items VALUES (1, 'Widget')");
    exec.executeSql("INSERT INTO items VALUES (2, 'Gadget')");

    var r4 = exec.executeSql("SELECT * FROM items");
    check("2 rows in testdb", r4.rowCount() == 2);

    // Verify file was created
    check("vdb file exists", IO.File.Exists(dbPath));

    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testMultiplePersistentDatabases() {
    Terminal.Say("--- Test 2: Multiple persistent databases ---");
    var dbPath1 = "/tmp/test_p3_multi1.vdb";
    var dbPath2 = "/tmp/test_p3_multi2.vdb";
    if IO.File.Exists(dbPath1) { IO.File.Delete(dbPath1); }
    if IO.File.Exists(dbPath2) { IO.File.Delete(dbPath2); }

    var exec = new Executor();
    exec.init();

    // Create two persistent databases
    exec.executeSql("CREATE DATABASE db1 FILE '" + dbPath1 + "'");
    exec.executeSql("CREATE DATABASE db2 FILE '" + dbPath2 + "'");

    // Populate db1
    exec.executeSql("USE db1");
    exec.executeSql("CREATE TABLE users (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO users VALUES (1, 'Alice')");

    // Populate db2
    exec.executeSql("USE db2");
    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 10)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 20)");

    // Verify db2 data
    var r1 = exec.executeSql("SELECT * FROM products");
    check("2 rows in db2.products", r1.rowCount() == 2);

    // Switch back to db1 and verify
    exec.executeSql("USE db1");
    var r2 = exec.executeSql("SELECT * FROM users");
    check("1 row in db1.users", r2.rowCount() == 1);

    // Both files should exist
    check("db1 file exists", IO.File.Exists(dbPath1));
    check("db2 file exists", IO.File.Exists(dbPath2));

    if IO.File.Exists(dbPath1) { IO.File.Delete(dbPath1); }
    if IO.File.Exists(dbPath2) { IO.File.Delete(dbPath2); }
}

func testSwitchBetweenInMemoryAndPersistent() {
    Terminal.Say("--- Test 3: Switch between in-memory and persistent ---");
    var dbPath = "/tmp/test_p3_switch.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec = new Executor();
    exec.init();

    // Create data in main (in-memory) database
    exec.executeSql("CREATE TABLE mem_table (id INTEGER)");
    exec.executeSql("INSERT INTO mem_table VALUES (42)");

    // Create persistent database
    exec.executeSql("CREATE DATABASE persist FILE '" + dbPath + "'");
    exec.executeSql("USE persist");
    exec.executeSql("CREATE TABLE persist_table (id INTEGER)");
    exec.executeSql("INSERT INTO persist_table VALUES (99)");

    // Switch back to main
    exec.executeSql("USE main");
    var r1 = exec.executeSql("SELECT * FROM mem_table");
    check("mem_table still has data", r1.rowCount() == 1);

    // Switch back to persist
    exec.executeSql("USE persist");
    var r2 = exec.executeSql("SELECT * FROM persist_table");
    check("persist_table has data", r2.rowCount() == 1);

    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testDuplicateDatabase() {
    Terminal.Say("--- Test 4: Duplicate database names ---");
    var dbPath = "/tmp/test_p3_dup.vdb";
    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("CREATE DATABASE dupdb FILE '" + dbPath + "'");
    check("first CREATE succeeds", r1.success);

    var r2 = exec.executeSql("CREATE DATABASE dupdb FILE '" + dbPath + "'");
    check("duplicate CREATE fails", r2.success == false);

    if IO.File.Exists(dbPath) { IO.File.Delete(dbPath); }
}

func testInMemoryDatabaseStillWorks() {
    Terminal.Say("--- Test 5: In-memory database unchanged ---");
    var exec = new Executor();
    exec.init();

    // Regular in-memory operations
    exec.executeSql("CREATE TABLE test (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO test VALUES (1, 'hello')");
    exec.executeSql("INSERT INTO test VALUES (2, 'world')");

    var r1 = exec.executeSql("SELECT * FROM test");
    check("in-memory: 2 rows", r1.rowCount() == 2);

    exec.executeSql("UPDATE test SET val = 'changed' WHERE id = 1");
    var r2 = exec.executeSql("SELECT val FROM test WHERE id = 1");
    check("in-memory: update works", r2.rowCount() == 1);

    exec.executeSql("DELETE FROM test WHERE id = 2");
    var r3 = exec.executeSql("SELECT * FROM test");
    check("in-memory: delete works", r3.rowCount() == 1);

    // SHOW DATABASES should show main
    var r4 = exec.executeSql("SHOW DATABASES");
    check("SHOW DATABASES works", r4.success);
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Phase 3: Per-Database Persistence Tests ===");
    Terminal.Say("");

    testCreateDatabaseWithFile();
    testMultiplePersistentDatabases();
    testSwitchBetweenInMemoryAndPersistent();
    testDuplicateDatabase();
    testInMemoryDatabaseStillWorks();

    printResults();
}
