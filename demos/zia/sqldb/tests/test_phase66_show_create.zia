// test_phase66_show_create.zia — Phase 66: SHOW CREATE TABLE
// DDL introspection: generate CREATE TABLE statement from table metadata.

module test_phase66_show_create;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Basic SHOW CREATE TABLE
//=========================================================================

func testBasicShowCreate() {
    section("Basic SHOW CREATE TABLE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE)");

    var r1 = exec.executeSql("SHOW CREATE TABLE users");
    assertSuccess(r1, "SHOW CREATE TABLE succeeds");
    assertRowCount(r1, 1, "1 row (the DDL)");

    // Check column names
    assertEq(r1.columnNames.get(0), "Table", "First column is Table");
    assertEq(r1.columnNames.get(1), "Create Table", "Second column is Create Table");

    // Check table name in first column
    assertEq(val(r1, 0, 0), "users", "Table name is users");

    // Check DDL contains key elements
    var ddl = val(r1, 0, 1);
    assertTrue(stringContains(ddl, "CREATE TABLE users"), "DDL contains CREATE TABLE");
    assertTrue(stringContains(ddl, "id INTEGER PRIMARY KEY"), "DDL contains id column");
    assertTrue(stringContains(ddl, "name TEXT NOT NULL"), "DDL contains name NOT NULL");
    assertTrue(stringContains(ddl, "email TEXT UNIQUE"), "DDL contains email UNIQUE");
}

//=========================================================================
// SHOW CREATE TABLE with defaults and foreign keys
//=========================================================================

func testWithDefaults() {
    section("SHOW CREATE TABLE with defaults/FK");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE departments (id INTEGER PRIMARY KEY, name TEXT NOT NULL)");
    exec.executeSql("CREATE TABLE employees (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, dept_id INTEGER REFERENCES departments(id) ON DELETE CASCADE, salary INTEGER DEFAULT 50000)");

    var r1 = exec.executeSql("SHOW CREATE TABLE employees");
    assertSuccess(r1, "SHOW CREATE TABLE employees");

    var ddl = val(r1, 0, 1);
    assertTrue(stringContains(ddl, "AUTOINCREMENT"), "DDL contains AUTOINCREMENT");
    assertTrue(stringContains(ddl, "REFERENCES departments(id)"), "DDL contains FK reference");
    assertTrue(stringContains(ddl, "ON DELETE CASCADE"), "DDL contains ON DELETE CASCADE");
    assertTrue(stringContains(ddl, "DEFAULT 50000"), "DDL contains DEFAULT");
}

//=========================================================================
// SHOW CREATE TABLE with CHECK constraint
//=========================================================================

func testWithCheck() {
    section("SHOW CREATE TABLE with CHECK");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER, price INTEGER CHECK (price > 0), name TEXT)");

    var r1 = exec.executeSql("SHOW CREATE TABLE products");
    assertSuccess(r1, "SHOW CREATE TABLE products");

    var ddl = val(r1, 0, 1);
    assertTrue(stringContains(ddl, "CHECK"), "DDL contains CHECK");
}

//=========================================================================
// SHOW CREATE TABLE with indexes
//=========================================================================

func testWithIndexes() {
    section("SHOW CREATE TABLE with indexes");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE orders (id INTEGER PRIMARY KEY, customer TEXT, amount INTEGER)");
    exec.executeSql("CREATE INDEX idx_customer ON orders (customer)");
    exec.executeSql("CREATE UNIQUE INDEX idx_id ON orders (id)");

    var r1 = exec.executeSql("SHOW CREATE TABLE orders");
    assertSuccess(r1, "SHOW CREATE TABLE with indexes");
    // Should have 3 rows: table DDL + 2 index DDLs
    assertRowCount(r1, 3, "3 rows (table + 2 indexes)");

    // First row is table DDL
    assertTrue(stringContains(val(r1, 0, 1), "CREATE TABLE orders"), "First row is table DDL");

    // Second row is index DDL
    assertTrue(stringContains(val(r1, 1, 1), "CREATE INDEX"), "Second row is index DDL");

    // Third row is unique index DDL
    assertTrue(stringContains(val(r1, 2, 1), "CREATE UNIQUE INDEX"), "Third row is unique index DDL");
}

//=========================================================================
// SHOW CREATE TABLE with generated columns
//=========================================================================

func testWithGenerated() {
    section("SHOW CREATE TABLE with generated columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (price INTEGER, qty INTEGER, total INTEGER GENERATED ALWAYS AS (price * qty) STORED)");

    var r1 = exec.executeSql("SHOW CREATE TABLE items");
    assertSuccess(r1, "SHOW CREATE TABLE items");

    var ddl = val(r1, 0, 1);
    assertTrue(stringContains(ddl, "GENERATED ALWAYS AS"), "DDL contains GENERATED ALWAYS AS");
    assertTrue(stringContains(ddl, "STORED"), "DDL contains STORED");
}

//=========================================================================
// SHOW CREATE TABLE — non-existent table
//=========================================================================

func testNonexistent() {
    section("SHOW CREATE TABLE non-existent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW CREATE TABLE nonexistent");
    assertFailure(r1, "SHOW CREATE TABLE non-existent errors");
}

//=========================================================================
// SHOW CREATE TABLE — simple types
//=========================================================================

func testAllTypes() {
    section("SHOW CREATE TABLE all types");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE typed (a INTEGER, b TEXT, c REAL, d BOOLEAN, e BLOB)");

    var r1 = exec.executeSql("SHOW CREATE TABLE typed");
    assertSuccess(r1, "SHOW CREATE TABLE typed");

    var ddl = val(r1, 0, 1);
    assertTrue(stringContains(ddl, "a INTEGER"), "DDL has INTEGER");
    assertTrue(stringContains(ddl, "b TEXT"), "DDL has TEXT");
    assertTrue(stringContains(ddl, "c REAL"), "DDL has REAL");
    assertTrue(stringContains(ddl, "d BOOLEAN"), "DDL has BOOLEAN");
    assertTrue(stringContains(ddl, "e BLOB"), "DDL has BLOB");
}

//=========================================================================
// SHOW CREATE TABLE — verify output is valid SQL
//=========================================================================

func testRoundTrip() {
    section("SHOW CREATE TABLE round-trip");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE original (id INTEGER PRIMARY KEY, name TEXT NOT NULL, score INTEGER DEFAULT 100)");
    exec.executeSql("INSERT INTO original VALUES (1, 'Alice', 95)");

    // Get the DDL
    var r1 = exec.executeSql("SHOW CREATE TABLE original");
    assertSuccess(r1, "Get DDL");

    // Drop and recreate using the DDL
    exec.executeSql("DROP TABLE original");
    var ddl = val(r1, 0, 1);
    var r2 = exec.executeSql(ddl);
    assertSuccess(r2, "Recreate from DDL");

    // Verify structure by inserting and selecting
    exec.executeSql("INSERT INTO original VALUES (1, 'Alice', 95)");
    var r3 = exec.executeSql("SELECT * FROM original");
    assertSuccess(r3, "SELECT from recreated table");
    assertRowCount(r3, 1, "1 row");
    assertEq(val(r3, 0, 1), "Alice", "Data matches");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 66: SHOW CREATE TABLE ===");

    testBasicShowCreate();
    testWithDefaults();
    testWithCheck();
    testWithIndexes();
    testWithGenerated();
    testNonexistent();
    testAllTypes();
    testRoundTrip();

    printResults();
}
