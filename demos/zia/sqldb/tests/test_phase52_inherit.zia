// test_phase52_inherit.zia — Phase 52: Table Inheritance
// Tests for CREATE TABLE ... INHERITS, ONLY modifier, polymorphic queries.

module test_phase52_inherit;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Basic INHERITS
//=========================================================================

func testBasicInherits() {
    section("Basic INHERITS");

    var exec = new Executor();
    exec.init();

    // Create parent table
    exec.executeSql("CREATE TABLE shapes (id INTEGER, color TEXT)");

    // Create child that inherits parent columns + adds own
    var r1 = exec.executeSql("CREATE TABLE circles (radius REAL) INHERITS (shapes)");
    assertSuccess(r1, "CREATE circles INHERITS shapes");

    // Insert into child table (has id, color from parent + radius)
    exec.executeSql("INSERT INTO circles VALUES (1, 'red', 3.14)");
    exec.executeSql("INSERT INTO circles VALUES (2, 'blue', 5.0)");

    // Insert into parent directly
    exec.executeSql("INSERT INTO shapes VALUES (10, 'green')");

    // Query child directly — should see all 3 columns
    var r2 = exec.executeSql("SELECT id, color, radius FROM circles ORDER BY id");
    assertSuccess(r2, "SELECT from child");
    assertRowCount(r2, 2, "2 child rows");
    assertEq(val(r2, 0, 0), "1", "child id 1");
    assertEq(val(r2, 0, 1), "red", "child color red");
    assertEq(val(r2, 0, 2), "3.14", "child radius");
}

//=========================================================================
// Polymorphic query (parent includes children)
//=========================================================================

func testPolymorphicQuery() {
    section("Polymorphic query");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE vehicles (id INTEGER, make TEXT)");
    exec.executeSql("CREATE TABLE cars (doors INTEGER) INHERITS (vehicles)");
    exec.executeSql("CREATE TABLE trucks (payload REAL) INHERITS (vehicles)");

    // Insert into parent and children
    exec.executeSql("INSERT INTO vehicles VALUES (1, 'Generic')");
    exec.executeSql("INSERT INTO cars VALUES (2, 'Toyota', 4)");
    exec.executeSql("INSERT INTO cars VALUES (3, 'Honda', 2)");
    exec.executeSql("INSERT INTO trucks VALUES (4, 'Ford', 5000.0)");

    // Query parent — should see all 4 rows (parent + both children)
    var r1 = exec.executeSql("SELECT id, make FROM vehicles ORDER BY id");
    assertSuccess(r1, "polymorphic SELECT");
    assertRowCount(r1, 4, "4 rows total");
    assertEq(val(r1, 0, 0), "1", "parent row");
    assertEq(val(r1, 0, 1), "Generic", "parent make");
    assertEq(val(r1, 1, 0), "2", "car 1");
    assertEq(val(r1, 1, 1), "Toyota", "car make");
    assertEq(val(r1, 2, 0), "3", "car 2");
    assertEq(val(r1, 3, 0), "4", "truck");
    assertEq(val(r1, 3, 1), "Ford", "truck make");
}

//=========================================================================
// ONLY modifier (exclude children)
//=========================================================================

func testOnlyModifier() {
    section("ONLY modifier");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE animals (id INTEGER, name TEXT)");
    exec.executeSql("CREATE TABLE dogs (breed TEXT) INHERITS (animals)");

    exec.executeSql("INSERT INTO animals VALUES (1, 'Cat')");
    exec.executeSql("INSERT INTO dogs VALUES (2, 'Rex', 'Lab')");
    exec.executeSql("INSERT INTO dogs VALUES (3, 'Buddy', 'Poodle')");

    // Without ONLY — see all
    var r1 = exec.executeSql("SELECT id, name FROM animals ORDER BY id");
    assertRowCount(r1, 3, "3 rows without ONLY");

    // With ONLY — only parent rows
    var r2 = exec.executeSql("SELECT id, name FROM ONLY animals ORDER BY id");
    assertSuccess(r2, "SELECT FROM ONLY");
    assertRowCount(r2, 1, "1 row with ONLY");
    assertEq(val(r2, 0, 0), "1", "only parent id");
    assertEq(val(r2, 0, 1), "Cat", "only parent name");
}

//=========================================================================
// WHERE filter on inherited query
//=========================================================================

func testWhereFilter() {
    section("WHERE on inherited");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price REAL)");
    exec.executeSql("CREATE TABLE electronics (warranty INTEGER) INHERITS (products)");

    exec.executeSql("INSERT INTO products VALUES (1, 'Chair', 49.99)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Table', 199.99)");
    exec.executeSql("INSERT INTO electronics VALUES (3, 'Laptop', 999.99, 24)");
    exec.executeSql("INSERT INTO electronics VALUES (4, 'Phone', 699.99, 12)");

    // Filter across parent + children
    var r1 = exec.executeSql("SELECT id, name FROM products WHERE price > 100 ORDER BY id");
    assertSuccess(r1, "WHERE filter");
    assertRowCount(r1, 3, "3 rows > 100");
    assertEq(val(r1, 0, 0), "2", "Table");
    assertEq(val(r1, 1, 0), "3", "Laptop");
    assertEq(val(r1, 2, 0), "4", "Phone");
}

//=========================================================================
// SELECT * from parent
//=========================================================================

func testSelectStar() {
    section("SELECT * inheritance");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE base (id INTEGER, val TEXT)");
    exec.executeSql("CREATE TABLE derived (extra INTEGER) INHERITS (base)");

    exec.executeSql("INSERT INTO base VALUES (1, 'parent')");
    exec.executeSql("INSERT INTO derived VALUES (2, 'child', 42)");

    // SELECT * from parent shows only parent columns
    var r1 = exec.executeSql("SELECT * FROM base ORDER BY id");
    assertSuccess(r1, "SELECT * from parent");
    assertRowCount(r1, 2, "2 rows");
    assertEq(val(r1, 0, 0), "1", "parent id");
    assertEq(val(r1, 0, 1), "parent", "parent val");
    assertEq(val(r1, 1, 0), "2", "child id");
    assertEq(val(r1, 1, 1), "child", "child val");
}

//=========================================================================
// Multiple inheritance levels
//=========================================================================

func testMultipleChildren() {
    section("Multiple children");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE person (id INTEGER, name TEXT)");
    exec.executeSql("CREATE TABLE employee (dept TEXT) INHERITS (person)");
    exec.executeSql("CREATE TABLE manager (level INTEGER) INHERITS (person)");

    exec.executeSql("INSERT INTO person VALUES (1, 'Alice')");
    exec.executeSql("INSERT INTO employee VALUES (2, 'Bob', 'Engineering')");
    exec.executeSql("INSERT INTO employee VALUES (3, 'Carol', 'Sales')");
    exec.executeSql("INSERT INTO manager VALUES (4, 'Dave', 3)");

    var r1 = exec.executeSql("SELECT id, name FROM person ORDER BY id");
    assertSuccess(r1, "multiple children");
    assertRowCount(r1, 4, "4 total");
    assertEq(val(r1, 0, 1), "Alice", "person");
    assertEq(val(r1, 1, 1), "Bob", "employee");
    assertEq(val(r1, 2, 1), "Carol", "employee 2");
    assertEq(val(r1, 3, 1), "Dave", "manager");
}

//=========================================================================
// Child with no extra columns
//=========================================================================

func testNoExtraColumns() {
    section("No extra columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE log_base (id INTEGER, msg TEXT)");
    exec.executeSql("CREATE TABLE error_log (severity TEXT) INHERITS (log_base)");

    exec.executeSql("INSERT INTO log_base VALUES (1, 'info msg')");
    exec.executeSql("INSERT INTO error_log VALUES (2, 'error msg', 'HIGH')");

    var r1 = exec.executeSql("SELECT * FROM log_base ORDER BY id");
    assertSuccess(r1, "no extra cols");
    assertRowCount(r1, 2, "2 rows");
    assertEq(val(r1, 1, 1), "error msg", "error from child");
}

//=========================================================================
// LIMIT on inherited query
//=========================================================================

func testLimitInherited() {
    section("LIMIT inherited");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, name TEXT)");
    exec.executeSql("CREATE TABLE special_items (bonus INTEGER) INHERITS (items)");

    exec.executeSql("INSERT INTO items VALUES (1, 'A')");
    exec.executeSql("INSERT INTO items VALUES (2, 'B')");
    exec.executeSql("INSERT INTO special_items VALUES (3, 'C', 100)");
    exec.executeSql("INSERT INTO special_items VALUES (4, 'D', 200)");

    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id LIMIT 2");
    assertSuccess(r1, "LIMIT 2");
    assertRowCount(r1, 2, "limited to 2");
    assertEq(val(r1, 0, 0), "1", "first");
    assertEq(val(r1, 1, 0), "2", "second");
}

//=========================================================================
// Error: nonexistent parent
//=========================================================================

func testNonexistentParent() {
    section("Nonexistent parent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("CREATE TABLE child (x INTEGER) INHERITS (nonexistent)");
    assertFailure(r1, "error for nonexistent parent");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 52: Table Inheritance ===");

    testBasicInherits();
    testPolymorphicQuery();
    testOnlyModifier();
    testWhereFilter();
    testSelectStar();
    testMultipleChildren();
    testNoExtraColumns();
    testLimitInherited();
    testNonexistentParent();

    printResults();
}
