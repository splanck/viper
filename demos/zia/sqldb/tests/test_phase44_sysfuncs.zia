// test_phase44_sysfuncs.zia â€” Phase 44: System Functions
// Tests for current_user, current_database, version(), current_setting(), etc.

module test_phase44_sysfuncs;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// current_user
//=========================================================================

func testCurrentUser() {
    section("current_user");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT current_user");
    assertSuccess(r1, "SELECT current_user");
    assertEq(val(r1, 0, 0), "admin", "current_user is admin");

    // Also works as a function with parentheses
    var r2 = exec.executeSql("SELECT CURRENT_USER()");
    assertSuccess(r2, "CURRENT_USER()");
    assertEq(val(r2, 0, 0), "admin", "CURRENT_USER() is admin");
}

//=========================================================================
// session_user
//=========================================================================

func testSessionUser() {
    section("session_user");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT session_user");
    assertSuccess(r1, "SELECT session_user");
    assertEq(val(r1, 0, 0), "admin", "session_user is admin");
}

//=========================================================================
// current_database
//=========================================================================

func testCurrentDatabase() {
    section("current_database");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT current_database()");
    assertSuccess(r1, "current_database()");
    assertEq(val(r1, 0, 0), "main", "current_database is main");

    // Without parens
    var r2 = exec.executeSql("SELECT current_database");
    assertSuccess(r2, "current_database no parens");
    assertEq(val(r2, 0, 0), "main", "current_database is main");
}

//=========================================================================
// current_schema
//=========================================================================

func testCurrentSchema() {
    section("current_schema");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT current_schema");
    assertSuccess(r1, "current_schema");
    assertEq(val(r1, 0, 0), "public", "current_schema is public");
}

//=========================================================================
// version()
//=========================================================================

func testVersion() {
    section("version()");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT version()");
    assertSuccess(r1, "version()");
    assertTrue(stringContains(val(r1, 0, 0), "ViperSQL"), "version contains ViperSQL");
}

//=========================================================================
// current_setting()
//=========================================================================

func testCurrentSetting() {
    section("current_setting()");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT current_setting('server_version')");
    assertSuccess(r1, "current_setting");
    assertTrue(stringContains(val(r1, 0, 0), "ViperSQL"), "setting contains ViperSQL");

    var r2 = exec.executeSql("SELECT current_setting('timezone')");
    assertEq(val(r2, 0, 0), "UTC", "timezone is UTC");
}

//=========================================================================
// set_config()
//=========================================================================

func testSetConfig() {
    section("set_config()");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT set_config('application_name', 'test_app', false)");
    assertSuccess(r1, "set_config");
    assertEq(val(r1, 0, 0), "test_app", "set_config returns value");

    var r2 = exec.executeSql("SELECT current_setting('application_name')");
    assertEq(val(r2, 0, 0), "test_app", "setting was updated");
}

//=========================================================================
// pg_backend_pid()
//=========================================================================

func testPgBackendPid() {
    section("pg_backend_pid()");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT pg_backend_pid()");
    assertSuccess(r1, "pg_backend_pid()");
    assertEq(val(r1, 0, 0), "0", "standalone session id is 0");
}

//=========================================================================
// txid_current()
//=========================================================================

func testTxidCurrent() {
    section("txid_current()");

    var exec = new Executor();
    exec.init();

    // Outside transaction should return 0
    var r1 = exec.executeSql("SELECT txid_current()");
    assertSuccess(r1, "txid_current outside txn");
    assertEq(val(r1, 0, 0), "0", "txid 0 outside txn");
}

//=========================================================================
// System functions in WHERE
//=========================================================================

func testSystemFuncsInWhere() {
    section("System functions in WHERE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE u (name TEXT, role TEXT)");
    exec.executeSql("INSERT INTO u VALUES ('admin', 'superuser')");
    exec.executeSql("INSERT INTO u VALUES ('bob', 'user')");

    var r1 = exec.executeSql("SELECT role FROM u WHERE name = current_user");
    assertSuccess(r1, "current_user in WHERE");
    assertRowCount(r1, 1, "1 matching row");
    assertEq(val(r1, 0, 0), "superuser", "admin role found");
}

//=========================================================================
// System functions in expressions
//=========================================================================

func testSystemFuncsExpr() {
    section("System functions in expressions");

    var exec = new Executor();
    exec.init();

    // Concatenation with system function
    var r1 = exec.executeSql("SELECT 'db:' || current_database()");
    assertSuccess(r1, "concat with current_database");
    assertEq(val(r1, 0, 0), "db:main", "concatenated value");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 44: System Functions ===");

    testCurrentUser();
    testSessionUser();
    testCurrentDatabase();
    testCurrentSchema();
    testVersion();
    testCurrentSetting();
    testSetConfig();
    testPgBackendPid();
    testTxidCurrent();
    testSystemFuncsInWhere();
    testSystemFuncsExpr();

    printResults();
}
