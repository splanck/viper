// test_pager_io.zia â€” Pager BinFile I/O Tests
// Part of ViperSQL Test Suite
//
// Tests the Pager's file I/O operations: create database, close/reopen,
// read/write pages, allocate new pages, and verify data persistence.
//
// Dependencies: storage/pager.zia, storage/page.zia, storage/serializer.zia

module test_pager_io;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind IO = Viper.IO;
bind Collections = Viper.Collections;

bind "./test_common";
bind "../storage/page";
bind "../storage/serializer";
bind "../storage/pager";
bind "../types";

func testCreateAndReopen() {
    section("Create and reopen database");

    var dbPath = "/tmp/test_pager_binfile.vdb";
    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    // Create database
    var pager = new Pager();
    pager.init();
    var ok = pager.createDatabase(dbPath);
    assertTrue(ok, "createDatabase succeeds");

    // Close and reopen
    pager.closeDatabase();

    var pager2 = new Pager();
    pager2.init();
    var ok2 = pager2.openDatabase(dbPath);
    assertTrue(ok2, "openDatabase succeeds");
    assertTrue(pager2.pageCount > 0, "reopened database has pages");

    // Read page 0 back
    var page = pager2.readPage(0);
    assertTrue(page != null, "readPage(0) returns non-null");

    pager2.closeDatabase();
}

func testWriteAndVerify() {
    section("Write page and verify after reopen");

    var dbPath = "/tmp/test_pager_binfile2.vdb";
    if IO.File.Exists(dbPath) {
        IO.File.Delete(dbPath);
    }

    // Create database and allocate a data page
    var pager = new Pager();
    pager.init();
    pager.createDatabase(dbPath);

    var pid = pager.allocatePage();
    assertTrue(pid > 0, "allocated page ID > 0");

    var newPage = new Page();
    newPage.initWithId(pid, PAGE_TYPE_DATA);
    newPage.data.seek(0);
    newPage.data.writeByte(PAGE_TYPE_DATA);
    newPage.data.writeInt32(42);
    newPage.markDirty();

    var wrote = pager.writePage(newPage);
    assertTrue(wrote, "writePage succeeds");

    pager.closeDatabase();

    // Reopen and verify
    var pager2 = new Pager();
    pager2.init();
    pager2.openDatabase(dbPath);

    var verifyPage = pager2.readPage(pid);
    assertTrue(verifyPage != null, "verify readPage returns non-null");
    if verifyPage != null {
        var vp = verifyPage;
        vp.data.seek(0);
        var ptype = vp.data.readByte();
        var testData = vp.data.readInt32();
        assertEqInt(ptype, PAGE_TYPE_DATA, "verified page type matches");
        assertEqInt(testData, 42, "verified test data matches");
    }

    pager2.closeDatabase();
}

func main() -> Integer {
    Terminal.Say("=== Pager BinFile I/O Tests ===");

    testCreateAndReopen();
    testWriteAndVerify();

    printResults();
    return 0;
}
