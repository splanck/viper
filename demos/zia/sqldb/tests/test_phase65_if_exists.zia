// test_phase65_if_exists.zia — Phase 65: IF EXISTS / IF NOT EXISTS / CREATE OR REPLACE
// Defensive DDL: prevent errors when objects already exist or don't exist.

module test_phase65_if_exists;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// DROP TABLE IF EXISTS
//=========================================================================

func testDropTableIfExists() {
    section("DROP TABLE IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent table without IF EXISTS -> error
    var r1 = exec.executeSql("DROP TABLE nonexistent");
    assertFailure(r1, "DROP TABLE without IF EXISTS errors");

    // Drop non-existent table with IF EXISTS -> success (no error)
    var r2 = exec.executeSql("DROP TABLE IF EXISTS nonexistent");
    assertSuccess(r2, "DROP TABLE IF EXISTS succeeds");

    // Create a table, then drop with IF EXISTS -> normal drop
    exec.executeSql("CREATE TABLE dropme (id INTEGER)");
    var r3 = exec.executeSql("DROP TABLE IF EXISTS dropme");
    assertSuccess(r3, "DROP TABLE IF EXISTS on existing table");

    // Verify it's really gone
    var r4 = exec.executeSql("SELECT * FROM dropme");
    assertFailure(r4, "Table actually dropped");

    // Double-drop with IF EXISTS -> still succeeds
    var r5 = exec.executeSql("DROP TABLE IF EXISTS dropme");
    assertSuccess(r5, "Double DROP IF EXISTS succeeds");
}

//=========================================================================
// CREATE TABLE IF NOT EXISTS
//=========================================================================

func testCreateTableIfNotExists() {
    section("CREATE TABLE IF NOT EXISTS");

    var exec = new Executor();
    exec.init();

    // Create a table normally
    var r1 = exec.executeSql("CREATE TABLE t1 (id INTEGER, name TEXT)");
    assertSuccess(r1, "CREATE TABLE t1");

    // Create same table without IF NOT EXISTS -> error
    var r2 = exec.executeSql("CREATE TABLE t1 (id INTEGER)");
    assertFailure(r2, "CREATE TABLE without IF NOT EXISTS errors");

    // Create same table with IF NOT EXISTS -> success (no error)
    var r3 = exec.executeSql("CREATE TABLE IF NOT EXISTS t1 (id INTEGER)");
    assertSuccess(r3, "CREATE TABLE IF NOT EXISTS succeeds");

    // Original table is unchanged (still has 2 columns)
    exec.executeSql("INSERT INTO t1 VALUES (1, 'Alice')");
    var r4 = exec.executeSql("SELECT * FROM t1");
    assertSuccess(r4, "SELECT from original table");
    assertRowCount(r4, 1, "1 row inserted");

    // Create a new table with IF NOT EXISTS (doesn't exist) -> creates it
    var r5 = exec.executeSql("CREATE TABLE IF NOT EXISTS t2 (val INTEGER)");
    assertSuccess(r5, "CREATE TABLE IF NOT EXISTS new table");
    exec.executeSql("INSERT INTO t2 VALUES (42)");
    var r6 = exec.executeSql("SELECT val FROM t2");
    assertSuccess(r6, "SELECT from new table");
    assertEq(val(r6, 0, 0), "42", "New table has data");
}

//=========================================================================
// DROP INDEX IF EXISTS
//=========================================================================

func testDropIndexIfExists() {
    section("DROP INDEX IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent index without IF EXISTS -> error
    var r1 = exec.executeSql("DROP INDEX nonexistent");
    assertFailure(r1, "DROP INDEX without IF EXISTS errors");

    // Drop non-existent index with IF EXISTS -> success
    var r2 = exec.executeSql("DROP INDEX IF EXISTS nonexistent");
    assertSuccess(r2, "DROP INDEX IF EXISTS succeeds");

    // Create an index, then drop with IF EXISTS
    exec.executeSql("CREATE TABLE idx_test (id INTEGER, val INTEGER)");
    exec.executeSql("CREATE INDEX idx_val ON idx_test (val)");
    var r3 = exec.executeSql("DROP INDEX IF EXISTS idx_val");
    assertSuccess(r3, "DROP INDEX IF EXISTS on existing index");

    // Double-drop -> still succeeds
    var r4 = exec.executeSql("DROP INDEX IF EXISTS idx_val");
    assertSuccess(r4, "Double DROP INDEX IF EXISTS succeeds");
}

//=========================================================================
// CREATE INDEX IF NOT EXISTS
//=========================================================================

func testCreateIndexIfNotExists() {
    section("CREATE INDEX IF NOT EXISTS");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t_idx (id INTEGER, val INTEGER)");
    exec.executeSql("CREATE INDEX idx1 ON t_idx (val)");

    // Create same index with IF NOT EXISTS -> success
    var r1 = exec.executeSql("CREATE INDEX IF NOT EXISTS idx1 ON t_idx (val)");
    assertSuccess(r1, "CREATE INDEX IF NOT EXISTS succeeds");

    // Create new index with IF NOT EXISTS (doesn't exist) -> creates it
    var r2 = exec.executeSql("CREATE INDEX IF NOT EXISTS idx2 ON t_idx (id)");
    assertSuccess(r2, "CREATE INDEX IF NOT EXISTS new index");
}

//=========================================================================
// DROP VIEW IF EXISTS
//=========================================================================

func testDropViewIfExists() {
    section("DROP VIEW IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent view without IF EXISTS -> error
    var r1 = exec.executeSql("DROP VIEW nonexistent");
    assertFailure(r1, "DROP VIEW without IF EXISTS errors");

    // Drop non-existent view with IF EXISTS -> success
    var r2 = exec.executeSql("DROP VIEW IF EXISTS nonexistent");
    assertSuccess(r2, "DROP VIEW IF EXISTS succeeds");

    // Create a view, then drop with IF EXISTS
    exec.executeSql("CREATE TABLE v_data (id INTEGER, val TEXT)");
    exec.executeSql("CREATE VIEW v_test AS SELECT * FROM v_data");
    var r3 = exec.executeSql("DROP VIEW IF EXISTS v_test");
    assertSuccess(r3, "DROP VIEW IF EXISTS on existing view");

    // Double-drop -> still succeeds
    var r4 = exec.executeSql("DROP VIEW IF EXISTS v_test");
    assertSuccess(r4, "Double DROP VIEW IF EXISTS succeeds");
}

//=========================================================================
// CREATE OR REPLACE VIEW
//=========================================================================

func testCreateOrReplaceView() {
    section("CREATE OR REPLACE VIEW");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 10)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 20)");
    exec.executeSql("INSERT INTO products VALUES (3, 'Doohickey', 30)");

    // Create a view
    exec.executeSql("CREATE VIEW cheap AS SELECT * FROM products WHERE price <= 20");
    var r1 = exec.executeSql("SELECT * FROM cheap");
    assertSuccess(r1, "Original view");
    assertRowCount(r1, 2, "2 cheap products");

    // CREATE VIEW without OR REPLACE -> error
    var r2 = exec.executeSql("CREATE VIEW cheap AS SELECT * FROM products WHERE price <= 10");
    assertFailure(r2, "CREATE VIEW without OR REPLACE errors");

    // CREATE OR REPLACE VIEW -> replaces the view
    var r3 = exec.executeSql("CREATE OR REPLACE VIEW cheap AS SELECT * FROM products WHERE price <= 10");
    assertSuccess(r3, "CREATE OR REPLACE VIEW succeeds");

    // Verify the replacement
    var r4 = exec.executeSql("SELECT * FROM cheap");
    assertSuccess(r4, "Replaced view works");
    assertRowCount(r4, 1, "1 cheap product after replacement");
    assertEq(val(r4, 0, 1), "Widget", "Only Widget is <= 10");

    // CREATE OR REPLACE on non-existent view -> creates normally
    var r5 = exec.executeSql("CREATE OR REPLACE VIEW expensive AS SELECT * FROM products WHERE price > 20");
    assertSuccess(r5, "CREATE OR REPLACE VIEW new view");
    var r6 = exec.executeSql("SELECT * FROM expensive");
    assertSuccess(r6, "New view works");
    assertRowCount(r6, 1, "1 expensive product");
}

//=========================================================================
// CREATE OR REPLACE FUNCTION
//=========================================================================

func testCreateOrReplaceFunction() {
    section("CREATE OR REPLACE FUNCTION");

    var exec = new Executor();
    exec.init();

    // Create a function
    exec.executeSql("CREATE FUNCTION DOUBLE(x INTEGER) RETURNS INTEGER AS 'SELECT x * 2'");

    // CREATE FUNCTION without OR REPLACE -> error
    var r1 = exec.executeSql("CREATE FUNCTION DOUBLE(x INTEGER) RETURNS INTEGER AS 'SELECT x * 3'");
    assertFailure(r1, "CREATE FUNCTION without OR REPLACE errors");

    // CREATE OR REPLACE FUNCTION -> replaces it
    var r2 = exec.executeSql("CREATE OR REPLACE FUNCTION DOUBLE(x INTEGER) RETURNS INTEGER AS 'SELECT x * 3'");
    assertSuccess(r2, "CREATE OR REPLACE FUNCTION succeeds");

    // CREATE OR REPLACE on non-existent function -> creates normally
    var r3 = exec.executeSql("CREATE OR REPLACE FUNCTION TRIPLE(x INTEGER) RETURNS INTEGER AS 'SELECT x * 3'");
    assertSuccess(r3, "CREATE OR REPLACE FUNCTION new function");
}

//=========================================================================
// DROP DATABASE IF EXISTS
//=========================================================================

func testDropDatabaseIfExists() {
    section("DROP DATABASE IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent database without IF EXISTS -> error
    var r1 = exec.executeSql("DROP DATABASE nonexistent");
    assertFailure(r1, "DROP DATABASE without IF EXISTS errors");

    // Drop non-existent database with IF EXISTS -> success
    var r2 = exec.executeSql("DROP DATABASE IF EXISTS nonexistent");
    assertSuccess(r2, "DROP DATABASE IF EXISTS succeeds");
}

//=========================================================================
// DROP TRIGGER IF EXISTS
//=========================================================================

func testDropTriggerIfExists() {
    section("DROP TRIGGER IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent trigger without IF EXISTS -> error
    var r1 = exec.executeSql("DROP TRIGGER nonexistent");
    assertFailure(r1, "DROP TRIGGER without IF EXISTS errors");

    // Drop non-existent trigger with IF EXISTS -> success
    var r2 = exec.executeSql("DROP TRIGGER IF EXISTS nonexistent");
    assertSuccess(r2, "DROP TRIGGER IF EXISTS succeeds");
}

//=========================================================================
// DROP SEQUENCE IF EXISTS
//=========================================================================

func testDropSequenceIfExists() {
    section("DROP SEQUENCE IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent sequence without IF EXISTS -> error
    var r1 = exec.executeSql("DROP SEQUENCE nonexistent");
    assertFailure(r1, "DROP SEQUENCE without IF EXISTS errors");

    // Drop non-existent sequence with IF EXISTS -> success
    var r2 = exec.executeSql("DROP SEQUENCE IF EXISTS nonexistent");
    assertSuccess(r2, "DROP SEQUENCE IF EXISTS succeeds");
}

//=========================================================================
// DROP FUNCTION IF EXISTS
//=========================================================================

func testDropFunctionIfExists() {
    section("DROP FUNCTION IF EXISTS");

    var exec = new Executor();
    exec.init();

    // Drop non-existent function without IF EXISTS -> error
    var r1 = exec.executeSql("DROP FUNCTION nonexistent");
    assertFailure(r1, "DROP FUNCTION without IF EXISTS errors");

    // Drop non-existent function with IF EXISTS -> success
    var r2 = exec.executeSql("DROP FUNCTION IF EXISTS nonexistent");
    assertSuccess(r2, "DROP FUNCTION IF EXISTS succeeds");
}

//=========================================================================
// Idempotent DDL script pattern
//=========================================================================

func testIdempotentScript() {
    section("Idempotent DDL script");

    var exec = new Executor();
    exec.init();

    // A script that can be run multiple times safely
    exec.executeSql("DROP TABLE IF EXISTS users");
    exec.executeSql("CREATE TABLE IF NOT EXISTS users (id INTEGER, name TEXT)");
    exec.executeSql("DROP INDEX IF EXISTS idx_users_name");
    exec.executeSql("CREATE INDEX IF NOT EXISTS idx_users_name ON users (name)");
    exec.executeSql("INSERT INTO users VALUES (1, 'Alice')");

    var r1 = exec.executeSql("SELECT * FROM users");
    assertSuccess(r1, "First run");
    assertRowCount(r1, 1, "1 user");

    // Run same script again — should not error
    var r2 = exec.executeSql("DROP TABLE IF EXISTS users");
    assertSuccess(r2, "Idempotent drop succeeds");

    var r3 = exec.executeSql("CREATE TABLE IF NOT EXISTS users (id INTEGER, name TEXT)");
    // Table was dropped, so this creates it fresh
    assertSuccess(r3, "Idempotent create succeeds");

    var r4 = exec.executeSql("CREATE INDEX IF NOT EXISTS idx_users_name ON users (name)");
    assertSuccess(r4, "Idempotent index succeeds");
}

//=========================================================================
// Regression: normal CREATE/DROP still work
//=========================================================================

func testRegressionNormalDDL() {
    section("Regression: normal DDL");

    var exec = new Executor();
    exec.init();

    // Normal CREATE TABLE still works
    var r1 = exec.executeSql("CREATE TABLE normal (id INTEGER)");
    assertSuccess(r1, "Normal CREATE TABLE");

    // Normal DROP TABLE still works
    var r2 = exec.executeSql("DROP TABLE normal");
    assertSuccess(r2, "Normal DROP TABLE");

    // Normal CREATE/DROP VIEW still works
    exec.executeSql("CREATE TABLE base_data (id INTEGER)");
    var r3 = exec.executeSql("CREATE VIEW v AS SELECT * FROM base_data");
    assertSuccess(r3, "Normal CREATE VIEW");
    var r4 = exec.executeSql("DROP VIEW v");
    assertSuccess(r4, "Normal DROP VIEW");

    // Normal CREATE/DROP INDEX still works
    var r5 = exec.executeSql("CREATE INDEX idx ON base_data (id)");
    assertSuccess(r5, "Normal CREATE INDEX");
    var r6 = exec.executeSql("DROP INDEX idx");
    assertSuccess(r6, "Normal DROP INDEX");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 65: IF EXISTS / IF NOT EXISTS / CREATE OR REPLACE ===");

    testDropTableIfExists();
    testCreateTableIfNotExists();
    testDropIndexIfExists();
    testCreateIndexIfNotExists();
    testDropViewIfExists();
    testCreateOrReplaceView();
    testCreateOrReplaceFunction();
    testDropDatabaseIfExists();
    testDropTriggerIfExists();
    testDropSequenceIfExists();
    testDropFunctionIfExists();
    testIdempotentScript();
    testRegressionNormalDDL();

    printResults();
}
