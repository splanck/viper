// test_phase55_lateral.zia — Phase 55: LATERAL Joins
// Tests for LATERAL subquery joins.

module test_phase55_lateral;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupData() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE departments (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO departments VALUES (1, 'Engineering')");
    exec.executeSql("INSERT INTO departments VALUES (2, 'Sales')");
    exec.executeSql("INSERT INTO departments VALUES (3, 'Marketing')");

    exec.executeSql("CREATE TABLE employees (id INTEGER, name TEXT, dept_id INTEGER, salary INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 1, 120)");
    exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 1, 100)");
    exec.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 2, 90)");
    exec.executeSql("INSERT INTO employees VALUES (4, 'Diana', 1, 110)");
    exec.executeSql("INSERT INTO employees VALUES (5, 'Eve', 2, 95)");
    exec.executeSql("INSERT INTO employees VALUES (6, 'Frank', 3, 80)");

    return exec;
}

//=========================================================================
// Basic LATERAL with comma syntax
//=========================================================================

func testBasicLateral() {
    section("Basic LATERAL");

    var exec = setupData();

    // For each department, get employees in that department
    var r1 = exec.executeSql("SELECT d.name, e.name FROM departments d, LATERAL (SELECT name FROM employees WHERE dept_id = d.id ORDER BY name) e");
    assertSuccess(r1, "basic LATERAL");
    // Engineering: Alice, Bob, Diana; Sales: Charlie, Eve; Marketing: Frank
    assertRowCount(r1, 6, "6 rows total");
}

//=========================================================================
// LATERAL with LIMIT (top-N per group)
//=========================================================================

func testLateralLimit() {
    section("LATERAL with LIMIT");

    var exec = setupData();

    // Top-2 highest paid employees per department
    var r1 = exec.executeSql("SELECT d.name, e.name, e.salary FROM departments d, LATERAL (SELECT name, salary FROM employees WHERE dept_id = d.id ORDER BY salary DESC LIMIT 2) e");
    assertSuccess(r1, "LATERAL LIMIT");
    // Engineering: Alice(120), Diana(110); Sales: Eve(95), Charlie(90); Marketing: Frank(80)
    assertRowCount(r1, 5, "5 rows (2+2+1)");
}

//=========================================================================
// LATERAL with aggregate
//=========================================================================

func testLateralAggregate() {
    section("LATERAL with aggregate");

    var exec = setupData();

    // Count and sum for each department
    var r1 = exec.executeSql("SELECT d.name, sub.cnt, sub.total FROM departments d, LATERAL (SELECT COUNT(*) AS cnt, SUM(salary) AS total FROM employees WHERE dept_id = d.id) sub");
    assertSuccess(r1, "LATERAL aggregate");
    assertRowCount(r1, 3, "3 departments");
    // Engineering: 3 employees, salary 330
    assertEq(val(r1, 0, 0), "Engineering", "Engineering");
    assertEq(val(r1, 0, 1), "3", "Eng count = 3");
    assertEq(val(r1, 0, 2), "330", "Eng total = 330");
    // Sales: 2 employees, salary 185
    assertEq(val(r1, 1, 0), "Sales", "Sales");
    assertEq(val(r1, 1, 1), "2", "Sales count = 2");
    assertEq(val(r1, 1, 2), "185", "Sales total = 185");
    // Marketing: 1 employee, salary 80
    assertEq(val(r1, 2, 0), "Marketing", "Marketing");
    assertEq(val(r1, 2, 1), "1", "Mkt count = 1");
    assertEq(val(r1, 2, 2), "80", "Mkt total = 80");
}

//=========================================================================
// LEFT JOIN LATERAL
//=========================================================================

func testLeftJoinLateral() {
    section("LEFT JOIN LATERAL");

    var exec = setupData();
    exec.executeSql("INSERT INTO departments VALUES (4, 'Legal')");

    // LEFT JOIN LATERAL — Legal dept has no employees, should still show
    var r1 = exec.executeSql("SELECT d.name, sub.cnt FROM departments d LEFT JOIN LATERAL (SELECT COUNT(*) AS cnt FROM employees WHERE dept_id = d.id) sub ON true ORDER BY d.name");
    assertSuccess(r1, "LEFT JOIN LATERAL");
    assertRowCount(r1, 4, "4 departments");
    // Alphabetical: Engineering, Legal, Marketing, Sales
    assertEq(val(r1, 0, 0), "Engineering", "Eng");
    assertEq(val(r1, 0, 1), "3", "Eng count");
    assertEq(val(r1, 1, 0), "Legal", "Legal");
    // Legal has COUNT(*) = 0, not NULL (since COUNT returns 0 for empty set)
    assertEq(val(r1, 1, 1), "0", "Legal count = 0");
}

//=========================================================================
// CROSS JOIN LATERAL
//=========================================================================

func testCrossJoinLateral() {
    section("CROSS JOIN LATERAL");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT d.name, e.name FROM departments d CROSS JOIN LATERAL (SELECT name FROM employees WHERE dept_id = d.id ORDER BY name LIMIT 1) e");
    assertSuccess(r1, "CROSS JOIN LATERAL");
    // First employee per dept: Alice, Charlie, Frank
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 1), "Alice", "Eng first = Alice");
    assertEq(val(r1, 1, 1), "Charlie", "Sales first = Charlie");
    assertEq(val(r1, 2, 1), "Frank", "Mkt first = Frank");
}

//=========================================================================
// LATERAL with expression in subquery
//=========================================================================

func testLateralExpression() {
    section("LATERAL with expression");

    var exec = setupData();

    // Compute salary as percentage of max in department
    var r1 = exec.executeSql("SELECT d.name, sub.max_sal FROM departments d, LATERAL (SELECT MAX(salary) AS max_sal FROM employees WHERE dept_id = d.id) sub");
    assertSuccess(r1, "LATERAL expression");
    assertRowCount(r1, 3, "3 departments");
    assertEq(val(r1, 0, 1), "120", "Eng max = 120");
    assertEq(val(r1, 1, 1), "95", "Sales max = 95");
    assertEq(val(r1, 2, 1), "80", "Mkt max = 80");
}

//=========================================================================
// LATERAL with no matching rows (CROSS JOIN skips)
//=========================================================================

func testLateralNoMatch() {
    section("LATERAL no match");

    var exec = setupData();
    exec.executeSql("INSERT INTO departments VALUES (4, 'Legal')");

    // CROSS JOIN with LATERAL — Legal has no employees, so no row for Legal
    var r1 = exec.executeSql("SELECT d.name, e.name FROM departments d, LATERAL (SELECT name FROM employees WHERE dept_id = d.id AND salary > 200) e");
    assertSuccess(r1, "LATERAL no match");
    // No employee has salary > 200, so no rows
    assertRowCount(r1, 0, "0 rows");
}

//=========================================================================
// LATERAL with multiple columns
//=========================================================================

func testLateralMultiColumn() {
    section("LATERAL multiple columns");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT d.id, sub.ename, sub.sal FROM departments d, LATERAL (SELECT name AS ename, salary AS sal FROM employees WHERE dept_id = d.id ORDER BY salary DESC LIMIT 1) sub");
    assertSuccess(r1, "LATERAL multi-column");
    assertRowCount(r1, 3, "3 rows");
    // Eng top: Alice(120)
    assertEq(val(r1, 0, 0), "1", "dept 1");
    assertEq(val(r1, 0, 1), "Alice", "Alice");
    assertEq(val(r1, 0, 2), "120", "120");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 55: LATERAL Joins ===");

    testBasicLateral();
    testLateralLimit();
    testLateralAggregate();
    testLeftJoinLateral();
    testCrossJoinLateral();
    testLateralExpression();
    testLateralNoMatch();
    testLateralMultiColumn();

    printResults();
}
