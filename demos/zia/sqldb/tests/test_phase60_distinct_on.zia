// test_phase60_distinct_on.zia — Phase 60: SELECT DISTINCT ON
// Tests for PostgreSQL-style DISTINCT ON (expr) which returns the
// first row for each unique value of the expression.

module test_phase60_distinct_on;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE employees (dept TEXT, name TEXT, salary INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES ('Sales', 'Alice', 50000)");
    exec.executeSql("INSERT INTO employees VALUES ('Sales', 'Bob', 60000)");
    exec.executeSql("INSERT INTO employees VALUES ('Sales', 'Charlie', 45000)");
    exec.executeSql("INSERT INTO employees VALUES ('Eng', 'Diana', 80000)");
    exec.executeSql("INSERT INTO employees VALUES ('Eng', 'Eve', 90000)");
    exec.executeSql("INSERT INTO employees VALUES ('Eng', 'Frank', 75000)");
    exec.executeSql("INSERT INTO employees VALUES ('HR', 'Grace', 55000)");
    exec.executeSql("INSERT INTO employees VALUES ('HR', 'Heidi', 52000)");

    return exec;
}

//=========================================================================
// DISTINCT ON single column — highest salary per department
//=========================================================================

func testDistinctOnBasic() {
    section("DISTINCT ON (dept) basic");

    var exec = setupExec();

    // Get one row per department, ordered by salary DESC (highest first)
    var r1 = exec.executeSql("SELECT DISTINCT ON (dept) dept, name, salary FROM employees ORDER BY dept, salary DESC");
    assertSuccess(r1, "DISTINCT ON basic");
    assertRowCount(r1, 3, "3 departments");

    // Eng highest = Eve(90000), HR highest = Grace(55000), Sales highest = Bob(60000)
    assertEq(val(r1, 0, 0), "Eng", "first dept = Eng");
    assertEq(val(r1, 0, 1), "Eve", "Eng highest = Eve");
    assertEq(val(r1, 0, 2), "90000", "Eve salary");

    assertEq(val(r1, 1, 0), "HR", "second dept = HR");
    assertEq(val(r1, 1, 1), "Grace", "HR highest = Grace");
    assertEq(val(r1, 1, 2), "55000", "Grace salary");

    assertEq(val(r1, 2, 0), "Sales", "third dept = Sales");
    assertEq(val(r1, 2, 1), "Bob", "Sales highest = Bob");
    assertEq(val(r1, 2, 2), "60000", "Bob salary");
}

//=========================================================================
// DISTINCT ON — lowest salary per department
//=========================================================================

func testDistinctOnLowest() {
    section("DISTINCT ON (dept) lowest salary");

    var exec = setupExec();

    // ORDER BY dept, salary ASC → lowest salary first per dept
    var r1 = exec.executeSql("SELECT DISTINCT ON (dept) dept, name, salary FROM employees ORDER BY dept, salary");
    assertSuccess(r1, "DISTINCT ON lowest");
    assertRowCount(r1, 3, "3 departments");

    assertEq(val(r1, 0, 1), "Frank", "Eng lowest = Frank");
    assertEq(val(r1, 0, 2), "75000", "Frank salary");
    assertEq(val(r1, 1, 1), "Heidi", "HR lowest = Heidi");
    assertEq(val(r1, 1, 2), "52000", "Heidi salary");
    assertEq(val(r1, 2, 1), "Charlie", "Sales lowest = Charlie");
    assertEq(val(r1, 2, 2), "45000", "Charlie salary");
}

//=========================================================================
// DISTINCT ON with single group (all same value)
//=========================================================================

func testDistinctOnSingleGroup() {
    section("DISTINCT ON single group");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t (grp TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES ('A', 1)");
    exec.executeSql("INSERT INTO t VALUES ('A', 2)");
    exec.executeSql("INSERT INTO t VALUES ('A', 3)");

    var r1 = exec.executeSql("SELECT DISTINCT ON (grp) grp, val FROM t ORDER BY grp, val DESC");
    assertSuccess(r1, "single group");
    assertRowCount(r1, 1, "1 group");
    assertEq(val(r1, 0, 1), "3", "highest val = 3");
}

//=========================================================================
// DISTINCT ON with no duplicates (no-op)
//=========================================================================

func testDistinctOnNoDupes() {
    section("DISTINCT ON no duplicates");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO t VALUES (1, 'Alice')");
    exec.executeSql("INSERT INTO t VALUES (2, 'Bob')");
    exec.executeSql("INSERT INTO t VALUES (3, 'Charlie')");

    var r1 = exec.executeSql("SELECT DISTINCT ON (id) id, name FROM t ORDER BY id");
    assertSuccess(r1, "no dupes");
    assertRowCount(r1, 3, "all 3 rows (no duplication)");
}

//=========================================================================
// DISTINCT ON with LIMIT
//=========================================================================

func testDistinctOnWithLimit() {
    section("DISTINCT ON with LIMIT");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT DISTINCT ON (dept) dept, name, salary FROM employees ORDER BY dept, salary DESC LIMIT 2");
    assertSuccess(r1, "DISTINCT ON + LIMIT");
    assertRowCount(r1, 2, "2 rows with LIMIT 2");
    assertEq(val(r1, 0, 0), "Eng", "first = Eng");
    assertEq(val(r1, 1, 0), "HR", "second = HR");
}

//=========================================================================
// DISTINCT ON with WHERE
//=========================================================================

func testDistinctOnWithWhere() {
    section("DISTINCT ON with WHERE");

    var exec = setupExec();

    // Only consider employees with salary > 50000
    var r1 = exec.executeSql("SELECT DISTINCT ON (dept) dept, name, salary FROM employees WHERE salary > 50000 ORDER BY dept, salary DESC");
    assertSuccess(r1, "DISTINCT ON + WHERE");
    // Eng: Eve(90000), Diana(80000), Frank(75000) → Eve
    // HR: Grace(55000), Heidi(52000) → Grace
    // Sales: Bob(60000) → Bob
    assertRowCount(r1, 3, "3 departments");
    assertEq(val(r1, 0, 1), "Eve", "Eng = Eve");
    assertEq(val(r1, 1, 1), "Grace", "HR = Grace");
    assertEq(val(r1, 2, 1), "Bob", "Sales = Bob");
}

//=========================================================================
// DISTINCT ON integer column
//=========================================================================

func testDistinctOnInteger() {
    section("DISTINCT ON integer column");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (student_id INTEGER, subject TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES (1, 'Math', 95)");
    exec.executeSql("INSERT INTO scores VALUES (1, 'Science', 88)");
    exec.executeSql("INSERT INTO scores VALUES (1, 'English', 92)");
    exec.executeSql("INSERT INTO scores VALUES (2, 'Math', 78)");
    exec.executeSql("INSERT INTO scores VALUES (2, 'Science', 85)");
    exec.executeSql("INSERT INTO scores VALUES (2, 'English', 90)");

    // Best subject per student
    var r1 = exec.executeSql("SELECT DISTINCT ON (student_id) student_id, subject, score FROM scores ORDER BY student_id, score DESC");
    assertSuccess(r1, "DISTINCT ON integer");
    assertRowCount(r1, 2, "2 students");
    assertEq(val(r1, 0, 1), "Math", "student 1 best = Math");
    assertEq(val(r1, 0, 2), "95", "score 95");
    assertEq(val(r1, 1, 1), "English", "student 2 best = English");
    assertEq(val(r1, 1, 2), "90", "score 90");
}

//=========================================================================
// DISTINCT ON with multiple ON columns
//=========================================================================

func testDistinctOnMultiple() {
    section("DISTINCT ON multiple columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE log (day TEXT, category TEXT, event TEXT, priority INTEGER)");
    exec.executeSql("INSERT INTO log VALUES ('Mon', 'Error', 'crash', 10)");
    exec.executeSql("INSERT INTO log VALUES ('Mon', 'Error', 'timeout', 5)");
    exec.executeSql("INSERT INTO log VALUES ('Mon', 'Warn', 'slow', 3)");
    exec.executeSql("INSERT INTO log VALUES ('Tue', 'Error', 'oom', 8)");
    exec.executeSql("INSERT INTO log VALUES ('Tue', 'Error', 'disk', 4)");
    exec.executeSql("INSERT INTO log VALUES ('Tue', 'Warn', 'lag', 2)");

    // Highest priority per (day, category) pair
    var r1 = exec.executeSql("SELECT DISTINCT ON (day, category) day, category, event, priority FROM log ORDER BY day, category, priority DESC");
    assertSuccess(r1, "DISTINCT ON multi");
    assertRowCount(r1, 4, "4 (day, category) pairs");
    // Mon/Error: crash(10), Mon/Warn: slow(3), Tue/Error: oom(8), Tue/Warn: lag(2)
    assertEq(val(r1, 0, 2), "crash", "Mon/Error = crash");
    assertEq(val(r1, 1, 2), "slow", "Mon/Warn = slow");
    assertEq(val(r1, 2, 2), "oom", "Tue/Error = oom");
    assertEq(val(r1, 3, 2), "lag", "Tue/Warn = lag");
}

//=========================================================================
// DISTINCT ON without explicit ORDER BY (arbitrary first row)
//=========================================================================

func testDistinctOnNoOrder() {
    section("DISTINCT ON without ORDER BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t (grp TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES ('A', 1)");
    exec.executeSql("INSERT INTO t VALUES ('A', 2)");
    exec.executeSql("INSERT INTO t VALUES ('B', 3)");
    exec.executeSql("INSERT INTO t VALUES ('B', 4)");

    // Without ORDER BY, gets first inserted row per group
    var r1 = exec.executeSql("SELECT DISTINCT ON (grp) grp, val FROM t");
    assertSuccess(r1, "no ORDER BY");
    assertRowCount(r1, 2, "2 groups");
    assertEq(val(r1, 0, 0), "A", "group A");
    assertEq(val(r1, 0, 1), "1", "first A val = 1");
    assertEq(val(r1, 1, 0), "B", "group B");
    assertEq(val(r1, 1, 1), "3", "first B val = 3");
}

//=========================================================================
// DISTINCT ON with SELECT *
//=========================================================================

func testDistinctOnSelectAll() {
    section("DISTINCT ON with SELECT *");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t (dept TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO t VALUES ('X', 10)");
    exec.executeSql("INSERT INTO t VALUES ('X', 20)");
    exec.executeSql("INSERT INTO t VALUES ('Y', 30)");

    var r1 = exec.executeSql("SELECT DISTINCT ON (dept) * FROM t ORDER BY dept, val DESC");
    assertSuccess(r1, "SELECT * DISTINCT ON");
    assertRowCount(r1, 2, "2 groups");
    assertEq(val(r1, 0, 1), "20", "X highest = 20");
    assertEq(val(r1, 1, 1), "30", "Y = 30");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 60: SELECT DISTINCT ON ===");

    testDistinctOnBasic();
    testDistinctOnLowest();
    testDistinctOnSingleGroup();
    testDistinctOnNoDupes();
    testDistinctOnWithLimit();
    testDistinctOnWithWhere();
    testDistinctOnInteger();
    testDistinctOnMultiple();
    testDistinctOnNoOrder();
    testDistinctOnSelectAll();

    printResults();
}
