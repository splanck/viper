// test_phase53_generated.zia â€” Phase 53: Generated Columns
// Tests for GENERATED ALWAYS AS (expr) STORED columns.

module test_phase53_generated;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Basic generated column
//=========================================================================

func testBasicGenerated() {
    section("Basic generated column");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("CREATE TABLE t1 (a INTEGER, b INTEGER, c INTEGER GENERATED ALWAYS AS (a + b) STORED)");
    assertSuccess(r1, "CREATE TABLE with generated col");

    exec.executeSql("INSERT INTO t1 (a, b) VALUES (3, 5)");
    var r2 = exec.executeSql("SELECT a, b, c FROM t1");
    assertSuccess(r2, "SELECT with generated col");
    assertRowCount(r2, 1, "1 row");
    assertEq(val(r2, 0, 0), "3", "a = 3");
    assertEq(val(r2, 0, 1), "5", "b = 5");
    assertEq(val(r2, 0, 2), "8", "c = 3 + 5 = 8");
}

//=========================================================================
// Positional INSERT (no column list)
//=========================================================================

func testPositionalInsert() {
    section("Positional INSERT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t2 (x INTEGER, y INTEGER, z INTEGER GENERATED ALWAYS AS (x * y) STORED)");

    // Positional INSERT should skip generated column
    exec.executeSql("INSERT INTO t2 VALUES (4, 7)");
    var r1 = exec.executeSql("SELECT x, y, z FROM t2");
    assertSuccess(r1, "positional insert");
    assertEq(val(r1, 0, 0), "4", "x = 4");
    assertEq(val(r1, 0, 1), "7", "y = 7");
    assertEq(val(r1, 0, 2), "28", "z = 4 * 7 = 28");
}

//=========================================================================
// Multiple rows
//=========================================================================

func testMultipleRows() {
    section("Multiple rows");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t3 (a INTEGER, b INTEGER, total INTEGER GENERATED ALWAYS AS (a + b) STORED)");
    exec.executeSql("INSERT INTO t3 (a, b) VALUES (1, 2)");
    exec.executeSql("INSERT INTO t3 (a, b) VALUES (10, 20)");
    exec.executeSql("INSERT INTO t3 (a, b) VALUES (100, 200)");

    var r1 = exec.executeSql("SELECT a, b, total FROM t3 ORDER BY a");
    assertSuccess(r1, "multiple rows");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 2), "3", "1 + 2 = 3");
    assertEq(val(r1, 1, 2), "30", "10 + 20 = 30");
    assertEq(val(r1, 2, 2), "300", "100 + 200 = 300");
}

//=========================================================================
// UPDATE recomputes generated column
//=========================================================================

func testUpdateRecomputes() {
    section("UPDATE recomputes");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t4 (price INTEGER, qty INTEGER, total INTEGER GENERATED ALWAYS AS (price * qty) STORED)");
    exec.executeSql("INSERT INTO t4 (price, qty) VALUES (10, 5)");

    var r1 = exec.executeSql("SELECT total FROM t4");
    assertEq(val(r1, 0, 0), "50", "initial total = 50");

    exec.executeSql("UPDATE t4 SET qty = 8 WHERE price = 10");
    var r2 = exec.executeSql("SELECT total FROM t4");
    assertEq(val(r2, 0, 0), "80", "updated total = 80");
}

//=========================================================================
// Cannot UPDATE generated column directly
//=========================================================================

func testCannotUpdateGenerated() {
    section("Cannot UPDATE generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t5 (a INTEGER, b INTEGER, c INTEGER GENERATED ALWAYS AS (a + b) STORED)");
    exec.executeSql("INSERT INTO t5 (a, b) VALUES (1, 2)");

    var r1 = exec.executeSql("UPDATE t5 SET c = 99 WHERE a = 1");
    assertFailure(r1, "cannot update generated column");
}

//=========================================================================
// Generated column with string expression
//=========================================================================

func testStringExpression() {
    section("String generated col");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t6 (first_name TEXT, last_name TEXT, full_name TEXT GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED)");
    exec.executeSql("INSERT INTO t6 (first_name, last_name) VALUES ('John', 'Doe')");

    var r1 = exec.executeSql("SELECT full_name FROM t6");
    assertSuccess(r1, "string generated");
    assertEq(val(r1, 0, 0), "John Doe", "full_name = John Doe");
}

//=========================================================================
// Generated column with arithmetic expressions
//=========================================================================

func testArithmeticExpression() {
    section("Arithmetic generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t7 (price REAL, tax_rate REAL, total REAL GENERATED ALWAYS AS (price + price * tax_rate) STORED)");
    exec.executeSql("INSERT INTO t7 (price, tax_rate) VALUES (100.0, 0.1)");

    var r1 = exec.executeSql("SELECT total FROM t7");
    assertSuccess(r1, "arithmetic generated");
    // 100.0 + 100.0 * 0.1 = 110.0 (may display as 110 without trailing .0)
    var totalStr = val(r1, 0, 0);
    assertTrue(totalStr == "110.0" || totalStr == "110", "total = 110");
}

//=========================================================================
// Generated column with function
//=========================================================================

func testFunctionExpression() {
    section("Function in generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t8 (name TEXT, name_upper TEXT GENERATED ALWAYS AS (UPPER(name)) STORED)");
    exec.executeSql("INSERT INTO t8 (name) VALUES ('hello')");

    var r1 = exec.executeSql("SELECT name_upper FROM t8");
    assertSuccess(r1, "function generated");
    assertEq(val(r1, 0, 0), "HELLO", "UPPER(hello) = HELLO");
}

//=========================================================================
// Generated column in WHERE clause
//=========================================================================

func testWhereOnGenerated() {
    section("WHERE on generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t9 (a INTEGER, b INTEGER, sum INTEGER GENERATED ALWAYS AS (a + b) STORED)");
    exec.executeSql("INSERT INTO t9 (a, b) VALUES (1, 2)");
    exec.executeSql("INSERT INTO t9 (a, b) VALUES (10, 20)");
    exec.executeSql("INSERT INTO t9 (a, b) VALUES (100, 200)");

    var r1 = exec.executeSql("SELECT a, b FROM t9 WHERE sum > 10 ORDER BY a");
    assertSuccess(r1, "WHERE on generated");
    assertRowCount(r1, 2, "2 rows with sum > 10");
    assertEq(val(r1, 0, 0), "10", "first match a=10");
    assertEq(val(r1, 1, 0), "100", "second match a=100");
}

//=========================================================================
// Generated column with CASE expression
//=========================================================================

func testCaseExpression() {
    section("CASE in generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t10 (score INTEGER, grade TEXT GENERATED ALWAYS AS (CASE WHEN score >= 90 THEN 'A' WHEN score >= 80 THEN 'B' ELSE 'C' END) STORED)");
    exec.executeSql("INSERT INTO t10 (score) VALUES (95)");
    exec.executeSql("INSERT INTO t10 (score) VALUES (85)");
    exec.executeSql("INSERT INTO t10 (score) VALUES (70)");

    var r1 = exec.executeSql("SELECT score, grade FROM t10 ORDER BY score DESC");
    assertSuccess(r1, "CASE generated");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 1), "A", "95 -> A");
    assertEq(val(r1, 1, 1), "B", "85 -> B");
    assertEq(val(r1, 2, 1), "C", "70 -> C");
}

//=========================================================================
// Multiple generated columns
//=========================================================================

func testMultipleGenerated() {
    section("Multiple generated cols");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t11 (a INTEGER, b INTEGER, sum INTEGER GENERATED ALWAYS AS (a + b) STORED, product INTEGER GENERATED ALWAYS AS (a * b) STORED)");
    exec.executeSql("INSERT INTO t11 (a, b) VALUES (3, 4)");

    var r1 = exec.executeSql("SELECT a, b, sum, product FROM t11");
    assertSuccess(r1, "multiple generated");
    assertEq(val(r1, 0, 2), "7", "3 + 4 = 7");
    assertEq(val(r1, 0, 3), "12", "3 * 4 = 12");
}

//=========================================================================
// DESCRIBE shows generated columns
//=========================================================================

func testDescribeGenerated() {
    section("DESCRIBE generated");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t12 (a INTEGER, b INTEGER GENERATED ALWAYS AS (a * 2) STORED)");
    var r1 = exec.executeSql("DESCRIBE t12");
    assertSuccess(r1, "DESCRIBE");
    assertRowCount(r1, 2, "2 columns");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 53: Generated Columns ===");

    testBasicGenerated();
    testPositionalInsert();
    testMultipleRows();
    testUpdateRecomputes();
    testCannotUpdateGenerated();
    testStringExpression();
    testArithmeticExpression();
    testFunctionExpression();
    testWhereOnGenerated();
    testCaseExpression();
    testMultipleGenerated();
    testDescribeGenerated();

    printResults();
}
