// Minimal PG wire protocol network test - single thread
module test_pg_net_minimal;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind Network = Viper.Network;
bind Threads = Viper.Threads;
bind Viper.Collections;

bind "../server/pg_wire";

var serverReady: Boolean;
var lock: List[Integer];

func serverThread(args: List[Integer]) {
    var port = args.get(0);
    var server = Network.TcpServer.Listen(port);

    Threads.Monitor.Enter(lock);
    serverReady = true;
    Threads.Monitor.PauseAll(lock);
    Threads.Monitor.Exit(lock);

    var client = Network.TcpServer.AcceptFor(server, 5000);
    if client == null {
        Terminal.Say("SERVER: No client connected");
        Network.TcpServer.Close(server);
        return;
    }

    Terminal.Say("SERVER: Client connected");

    // Read startup
    Terminal.Say("SERVER: Reading startup...");
    var startup = pgReadStartup(client);
    Terminal.Say("SERVER: Startup read, user=" + startup.user);

    // Send AuthOk
    Terminal.Say("SERVER: Sending AuthOk...");
    pgSendAuthOk(client);
    Terminal.Say("SERVER: AuthOk sent");

    // Send one ParameterStatus
    Terminal.Say("SERVER: Sending ParameterStatus...");
    pgSendParameterStatus(client, "server_version", "14.0");
    Terminal.Say("SERVER: ParameterStatus sent");

    // Send ReadyForQuery
    Terminal.Say("SERVER: Sending ReadyForQuery...");
    pgSendReadyForQuery(client, 73);
    Terminal.Say("SERVER: ReadyForQuery sent");

    // Read one message
    Terminal.Say("SERVER: Reading message...");
    var msg = pgReadMessage(client);
    Terminal.Say("SERVER: Message type=" + Fmt.Int(msg.msgType));

    Network.Tcp.Close(client);
    Network.TcpServer.Close(server);
    Terminal.Say("SERVER: Done");
}

var clientDone: Boolean;

func clientThread(args: List[Integer]) {
    var port = args.get(0);

    // Wait for server
    Threads.Monitor.Enter(lock);
    while serverReady == false {
        Threads.Monitor.Wait(lock);
    }
    Threads.Monitor.Exit(lock);
    Threads.Thread.Sleep(50);

    // Connect as client
    Terminal.Say("CLIENT: Connecting...");
    var client = Network.Tcp.Connect("localhost", port);
    Network.Tcp.SetRecvTimeout(client, 5000);
    Terminal.Say("CLIENT: Connected");

    // Send startup message
    Terminal.Say("CLIENT: Sending startup...");
    var body = new PgMsg(128);
    body.writeInt32(196608);
    body.writeCString("user");
    body.writeCString("admin");
    body.writeCString("database");
    body.writeCString("main");
    body.writeByte(0);
    var bodyBytes = body.toBytes();
    var length = bodyBytes.Len + 4;
    var startupMsg = Bytes.New(4 + bodyBytes.Len);
    writeInt32BE(startupMsg, 0, length);
    Bytes.Copy(startupMsg, 4, bodyBytes, 0, bodyBytes.Len);
    Network.Tcp.SendAll(client, startupMsg);
    Terminal.Say("CLIENT: Startup sent");

    // Receive AuthOk
    Terminal.Say("CLIENT: Receiving AuthOk...");
    var typeBuf: Bytes = Network.Tcp.RecvExact(client, 1);
    Terminal.Say("CLIENT: Got type=" + Fmt.Int(typeBuf.Get(0)));
    var lenBuf: Bytes = Network.Tcp.RecvExact(client, 4);
    var msgLen = readInt32BE(lenBuf, 0);
    Terminal.Say("CLIENT: Got len=" + Fmt.Int(msgLen));
    if msgLen > 4 {
        var bodyData: Bytes = Network.Tcp.RecvExact(client, msgLen - 4);
        Terminal.Say("CLIENT: Got body len=" + Fmt.Int(bodyData.Len));
    }

    // Receive ParameterStatus
    Terminal.Say("CLIENT: Receiving ParameterStatus...");
    typeBuf = Network.Tcp.RecvExact(client, 1);
    Terminal.Say("CLIENT: Got type=" + Fmt.Int(typeBuf.Get(0)));
    lenBuf = Network.Tcp.RecvExact(client, 4);
    msgLen = readInt32BE(lenBuf, 0);
    if msgLen > 4 {
        var bodyData: Bytes = Network.Tcp.RecvExact(client, msgLen - 4);
        Terminal.Say("CLIENT: Got param body len=" + Fmt.Int(bodyData.Len));
    }

    // Receive ReadyForQuery
    Terminal.Say("CLIENT: Receiving ReadyForQuery...");
    typeBuf = Network.Tcp.RecvExact(client, 1);
    Terminal.Say("CLIENT: Got type=" + Fmt.Int(typeBuf.Get(0)));
    lenBuf = Network.Tcp.RecvExact(client, 4);
    msgLen = readInt32BE(lenBuf, 0);
    if msgLen > 4 {
        var bodyData: Bytes = Network.Tcp.RecvExact(client, msgLen - 4);
        Terminal.Say("CLIENT: ReadyForQuery status=" + Fmt.Int(bodyData.Get(0)));
    }

    // Send terminate
    var termMsg = Bytes.New(5);
    termMsg.Set(0, 88);
    writeInt32BE(termMsg, 1, 4);
    Network.Tcp.SendAll(client, termMsg);

    Network.Tcp.Close(client);
    Terminal.Say("CLIENT: Done");
    clientDone = true;
}

func start() {
    Terminal.Say("=== Minimal PG Net Test ===");

    serverReady = false;
    clientDone = false;
    lock = [];

    var port = 15433;
    var args: List[Integer] = [];
    args.add(port);

    // Run client on background thread, server on main thread
    Threads.Thread.StartSafe(&clientThread, args);

    // Run server directly on main thread
    serverThread(args);

    // Wait for client
    Threads.Thread.Sleep(500);
    Terminal.Say("=== ALL DONE ===");
}
