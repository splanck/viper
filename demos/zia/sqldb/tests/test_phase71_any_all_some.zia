// test_phase71_any_all_some.zia — Phase 71: ANY/ALL/SOME Quantified Comparisons
// Tests for quantified subquery comparisons with all comparison operators.

module test_phase71_any_all_some;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// = ANY — equivalent to IN
//=========================================================================

func testEqAny() {
    section("= ANY subquery");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE depts (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO depts VALUES (1, 'Engineering')");
    exec.executeSql("INSERT INTO depts VALUES (2, 'Sales')");
    exec.executeSql("INSERT INTO depts VALUES (3, 'HR')");

    exec.executeSql("CREATE TABLE employees (id INTEGER, name TEXT, dept_id INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 1)");
    exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 2)");
    exec.executeSql("INSERT INTO employees VALUES (3, 'Carol', 1)");
    exec.executeSql("INSERT INTO employees VALUES (4, 'Dave', 4)");

    // = ANY is like IN
    var r1 = exec.executeSql("SELECT name FROM employees WHERE dept_id = ANY (SELECT id FROM depts)");
    assertSuccess(r1, "= ANY subquery");
    assertRowCount(r1, 3, "3 employees in known depts");

    // = SOME is synonym for ANY
    var r2 = exec.executeSql("SELECT name FROM employees WHERE dept_id = SOME (SELECT id FROM depts)");
    assertSuccess(r2, "= SOME subquery");
    assertRowCount(r2, 3, "SOME = ANY synonym");
}

//=========================================================================
// > ANY — greater than at least one
//=========================================================================

func testGtAny() {
    section("> ANY subquery");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 90)");
    exec.executeSql("INSERT INTO scores VALUES ('Bob', 70)");
    exec.executeSql("INSERT INTO scores VALUES ('Carol', 85)");

    exec.executeSql("CREATE TABLE thresholds (val INTEGER)");
    exec.executeSql("INSERT INTO thresholds VALUES (80)");
    exec.executeSql("INSERT INTO thresholds VALUES (60)");

    // > ANY: score > 60 OR score > 80 — effectively > min(thresholds)
    var r1 = exec.executeSql("SELECT name FROM scores WHERE score > ANY (SELECT val FROM thresholds)");
    assertSuccess(r1, "> ANY subquery");
    assertRowCount(r1, 3, "All scores > 60 (min threshold)");

    // < ANY: score < 80 OR score < 60 — effectively < max(thresholds)
    var r2 = exec.executeSql("SELECT name FROM scores WHERE score < ANY (SELECT val FROM thresholds)");
    assertSuccess(r2, "< ANY subquery");
    assertRowCount(r2, 1, "Only Bob(70) < 80");
}

//=========================================================================
// > ALL — greater than every value
//=========================================================================

func testGtAll() {
    section("> ALL subquery");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 95)");
    exec.executeSql("INSERT INTO scores VALUES ('Bob', 70)");
    exec.executeSql("INSERT INTO scores VALUES ('Carol', 85)");

    exec.executeSql("CREATE TABLE thresholds (val INTEGER)");
    exec.executeSql("INSERT INTO thresholds VALUES (80)");
    exec.executeSql("INSERT INTO thresholds VALUES (60)");

    // > ALL: score > 80 AND score > 60 — effectively > max(thresholds)
    var r1 = exec.executeSql("SELECT name FROM scores WHERE score > ALL (SELECT val FROM thresholds)");
    assertSuccess(r1, "> ALL subquery");
    assertRowCount(r1, 2, "Alice(95) and Carol(85) > all thresholds");

    // < ALL: score < 80 AND score < 60 — effectively < min(thresholds)
    var r2 = exec.executeSql("SELECT name FROM scores WHERE score < ALL (SELECT val FROM thresholds)");
    assertSuccess(r2, "< ALL subquery");
    assertRowCount(r2, 0, "No score < 60 AND < 80");
}

//=========================================================================
// ALL with empty subquery — should return true
//=========================================================================

func testAllEmpty() {
    section("ALL with empty subquery");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, val INTEGER)");
    exec.executeSql("INSERT INTO items VALUES (1, 10)");
    exec.executeSql("INSERT INTO items VALUES (2, 20)");

    exec.executeSql("CREATE TABLE empty_tbl (val INTEGER)");

    // > ALL (empty) should return true (vacuous truth)
    var r1 = exec.executeSql("SELECT * FROM items WHERE val > ALL (SELECT val FROM empty_tbl)");
    assertSuccess(r1, "> ALL empty subquery");
    assertRowCount(r1, 2, "All rows match (vacuous truth)");

    // = ANY (empty) should return false
    var r2 = exec.executeSql("SELECT * FROM items WHERE val = ANY (SELECT val FROM empty_tbl)");
    assertSuccess(r2, "= ANY empty subquery");
    assertRowCount(r2, 0, "No rows match ANY in empty set");
}

//=========================================================================
// <> ALL — not equal to any (like NOT IN)
//=========================================================================

func testNeAll() {
    section("<> ALL subquery");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (id INTEGER, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES (1, 10)");
    exec.executeSql("INSERT INTO data VALUES (2, 20)");
    exec.executeSql("INSERT INTO data VALUES (3, 30)");

    exec.executeSql("CREATE TABLE excluded (val INTEGER)");
    exec.executeSql("INSERT INTO excluded VALUES (10)");
    exec.executeSql("INSERT INTO excluded VALUES (30)");

    // <> ALL: val not in excluded list
    var r1 = exec.executeSql("SELECT * FROM data WHERE val <> ALL (SELECT val FROM excluded)");
    assertSuccess(r1, "<> ALL subquery");
    assertRowCount(r1, 1, "Only 20 is <> all excluded");
    assertEq(val(r1, 0, 1), "20", "Value 20 not excluded");
}

//=========================================================================
// >= ANY and <= ALL
//=========================================================================

func testGeLeQuantified() {
    section(">= ANY and <= ALL");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nums (n INTEGER)");
    exec.executeSql("INSERT INTO nums VALUES (5)");
    exec.executeSql("INSERT INTO nums VALUES (10)");
    exec.executeSql("INSERT INTO nums VALUES (15)");

    exec.executeSql("CREATE TABLE bounds (b INTEGER)");
    exec.executeSql("INSERT INTO bounds VALUES (10)");

    // >= ANY (10) — 10, 15
    var r1 = exec.executeSql("SELECT n FROM nums WHERE n >= ANY (SELECT b FROM bounds)");
    assertSuccess(r1, ">= ANY subquery");
    assertRowCount(r1, 2, "10 and 15 >= 10");

    // <= ALL (10) — 5, 10
    var r2 = exec.executeSql("SELECT n FROM nums WHERE n <= ALL (SELECT b FROM bounds)");
    assertSuccess(r2, "<= ALL subquery");
    assertRowCount(r2, 2, "5 and 10 <= 10");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 71: ANY/ALL/SOME Quantified Comparisons ===");

    testEqAny();
    testGtAny();
    testGtAll();
    testAllEmpty();
    testNeAll();
    testGeLeQuantified();

    printResults();
}
