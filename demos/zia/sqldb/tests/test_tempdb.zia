// test_tempdb.zia — Tests for tempdb (CREATE TEMP TABLE)
// Part of ViperSQL - Phase 8.1

module test_tempdb;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "../types";
bind "../server";
bind "../session";

//=============================================================================
// TEST HARNESS (local to avoid cross-module issues)
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func assert(condition: Boolean, msg: String) {
    if condition {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

func check(result: QueryResult, label: String) {
    if result.success == false {
        Terminal.Say("  FAIL: " + label + " => " + result.message);
        failed = failed + 1;
    } else {
        passed = passed + 1;
    }
}

func checkFail(result: QueryResult, label: String) {
    if result.success == false {
        passed = passed + 1;
    } else {
        Terminal.Say("  FAIL: " + label + " (expected failure)");
        failed = failed + 1;
    }
}

//=============================================================================
// TEST: CREATE TEMP TABLE basic
//=============================================================================

func testCreateTempTable() {
    Terminal.Say("Testing CREATE TEMP TABLE...");

    var exec = new Executor();
    exec.init();

    // Create a temp table
    check(exec.executeSql("CREATE TEMP TABLE scratch (id INTEGER, val TEXT)"), "CREATE TEMP TABLE");

    // Insert into temp table
    check(exec.executeSql("INSERT INTO scratch VALUES (1, 'hello')"), "INSERT into temp table");
    check(exec.executeSql("INSERT INTO scratch VALUES (2, 'world')"), "INSERT second row");

    // SELECT from temp table
    var r4 = exec.executeSql("SELECT * FROM scratch ORDER BY id");
    check(r4, "SELECT from temp table");
    assert(r4.rowCount() == 2, "Temp table has 2 rows");
}

func testCreateTemporaryTable() {
    Terminal.Say("Testing CREATE TEMPORARY TABLE (full keyword)...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TEMPORARY TABLE tmp_items (name TEXT)"), "CREATE TEMPORARY TABLE");
    check(exec.executeSql("INSERT INTO tmp_items VALUES ('apple')"), "INSERT into TEMPORARY table");

    var r3 = exec.executeSql("SELECT * FROM tmp_items");
    check(r3, "SELECT from TEMPORARY table");
    assert(r3.rowCount() == 1, "TEMPORARY table has 1 row");
}

//=============================================================================
// TEST: DROP TEMP TABLE
//=============================================================================

func testDropTempTable() {
    Terminal.Say("Testing DROP temp table...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TEMP TABLE tmp_drop (x INTEGER)"), "create temp");
    check(exec.executeSql("INSERT INTO tmp_drop VALUES (42)"), "insert into temp");

    var r1 = exec.executeSql("SELECT * FROM tmp_drop");
    assert(r1.rowCount() == 1, "Temp table exists with 1 row");

    check(exec.executeSql("DROP TABLE tmp_drop"), "DROP temp table");

    // Verify it's gone
    checkFail(exec.executeSql("SELECT * FROM tmp_drop"), "SELECT after DROP fails");
}

//=============================================================================
// TEST: DML on temp tables (UPDATE, DELETE)
//=============================================================================

func testTempTableDML() {
    Terminal.Say("Testing DML on temp tables...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TEMP TABLE tmp_dml (id INTEGER, val INTEGER)"), "create temp");
    check(exec.executeSql("INSERT INTO tmp_dml VALUES (1, 100)"), "insert 1");
    check(exec.executeSql("INSERT INTO tmp_dml VALUES (2, 200)"), "insert 2");
    check(exec.executeSql("INSERT INTO tmp_dml VALUES (3, 300)"), "insert 3");

    // UPDATE
    check(exec.executeSql("UPDATE tmp_dml SET val = 999 WHERE id = 2"), "UPDATE on temp table");

    var r2 = exec.executeSql("SELECT val FROM tmp_dml WHERE id = 2");
    assert(r2.rowCount() == 1, "Updated row found");

    // DELETE
    check(exec.executeSql("DELETE FROM tmp_dml WHERE id = 3"), "DELETE from temp table");

    var r4 = exec.executeSql("SELECT * FROM tmp_dml");
    assert(r4.rowCount() == 2, "2 rows remain after DELETE");
}

//=============================================================================
// TEST: Temp table with constraints
//=============================================================================

func testTempTableConstraints() {
    Terminal.Say("Testing temp table with constraints...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TEMP TABLE tmp_pk (id INTEGER PRIMARY KEY, name TEXT NOT NULL)"), "create temp with PK");
    check(exec.executeSql("INSERT INTO tmp_pk VALUES (1, 'Alice')"), "INSERT with PK");

    // Duplicate PK should fail
    checkFail(exec.executeSql("INSERT INTO tmp_pk VALUES (1, 'Bob')"), "Duplicate PK rejected");

    // NULL in NOT NULL column should fail
    checkFail(exec.executeSql("INSERT INTO tmp_pk VALUES (2, null)"), "NOT NULL enforced");
}

//=============================================================================
// TEST: Session isolation of temp tables
//=============================================================================

func testTempTableSessionIsolation() {
    Terminal.Say("Testing temp table session isolation...");

    var server = new DatabaseServer();
    server.init();

    var s1 = new Session();
    s1.initWithServer(1, "client-1", server);
    var s2 = new Session();
    s2.initWithServer(2, "client-2", server);

    // Session 1 creates a temp table
    check(s1.executeSql("CREATE TEMP TABLE my_temp (x INTEGER)"), "S1 creates temp table");
    check(s1.executeSql("INSERT INTO my_temp VALUES (42)"), "S1 insert");

    // Session 1 can see it
    var r2 = s1.executeSql("SELECT * FROM my_temp");
    check(r2, "S1 sees temp table");
    assert(r2.rowCount() == 1, "S1 temp table has 1 row");

    // Session 2 cannot see Session 1's temp table
    checkFail(s2.executeSql("SELECT * FROM my_temp"), "S2 cannot see S1 temp table");

    // Session 2 can create its own temp table with same name
    check(s2.executeSql("CREATE TEMP TABLE my_temp (y TEXT)"), "S2 creates own temp table");
    check(s2.executeSql("INSERT INTO my_temp VALUES ('hello')"), "S2 insert");

    var r5 = s2.executeSql("SELECT * FROM my_temp");
    check(r5, "S2 sees its own temp table");
    assert(r5.rowCount() == 1, "S2 temp table has 1 row");

    // Session 1 still sees its own temp table
    var r6 = s1.executeSql("SELECT * FROM my_temp");
    assert(r6.rowCount() == 1, "S1 still has its own temp data");
}

//=============================================================================
// TEST: Temp table cleanup on disconnect
//=============================================================================

func testTempTableCleanupOnDisconnect() {
    Terminal.Say("Testing temp table cleanup on disconnect...");

    var server = new DatabaseServer();
    server.init();

    var s1 = new Session();
    s1.initWithServer(1, "client-1", server);

    check(s1.executeSql("CREATE TEMP TABLE my_temp (x INTEGER)"), "create temp");
    check(s1.executeSql("INSERT INTO my_temp VALUES (1)"), "insert temp");
    check(s1.executeSql("CREATE TABLE permanent (y INTEGER)"), "create permanent");
    check(s1.executeSql("INSERT INTO permanent VALUES (99)"), "insert permanent");

    // Disconnect — should clean up temp tables
    s1.disconnect();

    // Temp table should be gone
    checkFail(s1.executeSql("SELECT * FROM my_temp"), "Temp table gone after disconnect");

    // Regular table should still exist
    var r2 = s1.executeSql("SELECT * FROM permanent");
    check(r2, "Regular table survives disconnect");
    assert(r2.rowCount() == 1, "Regular table data intact");
}

//=============================================================================
// TEST: Temp table with JOIN against regular table
//=============================================================================

func testTempTableWithJoin() {
    Terminal.Say("Testing temp table with JOIN...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, price INTEGER)"), "create products");
    check(exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 10)"), "insert widget");
    check(exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 20)"), "insert gadget");

    check(exec.executeSql("CREATE TEMP TABLE cart (product_id INTEGER, qty INTEGER)"), "create temp cart");
    check(exec.executeSql("INSERT INTO cart VALUES (1, 3)"), "insert cart 1");
    check(exec.executeSql("INSERT INTO cart VALUES (2, 1)"), "insert cart 2");

    // JOIN temp + regular table
    var r1 = exec.executeSql("SELECT p.name, c.qty FROM products p INNER JOIN cart c ON p.id = c.product_id ORDER BY p.name");
    check(r1, "JOIN temp and regular table");
    assert(r1.rowCount() == 2, "JOIN returns 2 rows");

    // Aggregate on temp table
    var r2 = exec.executeSql("SELECT SUM(qty) FROM cart");
    check(r2, "Aggregate on temp table");
    assert(r2.rowCount() == 1, "Aggregate returns 1 row");
}

//=============================================================================
// TEST: SHOW TABLES includes temp tables
//=============================================================================

func testShowTablesIncludesTemp() {
    Terminal.Say("Testing SHOW TABLES includes temp tables...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE reg_tbl (id INTEGER)"), "create regular");
    check(exec.executeSql("CREATE TEMP TABLE tmp_tbl (id INTEGER)"), "create temp");

    var r1 = exec.executeSql("SHOW TABLES");
    check(r1, "SHOW TABLES");
    assert(r1.rowCount() >= 2, "SHOW TABLES lists at least 2 tables");
}

//=============================================================================
// ENTRY POINT
//=============================================================================

func start() {
    Terminal.Say("=== Phase 8.1: Temporary Tables Tests ===");
    Terminal.Say("");

    testCreateTempTable();
    testCreateTemporaryTable();
    testDropTempTable();
    testTempTableDML();
    testTempTableConstraints();
    testTempTableSessionIsolation();
    testTempTableCleanupOnDisconnect();
    testTempTableWithJoin();
    testShowTablesIncludesTemp();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    }
}
