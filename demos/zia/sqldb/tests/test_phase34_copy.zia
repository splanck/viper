// test_phase34_copy.zia â€” Phase 34: COPY TO/FROM
// Tests for bulk data export/import.

module test_phase34_copy;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;
bind IO = Viper.IO;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// COPY TO STDOUT
//=========================================================================

func testCopyToStdout() {
    section("COPY TO STDOUT");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE copy_t (id INTEGER, name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO copy_t VALUES (1, 'Alice', 80)");
    exec.executeSql("INSERT INTO copy_t VALUES (2, 'Bob', 90)");
    exec.executeSql("INSERT INTO copy_t VALUES (3, 'Carol', 70)");

    var r1 = exec.executeSql("COPY copy_t TO STDOUT");
    assertSuccess(r1, "COPY TO STDOUT succeeds");
    // Should have header + 3 data rows = 4 rows
    assertTrue(r1.rows.count() >= 3, "COPY TO STDOUT returns data rows");
}

//=========================================================================
// COPY TO FILE
//=========================================================================

func testCopyToFile() {
    section("COPY TO file");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE copy_f (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO copy_f VALUES (1, 'Alice')");
    exec.executeSql("INSERT INTO copy_f VALUES (2, 'Bob')");

    var r1 = exec.executeSql("COPY copy_f TO '/tmp/viper_test_copy.csv'");
    assertSuccess(r1, "COPY TO file succeeds");
    assertTrue(stringContains(r1.message, "COPY 2"), "Reports 2 rows");

    // Verify file exists and has content
    var content = IO.File.ReadAllText("/tmp/viper_test_copy.csv");
    assertTrue(String.Length(content) > 0, "File has content");
    assertTrue(stringContains(content, "Alice"), "File contains Alice");
    assertTrue(stringContains(content, "Bob"), "File contains Bob");
}

//=========================================================================
// COPY FROM FILE
//=========================================================================

func testCopyFromFile() {
    section("COPY FROM file");

    // First write test data
    IO.File.WriteAllText("/tmp/viper_test_import.csv", "id,name,score\n1,Alice,80\n2,Bob,90\n3,Carol,70\n");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE import_t (id INTEGER, name TEXT, score INTEGER)");

    var r1 = exec.executeSql("COPY import_t FROM '/tmp/viper_test_import.csv'");
    assertSuccess(r1, "COPY FROM succeeds");
    assertTrue(stringContains(r1.message, "COPY 3"), "Reports 3 rows imported");

    var r2 = exec.executeSql("SELECT * FROM import_t ORDER BY id");
    assertEqInt(r2.rows.count(), 3, "3 rows in table");
    assertEq(val(r2, 0, 1), "Alice", "First row Alice");
    assertEq(val(r2, 1, 1), "Bob", "Second row Bob");
    assertEq(val(r2, 2, 1), "Carol", "Third row Carol");
}

//=========================================================================
// COPY ROUND-TRIP
//=========================================================================

func testCopyRoundTrip() {
    section("COPY round-trip");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE rt_src (id INTEGER, name TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO rt_src VALUES (1, 'Alpha', 100)");
    exec.executeSql("INSERT INTO rt_src VALUES (2, 'Beta', 200)");
    exec.executeSql("INSERT INTO rt_src VALUES (3, 'Gamma', 300)");

    // Export
    exec.executeSql("COPY rt_src TO '/tmp/viper_test_roundtrip.csv'");

    // Import into new table
    exec.executeSql("CREATE TABLE rt_dst (id INTEGER, name TEXT, val INTEGER)");
    exec.executeSql("COPY rt_dst FROM '/tmp/viper_test_roundtrip.csv'");

    var r1 = exec.executeSql("SELECT * FROM rt_dst ORDER BY id");
    assertEqInt(r1.rows.count(), 3, "3 rows imported");
    assertEq(val(r1, 0, 1), "Alpha", "Alpha imported");
    assertEq(val(r1, 2, 1), "Gamma", "Gamma imported");
    assertEq(val(r1, 2, 2), "300", "Value 300 imported");
}

//=========================================================================
// COPY (query) TO
//=========================================================================

func testCopyQueryToFile() {
    section("COPY (query) TO file");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE cq_t (id INTEGER, name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO cq_t VALUES (1, 'Alice', 80)");
    exec.executeSql("INSERT INTO cq_t VALUES (2, 'Bob', 90)");
    exec.executeSql("INSERT INTO cq_t VALUES (3, 'Carol', 70)");

    var r1 = exec.executeSql("COPY (SELECT name, score FROM cq_t WHERE score >= 80) TO '/tmp/viper_test_query_copy.csv'");
    assertSuccess(r1, "COPY (query) TO succeeds");
    assertTrue(stringContains(r1.message, "COPY 2"), "Reports 2 rows");

    var content = IO.File.ReadAllText("/tmp/viper_test_query_copy.csv");
    assertTrue(stringContains(content, "Alice"), "Query result has Alice");
    assertTrue(stringContains(content, "Bob"), "Query result has Bob");
}

//=========================================================================
// COPY with quoted text
//=========================================================================

func testCopyQuotedText() {
    section("COPY with quoted text");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE cq2 (id INTEGER, description TEXT)");
    exec.executeSql("INSERT INTO cq2 VALUES (1, 'Hello, World')");
    exec.executeSql("INSERT INTO cq2 VALUES (2, 'Simple text')");

    exec.executeSql("COPY cq2 TO '/tmp/viper_test_quoted.csv'");

    // Import back
    exec.executeSql("CREATE TABLE cq2_import (id INTEGER, description TEXT)");
    exec.executeSql("COPY cq2_import FROM '/tmp/viper_test_quoted.csv'");

    var r1 = exec.executeSql("SELECT * FROM cq2_import ORDER BY id");
    assertEqInt(r1.rows.count(), 2, "2 rows imported with quotes");
    assertEq(val(r1, 0, 1), "Hello, World", "Comma in text preserved");
}

//=========================================================================
// COPY error cases
//=========================================================================

func testCopyFromNonexistentTable() {
    section("COPY error cases");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("COPY nosuch FROM '/tmp/test.csv'");
    assertTrue(r1.success == false, "COPY FROM nonexistent table fails");
}

func main() -> Integer {
    Terminal.Say("=== Phase 34: COPY TO/FROM ===");

    testCopyToStdout();
    testCopyToFile();
    testCopyFromFile();
    testCopyRoundTrip();
    testCopyQueryToFile();
    testCopyQuotedText();
    testCopyFromNonexistentTable();

    printResults();
    return 0;
}
