// test_phase4_functions.zia â€” Phase 4: Additional Built-in Functions Tests
// Tests for POWER, SQRT, CEIL, FLOOR, SIGN, LOG, EXP, RANDOM, PI,
// LEFT, RIGHT, LPAD, RPAD, REVERSE, HEX, GREATEST, LEAST

module test_phase4_functions;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";

bind "../executor";
bind "../types";

func main() -> Integer {
    Terminal.Say("=== Phase 4: Additional Built-in Functions Tests ===");

    var exec = new Executor();
    exec.init();

    //=========================================================================
    // Setup test data
    //=========================================================================
    assertSuccess(exec.executeSql("CREATE TABLE math_test (id INTEGER PRIMARY KEY, val INTEGER, fval REAL)"), "create math_test");
    assertSuccess(exec.executeSql("INSERT INTO math_test VALUES (1, 8, '2.5')"), "insert 1");
    assertSuccess(exec.executeSql("INSERT INTO math_test VALUES (2, -5, '3.7')"), "insert 2");
    assertSuccess(exec.executeSql("INSERT INTO math_test VALUES (3, 0, '0.0')"), "insert 3");
    assertSuccess(exec.executeSql("INSERT INTO math_test VALUES (4, 16, '1.44')"), "insert 4");
    assertSuccess(exec.executeSql("INSERT INTO math_test VALUES (5, 100, '2.718281828')"), "insert 5");

    //=========================================================================
    // POWER / POW
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- POWER / POW ---");

    var r = exec.executeSql("SELECT POWER(2, 10) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "1024", "POWER(2,10) = 1024: " + val(r, 0, 0));

    r = exec.executeSql("SELECT POW(3, 0) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "1", "POW(3,0) = 1");

    r = exec.executeSql("SELECT POWER(5, 3) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "125", "POWER(5,3) = 125: " + val(r, 0, 0));

    r = exec.executeSql("SELECT POWER(-2, 3) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "-8", "POWER(-2,3) = -8: " + val(r, 0, 0));

    r = exec.executeSql("SELECT POWER(2, -1) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "0", "POWER(2,-1) = 0 (integer truncation): " + val(r, 0, 0));

    //=========================================================================
    // SQRT
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- SQRT ---");

    r = exec.executeSql("SELECT SQRT(val) FROM math_test WHERE id = 4");
    // SQRT(16) = 4.0
    var sqrtVal = val(r, 0, 0);
    // Check that it starts with "4"
    assert(String.Substring(sqrtVal, 0, 1) == "4", "SQRT(16) starts with 4: " + sqrtVal);

    r = exec.executeSql("SELECT SQRT(100) FROM math_test WHERE id = 1");
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 2) == "10", "SQRT(100) starts with 10: " + sqrtVal);

    //=========================================================================
    // CEIL / CEILING
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CEIL / CEILING ---");

    r = exec.executeSql("SELECT CEIL(2) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "2", "CEIL(2) = 2");

    //=========================================================================
    // FLOOR
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- FLOOR ---");

    r = exec.executeSql("SELECT FLOOR(7) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "7", "FLOOR(7) = 7");

    //=========================================================================
    // SIGN
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- SIGN ---");

    r = exec.executeSql("SELECT SIGN(val) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "1", "SIGN(8) = 1");

    r = exec.executeSql("SELECT SIGN(val) FROM math_test WHERE id = 2");
    assert(val(r, 0, 0) == "-1", "SIGN(-5) = -1");

    r = exec.executeSql("SELECT SIGN(val) FROM math_test WHERE id = 3");
    assert(val(r, 0, 0) == "0", "SIGN(0) = 0");

    //=========================================================================
    // LOG / LN
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LOG / LN ---");

    r = exec.executeSql("SELECT LOG(1) FROM math_test WHERE id = 1");
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 1) == "0", "LOG(1) = 0: " + sqrtVal);

    //=========================================================================
    // LOG10
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LOG10 ---");

    r = exec.executeSql("SELECT LOG10(val) FROM math_test WHERE id = 5");
    // LOG10(100) = 2.0
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 1) == "2", "LOG10(100) starts with 2: " + sqrtVal);

    //=========================================================================
    // LOG2
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LOG2 ---");

    r = exec.executeSql("SELECT LOG2(val) FROM math_test WHERE id = 1");
    // LOG2(8) = 3.0
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 1) == "3", "LOG2(8) starts with 3: " + sqrtVal);

    //=========================================================================
    // EXP
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- EXP ---");

    r = exec.executeSql("SELECT EXP(0) FROM math_test WHERE id = 1");
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 1) == "1", "EXP(0) starts with 1: " + sqrtVal);

    //=========================================================================
    // PI
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- PI ---");

    r = exec.executeSql("SELECT PI() FROM math_test WHERE id = 1");
    sqrtVal = val(r, 0, 0);
    assert(String.Substring(sqrtVal, 0, 4) == "3.14", "PI() starts with 3.14: " + sqrtVal);

    //=========================================================================
    // RANDOM
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- RANDOM ---");

    r = exec.executeSql("SELECT RANDOM() FROM math_test WHERE id = 1");
    assertSuccess(r, "RANDOM() returns successfully");
    // Just check it returns an integer
    var randVal = val(r, 0, 0);
    assert(randVal != "NULL", "RANDOM() returns non-null: " + randVal);

    //=========================================================================
    // LEFT
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LEFT ---");

    assertSuccess(exec.executeSql("CREATE TABLE str_test (id INTEGER PRIMARY KEY, name TEXT)"), "create str_test");
    assertSuccess(exec.executeSql("INSERT INTO str_test VALUES (1, 'Hello World')"), "insert str 1");
    assertSuccess(exec.executeSql("INSERT INTO str_test VALUES (2, 'Testing')"), "insert str 2");

    r = exec.executeSql("SELECT LEFT(name, 5) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "Hello", "LEFT('Hello World', 5) = 'Hello': " + val(r, 0, 0));

    r = exec.executeSql("SELECT LEFT(name, 100) FROM str_test WHERE id = 2");
    assert(val(r, 0, 0) == "Testing", "LEFT('Testing', 100) = 'Testing': " + val(r, 0, 0));

    r = exec.executeSql("SELECT LEFT(name, 0) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "", "LEFT('Hello World', 0) = '': " + val(r, 0, 0));

    //=========================================================================
    // RIGHT
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- RIGHT ---");

    r = exec.executeSql("SELECT RIGHT(name, 5) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "World", "RIGHT('Hello World', 5) = 'World': " + val(r, 0, 0));

    r = exec.executeSql("SELECT RIGHT(name, 100) FROM str_test WHERE id = 2");
    assert(val(r, 0, 0) == "Testing", "RIGHT('Testing', 100) = 'Testing': " + val(r, 0, 0));

    //=========================================================================
    // LPAD
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LPAD ---");

    r = exec.executeSql("SELECT LPAD('42', 5, '0') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "00042", "LPAD('42', 5, '0') = '00042': " + val(r, 0, 0));

    r = exec.executeSql("SELECT LPAD('Hello', 3, 'x') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "Hel", "LPAD('Hello', 3, 'x') = 'Hel' (truncate): " + val(r, 0, 0));

    r = exec.executeSql("SELECT LPAD('Hi', 6, 'ab') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "ababHi", "LPAD('Hi', 6, 'ab') = 'ababHi': " + val(r, 0, 0));

    //=========================================================================
    // RPAD
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- RPAD ---");

    r = exec.executeSql("SELECT RPAD('42', 5, '0') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "42000", "RPAD('42', 5, '0') = '42000': " + val(r, 0, 0));

    r = exec.executeSql("SELECT RPAD('Hello', 3, 'x') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "Hel", "RPAD('Hello', 3, 'x') = 'Hel' (truncate): " + val(r, 0, 0));

    //=========================================================================
    // REVERSE
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- REVERSE ---");

    r = exec.executeSql("SELECT REVERSE('Hello') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "olleH", "REVERSE('Hello') = 'olleH': " + val(r, 0, 0));

    r = exec.executeSql("SELECT REVERSE('abcde') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "edcba", "REVERSE('abcde') = 'edcba': " + val(r, 0, 0));

    //=========================================================================
    // HEX
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- HEX ---");

    r = exec.executeSql("SELECT HEX(255) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "FF", "HEX(255) = 'FF': " + val(r, 0, 0));

    r = exec.executeSql("SELECT HEX(0) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "0", "HEX(0) = '0': " + val(r, 0, 0));

    r = exec.executeSql("SELECT HEX(16) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "10", "HEX(16) = '10': " + val(r, 0, 0));

    r = exec.executeSql("SELECT HEX(256) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "100", "HEX(256) = '100': " + val(r, 0, 0));

    //=========================================================================
    // GREATEST
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- GREATEST ---");

    r = exec.executeSql("SELECT GREATEST(1, 5, 3, 2, 4) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "5", "GREATEST(1,5,3,2,4) = 5: " + val(r, 0, 0));

    r = exec.executeSql("SELECT GREATEST(-10, -5, -20) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "-5", "GREATEST(-10,-5,-20) = -5: " + val(r, 0, 0));

    r = exec.executeSql("SELECT GREATEST('apple', 'banana', 'cherry') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "cherry", "GREATEST('apple','banana','cherry') = 'cherry': " + val(r, 0, 0));

    //=========================================================================
    // LEAST
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- LEAST ---");

    r = exec.executeSql("SELECT LEAST(1, 5, 3, 2, 4) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "1", "LEAST(1,5,3,2,4) = 1: " + val(r, 0, 0));

    r = exec.executeSql("SELECT LEAST(-10, -5, -20) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "-20", "LEAST(-10,-5,-20) = -20: " + val(r, 0, 0));

    r = exec.executeSql("SELECT LEAST('apple', 'banana', 'cherry') FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "apple", "LEAST('apple','banana','cherry') = 'apple': " + val(r, 0, 0));

    //=========================================================================
    // NULL handling for new functions
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- NULL Handling ---");

    r = exec.executeSql("SELECT POWER(NULL, 2) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "NULL", "POWER(NULL,2) = NULL");

    r = exec.executeSql("SELECT SQRT(NULL) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "NULL", "SQRT(NULL) = NULL");

    r = exec.executeSql("SELECT LEFT(NULL, 5) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "NULL", "LEFT(NULL,5) = NULL");

    r = exec.executeSql("SELECT GREATEST(1, NULL, 3) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "NULL", "GREATEST with NULL = NULL");

    r = exec.executeSql("SELECT LEAST(1, NULL, 3) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "NULL", "LEAST with NULL = NULL");

    //=========================================================================
    // Combined expressions with new functions
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- Combined Expressions ---");

    r = exec.executeSql("SELECT POWER(2, val) FROM math_test WHERE id = 1");
    assert(val(r, 0, 0) == "256", "POWER(2, val) where val=8 = 256: " + val(r, 0, 0));

    r = exec.executeSql("SELECT SIGN(val) * ABS(val) FROM math_test WHERE id = 2");
    assert(val(r, 0, 0) == "-5", "SIGN(-5) * ABS(-5) = -5");

    r = exec.executeSql("SELECT LEFT(REVERSE('Hello'), 3) FROM str_test WHERE id = 1");
    assert(val(r, 0, 0) == "oll", "LEFT(REVERSE('Hello'), 3) = 'oll': " + val(r, 0, 0));

    //=========================================================================
    // Summary
    //=========================================================================
    printResults();
    return 0;
}
