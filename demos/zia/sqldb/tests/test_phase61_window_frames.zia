// test_phase61_window_frames.zia â€” Phase 61: Window Frame Specifications
// Tests for ROWS BETWEEN ... AND ... window frame clauses.

module test_phase61_window_frames;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (day INTEGER, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES (1, 100)");
    exec.executeSql("INSERT INTO sales VALUES (2, 200)");
    exec.executeSql("INSERT INTO sales VALUES (3, 150)");
    exec.executeSql("INSERT INTO sales VALUES (4, 300)");
    exec.executeSql("INSERT INTO sales VALUES (5, 250)");

    return exec;
}

//=========================================================================
// SUM with ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW (running sum)
//=========================================================================

func testSumRunning() {
    section("SUM ROWS UNBOUNDED PRECEDING TO CURRENT ROW");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) FROM sales");
    assertSuccess(r1, "running sum");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 2), "100", "day 1: 100");
    assertEq(val(r1, 1, 2), "300", "day 2: 100+200=300");
    assertEq(val(r1, 2, 2), "450", "day 3: 300+150=450");
    assertEq(val(r1, 3, 2), "750", "day 4: 450+300=750");
    assertEq(val(r1, 4, 2), "1000", "day 5: 750+250=1000");
}

//=========================================================================
// SUM with ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING (sliding window of 3)
//=========================================================================

func testSumSliding3() {
    section("SUM ROWS 1 PRECEDING AND 1 FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) FROM sales");
    assertSuccess(r1, "sliding 3");
    assertRowCount(r1, 5, "5 rows");
    // day 1: [100, 200] = 300
    assertEq(val(r1, 0, 2), "300", "day 1: 100+200=300");
    // day 2: [100, 200, 150] = 450
    assertEq(val(r1, 1, 2), "450", "day 2: 100+200+150=450");
    // day 3: [200, 150, 300] = 650
    assertEq(val(r1, 2, 2), "650", "day 3: 200+150+300=650");
    // day 4: [150, 300, 250] = 700
    assertEq(val(r1, 3, 2), "700", "day 4: 150+300+250=700");
    // day 5: [300, 250] = 550
    assertEq(val(r1, 4, 2), "550", "day 5: 300+250=550");
}

//=========================================================================
// COUNT with ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
//=========================================================================

func testCountPreceding() {
    section("COUNT ROWS 2 PRECEDING AND CURRENT ROW");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, COUNT(*) OVER (ORDER BY day ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) FROM sales");
    assertSuccess(r1, "count preceding");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 1), "1", "day 1: 1 row");
    assertEq(val(r1, 1, 1), "2", "day 2: 2 rows");
    assertEq(val(r1, 2, 1), "3", "day 3: 3 rows");
    assertEq(val(r1, 3, 1), "3", "day 4: 3 rows (max window)");
    assertEq(val(r1, 4, 1), "3", "day 5: 3 rows (max window)");
}

//=========================================================================
// AVG with ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING (moving average)
//=========================================================================

func testAvgMoving() {
    section("AVG ROWS 1 PRECEDING AND 1 FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, AVG(amount) OVER (ORDER BY day ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) FROM sales");
    assertSuccess(r1, "moving avg");
    assertRowCount(r1, 5, "5 rows");
    // day 1: avg(100, 200) = 150
    assertEq(val(r1, 0, 2), "150", "day 1: avg(100,200)=150");
    // day 2: avg(100, 200, 150) = 150
    assertEq(val(r1, 1, 2), "150", "day 2: avg(100,200,150)=150");
    // day 3: avg(200, 150, 300) = 216
    assertEq(val(r1, 2, 2), "216", "day 3: avg(200,150,300)=216");
    // day 4: avg(150, 300, 250) = 233
    assertEq(val(r1, 3, 2), "233", "day 4: avg(150,300,250)=233");
    // day 5: avg(300, 250) = 275
    assertEq(val(r1, 4, 2), "275", "day 5: avg(300,250)=275");
}

//=========================================================================
// MIN with ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
//=========================================================================

func testMinSliding() {
    section("MIN ROWS 1 PRECEDING AND 1 FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, MIN(amount) OVER (ORDER BY day ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) FROM sales");
    assertSuccess(r1, "min sliding");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 2), "100", "day 1: min(100,200)=100");
    assertEq(val(r1, 1, 2), "100", "day 2: min(100,200,150)=100");
    assertEq(val(r1, 2, 2), "150", "day 3: min(200,150,300)=150");
    assertEq(val(r1, 3, 2), "150", "day 4: min(150,300,250)=150");
    assertEq(val(r1, 4, 2), "250", "day 5: min(300,250)=250");
}

//=========================================================================
// MAX with ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
//=========================================================================

func testMaxSliding() {
    section("MAX ROWS 1 PRECEDING AND 1 FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, MAX(amount) OVER (ORDER BY day ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) FROM sales");
    assertSuccess(r1, "max sliding");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 2), "200", "day 1: max(100,200)=200");
    assertEq(val(r1, 1, 2), "200", "day 2: max(100,200,150)=200");
    assertEq(val(r1, 2, 2), "300", "day 3: max(200,150,300)=300");
    assertEq(val(r1, 3, 2), "300", "day 4: max(150,300,250)=300");
    assertEq(val(r1, 4, 2), "300", "day 5: max(300,250)=300");
}

//=========================================================================
// SUM with ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING
//=========================================================================

func testSumCurrentToEnd() {
    section("SUM ROWS CURRENT ROW AND UNBOUNDED FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) FROM sales");
    assertSuccess(r1, "current to end");
    assertRowCount(r1, 5, "5 rows");
    // Reverse running sum
    assertEq(val(r1, 0, 2), "1000", "day 1: all = 1000");
    assertEq(val(r1, 1, 2), "900", "day 2: 200+150+300+250=900");
    assertEq(val(r1, 2, 2), "700", "day 3: 150+300+250=700");
    assertEq(val(r1, 3, 2), "550", "day 4: 300+250=550");
    assertEq(val(r1, 4, 2), "250", "day 5: 250");
}

//=========================================================================
// SUM with ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING (whole partition)
//=========================================================================

func testSumEntirePartition() {
    section("SUM ROWS UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) FROM sales");
    assertSuccess(r1, "entire partition");
    assertRowCount(r1, 5, "5 rows");
    // Every row should see total = 1000
    assertEq(val(r1, 0, 2), "1000", "day 1: total");
    assertEq(val(r1, 1, 2), "1000", "day 2: total");
    assertEq(val(r1, 2, 2), "1000", "day 3: total");
    assertEq(val(r1, 3, 2), "1000", "day 4: total");
    assertEq(val(r1, 4, 2), "1000", "day 5: total");
}

//=========================================================================
// ROWS shorthand (ROWS N PRECEDING = ROWS BETWEEN N PRECEDING AND CURRENT ROW)
//=========================================================================

func testRowsShorthand() {
    section("ROWS shorthand (N PRECEDING)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS 2 PRECEDING) FROM sales");
    assertSuccess(r1, "rows shorthand");
    assertRowCount(r1, 5, "5 rows");
    // ROWS 2 PRECEDING = ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    assertEq(val(r1, 0, 2), "100", "day 1: just 100");
    assertEq(val(r1, 1, 2), "300", "day 2: 100+200=300");
    assertEq(val(r1, 2, 2), "450", "day 3: 100+200+150=450");
    assertEq(val(r1, 3, 2), "650", "day 4: 200+150+300=650");
    assertEq(val(r1, 4, 2), "700", "day 5: 150+300+250=700");
}

//=========================================================================
// Window frame with PARTITION BY
//=========================================================================

func testFrameWithPartition() {
    section("Frame with PARTITION BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (grp TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES ('A', 10)");
    exec.executeSql("INSERT INTO data VALUES ('A', 20)");
    exec.executeSql("INSERT INTO data VALUES ('A', 30)");
    exec.executeSql("INSERT INTO data VALUES ('B', 100)");
    exec.executeSql("INSERT INTO data VALUES ('B', 200)");

    var r1 = exec.executeSql("SELECT grp, val, SUM(val) OVER (PARTITION BY grp ORDER BY val ROWS BETWEEN 1 PRECEDING AND CURRENT ROW) FROM data");
    assertSuccess(r1, "frame + partition");
    assertRowCount(r1, 5, "5 rows");
    // Group A: [10], [10,20], [20,30]
    // Group B: [100], [100,200]
    // Find A rows (sorted by val)
    var foundA10 = false;
    var foundA20 = false;
    var foundA30 = false;
    var ri = 0;
    while ri < 5 {
        if val(r1, ri, 0) == "A" && val(r1, ri, 1) == "10" {
            assertEq(val(r1, ri, 2), "10", "A:10 sum=10");
            foundA10 = true;
        }
        if val(r1, ri, 0) == "A" && val(r1, ri, 1) == "20" {
            assertEq(val(r1, ri, 2), "30", "A:20 sum=10+20=30");
            foundA20 = true;
        }
        if val(r1, ri, 0) == "A" && val(r1, ri, 1) == "30" {
            assertEq(val(r1, ri, 2), "50", "A:30 sum=20+30=50");
            foundA30 = true;
        }
        ri = ri + 1;
    }
    assert(foundA10 && foundA20 && foundA30, "all A rows found");
}

//=========================================================================
// SUM with ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING
//=========================================================================

func testSumFollowing() {
    section("SUM ROWS CURRENT ROW AND 2 FOLLOWING");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER (ORDER BY day ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING) FROM sales");
    assertSuccess(r1, "current to 2 following");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 2), "450", "day 1: 100+200+150=450");
    assertEq(val(r1, 1, 2), "650", "day 2: 200+150+300=650");
    assertEq(val(r1, 2, 2), "700", "day 3: 150+300+250=700");
    assertEq(val(r1, 3, 2), "550", "day 4: 300+250=550");
    assertEq(val(r1, 4, 2), "250", "day 5: 250");
}

//=========================================================================
// Existing window functions still work (regression)
//=========================================================================

func testRegressionRowNumber() {
    section("ROW_NUMBER (regression)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT day, ROW_NUMBER() OVER (ORDER BY day) FROM sales");
    assertSuccess(r1, "ROW_NUMBER");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 1), "1", "row 1");
    assertEq(val(r1, 4, 1), "5", "row 5");
}

func testRegressionSumNoFrame() {
    section("SUM without frame (regression)");

    var exec = setupExec();

    // SUM over entire partition (no ORDER BY, no frame)
    // Note: window arg must be in SELECT list for resolution
    var r1 = exec.executeSql("SELECT day, amount, SUM(amount) OVER () FROM sales");
    assertSuccess(r1, "SUM over all");
    assertEq(val(r1, 0, 2), "1000", "total 1000");
    assertEq(val(r1, 4, 2), "1000", "total 1000 all rows");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 61: Window Frame Specifications ===");

    testSumRunning();
    testSumSliding3();
    testCountPreceding();
    testAvgMoving();
    testMinSliding();
    testMaxSliding();
    testSumCurrentToEnd();
    testSumEntirePartition();
    testRowsShorthand();
    testFrameWithPartition();
    testSumFollowing();
    testRegressionRowNumber();
    testRegressionSumNoFrame();

    printResults();
}
