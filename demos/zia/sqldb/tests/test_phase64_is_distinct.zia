// test_phase64_is_distinct.zia — Phase 64: IS DISTINCT FROM / IS NOT DISTINCT FROM
// NULL-safe comparison operators.

module test_phase64_is_distinct;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t (id INTEGER, val INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO t VALUES (1, 10, 'Alice')");
    exec.executeSql("INSERT INTO t VALUES (2, 20, 'Bob')");
    exec.executeSql("INSERT INTO t VALUES (3, 10, 'Carol')");
    exec.executeSql("INSERT INTO t (id, name) VALUES (4, 'Dave')");  // val=NULL
    exec.executeSql("INSERT INTO t (id, name) VALUES (5, 'Eve')");   // val=NULL

    return exec;
}

//=========================================================================
// IS DISTINCT FROM — basic (non-NULL vs non-NULL)
//=========================================================================

func testDistinctBasic() {
    section("IS DISTINCT FROM basic");

    var exec = setupExec();

    // Different values → true
    var r1 = exec.executeSql("SELECT id FROM t WHERE val IS DISTINCT FROM 10 ORDER BY id");
    assertSuccess(r1, "val IS DISTINCT FROM 10");
    assertRowCount(r1, 3, "3 rows (id 2 + NULL rows 4,5)");
    assertEq(val(r1, 0, 0), "2", "id=2 (val=20)");
    assertEq(val(r1, 1, 0), "4", "id=4 (val=NULL)");
    assertEq(val(r1, 2, 0), "5", "id=5 (val=NULL)");

    // Same value → false (not returned)
    var r2 = exec.executeSql("SELECT id FROM t WHERE val IS DISTINCT FROM 20 ORDER BY id");
    assertSuccess(r2, "val IS DISTINCT FROM 20");
    assertRowCount(r2, 4, "4 rows (not id=2)");
}

//=========================================================================
// IS DISTINCT FROM — NULL comparisons
//=========================================================================

func testDistinctNull() {
    section("IS DISTINCT FROM with NULL");

    var exec = setupExec();

    // NULL IS DISTINCT FROM NULL → false (NULLs considered equal)
    // So rows with NULL val should NOT match
    var r1 = exec.executeSql("SELECT id FROM t WHERE val IS DISTINCT FROM NULL ORDER BY id");
    assertSuccess(r1, "val IS DISTINCT FROM NULL");
    assertRowCount(r1, 3, "3 non-NULL val rows");
    assertEq(val(r1, 0, 0), "1", "id=1 (val=10)");
    assertEq(val(r1, 1, 0), "2", "id=2 (val=20)");
    assertEq(val(r1, 2, 0), "3", "id=3 (val=10)");

    // Compare to regular != NULL which returns empty (NULL != NULL is NULL)
    var r2 = exec.executeSql("SELECT id FROM t WHERE val != NULL ORDER BY id");
    assertSuccess(r2, "val != NULL (standard SQL)");
    assertRowCount(r2, 0, "0 rows (SQL NULL comparison)");
}

//=========================================================================
// IS NOT DISTINCT FROM — basic (non-NULL vs non-NULL)
//=========================================================================

func testNotDistinctBasic() {
    section("IS NOT DISTINCT FROM basic");

    var exec = setupExec();

    // Same values → true
    var r1 = exec.executeSql("SELECT id FROM t WHERE val IS NOT DISTINCT FROM 10 ORDER BY id");
    assertSuccess(r1, "val IS NOT DISTINCT FROM 10");
    assertRowCount(r1, 2, "2 rows with val=10");
    assertEq(val(r1, 0, 0), "1", "id=1");
    assertEq(val(r1, 1, 0), "3", "id=3");
}

//=========================================================================
// IS NOT DISTINCT FROM — NULL comparisons
//=========================================================================

func testNotDistinctNull() {
    section("IS NOT DISTINCT FROM NULL");

    var exec = setupExec();

    // NULL IS NOT DISTINCT FROM NULL → true (NULLs considered equal)
    var r1 = exec.executeSql("SELECT id FROM t WHERE val IS NOT DISTINCT FROM NULL ORDER BY id");
    assertSuccess(r1, "val IS NOT DISTINCT FROM NULL");
    assertRowCount(r1, 2, "2 NULL val rows");
    assertEq(val(r1, 0, 0), "4", "id=4 (val=NULL)");
    assertEq(val(r1, 1, 0), "5", "id=5 (val=NULL)");

    // Compare to regular = NULL which returns empty
    var r2 = exec.executeSql("SELECT id FROM t WHERE val = NULL ORDER BY id");
    assertSuccess(r2, "val = NULL (standard SQL)");
    assertRowCount(r2, 0, "0 rows (SQL NULL comparison)");
}

//=========================================================================
// Column vs column comparison
//=========================================================================

func testColumnComparison() {
    section("Column IS DISTINCT FROM column");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE pairs (id INTEGER, a INTEGER, b INTEGER)");
    exec.executeSql("INSERT INTO pairs VALUES (1, 10, 10)");   // same
    exec.executeSql("INSERT INTO pairs VALUES (2, 10, 20)");   // different
    exec.executeSql("INSERT INTO pairs (id, a) VALUES (3, 10)");   // b=NULL
    exec.executeSql("INSERT INTO pairs (id, b) VALUES (4, 10)");   // a=NULL
    exec.executeSql("INSERT INTO pairs (id) VALUES (5)");          // both NULL

    // IS DISTINCT FROM: rows where a and b are different (NULL-aware)
    var r1 = exec.executeSql("SELECT id FROM pairs WHERE a IS DISTINCT FROM b ORDER BY id");
    assertSuccess(r1, "a IS DISTINCT FROM b");
    assertRowCount(r1, 3, "3 distinct rows");
    assertEq(val(r1, 0, 0), "2", "id=2 (10 vs 20)");
    assertEq(val(r1, 1, 0), "3", "id=3 (10 vs NULL)");
    assertEq(val(r1, 2, 0), "4", "id=4 (NULL vs 10)");

    // IS NOT DISTINCT FROM: rows where a and b are the same (NULL-aware)
    var r2 = exec.executeSql("SELECT id FROM pairs WHERE a IS NOT DISTINCT FROM b ORDER BY id");
    assertSuccess(r2, "a IS NOT DISTINCT FROM b");
    assertRowCount(r2, 2, "2 not-distinct rows");
    assertEq(val(r2, 0, 0), "1", "id=1 (10 == 10)");
    assertEq(val(r2, 1, 0), "5", "id=5 (NULL == NULL)");
}

//=========================================================================
// Text comparisons
//=========================================================================

func testTextComparison() {
    section("IS DISTINCT FROM with TEXT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE names (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO names VALUES (1, 'Alice')");
    exec.executeSql("INSERT INTO names VALUES (2, 'Bob')");
    exec.executeSql("INSERT INTO names (id) VALUES (3)");  // name=NULL

    var r1 = exec.executeSql("SELECT id FROM names WHERE name IS NOT DISTINCT FROM 'Alice' ORDER BY id");
    assertSuccess(r1, "text IS NOT DISTINCT FROM");
    assertRowCount(r1, 1, "1 row");
    assertEq(val(r1, 0, 0), "1", "id=1 (Alice)");

    var r2 = exec.executeSql("SELECT id FROM names WHERE name IS DISTINCT FROM 'Alice' ORDER BY id");
    assertSuccess(r2, "text IS DISTINCT FROM");
    assertRowCount(r2, 2, "2 rows (Bob and NULL)");
    assertEq(val(r2, 0, 0), "2", "id=2 (Bob)");
    assertEq(val(r2, 1, 0), "3", "id=3 (NULL)");
}

//=========================================================================
// In SELECT expressions
//=========================================================================

func testInSelect() {
    section("IS DISTINCT FROM in SELECT");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, val IS DISTINCT FROM 10 FROM t ORDER BY id");
    assertSuccess(r1, "IS DISTINCT FROM in SELECT");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 1), "0", "id=1: 10 not distinct from 10");
    assertEq(val(r1, 1, 1), "1", "id=2: 20 distinct from 10");
    assertEq(val(r1, 2, 1), "0", "id=3: 10 not distinct from 10");
    assertEq(val(r1, 3, 1), "1", "id=4: NULL distinct from 10");
    assertEq(val(r1, 4, 1), "1", "id=5: NULL distinct from 10");
}

//=========================================================================
// With UPDATE
//=========================================================================

func testWithUpdate() {
    section("IS DISTINCT FROM with UPDATE");

    var exec = setupExec();

    // Set all distinct-from-10 rows to val=99
    exec.executeSql("UPDATE t SET val = 99 WHERE val IS DISTINCT FROM 10");

    var r1 = exec.executeSql("SELECT id, val FROM t ORDER BY id");
    assertSuccess(r1, "after UPDATE");
    assertEq(val(r1, 0, 1), "10", "id=1 unchanged");
    assertEq(val(r1, 1, 1), "99", "id=2 updated");
    assertEq(val(r1, 2, 1), "10", "id=3 unchanged");
    assertEq(val(r1, 3, 1), "99", "id=4 updated (was NULL)");
    assertEq(val(r1, 4, 1), "99", "id=5 updated (was NULL)");
}

//=========================================================================
// Regression: IS NULL / IS NOT NULL still work
//=========================================================================

func testRegressionIsNull() {
    section("Regression: IS NULL / IS NOT NULL");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id FROM t WHERE val IS NULL ORDER BY id");
    assertSuccess(r1, "IS NULL");
    assertRowCount(r1, 2, "2 NULL rows");
    assertEq(val(r1, 0, 0), "4", "id=4");
    assertEq(val(r1, 1, 0), "5", "id=5");

    var r2 = exec.executeSql("SELECT id FROM t WHERE val IS NOT NULL ORDER BY id");
    assertSuccess(r2, "IS NOT NULL");
    assertRowCount(r2, 3, "3 non-NULL rows");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 64: IS DISTINCT FROM / IS NOT DISTINCT FROM ===");

    testDistinctBasic();
    testDistinctNull();
    testNotDistinctBasic();
    testNotDistinctNull();
    testColumnComparison();
    testTextComparison();
    testInSelect();
    testWithUpdate();
    testRegressionIsNull();

    printResults();
}
