// test_phase4_cte.zia — Phase 4: Common Table Expressions (WITH clause) Tests
// Tests for WITH, multiple CTEs, CTE in INSERT/UPDATE/DELETE, nested queries

module test_phase4_cte;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "../types";

var passCount = 0;
var failCount = 0;

func assert(condition: Boolean, msg: String) {
    if condition {
        passCount = passCount + 1;
    } else {
        Terminal.Say("FAIL: " + msg);
        failCount = failCount + 1;
    }
}

func check(result: QueryResult, label: String) {
    if result.success == false {
        Terminal.Say("FAIL: " + label + " => " + result.message);
        failCount = failCount + 1;
    } else {
        passCount = passCount + 1;
    }
}

func val(result: QueryResult, row: Integer, col: Integer) -> String {
    var r = result.getRow(row);
    if r == null { return "NULL_ROW"; }
    var rr = r;
    return rr.getValue(col).toString();
}

func main() {
    Terminal.Say("=== Phase 4: Common Table Expressions Tests ===");

    var exec = new Executor();
    exec.init();

    //=========================================================================
    // Setup test data
    //=========================================================================
    check(exec.executeSql("CREATE TABLE employees (id INTEGER PRIMARY KEY, name TEXT, dept TEXT, salary INTEGER, manager_id INTEGER)"), "create employees");
    check(exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 'Engineering', 90000, NULL)"), "emp 1");
    check(exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 'Engineering', 80000, 1)"), "emp 2");
    check(exec.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 'Sales', 70000, 1)"), "emp 3");
    check(exec.executeSql("INSERT INTO employees VALUES (4, 'Dave', 'Sales', 60000, 3)"), "emp 4");
    check(exec.executeSql("INSERT INTO employees VALUES (5, 'Eve', 'Marketing', 75000, 1)"), "emp 5");
    check(exec.executeSql("INSERT INTO employees VALUES (6, 'Frank', 'Engineering', 85000, 2)"), "emp 6");
    check(exec.executeSql("INSERT INTO employees VALUES (7, 'Grace', 'Marketing', 65000, 5)"), "emp 7");

    //=========================================================================
    // Test 1: Simple CTE
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- Simple CTE ---");

    var r = exec.executeSql("WITH eng AS (SELECT * FROM employees WHERE dept = 'Engineering') SELECT COUNT(*) FROM eng");
    check(r, "simple CTE");
    assert(val(r, 0, 0) == "3", "CTE: 3 engineers: " + val(r, 0, 0));

    //=========================================================================
    // Test 2: CTE with column selection
    //=========================================================================
    r = exec.executeSql("WITH high_earners AS (SELECT name, salary FROM employees WHERE salary >= 75000) SELECT name FROM high_earners ORDER BY name");
    check(r, "CTE with filtered columns");
    assert(val(r, 0, 0) == "Alice", "high earner 0 = Alice: " + val(r, 0, 0));
    assert(val(r, 1, 0) == "Bob", "high earner 1 = Bob");
    assert(val(r, 2, 0) == "Eve", "high earner 2 = Eve");
    assert(val(r, 3, 0) == "Frank", "high earner 3 = Frank");

    //=========================================================================
    // Test 3: CTE with aggregation
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE with Aggregation ---");

    r = exec.executeSql("WITH dept_stats AS (SELECT dept, COUNT(*) AS cnt, SUM(salary) AS total FROM employees GROUP BY dept) SELECT dept, cnt FROM dept_stats ORDER BY dept");
    check(r, "CTE with aggregation");
    assert(val(r, 0, 0) == "Engineering", "dept 0 = Engineering");
    assert(val(r, 0, 1) == "3", "Engineering count = 3: " + val(r, 0, 1));
    assert(val(r, 1, 0) == "Marketing", "dept 1 = Marketing");
    assert(val(r, 1, 1) == "2", "Marketing count = 2: " + val(r, 1, 1));
    assert(val(r, 2, 0) == "Sales", "dept 2 = Sales");
    assert(val(r, 2, 1) == "2", "Sales count = 2: " + val(r, 2, 1));

    //=========================================================================
    // Test 4: Multiple CTEs
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- Multiple CTEs ---");

    r = exec.executeSql("WITH eng AS (SELECT * FROM employees WHERE dept = 'Engineering'), sales AS (SELECT * FROM employees WHERE dept = 'Sales') SELECT COUNT(*) FROM eng");
    check(r, "multiple CTEs");
    assert(val(r, 0, 0) == "3", "multiple CTEs: eng count = 3: " + val(r, 0, 0));

    r = exec.executeSql("WITH eng AS (SELECT * FROM employees WHERE dept = 'Engineering'), sales AS (SELECT * FROM employees WHERE dept = 'Sales') SELECT COUNT(*) FROM sales");
    check(r, "multiple CTEs query sales");
    assert(val(r, 0, 0) == "2", "multiple CTEs: sales count = 2: " + val(r, 0, 0));

    //=========================================================================
    // Test 5: CTE referenced in WHERE subquery
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE in Complex Queries ---");

    r = exec.executeSql("WITH avg_sal AS (SELECT AVG(salary) AS avg_salary FROM employees) SELECT name FROM employees WHERE salary > (SELECT avg_salary FROM avg_sal) ORDER BY name");
    check(r, "CTE with subquery reference");
    // Average salary = (90000+80000+70000+60000+75000+85000+65000)/7 = 525000/7 = 75000
    // Above average: Alice(90000), Bob(80000), Frank(85000)
    assert(val(r, 0, 0) == "Alice", "above avg 0 = Alice: " + val(r, 0, 0));
    assert(val(r, 1, 0) == "Bob", "above avg 1 = Bob: " + val(r, 1, 0));
    assert(val(r, 2, 0) == "Frank", "above avg 2 = Frank: " + val(r, 2, 0));
    assert(r.rowCount() == 3, "3 employees above avg salary");

    //=========================================================================
    // Test 6: CTE used in INSERT...SELECT
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE in INSERT ---");

    check(exec.executeSql("CREATE TABLE bonus_list (name TEXT, bonus INTEGER)"), "create bonus_list");

    r = exec.executeSql("WITH top_earners AS (SELECT name, salary FROM employees WHERE salary >= 80000) INSERT INTO bonus_list SELECT name, salary / 10 FROM top_earners");
    check(r, "CTE in INSERT...SELECT");

    r = exec.executeSql("SELECT COUNT(*) FROM bonus_list");
    assert(val(r, 0, 0) == "3", "bonus list has 3 entries: " + val(r, 0, 0));

    r = exec.executeSql("SELECT name FROM bonus_list ORDER BY name");
    assert(val(r, 0, 0) == "Alice", "bonus 0 = Alice");
    assert(val(r, 1, 0) == "Bob", "bonus 1 = Bob");
    assert(val(r, 2, 0) == "Frank", "bonus 2 = Frank");

    //=========================================================================
    // Test 7: CTE cleanup — temp tables are removed
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE Cleanup ---");

    r = exec.executeSql("SELECT * FROM eng");
    assert(r.success == false, "CTE temp table 'eng' not accessible after query: " + r.message);

    r = exec.executeSql("SELECT * FROM high_earners");
    assert(r.success == false, "CTE temp table 'high_earners' not accessible after query");

    //=========================================================================
    // Test 8: CTE with JOIN
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE with JOIN ---");

    check(exec.executeSql("CREATE TABLE departments (id INTEGER PRIMARY KEY, dept_name TEXT, budget INTEGER)"), "create departments");
    check(exec.executeSql("INSERT INTO departments VALUES (1, 'Engineering', 500000)"), "dept 1");
    check(exec.executeSql("INSERT INTO departments VALUES (2, 'Sales', 300000)"), "dept 2");
    check(exec.executeSql("INSERT INTO departments VALUES (3, 'Marketing', 200000)"), "dept 3");

    r = exec.executeSql("WITH dept_count AS (SELECT dept, COUNT(*) AS emp_count FROM employees GROUP BY dept) SELECT d.dept_name, dc.emp_count FROM departments d INNER JOIN dept_count dc ON d.dept_name = dc.dept ORDER BY d.dept_name");
    check(r, "CTE with JOIN");
    assert(val(r, 0, 0) == "Engineering", "join dept 0 = Engineering");
    assert(val(r, 0, 1) == "3", "Engineering emp count = 3: " + val(r, 0, 1));

    //=========================================================================
    // Test 9: CTE referencing earlier CTE
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- CTE Chaining ---");

    r = exec.executeSql("WITH dept_totals AS (SELECT dept, SUM(salary) AS total_sal FROM employees GROUP BY dept), big_depts AS (SELECT dept FROM dept_totals WHERE total_sal > 200000) SELECT dept FROM big_depts ORDER BY dept");
    check(r, "CTE chaining");
    // Engineering: 90000+80000+85000=255000, Sales: 70000+60000=130000, Marketing: 75000+65000=140000
    assert(val(r, 0, 0) == "Engineering", "big dept = Engineering: " + val(r, 0, 0));
    assert(r.rowCount() == 1, "only 1 big dept: " + Fmt.Int(r.rowCount()));

    //=========================================================================
    // Summary
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passCount));
    Terminal.Say("Failed: " + Fmt.Int(failCount));

    Terminal.Say("=== Phase 4 CTEs: " + Fmt.Int(passCount) + " passed, " + Fmt.Int(failCount) + " failed ===");
}
