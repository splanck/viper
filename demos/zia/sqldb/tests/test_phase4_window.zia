// test_phase4_window.zia â€” Phase 4: Window Functions Tests
// Tests for ROW_NUMBER, RANK, DENSE_RANK, SUM/COUNT/AVG/MIN/MAX OVER

module test_phase4_window;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";

bind "../executor";
bind "../types";

func main() -> Integer {
    Terminal.Say("=== Phase 4: Window Functions Tests ===");

    var exec = new Executor();
    exec.init();

    //=========================================================================
    // Setup test data
    //=========================================================================
    assertSuccess(exec.executeSql("CREATE TABLE employees (id INTEGER PRIMARY KEY, name TEXT, dept TEXT, salary INTEGER)"), "create employees");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 'Engineering', 90000)"), "emp 1");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 'Engineering', 80000)"), "emp 2");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 'Sales', 70000)"), "emp 3");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (4, 'Dave', 'Sales', 60000)"), "emp 4");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (5, 'Eve', 'Engineering', 85000)"), "emp 5");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (6, 'Frank', 'Sales', 75000)"), "emp 6");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (7, 'Grace', 'Marketing', 65000)"), "emp 7");
    assertSuccess(exec.executeSql("INSERT INTO employees VALUES (8, 'Heidi', 'Marketing', 70000)"), "emp 8");

    //=========================================================================
    // ROW_NUMBER
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- ROW_NUMBER ---");

    // Test 1: Simple ROW_NUMBER with ORDER BY
    var r = exec.executeSql("SELECT name, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) AS rn FROM employees");
    assertSuccess(r, "ROW_NUMBER");
    // Sorted by salary DESC: Alice(90000), Eve(85000), Bob(80000), Frank(75000),
    // Charlie/Heidi(70000), Grace(65000), Dave(60000)
    assert(val(r, 0, 2) == "1", "row 0 rn=1: " + val(r, 0, 2));
    assert(val(r, 0, 0) == "Alice", "row 0 = Alice: " + val(r, 0, 0));

    // Test 2: ROW_NUMBER with PARTITION BY
    r = exec.executeSql("SELECT name, dept, salary, ROW_NUMBER() OVER (PARTITION BY dept ORDER BY salary DESC) AS rn FROM employees");
    assertSuccess(r, "ROW_NUMBER with PARTITION");

    // Find Engineering rows and check their row numbers
    // Engineering: Alice(90000)=1, Eve(85000)=2, Bob(80000)=3
    var engRows = 0;
    var salesRows = 0;
    var mktRows = 0;
    var i = 0;
    while i < r.rowCount() {
        var dept = val(r, i, 1);
        var rn = val(r, i, 3);
        if dept == "Engineering" {
            engRows = engRows + 1;
            if rn == "1" {
                assert(val(r, i, 0) == "Alice", "Eng rank 1 = Alice: " + val(r, i, 0));
            }
        }
        if dept == "Sales" { salesRows = salesRows + 1; }
        if dept == "Marketing" { mktRows = mktRows + 1; }
        i = i + 1;
    }
    assert(engRows == 3, "3 engineering rows: " + Fmt.Int(engRows));
    assert(salesRows == 3, "3 sales rows: " + Fmt.Int(salesRows));
    assert(mktRows == 2, "2 marketing rows: " + Fmt.Int(mktRows));

    //=========================================================================
    // RANK
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- RANK ---");

    // Create data with ties
    assertSuccess(exec.executeSql("CREATE TABLE scores (id INTEGER PRIMARY KEY, name TEXT, score INTEGER)"), "create scores");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (1, 'A', 100)"), "score 1");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (2, 'B', 90)"), "score 2");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (3, 'C', 90)"), "score 3");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (4, 'D', 80)"), "score 4");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (5, 'E', 80)"), "score 5");
    assertSuccess(exec.executeSql("INSERT INTO scores VALUES (6, 'F', 70)"), "score 6");

    r = exec.executeSql("SELECT name, score, RANK() OVER (ORDER BY score DESC) AS rnk FROM scores");
    assertSuccess(r, "RANK");

    // Expected: A=1, B=2, C=2, D=4, E=4, F=6
    // Find rows by name and check rank
    i = 0;
    while i < r.rowCount() {
        var name = val(r, i, 0);
        var rnk = val(r, i, 2);
        if name == "A" { assert(rnk == "1", "A rank=1: " + rnk); }
        if name == "B" { assert(rnk == "2", "B rank=2: " + rnk); }
        if name == "C" { assert(rnk == "2", "C rank=2: " + rnk); }
        if name == "D" { assert(rnk == "4", "D rank=4: " + rnk); }
        if name == "E" { assert(rnk == "4", "E rank=4: " + rnk); }
        if name == "F" { assert(rnk == "6", "F rank=6: " + rnk); }
        i = i + 1;
    }

    //=========================================================================
    // DENSE_RANK
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- DENSE_RANK ---");

    r = exec.executeSql("SELECT name, score, DENSE_RANK() OVER (ORDER BY score DESC) AS drnk FROM scores");
    assertSuccess(r, "DENSE_RANK");

    // Expected: A=1, B=2, C=2, D=3, E=3, F=4
    i = 0;
    while i < r.rowCount() {
        var name = val(r, i, 0);
        var drnk = val(r, i, 2);
        if name == "A" { assert(drnk == "1", "A dense_rank=1: " + drnk); }
        if name == "B" { assert(drnk == "2", "B dense_rank=2: " + drnk); }
        if name == "C" { assert(drnk == "2", "C dense_rank=2: " + drnk); }
        if name == "D" { assert(drnk == "3", "D dense_rank=3: " + drnk); }
        if name == "E" { assert(drnk == "3", "E dense_rank=3: " + drnk); }
        if name == "F" { assert(drnk == "4", "F dense_rank=4: " + drnk); }
        i = i + 1;
    }

    //=========================================================================
    // SUM OVER (running sum)
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- SUM OVER ---");

    r = exec.executeSql("SELECT name, salary, SUM(salary) OVER (ORDER BY salary) AS running_sum FROM employees");
    assertSuccess(r, "SUM OVER");
    // The running sum should increase with each row (sorted by salary ASC)

    // Test with PARTITION BY
    r = exec.executeSql("SELECT name, dept, salary, SUM(salary) OVER (PARTITION BY dept ORDER BY salary) AS dept_running_sum FROM employees");
    assertSuccess(r, "SUM OVER PARTITION");

    // Check that the running sum within Engineering partition adds up correctly
    // Engineering sorted by salary: Bob(80000), Eve(85000), Alice(90000)
    // Running sums: 80000, 165000, 255000
    var found80 = false;
    var found165 = false;
    var found255 = false;
    i = 0;
    while i < r.rowCount() {
        if val(r, i, 1) == "Engineering" {
            var sum = val(r, i, 3);
            if sum == "80000" { found80 = true; }
            if sum == "165000" { found165 = true; }
            if sum == "255000" { found255 = true; }
        }
        i = i + 1;
    }
    assert(found80, "Eng running sum has 80000");
    assert(found165, "Eng running sum has 165000");
    assert(found255, "Eng running sum has 255000");

    //=========================================================================
    // COUNT OVER
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- COUNT OVER ---");

    r = exec.executeSql("SELECT name, dept, COUNT(*) OVER (PARTITION BY dept) AS dept_count FROM employees");
    assertSuccess(r, "COUNT OVER PARTITION");

    // Every Engineering row should have dept_count=3
    // Every Sales row should have dept_count=3
    // Every Marketing row should have dept_count=2
    i = 0;
    while i < r.rowCount() {
        var dept = val(r, i, 1);
        var cnt = val(r, i, 2);
        if dept == "Engineering" {
            assert(cnt == "3", "Eng count=3: " + cnt);
        }
        if dept == "Sales" {
            assert(cnt == "3", "Sales count=3: " + cnt);
        }
        if dept == "Marketing" {
            assert(cnt == "2", "Mkt count=2: " + cnt);
        }
        i = i + 1;
    }

    //=========================================================================
    // Multiple window functions in same query
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- Multiple Window Functions ---");

    r = exec.executeSql("SELECT name, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) AS rn, RANK() OVER (ORDER BY salary DESC) AS rnk FROM scores");
    assertSuccess(r, "multiple window functions");
    assert(r.rowCount() == 6, "6 rows in result");

    //=========================================================================
    // Summary
    //=========================================================================
    printResults();
    return 0;
}
