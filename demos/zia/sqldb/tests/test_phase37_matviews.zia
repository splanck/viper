// test_phase37_matviews.zia — Phase 37: Materialized Views
// Tests for CREATE/REFRESH/DROP MATERIALIZED VIEW.

module test_phase37_matviews;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// CREATE MATERIALIZED VIEW
//=========================================================================

func testCreateMatView() {
    section("CREATE MATERIALIZED VIEW");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 100)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 200)");
    exec.executeSql("INSERT INTO products VALUES (3, 'Doohickey', 150)");

    // Create materialized view
    var r1 = exec.executeSql("CREATE MATERIALIZED VIEW expensive AS SELECT id, name, price FROM products WHERE price >= 150");
    assertSuccess(r1, "CREATE MATERIALIZED VIEW succeeds");
    assertTrue(stringContains(r1.message, "2 rows"), "materialized 2 rows");

    // Query the materialized view (reads from stored data, not source table)
    var r2 = exec.executeSql("SELECT name FROM expensive ORDER BY name");
    assertSuccess(r2, "SELECT from matview succeeds");
    assertEq(val(r2, 0, 0), "Doohickey", "first row");
    assertEq(val(r2, 1, 0), "Gadget", "second row");
    assertEqInt(r2.rows.count(), 2, "2 rows in matview");
}

//=========================================================================
// SELECT FROM MATERIALIZED VIEW
//=========================================================================

func testSelectFromMatView() {
    section("SELECT from materialized view");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (student TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES ('Alice', 90)");
    exec.executeSql("INSERT INTO scores VALUES ('Bob', 80)");
    exec.executeSql("INSERT INTO scores VALUES ('Charlie', 95)");

    exec.executeSql("CREATE MATERIALIZED VIEW top_students AS SELECT student, score FROM scores WHERE score >= 85");

    // Query with WHERE on the materialized view
    var r1 = exec.executeSql("SELECT student FROM top_students WHERE score >= 90 ORDER BY student");
    assertSuccess(r1, "SELECT with WHERE on matview");
    assertEqInt(r1.rows.count(), 2, "2 students with score >= 90");
    assertEq(val(r1, 0, 0), "Alice", "Alice has 90+");
    assertEq(val(r1, 1, 0), "Charlie", "Charlie has 90+");

    // Matview data is snapshot — changes to source table don't affect it
    exec.executeSql("INSERT INTO scores VALUES ('Diana', 99)");
    var r2 = exec.executeSql("SELECT COUNT(*) FROM top_students");
    assertSuccess(r2, "matview is a snapshot");
    assertEq(val(r2, 0, 0), "2", "still 2 rows — Diana not in snapshot");
}

//=========================================================================
// REFRESH MATERIALIZED VIEW
//=========================================================================

func testRefreshMatView() {
    section("REFRESH MATERIALIZED VIEW");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE inventory (item TEXT, qty INTEGER)");
    exec.executeSql("INSERT INTO inventory VALUES ('apples', 50)");
    exec.executeSql("INSERT INTO inventory VALUES ('bananas', 30)");
    exec.executeSql("INSERT INTO inventory VALUES ('cherries', 10)");

    exec.executeSql("CREATE MATERIALIZED VIEW low_stock AS SELECT item, qty FROM inventory WHERE qty < 40");

    // Initially 2 items in low stock
    var r1 = exec.executeSql("SELECT COUNT(*) FROM low_stock");
    assertEq(val(r1, 0, 0), "2", "initial: 2 low stock items");

    // Add more data and change existing
    exec.executeSql("INSERT INTO inventory VALUES ('dates', 5)");
    exec.executeSql("UPDATE inventory SET qty = 20 WHERE item = 'apples'");

    // Matview still shows old data
    var r2 = exec.executeSql("SELECT COUNT(*) FROM low_stock");
    assertEq(val(r2, 0, 0), "2", "before refresh: still 2");

    // Refresh the materialized view
    var r3 = exec.executeSql("REFRESH MATERIALIZED VIEW low_stock");
    assertSuccess(r3, "REFRESH succeeds");
    assertTrue(stringContains(r3.message, "refreshed"), "refresh message");

    // Now matview shows updated data
    var r4 = exec.executeSql("SELECT COUNT(*) FROM low_stock");
    assertEq(val(r4, 0, 0), "4", "after refresh: 4 low stock items");

    // Verify new content
    var r5 = exec.executeSql("SELECT item FROM low_stock ORDER BY item");
    assertSuccess(r5, "query refreshed matview");
    assertEq(val(r5, 0, 0), "apples", "apples now low stock");
    assertEq(val(r5, 1, 0), "bananas", "bananas still low stock");
    assertEq(val(r5, 2, 0), "cherries", "cherries still low stock");
    assertEq(val(r5, 3, 0), "dates", "dates is new low stock");
}

//=========================================================================
// DROP MATERIALIZED VIEW
//=========================================================================

func testDropMatView() {
    section("DROP MATERIALIZED VIEW");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data_t (x INTEGER)");
    exec.executeSql("INSERT INTO data_t VALUES (1)");
    exec.executeSql("INSERT INTO data_t VALUES (2)");

    exec.executeSql("CREATE MATERIALIZED VIEW mv_data AS SELECT x FROM data_t");

    // Verify it exists
    var r1 = exec.executeSql("SELECT COUNT(*) FROM mv_data");
    assertEq(val(r1, 0, 0), "2", "matview has 2 rows");

    // Drop it
    var r2 = exec.executeSql("DROP MATERIALIZED VIEW mv_data");
    assertSuccess(r2, "DROP MATERIALIZED VIEW succeeds");
    assertTrue(stringContains(r2.message, "dropped"), "drop message");

    // Verify it's gone
    var r3 = exec.executeSql("SELECT * FROM mv_data");
    assertFailure(r3, "SELECT from dropped matview fails");
}

//=========================================================================
// ERROR HANDLING
//=========================================================================

func testMatViewErrors() {
    section("Materialized view errors");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE err_t (id INTEGER)");
    exec.executeSql("INSERT INTO err_t VALUES (1)");

    exec.executeSql("CREATE MATERIALIZED VIEW mv_err AS SELECT id FROM err_t");

    // Duplicate materialized view
    var r1 = exec.executeSql("CREATE MATERIALIZED VIEW mv_err AS SELECT id FROM err_t");
    assertFailure(r1, "duplicate matview fails");
    assertTrue(stringContains(r1.message, "already exists"), "already exists error");

    // Refresh nonexistent
    var r2 = exec.executeSql("REFRESH MATERIALIZED VIEW nonexistent");
    assertFailure(r2, "refresh nonexistent fails");
    assertTrue(stringContains(r2.message, "does not exist"), "not exist error");

    // Drop nonexistent
    var r3 = exec.executeSql("DROP MATERIALIZED VIEW nonexistent");
    assertFailure(r3, "drop nonexistent fails");
    assertTrue(stringContains(r3.message, "does not exist"), "not exist error on drop");

    // Name conflict with table
    var r4 = exec.executeSql("CREATE MATERIALIZED VIEW err_t AS SELECT id FROM err_t");
    assertFailure(r4, "matview name conflicts with table");
    assertTrue(stringContains(r4.message, "table"), "table conflict message");
}

//=========================================================================
// MATERIALIZED VIEW with aggregation
//=========================================================================

func testMatViewWithAggregation() {
    section("Materialized view with aggregation");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (region TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES ('North', 100)");
    exec.executeSql("INSERT INTO sales VALUES ('North', 200)");
    exec.executeSql("INSERT INTO sales VALUES ('South', 150)");
    exec.executeSql("INSERT INTO sales VALUES ('South', 250)");

    // Create matview with GROUP BY aggregation
    var r1 = exec.executeSql("CREATE MATERIALIZED VIEW region_totals AS SELECT region, SUM(amount) FROM sales GROUP BY region ORDER BY region");
    assertSuccess(r1, "matview with aggregation succeeds");

    var r2 = exec.executeSql("SELECT * FROM region_totals ORDER BY region");
    assertSuccess(r2, "query aggregated matview");
    assertEqInt(r2.rows.count(), 2, "2 regions");
    assertEq(val(r2, 0, 0), "North", "first region");
    assertEq(val(r2, 0, 1), "300", "north total");
    assertEq(val(r2, 1, 0), "South", "second region");
    assertEq(val(r2, 1, 1), "400", "south total");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 37: Materialized Views ===");

    testCreateMatView();
    testSelectFromMatView();
    testRefreshMatView();
    testDropMatView();
    testMatViewErrors();
    testMatViewWithAggregation();

    printResults();
}
