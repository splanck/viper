// test_system_views.zia â€” Tests for system views (Phase 8.2)
// Part of ViperSQL

module test_system_views;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "../types";
bind "../server";

//=============================================================================
// TEST HARNESS
//=============================================================================

Integer passed = 0;
Integer failed = 0;

func check(result: QueryResult, label: String) {
    if result.success == false {
        Terminal.Say("  FAIL: " + label + " => " + result.message);
        failed = failed + 1;
    } else {
        passed = passed + 1;
    }
}

func assert(cond: Boolean, msg: String) {
    if cond {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

//=============================================================================
// TEST: INFORMATION_SCHEMA.TABLES
//=============================================================================

func testInformationSchemaTables() {
    Terminal.Say("Testing information_schema.tables...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE users (id INTEGER, name TEXT)"), "create users");
    check(exec.executeSql("CREATE TABLE orders (id INTEGER, user_id INTEGER)"), "create orders");

    var r = exec.executeSql("SELECT * FROM information_schema.tables");
    check(r, "SELECT from information_schema.tables");
    assert(r.rowCount() >= 2, "At least 2 tables listed");
    assert(r.columnNames.count() == 4, "4 columns: catalog, schema, name, type");
}

//=============================================================================
// TEST: INFORMATION_SCHEMA.COLUMNS
//=============================================================================

func testInformationSchemaColumns() {
    Terminal.Say("Testing information_schema.columns...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE staff (id INTEGER PRIMARY KEY, name TEXT NOT NULL, salary INTEGER)"), "create staff");

    var r = exec.executeSql("SELECT * FROM information_schema.columns");
    check(r, "SELECT from information_schema.columns");
    assert(r.rowCount() >= 3, "At least 3 columns (id, name, salary)");
    assert(r.columnNames.count() == 6, "6 columns in result");
}

//=============================================================================
// TEST: INFORMATION_SCHEMA.SCHEMATA
//=============================================================================

func testInformationSchemaSchemata() {
    Terminal.Say("Testing information_schema.schemata...");

    var exec = new Executor();
    exec.init();

    var r = exec.executeSql("SELECT * FROM information_schema.schemata");
    check(r, "SELECT from information_schema.schemata");
    assert(r.rowCount() >= 1, "At least 1 schema (main)");
}

//=============================================================================
// TEST: SYS.DATABASES
//=============================================================================

func testSysDatabases() {
    Terminal.Say("Testing sys.databases...");

    var exec = new Executor();
    exec.init();

    var r = exec.executeSql("SELECT * FROM sys.databases");
    check(r, "SELECT from sys.databases");
    assert(r.rowCount() >= 1, "At least 1 database");
    assert(r.columnNames.count() == 4, "4 columns: name, table_count, is_persistent, file_path");
}

//=============================================================================
// TEST: SYS.TABLES
//=============================================================================

func testSysTables() {
    Terminal.Say("Testing sys.tables...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price INTEGER)"), "create products");
    check(exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 10)"), "insert 1");
    check(exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 20)"), "insert 2");

    var r = exec.executeSql("SELECT * FROM sys.tables");
    check(r, "SELECT from sys.tables");
    assert(r.rowCount() >= 1, "At least 1 table in result");
    assert(r.columnNames.count() == 4, "4 columns: db, name, rows, cols");
}

//=============================================================================
// TEST: SYS.COLUMNS
//=============================================================================

func testSysColumns() {
    Terminal.Say("Testing sys.columns...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE items (id INTEGER PRIMARY KEY, label TEXT NOT NULL)"), "create items");

    var r = exec.executeSql("SELECT * FROM sys.columns");
    check(r, "SELECT from sys.columns");
    assert(r.rowCount() >= 2, "At least 2 columns (id, label)");
    assert(r.columnNames.count() == 5, "5 columns: table, name, type, pk, nullable");
}

//=============================================================================
// TEST: SYS.STATS
//=============================================================================

func testSysStats() {
    Terminal.Say("Testing sys.stats...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE t1 (x INTEGER)"), "create t1");
    check(exec.executeSql("INSERT INTO t1 VALUES (1)"), "insert");

    var r = exec.executeSql("SELECT * FROM sys.stats");
    check(r, "SELECT from sys.stats");
    assert(r.rowCount() >= 3, "At least 3 stats rows");
}

//=============================================================================
// TEST: Case insensitivity
//=============================================================================

func testCaseInsensitive() {
    Terminal.Say("Testing system views are case-insensitive...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE test_ci (id INTEGER)"), "create table");

    var r1 = exec.executeSql("SELECT * FROM INFORMATION_SCHEMA.TABLES");
    check(r1, "UPPERCASE works");

    var r2 = exec.executeSql("SELECT * FROM SYS.DATABASES");
    check(r2, "SYS.DATABASES uppercase works");
}

//=============================================================================
// TEST: System views with multi-database server
//=============================================================================

func testMultiDatabaseViews() {
    Terminal.Say("Testing system views across multiple databases...");

    var exec = new Executor();
    exec.init();

    check(exec.executeSql("CREATE TABLE main_t (id INTEGER)"), "create in main");
    check(exec.executeSql("CREATE DATABASE testdb"), "create testdb");
    check(exec.executeSql("USE testdb"), "switch to testdb");
    check(exec.executeSql("CREATE TABLE testdb_t (name TEXT)"), "create in testdb");

    // sys.databases should show both
    var r1 = exec.executeSql("SELECT * FROM sys.databases");
    check(r1, "sys.databases");
    assert(r1.rowCount() >= 2, "At least 2 databases (main, testdb)");

    // information_schema.tables should show tables from all dbs
    var r2 = exec.executeSql("SELECT * FROM information_schema.tables");
    check(r2, "information_schema.tables");
    assert(r2.rowCount() >= 2, "Tables from multiple databases visible");
}

//=============================================================================
// ENTRY POINT
//=============================================================================

func start() {
    Terminal.Say("=== Phase 8.2: System Views Tests ===");
    Terminal.Say("");

    testInformationSchemaTables();
    testInformationSchemaColumns();
    testInformationSchemaSchemata();
    testSysDatabases();
    testSysTables();
    testSysColumns();
    testSysStats();
    testCaseInsensitive();
    testMultiDatabaseViews();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    }
}
