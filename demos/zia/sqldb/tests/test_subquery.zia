// test_subquery.zia â€” Test subquery support
// Part of ViperSQL
module test_subquery;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "./test_common";

func main() {
    var exec = new Executor();
    exec.init();

    Terminal.Say("=== Subquery Tests ===");
    Terminal.Say("");

    // Create test tables
    exec.executeSql("CREATE TABLE departments (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO departments VALUES (1, 'Engineering')");
    exec.executeSql("INSERT INTO departments VALUES (2, 'Marketing')");
    exec.executeSql("INSERT INTO departments VALUES (3, 'Sales')");

    exec.executeSql("CREATE TABLE employees (id INTEGER, name TEXT, dept_id INTEGER, salary INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 1, 80000)");
    exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 1, 75000)");
    exec.executeSql("INSERT INTO employees VALUES (3, 'Charlie', 2, 65000)");
    exec.executeSql("INSERT INTO employees VALUES (4, 'Diana', 2, 70000)");
    exec.executeSql("INSERT INTO employees VALUES (5, 'Eve', 3, 60000)");

    // Test scalar subquery in WHERE clause
    Terminal.Say("Testing scalar subquery in WHERE...");
    var r1 = exec.executeSql("SELECT name FROM employees WHERE salary = (SELECT MAX(salary) FROM employees)");
    assert(r1.success, "Scalar subquery should work");
    assert(r1.rowCount() == 1, "Should return 1 row for max salary");
    if r1.rowCount() == 1 {
        var row = r1.getRow(0);
        if row != null {
            var r = row;
            var name = r.getValue(0);
            assert(name.textValue == "Alice", "Max salary employee should be Alice");
        }
    }

    // Test subquery with MIN
    Terminal.Say("Testing MIN subquery...");
    var r2 = exec.executeSql("SELECT name FROM employees WHERE salary = (SELECT MIN(salary) FROM employees)");
    assert(r2.success, "MIN subquery should work");
    assert(r2.rowCount() == 1, "Should return 1 row for min salary");
    if r2.rowCount() == 1 {
        var row = r2.getRow(0);
        if row != null {
            var r = row;
            var name = r.getValue(0);
            assert(name.textValue == "Eve", "Min salary employee should be Eve");
        }
    }

    // Test IN subquery
    Terminal.Say("Testing IN subquery...");
    var r3 = exec.executeSql("SELECT name FROM employees WHERE dept_id IN (SELECT id FROM departments WHERE name = 'Engineering')");
    assert(r3.success, "IN subquery should work");
    assert(r3.rowCount() == 2, "Should return 2 engineering employees");

    // Test IN subquery with multiple values
    Terminal.Say("Testing IN with multiple values...");
    var r4 = exec.executeSql("SELECT name FROM employees WHERE dept_id IN (SELECT id FROM departments WHERE id <= 2)");
    assert(r4.success, "IN subquery with multiple values should work");
    assert(r4.rowCount() == 4, "Should return 4 employees (Engineering + Marketing)");

    // Test scalar subquery in SELECT column (comparison)
    Terminal.Say("Testing subquery comparison...");
    var r5 = exec.executeSql("SELECT name FROM employees WHERE salary > (SELECT AVG(salary) FROM employees)");
    assert(r5.success, "Comparison with subquery should work");
    // AVG salary = (80000+75000+65000+70000+60000)/5 = 70000
    // So employees > 70000: Alice (80000), Bob (75000) = 2 employees
    assert(r5.rowCount() == 2, "Should return 2 employees above average");

    // Test NOT IN (using comparison)
    Terminal.Say("Testing subquery with comparison operators...");
    var r6 = exec.executeSql("SELECT COUNT(*) FROM employees WHERE dept_id = (SELECT id FROM departments WHERE name = 'Sales')");
    assert(r6.success, "COUNT with subquery should work");
    if r6.rowCount() == 1 {
        var row = r6.getRow(0);
        if row != null {
            var r = row;
            var cnt = r.getValue(0);
            assert(cnt.intValue == 1, "Should have 1 sales employee");
        }
    }

    // Test nested conditions with subquery
    Terminal.Say("Testing complex conditions with subquery...");
    var r7 = exec.executeSql("SELECT name FROM employees WHERE salary >= 70000 AND dept_id IN (SELECT id FROM departments WHERE id = 1)");
    assert(r7.success, "Complex condition with subquery should work");
    assert(r7.rowCount() == 2, "Should return Alice and Bob (Engineering with salary >= 70000)");

    // Print results
    printResults();
}
