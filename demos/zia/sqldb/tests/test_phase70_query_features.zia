// test_phase70_query_features.zia — Phase 70: BETWEEN SYMMETRIC, TABLESAMPLE, Column Aliases in ORDER BY
// Tests for symmetric range checks, table sampling, and alias-based ordering.

module test_phase70_query_features;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// BETWEEN SYMMETRIC — basic usage
//=========================================================================

func testBetweenSymmetric() {
    section("BETWEEN SYMMETRIC");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE vals (id INTEGER, n INTEGER)");
    exec.executeSql("INSERT INTO vals VALUES (1, 5)");
    exec.executeSql("INSERT INTO vals VALUES (2, 10)");
    exec.executeSql("INSERT INTO vals VALUES (3, 15)");
    exec.executeSql("INSERT INTO vals VALUES (4, 20)");
    exec.executeSql("INSERT INTO vals VALUES (5, 25)");

    // Normal order: BETWEEN SYMMETRIC 5 AND 15 (low <= high)
    var r1 = exec.executeSql("SELECT * FROM vals WHERE n BETWEEN SYMMETRIC 5 AND 15");
    assertSuccess(r1, "BETWEEN SYMMETRIC normal order");
    assertRowCount(r1, 3, "3 rows between 5 and 15");

    // Reversed order: BETWEEN SYMMETRIC 15 AND 5 (high < low)
    var r2 = exec.executeSql("SELECT * FROM vals WHERE n BETWEEN SYMMETRIC 15 AND 5");
    assertSuccess(r2, "BETWEEN SYMMETRIC reversed order");
    assertRowCount(r2, 3, "3 rows between 15 and 5 (symmetric)");

    // Compare with normal BETWEEN — reversed should return nothing
    var r3 = exec.executeSql("SELECT * FROM vals WHERE n BETWEEN 15 AND 5");
    assertSuccess(r3, "Normal BETWEEN reversed");
    assertRowCount(r3, 0, "Normal BETWEEN 15 AND 5 returns 0 rows");

    // Boundary values — SYMMETRIC 25 AND 10 matches 10,15,20,25
    var r4 = exec.executeSql("SELECT * FROM vals WHERE n BETWEEN SYMMETRIC 25 AND 10");
    assertSuccess(r4, "BETWEEN SYMMETRIC boundary");
    assertRowCount(r4, 4, "10, 15, 20, 25 match");
}

//=========================================================================
// NOT BETWEEN SYMMETRIC
//=========================================================================

func testNotBetweenSymmetric() {
    section("NOT BETWEEN SYMMETRIC");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nums (n INTEGER)");
    exec.executeSql("INSERT INTO nums VALUES (1)");
    exec.executeSql("INSERT INTO nums VALUES (5)");
    exec.executeSql("INSERT INTO nums VALUES (10)");
    exec.executeSql("INSERT INTO nums VALUES (15)");
    exec.executeSql("INSERT INTO nums VALUES (20)");

    // NOT BETWEEN SYMMETRIC 10 AND 5 — excludes 5..10
    var r1 = exec.executeSql("SELECT * FROM nums WHERE n NOT BETWEEN SYMMETRIC 10 AND 5");
    assertSuccess(r1, "NOT BETWEEN SYMMETRIC");
    assertRowCount(r1, 3, "1, 15, 20 outside 5..10");

    // NOT BETWEEN SYMMETRIC 5 AND 10 — same result
    var r2 = exec.executeSql("SELECT * FROM nums WHERE n NOT BETWEEN SYMMETRIC 5 AND 10");
    assertSuccess(r2, "NOT BETWEEN SYMMETRIC normal order");
    assertRowCount(r2, 3, "Same result regardless of order");
}

//=========================================================================
// TABLESAMPLE SYSTEM — basic sampling
//=========================================================================

func testTablesample() {
    section("TABLESAMPLE SYSTEM");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE big_data (id INTEGER, name TEXT)");
    var i = 1;
    while i <= 100 {
        exec.executeSql("INSERT INTO big_data VALUES (" + Fmt.Int(i) + ", 'row" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // 0% should return no rows
    var r1 = exec.executeSql("SELECT * FROM big_data TABLESAMPLE SYSTEM (0)");
    assertSuccess(r1, "TABLESAMPLE 0%");
    assertRowCount(r1, 0, "0% sample returns 0 rows");

    // 100% should return all rows
    var r2 = exec.executeSql("SELECT * FROM big_data TABLESAMPLE SYSTEM (100)");
    assertSuccess(r2, "TABLESAMPLE 100%");
    assertRowCount(r2, 100, "100% sample returns all rows");

    // 50% should return roughly half (with some variance)
    var r3 = exec.executeSql("SELECT * FROM big_data TABLESAMPLE SYSTEM (50)");
    assertSuccess(r3, "TABLESAMPLE 50%");
    assertTrue(r3.rowCount() > 20, "50% sample returns at least 20 rows");
    assertTrue(r3.rowCount() < 80, "50% sample returns at most 80 rows");
}

//=========================================================================
// TABLESAMPLE BERNOULLI (alias for SYSTEM)
//=========================================================================

func testTablesampleBernoulli() {
    section("TABLESAMPLE BERNOULLI");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (id INTEGER)");
    var i = 1;
    while i <= 50 {
        exec.executeSql("INSERT INTO data VALUES (" + Fmt.Int(i) + ")");
        i = i + 1;
    }

    // BERNOULLI method also works
    var r1 = exec.executeSql("SELECT * FROM data TABLESAMPLE BERNOULLI (100)");
    assertSuccess(r1, "TABLESAMPLE BERNOULLI 100%");
    assertRowCount(r1, 50, "100% returns all rows");
}

//=========================================================================
// Column aliases in ORDER BY
//=========================================================================

func testOrderByAlias() {
    section("ORDER BY column alias");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 25)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 50)");
    exec.executeSql("INSERT INTO products VALUES (3, 'Doohickey', 15)");
    exec.executeSql("INSERT INTO products VALUES (4, 'Thingamajig', 35)");

    // ORDER BY using column alias
    var r1 = exec.executeSql("SELECT name, price AS cost FROM products ORDER BY cost ASC");
    assertSuccess(r1, "ORDER BY column alias");
    assertRowCount(r1, 4, "All 4 rows returned");
    assertEq(val(r1, 0, 0), "Doohickey", "Cheapest first");
    assertEq(val(r1, 3, 0), "Gadget", "Most expensive last");

    // DESC ordering by alias
    var r2 = exec.executeSql("SELECT name, price AS cost FROM products ORDER BY cost DESC");
    assertSuccess(r2, "ORDER BY alias DESC");
    assertEq(val(r2, 0, 0), "Gadget", "Most expensive first");
    assertEq(val(r2, 3, 0), "Doohickey", "Cheapest last");
}

//=========================================================================
// Column alias — check column name in result header
//=========================================================================

func testAliasInResult() {
    section("Alias in result header");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, quantity INTEGER)");
    exec.executeSql("INSERT INTO items VALUES (1, 10)");

    var r1 = exec.executeSql("SELECT quantity AS qty FROM items");
    assertSuccess(r1, "SELECT with alias");
    assertRowCount(r1, 1, "1 row");
    // Column name should use alias
    assertEq(r1.columnNames.get(0), "qty", "Column name is alias 'qty'");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 70: BETWEEN SYMMETRIC, TABLESAMPLE, Column Aliases in ORDER BY ===");

    testBetweenSymmetric();
    testNotBetweenSymmetric();
    testTablesample();
    testTablesampleBernoulli();
    testOrderByAlias();
    testAliasInResult();

    printResults();
}
