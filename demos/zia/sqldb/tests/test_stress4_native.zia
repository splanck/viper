// test_stress4_native.zia â€” High-scale stress tests (native binary only)
// Part of ViperSQL
// These tests use large row counts that exceed VM interpreter limits
// Build: viper build demos/zia/sqldb/test_stress4_native.zia -o /tmp/test_stress4_native
// Run: /tmp/test_stress4_native
module test_stress4_native;

bind Terminal = Viper.Terminal;
bind IO = Viper.IO;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "./test_common";

func cleanup(path: String) {
    if IO.File.Exists(path) { IO.File.Delete(path); }
    var walDir = path + ".wal";
    var i = 0;
    while i < 10 {
        var walFile = walDir + "/wal_" + Fmt.Int(i) + ".log";
        if IO.File.Exists(walFile) { IO.File.Delete(walFile); }
        i = i + 1;
    }
}

//=============================================================================
// STRESS 1: 1000-row INSERT + DELETE + reopen
//=============================================================================

func stress1() {
    Terminal.Say("--- Stress 1: 1000-row INSERT + DELETE half + reopen ---");
    cleanup("/tmp/s4_1k.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/s4_1k.vdb'");
    exec.executeSql("CREATE TABLE big (id INTEGER PRIMARY KEY, cat TEXT, val INTEGER)");

    var i = 0;
    while i < 1000 {
        var cat = "keep";
        if i % 2 == 1 { cat = "drop"; }
        exec.executeSql("INSERT INTO big VALUES (" + Fmt.Int(i) + ", '" + cat + "', " + Fmt.Int(i * 3) + ")");
        i = i + 1;
    }
    Terminal.Say("  1000 rows inserted");

    exec.executeSql("DELETE FROM big WHERE cat = 'drop'");
    var r1 = exec.executeSql("SELECT * FROM big");
    check("1k: 500 rows remain", r1.rowCount() == 500);

    exec.executeSql("CLOSE");

    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/s4_1k.vdb'");
    var r2 = exec2.executeSql("SELECT * FROM big");
    check("1k: 500 rows after reopen", r2.rowCount() == 500);

    var r3 = exec2.executeSql("SELECT * FROM big WHERE id = 998");
    check("1k: id=998 survives", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT * FROM big WHERE id = 999");
    check("1k: id=999 dropped", r4.rowCount() == 0);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/s4_1k.vdb");
}

//=============================================================================
// STRESS 2: Repeated UPDATE cycles
//=============================================================================

func stress2() {
    Terminal.Say("--- Stress 2: 200-row repeated UPDATE cycles ---");
    cleanup("/tmp/s4_upd.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/s4_upd.vdb'");
    exec.executeSql("CREATE TABLE counters (id INTEGER PRIMARY KEY, val INTEGER)");

    var i = 0;
    while i < 200 {
        exec.executeSql("INSERT INTO counters VALUES (" + Fmt.Int(i) + ", 0)");
        i = i + 1;
    }

    // Update in batches
    exec.executeSql("UPDATE counters SET val = val + 1 WHERE id < 50");
    exec.executeSql("UPDATE counters SET val = val + 10 WHERE id >= 50 AND id < 100");
    exec.executeSql("UPDATE counters SET val = val + 100 WHERE id >= 100 AND id < 150");
    exec.executeSql("UPDATE counters SET val = val + 1000 WHERE id >= 150");

    exec.executeSql("CLOSE");

    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/s4_upd.vdb'");

    var r1 = exec2.executeSql("SELECT * FROM counters WHERE id = 0 AND val = 1");
    check("upd: id=0 val=1", r1.rowCount() == 1);

    var r2 = exec2.executeSql("SELECT * FROM counters WHERE id = 75 AND val = 10");
    check("upd: id=75 val=10", r2.rowCount() == 1);

    var r3 = exec2.executeSql("SELECT * FROM counters WHERE id = 125 AND val = 100");
    check("upd: id=125 val=100", r3.rowCount() == 1);

    var r4 = exec2.executeSql("SELECT * FROM counters WHERE id = 199 AND val = 1000");
    check("upd: id=199 val=1000", r4.rowCount() == 1);

    var r5 = exec2.executeSql("SELECT * FROM counters");
    check("upd: 200 total rows", r5.rowCount() == 200);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/s4_upd.vdb");
}

//=============================================================================
// STRESS 3: Multi-database concurrent operations
//=============================================================================

func stress3() {
    Terminal.Say("--- Stress 3: 3-database concurrent ops ---");
    cleanup("/tmp/s4_dba.vdb");
    cleanup("/tmp/s4_dbb.vdb");
    cleanup("/tmp/s4_dbc.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE DATABASE dba FILE '/tmp/s4_dba.vdb'");
    exec.executeSql("CREATE DATABASE dbb FILE '/tmp/s4_dbb.vdb'");
    exec.executeSql("CREATE DATABASE dbc FILE '/tmp/s4_dbc.vdb'");

    // Populate each database
    exec.executeSql("USE dba");
    exec.executeSql("CREATE TABLE orders (id INTEGER PRIMARY KEY, amount INTEGER)");
    var i = 0;
    while i < 50 {
        exec.executeSql("INSERT INTO orders VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i * 100) + ")");
        i = i + 1;
    }

    exec.executeSql("USE dbb");
    exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, stock INTEGER)");
    i = 0;
    while i < 30 {
        exec.executeSql("INSERT INTO products VALUES (" + Fmt.Int(i) + ", 'prod_" + Fmt.Int(i) + "', " + Fmt.Int(100 - i) + ")");
        i = i + 1;
    }

    exec.executeSql("USE dbc");
    exec.executeSql("CREATE TABLE logs (id INTEGER PRIMARY KEY, msg TEXT)");
    i = 0;
    while i < 20 {
        exec.executeSql("INSERT INTO logs VALUES (" + Fmt.Int(i) + ", 'log_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // Cross-database operations
    exec.executeSql("USE dba");
    exec.executeSql("UPDATE orders SET amount = 0 WHERE id >= 40");
    exec.executeSql("DELETE FROM orders WHERE amount = 0");

    exec.executeSql("USE dbb");
    exec.executeSql("UPDATE products SET stock = 0 WHERE id < 5");

    exec.executeSql("USE dbc");
    exec.executeSql("DELETE FROM logs WHERE id >= 10");

    // Close all
    exec.executeSql("USE dba");
    exec.executeSql("CLOSE");
    exec.executeSql("USE dbb");
    exec.executeSql("CLOSE");
    exec.executeSql("USE dbc");
    exec.executeSql("CLOSE");

    // Reopen and verify
    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/s4_dba.vdb'");
    var ra = exec2.executeSql("SELECT * FROM orders");
    // id=0 has amount=0*100=0, also deleted. 50-11=39
    check("3db: dba 39 orders", ra.rowCount() == 39);
    exec2.executeSql("CLOSE");

    var exec3 = new Executor();
    exec3.init();
    exec3.executeSql("OPEN '/tmp/s4_dbb.vdb'");
    var rb = exec3.executeSql("SELECT * FROM products");
    check("3db: dbb 30 products", rb.rowCount() == 30);
    var rb2 = exec3.executeSql("SELECT * FROM products WHERE stock = 0");
    check("3db: dbb 5 zero-stock", rb2.rowCount() == 5);
    exec3.executeSql("CLOSE");

    var exec4 = new Executor();
    exec4.init();
    exec4.executeSql("OPEN '/tmp/s4_dbc.vdb'");
    var rc = exec4.executeSql("SELECT * FROM logs");
    check("3db: dbc 10 logs", rc.rowCount() == 10);
    exec4.executeSql("CLOSE");

    cleanup("/tmp/s4_dba.vdb");
    cleanup("/tmp/s4_dbb.vdb");
    cleanup("/tmp/s4_dbc.vdb");
}

//=============================================================================
// STRESS 4: Rapid open/close with UPDATE (50 cycles)
//=============================================================================

func stress4() {
    Terminal.Say("--- Stress 4: 50-cycle open/close ---");
    cleanup("/tmp/s4_cycles.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/s4_cycles.vdb'");
    exec.executeSql("CREATE TABLE counter (id INTEGER PRIMARY KEY, val INTEGER)");
    exec.executeSql("INSERT INTO counter VALUES (1, 0)");
    exec.executeSql("CLOSE");

    var cycle = 0;
    while cycle < 50 {
        var ex = new Executor();
        ex.init();
        ex.executeSql("OPEN '/tmp/s4_cycles.vdb'");
        ex.executeSql("UPDATE counter SET val = " + Fmt.Int(cycle + 1) + " WHERE id = 1");
        ex.executeSql("CLOSE");
        cycle = cycle + 1;
    }

    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/s4_cycles.vdb'");
    var r = exec2.executeSql("SELECT * FROM counter WHERE val = 50");
    check("cycles: val = 50 after 50 cycles", r.rowCount() == 1);
    exec2.executeSql("CLOSE");
    cleanup("/tmp/s4_cycles.vdb");
}

//=============================================================================
// STRESS 5: DELETE all + mass re-INSERT (data migration pattern)
//=============================================================================

func stress5() {
    Terminal.Say("--- Stress 5: Mass DELETE + re-INSERT (migration) ---");
    cleanup("/tmp/s4_migrate.vdb");

    var exec = new Executor();
    exec.init();
    exec.executeSql("OPEN '/tmp/s4_migrate.vdb'");
    exec.executeSql("CREATE TABLE data (id INTEGER PRIMARY KEY, version INTEGER, val TEXT)");

    // Insert v1 data
    var i = 0;
    while i < 100 {
        exec.executeSql("INSERT INTO data VALUES (" + Fmt.Int(i) + ", 1, 'v1_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // "Migrate": delete all v1, insert v2
    exec.executeSql("DELETE FROM data WHERE version = 1");
    i = 0;
    while i < 150 {
        exec.executeSql("INSERT INTO data VALUES (" + Fmt.Int(1000 + i) + ", 2, 'v2_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    var r1 = exec.executeSql("SELECT * FROM data");
    check("migrate: 150 v2 rows in-memory", r1.rowCount() == 150);

    exec.executeSql("CLOSE");

    var exec2 = new Executor();
    exec2.init();
    exec2.executeSql("OPEN '/tmp/s4_migrate.vdb'");
    var r2 = exec2.executeSql("SELECT * FROM data");
    check("migrate: 150 v2 rows after reopen", r2.rowCount() == 150);

    var r3 = exec2.executeSql("SELECT * FROM data WHERE version = 1");
    check("migrate: no v1 rows", r3.rowCount() == 0);

    var r4 = exec2.executeSql("SELECT * FROM data WHERE id = 1050");
    check("migrate: v2 id=1050 exists", r4.rowCount() == 1);

    exec2.executeSql("CLOSE");
    cleanup("/tmp/s4_migrate.vdb");
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Native-Scale Stress Tests ===");
    Terminal.Say("");

    stress1();
    stress2();
    stress3();
    stress4();
    stress5();

    printResults();
}
