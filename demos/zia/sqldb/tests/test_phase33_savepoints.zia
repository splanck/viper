// test_phase33_savepoints.zia — Phase 33: Savepoints
// Tests for SAVEPOINT, RELEASE SAVEPOINT, ROLLBACK TO SAVEPOINT.

module test_phase33_savepoints;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// SAVEPOINT BASIC
//=========================================================================

func testSavepointBasic() {
    section("SAVEPOINT basic");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE sp_t (id INTEGER, name TEXT)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO sp_t VALUES (1, 'Alice')");

    var r1 = exec.executeSql("SAVEPOINT sp1");
    assertSuccess(r1, "SAVEPOINT succeeds");
    assertTrue(stringContains(r1.message, "SAVEPOINT"), "SAVEPOINT message");

    exec.executeSql("INSERT INTO sp_t VALUES (2, 'Bob')");
    exec.executeSql("COMMIT");

    var r2 = exec.executeSql("SELECT * FROM sp_t ORDER BY id");
    assertEqInt(r2.rows.count(), 2, "Both rows committed");
}

func testSavepointRequiresTransaction() {
    section("SAVEPOINT requires transaction");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SAVEPOINT sp1");
    assertTrue(r1.success == false, "SAVEPOINT outside txn fails");
}

//=========================================================================
// ROLLBACK TO SAVEPOINT
//=========================================================================

func testRollbackToSavepoint() {
    section("ROLLBACK TO SAVEPOINT");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE rbsp_t (id INTEGER, name TEXT)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO rbsp_t VALUES (1, 'Alice')");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO rbsp_t VALUES (2, 'Bob')");
    exec.executeSql("INSERT INTO rbsp_t VALUES (3, 'Carol')");

    // Rollback to savepoint — should undo Bob and Carol
    var r1 = exec.executeSql("ROLLBACK TO SAVEPOINT sp1");
    assertSuccess(r1, "ROLLBACK TO SAVEPOINT succeeds");

    exec.executeSql("COMMIT");

    var r2 = exec.executeSql("SELECT * FROM rbsp_t ORDER BY id");
    assertEqInt(r2.rows.count(), 1, "Only Alice remains after rollback to savepoint");
    assertEq(val(r2, 0, 1), "Alice", "Alice survived");
}

func testRollbackToSavepointPreservesEarlierWork() {
    section("ROLLBACK TO preserves earlier work");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE rbsp2 (id INTEGER, val INTEGER)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO rbsp2 VALUES (1, 10)");
    exec.executeSql("INSERT INTO rbsp2 VALUES (2, 20)");

    exec.executeSql("SAVEPOINT before_update");
    exec.executeSql("UPDATE rbsp2 SET val = 99 WHERE id = 1");
    exec.executeSql("DELETE FROM rbsp2 WHERE id = 2");

    // Rollback to savepoint — undo update and delete
    exec.executeSql("ROLLBACK TO SAVEPOINT before_update");
    exec.executeSql("COMMIT");

    var r1 = exec.executeSql("SELECT * FROM rbsp2 ORDER BY id");
    assertEqInt(r1.rows.count(), 2, "Both rows preserved");
    assertEq(val(r1, 0, 1), "10", "id=1 still has val=10");
    assertEq(val(r1, 1, 1), "20", "id=2 still has val=20");
}

func testRollbackToSavepointThenContinue() {
    section("ROLLBACK TO then continue");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE rbsp3 (id INTEGER, name TEXT)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO rbsp3 VALUES (1, 'Alice')");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO rbsp3 VALUES (2, 'Bob')");

    exec.executeSql("ROLLBACK TO SAVEPOINT sp1");

    // Continue adding after rollback
    exec.executeSql("INSERT INTO rbsp3 VALUES (3, 'Carol')");
    exec.executeSql("COMMIT");

    var r1 = exec.executeSql("SELECT * FROM rbsp3 ORDER BY id");
    assertEqInt(r1.rows.count(), 2, "Alice and Carol, not Bob");
    assertEq(val(r1, 0, 1), "Alice", "Alice present");
    assertEq(val(r1, 1, 1), "Carol", "Carol present");
}

//=========================================================================
// NESTED SAVEPOINTS
//=========================================================================

func testNestedSavepoints() {
    section("Nested savepoints");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE nested_sp (id INTEGER)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO nested_sp VALUES (1)");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO nested_sp VALUES (2)");

    exec.executeSql("SAVEPOINT sp2");
    exec.executeSql("INSERT INTO nested_sp VALUES (3)");

    // Rollback to sp2 — only row 3 should be removed
    exec.executeSql("ROLLBACK TO SAVEPOINT sp2");

    // Rollback to sp1 — row 2 should also be removed
    exec.executeSql("ROLLBACK TO SAVEPOINT sp1");

    exec.executeSql("COMMIT");

    var r1 = exec.executeSql("SELECT * FROM nested_sp ORDER BY id");
    assertEqInt(r1.rows.count(), 1, "Only row 1 after nested rollbacks");
    assertEq(val(r1, 0, 0), "1", "Row 1 present");
}

func testNestedSavepointPartial() {
    section("Nested savepoint partial rollback");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE nested_sp2 (id INTEGER)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO nested_sp2 VALUES (1)");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO nested_sp2 VALUES (2)");

    exec.executeSql("SAVEPOINT sp2");
    exec.executeSql("INSERT INTO nested_sp2 VALUES (3)");

    // Rollback only to sp2 — keeps row 2
    exec.executeSql("ROLLBACK TO SAVEPOINT sp2");

    exec.executeSql("COMMIT");

    var r1 = exec.executeSql("SELECT * FROM nested_sp2 ORDER BY id");
    assertEqInt(r1.rows.count(), 2, "Rows 1 and 2 remain");
    assertEq(val(r1, 0, 0), "1", "Row 1");
    assertEq(val(r1, 1, 0), "2", "Row 2");
}

//=========================================================================
// RELEASE SAVEPOINT
//=========================================================================

func testReleaseSavepoint() {
    section("RELEASE SAVEPOINT");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE rel_sp (id INTEGER)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO rel_sp VALUES (1)");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO rel_sp VALUES (2)");

    var r1 = exec.executeSql("RELEASE SAVEPOINT sp1");
    assertSuccess(r1, "RELEASE SAVEPOINT succeeds");

    // After RELEASE, ROLLBACK TO should fail
    var r2 = exec.executeSql("ROLLBACK TO SAVEPOINT sp1");
    assertTrue(r2.success == false, "ROLLBACK TO released savepoint fails");

    exec.executeSql("COMMIT");

    var r3 = exec.executeSql("SELECT * FROM rel_sp ORDER BY id");
    assertEqInt(r3.rows.count(), 2, "Both rows committed after release");
}

func testReleaseNonexistent() {
    section("RELEASE nonexistent savepoint");

    var exec = new Executor();
    exec.init();

    exec.executeSql("BEGIN");
    var r1 = exec.executeSql("RELEASE SAVEPOINT nosuch");
    assertTrue(r1.success == false, "RELEASE nonexistent savepoint fails");
    exec.executeSql("ROLLBACK");
}

//=========================================================================
// SAVEPOINT OVERWRITE
//=========================================================================

func testSavepointOverwrite() {
    section("SAVEPOINT overwrite");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE sp_overwrite (id INTEGER)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO sp_overwrite VALUES (1)");

    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO sp_overwrite VALUES (2)");
    exec.executeSql("INSERT INTO sp_overwrite VALUES (3)");

    // Overwrite sp1 at current journal position
    exec.executeSql("SAVEPOINT sp1");
    exec.executeSql("INSERT INTO sp_overwrite VALUES (4)");

    // Rollback to overwritten sp1 — should only remove row 4
    exec.executeSql("ROLLBACK TO SAVEPOINT sp1");
    exec.executeSql("COMMIT");

    var r1 = exec.executeSql("SELECT * FROM sp_overwrite ORDER BY id");
    assertEqInt(r1.rows.count(), 3, "Rows 1, 2, 3 after overwrite rollback");
}

func main() -> Integer {
    Terminal.Say("=== Phase 33: Savepoints ===");

    testSavepointBasic();
    testSavepointRequiresTransaction();
    testRollbackToSavepoint();
    testRollbackToSavepointPreservesEarlierWork();
    testRollbackToSavepointThenContinue();
    testNestedSavepoints();
    testNestedSavepointPartial();
    testReleaseSavepoint();
    testReleaseNonexistent();
    testSavepointOverwrite();

    printResults();
    return 0;
}
