// test_phase75_named_windows.zia — Phase 75: Named WINDOW Clause
// Tests: WINDOW w AS (...), OVER w references

module test_phase75_named_windows;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// 1. Basic named window with PARTITION BY
//=========================================================================

func testBasicNamedWindow() {
    section("Named WINDOW — basic PARTITION BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (id INTEGER, dept TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES (1, 'A', 100)");
    exec.executeSql("INSERT INTO sales VALUES (2, 'A', 200)");
    exec.executeSql("INSERT INTO sales VALUES (3, 'B', 150)");
    exec.executeSql("INSERT INTO sales VALUES (4, 'B', 250)");
    exec.executeSql("INSERT INTO sales VALUES (5, 'A', 300)");

    // Use named window
    var r1 = exec.executeSql("SELECT id, dept, amount, SUM(amount) OVER w AS dept_total FROM sales WINDOW w AS (PARTITION BY dept) ORDER BY id");
    assertSuccess(r1, "named window query");
    assertRowCount(r1, 5, "5 rows");

    // Dept A total = 100+200+300 = 600
    assertEq(val(r1, 0, 3), "600", "row 1 dept A total");
    assertEq(val(r1, 1, 3), "600", "row 2 dept A total");
    assertEq(val(r1, 4, 3), "600", "row 5 dept A total");

    // Dept B total = 150+250 = 400
    assertEq(val(r1, 2, 3), "400", "row 3 dept B total");
    assertEq(val(r1, 3, 3), "400", "row 4 dept B total");
}

//=========================================================================
// 2. Named window with ORDER BY (running aggregate)
//=========================================================================

func testNamedWindowOrderBy() {
    section("Named WINDOW — ORDER BY (running sum)");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (id INTEGER, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES (1, 10)");
    exec.executeSql("INSERT INTO scores VALUES (2, 20)");
    exec.executeSql("INSERT INTO scores VALUES (3, 30)");
    exec.executeSql("INSERT INTO scores VALUES (4, 40)");

    var r1 = exec.executeSql("SELECT id, score, SUM(score) OVER w AS running FROM scores WINDOW w AS (ORDER BY id) ORDER BY id");
    assertSuccess(r1, "named window with ORDER BY");
    assertRowCount(r1, 4, "4 rows");
    assertEq(val(r1, 0, 2), "10", "running sum row 1");
    assertEq(val(r1, 1, 2), "30", "running sum row 2");
    assertEq(val(r1, 2, 2), "60", "running sum row 3");
    assertEq(val(r1, 3, 2), "100", "running sum row 4");
}

//=========================================================================
// 3. Multiple functions using same named window
//=========================================================================

func testMultipleFunctionsSameWindow() {
    section("Multiple functions — same named WINDOW");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (id INTEGER, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES (1, 10)");
    exec.executeSql("INSERT INTO data VALUES (2, 30)");
    exec.executeSql("INSERT INTO data VALUES (3, 20)");

    var r1 = exec.executeSql("SELECT id, val, SUM(val) OVER w AS total, COUNT(val) OVER w AS cnt FROM data WINDOW w AS (ORDER BY id) ORDER BY id");
    assertSuccess(r1, "multiple funcs same window");
    assertRowCount(r1, 3, "3 rows");

    // Running SUM
    assertEq(val(r1, 0, 2), "10", "sum row 1");
    assertEq(val(r1, 1, 2), "40", "sum row 2");
    assertEq(val(r1, 2, 2), "60", "sum row 3");

    // Running COUNT
    assertEq(val(r1, 0, 3), "1", "count row 1");
    assertEq(val(r1, 1, 3), "2", "count row 2");
    assertEq(val(r1, 2, 3), "3", "count row 3");
}

//=========================================================================
// 4. Multiple named windows
//=========================================================================

func testMultipleNamedWindows() {
    section("Multiple named WINDOW definitions");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE employees (id INTEGER, dept TEXT, salary INTEGER)");
    exec.executeSql("INSERT INTO employees VALUES (1, 'Sales', 50000)");
    exec.executeSql("INSERT INTO employees VALUES (2, 'Sales', 60000)");
    exec.executeSql("INSERT INTO employees VALUES (3, 'Eng', 70000)");
    exec.executeSql("INSERT INTO employees VALUES (4, 'Eng', 80000)");

    // Two named windows: one partitioned, one global
    var r1 = exec.executeSql("SELECT id, dept, salary, SUM(salary) OVER dept_w AS dept_total, SUM(salary) OVER all_w AS grand_total FROM employees WINDOW dept_w AS (PARTITION BY dept), all_w AS (ORDER BY id) ORDER BY id");
    assertSuccess(r1, "two named windows");
    assertRowCount(r1, 4, "4 rows");

    // Dept totals
    assertEq(val(r1, 0, 3), "110000", "sales dept total");
    assertEq(val(r1, 1, 3), "110000", "sales dept total 2");
    assertEq(val(r1, 2, 3), "150000", "eng dept total");
    assertEq(val(r1, 3, 3), "150000", "eng dept total 2");

    // Grand running total
    assertEq(val(r1, 0, 4), "50000", "grand running 1");
    assertEq(val(r1, 1, 4), "110000", "grand running 2");
    assertEq(val(r1, 2, 4), "180000", "grand running 3");
    assertEq(val(r1, 3, 4), "260000", "grand running 4");
}

//=========================================================================
// 5. Named window with ROW_NUMBER
//=========================================================================

func testNamedWindowRowNumber() {
    section("Named WINDOW — ROW_NUMBER");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, category TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO items VALUES (1, 'A', 30)");
    exec.executeSql("INSERT INTO items VALUES (2, 'A', 10)");
    exec.executeSql("INSERT INTO items VALUES (3, 'B', 50)");
    exec.executeSql("INSERT INTO items VALUES (4, 'B', 20)");

    var r1 = exec.executeSql("SELECT id, category, price, ROW_NUMBER() OVER w AS rn FROM items WINDOW w AS (PARTITION BY category ORDER BY price) ORDER BY category, price");
    assertSuccess(r1, "row_number named window");
    assertRowCount(r1, 4, "4 rows");
    assertEq(val(r1, 0, 3), "1", "A rn=1");
    assertEq(val(r1, 1, 3), "2", "A rn=2");
    assertEq(val(r1, 2, 3), "1", "B rn=1");
    assertEq(val(r1, 3, 3), "2", "B rn=2");
}

//=========================================================================
// Main
//=========================================================================

func main() {
    Terminal.Say("=== Phase 75: Named WINDOW Clause ===");

    testBasicNamedWindow();
    testNamedWindowOrderBy();
    testMultipleFunctionsSameWindow();
    testMultipleNamedWindows();
    testNamedWindowRowNumber();

    printResults();
}
