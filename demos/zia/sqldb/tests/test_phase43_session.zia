// test_phase43_session.zia â€” Phase 43: Session Variables & COMMENT ON
// Tests for SET/SHOW/RESET session variables and COMMENT ON TABLE/COLUMN.

module test_phase43_session;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// SET and SHOW basic
//=========================================================================

func testSetShow() {
    section("SET and SHOW basic");

    var exec = new Executor();
    exec.init();

    // SHOW a default variable
    var r1 = exec.executeSql("SHOW search_path");
    assertSuccess(r1, "SHOW search_path");
    assertEq(val(r1, 0, 0), "public", "default search_path");

    // SET a variable
    var r2 = exec.executeSql("SET search_path = 'myschema'");
    assertSuccess(r2, "SET search_path");
    assertTrue(stringContains(r2.message, "SET"), "SET message");

    // SHOW updated variable
    var r3 = exec.executeSql("SHOW search_path");
    assertEq(val(r3, 0, 0), "myschema", "updated search_path");
}

//=========================================================================
// SET with TO syntax
//=========================================================================

func testSetTo() {
    section("SET with TO syntax");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SET timezone TO 'US/Eastern'");
    assertSuccess(r1, "SET timezone TO");

    var r2 = exec.executeSql("SHOW timezone");
    assertEq(val(r2, 0, 0), "US/Eastern", "timezone updated");
}

//=========================================================================
// SET custom variable
//=========================================================================

func testSetCustom() {
    section("SET custom variable");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SET my_app.debug = 'true'");
    assertSuccess(r1, "SET custom var");

    var r2 = exec.executeSql("SHOW my_app.debug");
    assertEq(val(r2, 0, 0), "true", "custom var value");
}

//=========================================================================
// SHOW ALL
//=========================================================================

func testShowAll() {
    section("SHOW ALL");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW ALL");
    assertSuccess(r1, "SHOW ALL");
    assertColumnCount(r1, 2, "2 columns (name, setting)");
    // Should have at least the default vars
    assertTrue(r1.rows.count() >= 10, "at least 10 default vars");
}

//=========================================================================
// SHOW nonexistent variable
//=========================================================================

func testShowNonexistent() {
    section("SHOW nonexistent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW nonexistent_var");
    assertFailure(r1, "nonexistent var fails");
}

//=========================================================================
// RESET variable
//=========================================================================

func testReset() {
    section("RESET variable");

    var exec = new Executor();
    exec.init();

    // Change a variable
    exec.executeSql("SET search_path = 'custom'");
    var r1 = exec.executeSql("SHOW search_path");
    assertEq(val(r1, 0, 0), "custom", "custom search_path");

    // Reset it
    var r2 = exec.executeSql("RESET search_path");
    assertSuccess(r2, "RESET search_path");

    var r3 = exec.executeSql("SHOW search_path");
    assertEq(val(r3, 0, 0), "public", "reset to default");
}

//=========================================================================
// RESET ALL
//=========================================================================

func testResetAll() {
    section("RESET ALL");

    var exec = new Executor();
    exec.init();

    exec.executeSql("SET search_path = 'x'");
    exec.executeSql("SET timezone = 'Mars'");
    exec.executeSql("SET custom_var = 'hello'");

    var r1 = exec.executeSql("RESET ALL");
    assertSuccess(r1, "RESET ALL");

    var r2 = exec.executeSql("SHOW search_path");
    assertEq(val(r2, 0, 0), "public", "search_path reset");

    var r3 = exec.executeSql("SHOW timezone");
    assertEq(val(r3, 0, 0), "UTC", "timezone reset");
}

//=========================================================================
// Default server variables
//=========================================================================

func testDefaultVars() {
    section("Default server variables");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW server_version");
    assertSuccess(r1, "SHOW server_version");
    assertTrue(stringContains(val(r1, 0, 0), "ViperSQL"), "version contains ViperSQL");

    var r2 = exec.executeSql("SHOW client_encoding");
    assertEq(val(r2, 0, 0), "UTF8", "client_encoding is UTF8");

    var r3 = exec.executeSql("SHOW standard_conforming_strings");
    assertEq(val(r3, 0, 0), "on", "standard_conforming_strings is on");
}

//=========================================================================
// COMMENT ON TABLE
//=========================================================================

func testCommentTable() {
    section("COMMENT ON TABLE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE comments_t (id INTEGER, name TEXT)");

    var r1 = exec.executeSql("COMMENT ON TABLE comments_t IS 'Main user table'");
    assertSuccess(r1, "COMMENT ON TABLE");
    assertTrue(stringContains(r1.message, "COMMENT"), "COMMENT message");

    // Verify comment is stored (access via executor API)
    assertTrue(exec.getComment("table:comments_t") == "Main user table", "comment stored");
}

//=========================================================================
// COMMENT ON COLUMN
//=========================================================================

func testCommentColumn() {
    section("COMMENT ON COLUMN");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE col_t (id INTEGER, email TEXT)");

    var r1 = exec.executeSql("COMMENT ON COLUMN col_t.email IS 'User email address'");
    assertSuccess(r1, "COMMENT ON COLUMN");

    assertTrue(exec.getComment("column:col_t.email") == "User email address", "column comment stored");
}

//=========================================================================
// COMMENT ON with NULL removes comment
//=========================================================================

func testCommentNull() {
    section("COMMENT ON NULL removes");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE null_c (id INTEGER)");
    exec.executeSql("COMMENT ON TABLE null_c IS 'temp comment'");
    assertTrue(exec.getComment("table:null_c") == "temp comment", "comment set");

    var r1 = exec.executeSql("COMMENT ON TABLE null_c IS NULL");
    assertSuccess(r1, "COMMENT IS NULL");
    assertTrue(exec.getComment("table:null_c") == "", "comment removed");
}

//=========================================================================
// COMMENT ON nonexistent table
//=========================================================================

func testCommentNonexistent() {
    section("COMMENT ON nonexistent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("COMMENT ON TABLE no_such_table IS 'hello'");
    assertFailure(r1, "nonexistent table fails");
}

//=========================================================================
// COMMENT ON nonexistent column
//=========================================================================

func testCommentBadColumn() {
    section("COMMENT ON bad column");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE bad_col_t (id INTEGER)");

    var r1 = exec.executeSql("COMMENT ON COLUMN bad_col_t.no_such IS 'hello'");
    assertFailure(r1, "nonexistent column fails");
}

//=========================================================================
// SET with unquoted value
//=========================================================================

func testSetUnquoted() {
    section("SET with unquoted value");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SET application_name = myapp");
    assertSuccess(r1, "SET unquoted");

    var r2 = exec.executeSql("SHOW application_name");
    assertEq(val(r2, 0, 0), "myapp", "unquoted value set");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 43: Session Variables & COMMENT ON ===");

    testSetShow();
    testSetTo();
    testSetCustom();
    testShowAll();
    testShowNonexistent();
    testReset();
    testResetAll();
    testDefaultVars();
    testCommentTable();
    testCommentColumn();
    testCommentNull();
    testCommentNonexistent();
    testCommentBadColumn();
    testSetUnquoted();

    printResults();
}
