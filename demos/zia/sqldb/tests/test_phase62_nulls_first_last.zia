// test_phase62_nulls_first_last.zia — Phase 62: NULLS FIRST / NULLS LAST
// Tests for ORDER BY ... NULLS FIRST and NULLS LAST modifiers.

module test_phase62_nulls_first_last;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper — table with NULLs
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (name TEXT, price INTEGER, category TEXT)");
    exec.executeSql("INSERT INTO items VALUES ('Apple', 100, 'Fruit')");
    exec.executeSql("INSERT INTO items (name, category) VALUES ('Banana', 'Fruit')");  // price=NULL
    exec.executeSql("INSERT INTO items VALUES ('Cherry', 300, 'Fruit')");
    exec.executeSql("INSERT INTO items (name, price) VALUES ('Date', 200)");  // category=NULL
    exec.executeSql("INSERT INTO items (name) VALUES ('Elderberry')");  // price=NULL, category=NULL

    return exec;
}

//=========================================================================
// Default NULL ordering: ASC = NULLs last, DESC = NULLs first
//=========================================================================

func testDefaultNullOrderAsc() {
    section("Default NULL order ASC (NULLs last)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price ASC");
    assertSuccess(r1, "ASC default");
    assertRowCount(r1, 5, "5 rows");
    // Non-null prices first: 100, 200, 300
    assertEq(val(r1, 0, 1), "100", "row 0: 100");
    assertEq(val(r1, 1, 1), "200", "row 1: 200");
    assertEq(val(r1, 2, 1), "300", "row 2: 300");
    // NULLs last
    assertEq(val(r1, 3, 1), "NULL", "row 3: NULL");
    assertEq(val(r1, 4, 1), "NULL", "row 4: NULL");
}

func testDefaultNullOrderDesc() {
    section("Default NULL order DESC (NULLs first)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price DESC");
    assertSuccess(r1, "DESC default");
    assertRowCount(r1, 5, "5 rows");
    // NULLs first for DESC
    assertEq(val(r1, 0, 1), "NULL", "row 0: NULL");
    assertEq(val(r1, 1, 1), "NULL", "row 1: NULL");
    // Then descending non-null values
    assertEq(val(r1, 2, 1), "300", "row 2: 300");
    assertEq(val(r1, 3, 1), "200", "row 3: 200");
    assertEq(val(r1, 4, 1), "100", "row 4: 100");
}

//=========================================================================
// NULLS FIRST with ASC — NULLs sorted to the top
//=========================================================================

func testNullsFirstAsc() {
    section("ASC NULLS FIRST");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price ASC NULLS FIRST");
    assertSuccess(r1, "ASC NULLS FIRST");
    assertRowCount(r1, 5, "5 rows");
    // NULLs first
    assertEq(val(r1, 0, 1), "NULL", "row 0: NULL");
    assertEq(val(r1, 1, 1), "NULL", "row 1: NULL");
    // Then ascending non-null values
    assertEq(val(r1, 2, 1), "100", "row 2: 100");
    assertEq(val(r1, 3, 1), "200", "row 3: 200");
    assertEq(val(r1, 4, 1), "300", "row 4: 300");
}

//=========================================================================
// NULLS LAST with DESC — NULLs sorted to the bottom
//=========================================================================

func testNullsLastDesc() {
    section("DESC NULLS LAST");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price DESC NULLS LAST");
    assertSuccess(r1, "DESC NULLS LAST");
    assertRowCount(r1, 5, "5 rows");
    // Descending non-null values first
    assertEq(val(r1, 0, 1), "300", "row 0: 300");
    assertEq(val(r1, 1, 1), "200", "row 1: 200");
    assertEq(val(r1, 2, 1), "100", "row 2: 100");
    // NULLs last
    assertEq(val(r1, 3, 1), "NULL", "row 3: NULL");
    assertEq(val(r1, 4, 1), "NULL", "row 4: NULL");
}

//=========================================================================
// NULLS LAST with ASC — same as default (NULLs already last)
//=========================================================================

func testNullsLastAsc() {
    section("ASC NULLS LAST (same as default)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price ASC NULLS LAST");
    assertSuccess(r1, "ASC NULLS LAST");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 1), "100", "row 0: 100");
    assertEq(val(r1, 1, 1), "200", "row 1: 200");
    assertEq(val(r1, 2, 1), "300", "row 2: 300");
    assertEq(val(r1, 3, 1), "NULL", "row 3: NULL");
    assertEq(val(r1, 4, 1), "NULL", "row 4: NULL");
}

//=========================================================================
// NULLS FIRST with DESC — same as default (NULLs already first)
//=========================================================================

func testNullsFirstDesc() {
    section("DESC NULLS FIRST (same as default)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price DESC NULLS FIRST");
    assertSuccess(r1, "DESC NULLS FIRST");
    assertRowCount(r1, 5, "5 rows");
    assertEq(val(r1, 0, 1), "NULL", "row 0: NULL");
    assertEq(val(r1, 1, 1), "NULL", "row 1: NULL");
    assertEq(val(r1, 2, 1), "300", "row 2: 300");
    assertEq(val(r1, 3, 1), "200", "row 3: 200");
    assertEq(val(r1, 4, 1), "100", "row 4: 100");
}

//=========================================================================
// Multi-column ORDER BY with different NULLS modes
//=========================================================================

func testMultiColumnNulls() {
    section("Multi-column ORDER BY with NULLS modes");

    var exec = setupExec();

    // category ASC NULLS FIRST, price ASC NULLS LAST
    var r1 = exec.executeSql("SELECT name, category, price FROM items ORDER BY category ASC NULLS FIRST, price ASC NULLS LAST");
    assertSuccess(r1, "multi-column nulls");
    assertRowCount(r1, 5, "5 rows");
    // category NULL first (Date has NULL category, Elderberry has NULL category)
    // Among NULL categories, sort by price ASC NULLS LAST
    // Date has price=200, Elderberry has price=NULL
    assertEq(val(r1, 0, 0), "Date", "row 0: Date (NULL category, price 200)");
    assertEq(val(r1, 1, 0), "Elderberry", "row 1: Elderberry (NULL category, NULL price)");
    // Then Fruit category rows, sorted by price ASC NULLS LAST
    // Apple=100, Cherry=300, Banana=NULL
    assertEq(val(r1, 2, 0), "Apple", "row 2: Apple (Fruit, 100)");
    assertEq(val(r1, 3, 0), "Cherry", "row 3: Cherry (Fruit, 300)");
    assertEq(val(r1, 4, 0), "Banana", "row 4: Banana (Fruit, NULL price)");
}

//=========================================================================
// NULLS FIRST with TEXT column
//=========================================================================

func testNullsFirstText() {
    section("NULLS FIRST with TEXT column");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, category FROM items ORDER BY category ASC NULLS FIRST");
    assertSuccess(r1, "text NULLS FIRST");
    assertRowCount(r1, 5, "5 rows");
    // NULLs first
    assertEq(val(r1, 0, 1), "NULL", "row 0: NULL category");
    assertEq(val(r1, 1, 1), "NULL", "row 1: NULL category");
    // Then sorted text values
    assertEq(val(r1, 2, 1), "Fruit", "row 2: Fruit");
    assertEq(val(r1, 3, 1), "Fruit", "row 3: Fruit");
    assertEq(val(r1, 4, 1), "Fruit", "row 4: Fruit");
}

//=========================================================================
// NULLS LAST with TEXT column DESC
//=========================================================================

func testNullsLastTextDesc() {
    section("NULLS LAST with TEXT column DESC");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, category FROM items ORDER BY category DESC NULLS LAST");
    assertSuccess(r1, "text DESC NULLS LAST");
    assertRowCount(r1, 5, "5 rows");
    // Fruit first (only non-null category)
    assertEq(val(r1, 0, 1), "Fruit", "row 0: Fruit");
    assertEq(val(r1, 1, 1), "Fruit", "row 1: Fruit");
    assertEq(val(r1, 2, 1), "Fruit", "row 2: Fruit");
    // NULLs last
    assertEq(val(r1, 3, 1), "NULL", "row 3: NULL");
    assertEq(val(r1, 4, 1), "NULL", "row 4: NULL");
}

//=========================================================================
// ORDER BY with LIMIT and NULLS FIRST
//=========================================================================

func testNullsFirstWithLimit() {
    section("NULLS FIRST with LIMIT");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT name, price FROM items ORDER BY price ASC NULLS FIRST LIMIT 3");
    assertSuccess(r1, "NULLS FIRST + LIMIT");
    assertRowCount(r1, 3, "3 rows");
    // NULLs first, then ascending
    assertEq(val(r1, 0, 1), "NULL", "row 0: NULL");
    assertEq(val(r1, 1, 1), "NULL", "row 1: NULL");
    assertEq(val(r1, 2, 1), "100", "row 2: 100");
}

//=========================================================================
// ORDER BY with WHERE and NULLS LAST
//=========================================================================

func testNullsLastWithWhere() {
    section("NULLS LAST with WHERE");

    var exec = setupExec();

    // Only Fruit items — Apple(100), Banana(NULL), Cherry(300)
    var r1 = exec.executeSql("SELECT name, price FROM items WHERE category = 'Fruit' ORDER BY price ASC NULLS LAST");
    assertSuccess(r1, "WHERE + NULLS LAST");
    assertRowCount(r1, 3, "3 Fruit rows");
    assertEq(val(r1, 0, 1), "100", "row 0: 100 (Apple)");
    assertEq(val(r1, 1, 1), "300", "row 1: 300 (Cherry)");
    assertEq(val(r1, 2, 1), "NULL", "row 2: NULL (Banana)");
}

//=========================================================================
// Aggregate query with GROUP BY and NULLS ordering
//=========================================================================

func testNullsWithGroupBy() {
    section("NULLS ordering with GROUP BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE orders (region TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO orders VALUES ('East', 100)");
    exec.executeSql("INSERT INTO orders VALUES ('West', 200)");
    exec.executeSql("INSERT INTO orders (amount) VALUES (50)");   // region=NULL
    exec.executeSql("INSERT INTO orders VALUES ('East', 150)");
    exec.executeSql("INSERT INTO orders (amount) VALUES (75)");   // region=NULL

    var r1 = exec.executeSql("SELECT region, SUM(amount) FROM orders GROUP BY region ORDER BY region ASC NULLS FIRST");
    assertSuccess(r1, "GROUP BY + NULLS FIRST");
    assertRowCount(r1, 3, "3 groups");
    // NULL group first
    assertEq(val(r1, 0, 0), "NULL", "row 0: NULL region");
    assertEq(val(r1, 0, 1), "125", "row 0: sum=125");
    // Then alphabetical
    assertEq(val(r1, 1, 0), "East", "row 1: East");
    assertEq(val(r1, 2, 0), "West", "row 2: West");
}

//=========================================================================
// All non-NULL — NULLS FIRST/LAST should not change ordering
//=========================================================================

func testNoNulls() {
    section("No NULLs (NULLS FIRST is no-op)");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nums (val INTEGER)");
    exec.executeSql("INSERT INTO nums VALUES (30)");
    exec.executeSql("INSERT INTO nums VALUES (10)");
    exec.executeSql("INSERT INTO nums VALUES (20)");

    var r1 = exec.executeSql("SELECT val FROM nums ORDER BY val ASC NULLS FIRST");
    assertSuccess(r1, "no nulls NULLS FIRST");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "10", "row 0: 10");
    assertEq(val(r1, 1, 0), "20", "row 1: 20");
    assertEq(val(r1, 2, 0), "30", "row 2: 30");

    var r2 = exec.executeSql("SELECT val FROM nums ORDER BY val DESC NULLS LAST");
    assertSuccess(r2, "no nulls NULLS LAST");
    assertRowCount(r2, 3, "3 rows");
    assertEq(val(r2, 0, 0), "30", "row 0: 30");
    assertEq(val(r2, 1, 0), "20", "row 1: 20");
    assertEq(val(r2, 2, 0), "10", "row 2: 10");
}

//=========================================================================
// All NULLs
//=========================================================================

func testAllNulls() {
    section("All NULLs");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nulltab (val INTEGER)");
    exec.executeSql("INSERT INTO nulltab (val) VALUES (NULL)");
    exec.executeSql("INSERT INTO nulltab (val) VALUES (NULL)");
    exec.executeSql("INSERT INTO nulltab (val) VALUES (NULL)");

    var r1 = exec.executeSql("SELECT val FROM nulltab ORDER BY val ASC NULLS FIRST");
    assertSuccess(r1, "all nulls NULLS FIRST");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "NULL", "all NULL");
    assertEq(val(r1, 2, 0), "NULL", "all NULL");
}

//=========================================================================
// Regression: ORDER BY without NULLS should still work
//=========================================================================

func testRegressionPlainOrderBy() {
    section("Regression: plain ORDER BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE reg (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO reg VALUES (3, 'c')");
    exec.executeSql("INSERT INTO reg VALUES (1, 'a')");
    exec.executeSql("INSERT INTO reg VALUES (2, 'b')");

    var r1 = exec.executeSql("SELECT id, name FROM reg ORDER BY id ASC");
    assertSuccess(r1, "plain ORDER BY ASC");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "1", "id=1");
    assertEq(val(r1, 1, 0), "2", "id=2");
    assertEq(val(r1, 2, 0), "3", "id=3");

    var r2 = exec.executeSql("SELECT id, name FROM reg ORDER BY name DESC");
    assertSuccess(r2, "plain ORDER BY DESC");
    assertEq(val(r2, 0, 1), "c", "name=c");
    assertEq(val(r2, 1, 1), "b", "name=b");
    assertEq(val(r2, 2, 1), "a", "name=a");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 62: NULLS FIRST / NULLS LAST ===");

    testDefaultNullOrderAsc();
    testDefaultNullOrderDesc();
    testNullsFirstAsc();
    testNullsLastDesc();
    testNullsLastAsc();
    testNullsFirstDesc();
    testMultiColumnNulls();
    testNullsFirstText();
    testNullsLastTextDesc();
    testNullsFirstWithLimit();
    testNullsLastWithWhere();
    testNullsWithGroupBy();
    testNoNulls();
    testAllNulls();
    testRegressionPlainOrderBy();

    printResults();
}
