// test_phase49_strings.zia — Phase 49: String Functions
// Tests for TRANSLATE, OVERLAY, CHAR_LENGTH, STARTS_WITH, ENDS_WITH,
// QUOTE_LITERAL, QUOTE_IDENT, MD5, SHA256, TO_HEX.

module test_phase49_strings;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// CHAR_LENGTH / CHARACTER_LENGTH / OCTET_LENGTH / BIT_LENGTH
//=========================================================================

func testLengthAliases() {
    section("Length aliases");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT CHAR_LENGTH('hello')");
    assertSuccess(r1, "CHAR_LENGTH");
    assertEq(val(r1, 0, 0), "5", "char_length = 5");

    var r2 = exec.executeSql("SELECT CHARACTER_LENGTH('world')");
    assertSuccess(r2, "CHARACTER_LENGTH");
    assertEq(val(r2, 0, 0), "5", "character_length = 5");

    var r3 = exec.executeSql("SELECT OCTET_LENGTH('test')");
    assertEq(val(r3, 0, 0), "4", "octet_length = 4");

    var r4 = exec.executeSql("SELECT BIT_LENGTH('AB')");
    assertEq(val(r4, 0, 0), "16", "bit_length = 16 (2 bytes * 8)");
}

//=========================================================================
// TRANSLATE
//=========================================================================

func testTranslate() {
    section("TRANSLATE");

    var exec = new Executor();
    exec.init();

    // Replace vowels: a→1, e→2, i→3, o→4, u→5
    var r1 = exec.executeSql("SELECT TRANSLATE('hello world', 'aeiou', '12345')");
    assertSuccess(r1, "TRANSLATE");
    assertEq(val(r1, 0, 0), "h2ll4 w4rld", "vowels translated");

    // Delete characters (from longer than to)
    var r2 = exec.executeSql("SELECT TRANSLATE('hello', 'lo', 'L')");
    assertEq(val(r2, 0, 0), "heLL", "delete chars");
}

//=========================================================================
// OVERLAY
//=========================================================================

func testOverlay() {
    section("OVERLAY");

    var exec = new Executor();
    exec.init();

    // OVERLAY('hello world' PLACING 'XY' FROM 7 FOR 5)
    var r1 = exec.executeSql("SELECT OVERLAY('hello world', 'XY', 7, 5)");
    assertSuccess(r1, "OVERLAY");
    assertEq(val(r1, 0, 0), "hello XY", "overlay replacement");

    // OVERLAY without FOR (default count = length of replacement)
    var r2 = exec.executeSql("SELECT OVERLAY('abcdef', 'XY', 3)");
    assertEq(val(r2, 0, 0), "abXYef", "overlay default count");
}

//=========================================================================
// STARTS_WITH / ENDS_WITH
//=========================================================================

func testStartsEndsWith() {
    section("STARTS_WITH / ENDS_WITH");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT STARTS_WITH('hello world', 'hello')");
    assertSuccess(r1, "STARTS_WITH");
    assertEq(val(r1, 0, 0), "true", "starts with hello");

    var r2 = exec.executeSql("SELECT STARTS_WITH('hello world', 'world')");
    assertEq(val(r2, 0, 0), "false", "does not start with world");

    var r3 = exec.executeSql("SELECT ENDS_WITH('hello world', 'world')");
    assertEq(val(r3, 0, 0), "true", "ends with world");

    var r4 = exec.executeSql("SELECT ENDS_WITH('hello world', 'hello')");
    assertEq(val(r4, 0, 0), "false", "does not end with hello");
}

//=========================================================================
// QUOTE_LITERAL / QUOTE_IDENT
//=========================================================================

func testQuoteFunctions() {
    section("QUOTE functions");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT QUOTE_LITERAL('hello')");
    assertSuccess(r1, "QUOTE_LITERAL");
    assertEq(val(r1, 0, 0), "'hello'", "quoted literal");

    var r2 = exec.executeSql("SELECT QUOTE_IDENT('my_table')");
    assertEq(val(r2, 0, 0), "\"my_table\"", "quoted ident");

    // NULL handling
    var r3 = exec.executeSql("SELECT QUOTE_LITERAL(NULL)");
    assertEq(val(r3, 0, 0), "NULL", "quote null");
}

//=========================================================================
// MD5 / SHA256
//=========================================================================

func testHashFunctions() {
    section("Hash functions");

    var exec = new Executor();
    exec.init();

    // MD5('hello') = 5d41402abc4b2a76b9719d911017c592
    var r1 = exec.executeSql("SELECT MD5('hello')");
    assertSuccess(r1, "MD5");
    var md5 = val(r1, 0, 0);
    assertTrue(stringContains(md5, "5d41402abc4b2a76"), "md5 of hello");

    // SHA256('hello')
    var r2 = exec.executeSql("SELECT SHA256('hello')");
    assertSuccess(r2, "SHA256");
    var sha = val(r2, 0, 0);
    assertTrue(stringContains(sha, "2cf24dba"), "sha256 of hello");
}

//=========================================================================
// TO_HEX
//=========================================================================

func testToHex() {
    section("TO_HEX");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT TO_HEX(255)");
    assertSuccess(r1, "TO_HEX");
    assertEq(val(r1, 0, 0), "ff", "255 = ff");

    var r2 = exec.executeSql("SELECT TO_HEX(16)");
    assertEq(val(r2, 0, 0), "10", "16 = 10");

    var r3 = exec.executeSql("SELECT TO_HEX(0)");
    assertEq(val(r3, 0, 0), "0", "0 = 0");
}

//=========================================================================
// Existing string functions still work
//=========================================================================

func testExistingStrings() {
    section("Existing string funcs");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT UPPER('hello')");
    assertEq(val(r1, 0, 0), "HELLO", "upper");

    var r2 = exec.executeSql("SELECT LOWER('WORLD')");
    assertEq(val(r2, 0, 0), "world", "lower");

    var r3 = exec.executeSql("SELECT REVERSE('abc')");
    assertEq(val(r3, 0, 0), "cba", "reverse");

    var r4 = exec.executeSql("SELECT LPAD('42', 5, '0')");
    assertEq(val(r4, 0, 0), "00042", "lpad");

    var r5 = exec.executeSql("SELECT RPAD('hi', 5, '!')");
    assertEq(val(r5, 0, 0), "hi!!!", "rpad");

    var r6 = exec.executeSql("SELECT INITCAP('hello world')");
    assertEq(val(r6, 0, 0), "Hello World", "initcap");

    var r7 = exec.executeSql("SELECT REPEAT('ab', 3)");
    assertEq(val(r7, 0, 0), "ababab", "repeat");

    var r8 = exec.executeSql("SELECT SPLIT_PART('a,b,c', ',', 2)");
    assertEq(val(r8, 0, 0), "b", "split_part");
}

//=========================================================================
// Table usage
//=========================================================================

func testWithTable() {
    section("String funcs with table");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE names (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO names VALUES (1, 'hello world')");
    exec.executeSql("INSERT INTO names VALUES (2, 'testing')");

    var r1 = exec.executeSql("SELECT CHAR_LENGTH(name) FROM names ORDER BY id");
    assertSuccess(r1, "CHAR_LENGTH with table");
    assertEq(val(r1, 0, 0), "11", "hello world = 11 chars");
    assertEq(val(r1, 1, 0), "7", "testing = 7 chars");

    var r2 = exec.executeSql("SELECT STARTS_WITH(name, 'hello') FROM names ORDER BY id");
    assertEq(val(r2, 0, 0), "true", "name 1 starts with hello");
    assertEq(val(r2, 1, 0), "false", "name 2 does not start with hello");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 49: String Functions ===");

    testLengthAliases();
    testTranslate();
    testOverlay();
    testStartsEndsWith();
    testQuoteFunctions();
    testHashFunctions();
    testToHex();
    testExistingStrings();
    testWithTable();

    printResults();
}
