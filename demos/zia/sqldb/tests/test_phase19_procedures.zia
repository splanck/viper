// test_phase19_procedures.zia â€” Phase 19: Stored Procedures / Functions Tests
// Tests for CREATE FUNCTION, DROP FUNCTION, SHOW FUNCTIONS,
// user-defined functions with parameters, SQL body substitution,
// and function invocation in queries.

module test_phase19_procedures;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";
bind "../procedures";

func main() -> Integer {
    Terminal.Say("=== Phase 19: Stored Procedures / Functions Tests ===");

    //=========================================================================
    // 1. STORED FUNCTION ENTITY BASICS
    //=========================================================================
    section("StoredFunction Entity");

    // Test 1: Create a FuncParam
    var p1 = new FuncParam();
    p1.initFull("x", SQL_INTEGER);
    assertEq(p1.name, "x", "Param name = x");
    assertEqInt(p1.typeCode, SQL_INTEGER, "Param type = INTEGER");
    assertEq(p1.typeName(), "INTEGER", "Param typeName = INTEGER");

    // Test 2: Create a StoredFunction
    var fn = new StoredFunction();
    fn.init();
    assertEq(fn.name, "", "Default name = empty");
    assertEqInt(fn.returnType, SQL_TEXT, "Default return type = TEXT");
    assertEqInt(fn.paramCount(), 0, "Default param count = 0");

    // Test 3: initFull
    var params: List[FuncParam] = [];
    var px = new FuncParam();
    px.initFull("x", SQL_INTEGER);
    params.add(px);
    var py = new FuncParam();
    py.initFull("y", SQL_INTEGER);
    params.add(py);
    var fn2 = new StoredFunction();
    fn2.initFull("ADD_NUMS", params, SQL_INTEGER, "SELECT $1 + $2");
    assertEq(fn2.name, "ADD_NUMS", "Function name = ADD_NUMS");
    assertEqInt(fn2.paramCount(), 2, "Param count = 2");
    assertEqInt(fn2.returnType, SQL_INTEGER, "Return type = INTEGER");
    assertEq(fn2.bodySQL, "SELECT $1 + $2", "Body SQL correct");

    // Test 4: substituteParams
    var args: List[SqlValue] = [];
    args.add(sqlInteger(10));
    args.add(sqlInteger(20));
    var substituted = fn2.substituteParams(args);
    assertEq(substituted, "SELECT 10 + 20", "Substituted SQL = SELECT 10 + 20");

    // Test 5: toString
    var desc = fn2.toString();
    assert(String.Length(desc) > 0, "toString produces output");

    //=========================================================================
    // 2. FUNCTION MANAGER
    //=========================================================================
    section("FunctionManager");

    var mgr = new FunctionManager();
    mgr.init();
    assertEqInt(mgr.count(), 0, "Manager starts empty");

    // Test 6: Add a function
    var f1 = new StoredFunction();
    var p1list: List[FuncParam] = [];
    var p1a = new FuncParam();
    p1a.initFull("n", SQL_INTEGER);
    p1list.add(p1a);
    f1.initFull("DOUBLE_IT", p1list, SQL_INTEGER, "SELECT $1 * 2");
    var err = mgr.addFunction(f1);
    assertEq(err, "", "addFunction succeeds");
    assertEqInt(mgr.count(), 1, "Manager count = 1");

    // Test 7: Find function by name and arg count
    var found = mgr.findFunction("DOUBLE_IT", 1);
    assert(found != null, "findFunction finds DOUBLE_IT");

    // Test 8: Duplicate detection
    var f1dup = new StoredFunction();
    var p1duplist: List[FuncParam] = [];
    var p1dup = new FuncParam();
    p1dup.initFull("n", SQL_INTEGER);
    p1duplist.add(p1dup);
    f1dup.initFull("DOUBLE_IT", p1duplist, SQL_INTEGER, "SELECT $1 * 2");
    var dupErr = mgr.addFunction(f1dup);
    assert(String.Length(dupErr) > 0, "Duplicate function rejected");

    // Test 9: Find by name
    var byName = mgr.findByName("DOUBLE_IT");
    assert(byName != null, "findByName finds DOUBLE_IT");

    // Test 10: Drop function
    var dropped = mgr.dropFunction("DOUBLE_IT");
    assert(dropped == true, "dropFunction returns true");
    assertEqInt(mgr.count(), 0, "Manager count = 0 after drop");

    // Test 11: Drop non-existent
    var notDropped = mgr.dropFunction("NONEXIST");
    assert(notDropped == false, "Drop non-existent returns false");

    //=========================================================================
    // 3. SQL: CREATE FUNCTION
    //=========================================================================
    section("CREATE FUNCTION SQL");

    var exec = new Executor();
    exec.init();

    // Test 12: Simple function
    var r1 = exec.executeSql("CREATE FUNCTION double_val(x INTEGER) RETURNS INTEGER AS 'SELECT $1 * 2'");
    assertSuccess(r1, "CREATE FUNCTION double_val succeeds");

    // Test 13: Call the function
    var r2 = exec.executeSql("SELECT double_val(21)");
    assertSuccess(r2, "SELECT double_val(21) succeeds");
    assertRowCount(r2, 1, "Returns 1 row");
    assertEq(val(r2, 0, 0), "42", "double_val(21) = 42");

    // Test 14: Function with text parameter
    var r3 = exec.executeSql("CREATE FUNCTION greet(name TEXT) RETURNS TEXT AS 'SELECT ''Hello '' || $1'");
    assertSuccess(r3, "CREATE FUNCTION greet succeeds");

    // Test 15: Multi-param function
    var r4 = exec.executeSql("CREATE FUNCTION add_nums(a INTEGER, b INTEGER) RETURNS INTEGER AS 'SELECT $1 + $2'");
    assertSuccess(r4, "CREATE FUNCTION add_nums succeeds");

    var r5 = exec.executeSql("SELECT add_nums(10, 32)");
    assertSuccess(r5, "SELECT add_nums(10, 32) succeeds");
    assertRowCount(r5, 1, "Returns 1 row");
    assertEq(val(r5, 0, 0), "42", "add_nums(10, 32) = 42");

    // Test 16: Function with no parameters
    var r6 = exec.executeSql("CREATE FUNCTION get_answer() RETURNS INTEGER AS 'SELECT 42'");
    assertSuccess(r6, "CREATE FUNCTION get_answer succeeds");

    var r7 = exec.executeSql("SELECT get_answer()");
    assertSuccess(r7, "SELECT get_answer() succeeds");
    assertEq(val(r7, 0, 0), "42", "get_answer() = 42");

    //=========================================================================
    // 4. SQL: DROP FUNCTION
    //=========================================================================
    section("DROP FUNCTION SQL");

    // Test 17: Drop existing function
    var r8 = exec.executeSql("DROP FUNCTION double_val");
    assertSuccess(r8, "DROP FUNCTION double_val succeeds");

    // Test 18: Drop non-existent function
    var r9 = exec.executeSql("DROP FUNCTION nonexistent");
    assertFailure(r9, "DROP FUNCTION nonexistent fails");

    // Test 19: Verify dropped function can't be called
    var r10 = exec.executeSql("SELECT double_val(5)");
    // This should still succeed but return NULL (no such function)
    assertSuccess(r10, "SELECT with unknown function still runs");

    //=========================================================================
    // 5. SQL: SHOW FUNCTIONS
    //=========================================================================
    section("SHOW FUNCTIONS SQL");

    // Test 20: Show functions
    var r11 = exec.executeSql("SHOW FUNCTIONS");
    assertSuccess(r11, "SHOW FUNCTIONS succeeds");
    // Should have add_nums, greet, get_answer (double_val was dropped)
    assertRowCount(r11, 3, "3 functions remain after drop");

    //=========================================================================
    // 6. FUNCTIONS WITH TABLE DATA
    //=========================================================================
    section("Functions with Table Data");

    exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 100)");
    exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 200)");
    exec.executeSql("INSERT INTO products VALUES (3, 'Doohickey', 150)");

    // Test 21: Function that queries a table (count)
    var r12 = exec.executeSql("CREATE FUNCTION count_products() RETURNS INTEGER AS 'SELECT COUNT(*) FROM products'");
    assertSuccess(r12, "CREATE FUNCTION count_products succeeds");

    var r13 = exec.executeSql("SELECT count_products()");
    assertSuccess(r13, "SELECT count_products() succeeds");
    assertEq(val(r13, 0, 0), "3", "count_products() = 3");

    // Test 22: Function that queries with parameter
    var r14 = exec.executeSql("CREATE FUNCTION get_price(pid INTEGER) RETURNS INTEGER AS 'SELECT price FROM products WHERE id = $1'");
    assertSuccess(r14, "CREATE FUNCTION get_price succeeds");

    var r15 = exec.executeSql("SELECT get_price(2)");
    assertSuccess(r15, "SELECT get_price(2) succeeds");
    assertEq(val(r15, 0, 0), "200", "get_price(2) = 200");

    // Test 23: Function used in WHERE clause
    var r16 = exec.executeSql("SELECT name FROM products WHERE price > get_price(1)");
    assertSuccess(r16, "SELECT with function in WHERE succeeds");
    assertRowCount(r16, 2, "2 products more expensive than product 1");

    // Test 24: Function used in expressions
    var r17 = exec.executeSql("SELECT add_nums(price, 50) FROM products WHERE id = 1");
    assertSuccess(r17, "Function in expression succeeds");
    assertEq(val(r17, 0, 0), "150", "add_nums(100, 50) = 150");

    //=========================================================================
    // 7. FUNCTION WITH INSERT/UPDATE
    //=========================================================================
    section("Functions in DML");

    exec.executeSql("CREATE TABLE computed_vals (id INTEGER PRIMARY KEY, val INTEGER)");

    // Test 25: Function in INSERT
    var r18 = exec.executeSql("INSERT INTO computed_vals VALUES (1, add_nums(10, 20))");
    assertSuccess(r18, "INSERT with function call succeeds");

    var r19 = exec.executeSql("SELECT val FROM computed_vals WHERE id = 1");
    assertSuccess(r19, "SELECT inserted value");
    assertEq(val(r19, 0, 0), "30", "Inserted value = 30");

    // Test 26: Function in UPDATE
    var r20 = exec.executeSql("UPDATE computed_vals SET val = add_nums(val, 10) WHERE id = 1");
    assertSuccess(r20, "UPDATE with function call succeeds");

    var r21 = exec.executeSql("SELECT val FROM computed_vals WHERE id = 1");
    assertEq(val(r21, 0, 0), "40", "Updated value = 40");

    //=========================================================================
    // 8. DUPLICATE AND ERROR CASES
    //=========================================================================
    section("Error Handling");

    // Test 27: Duplicate function
    var r22 = exec.executeSql("CREATE FUNCTION get_answer() RETURNS INTEGER AS 'SELECT 42'");
    assertFailure(r22, "Duplicate function rejected");

    // Test 28: CREATE FUNCTION without body
    var r23 = exec.executeSql("CREATE FUNCTION bad_func(x INTEGER) RETURNS INTEGER");
    assertFailure(r23, "Function without AS body rejected");

    //=========================================================================
    // 9. PARAMETER SUBSTITUTION EDGE CASES
    //=========================================================================
    section("Parameter Substitution");

    // Test 29: Text parameter substitution
    var r24 = exec.executeSql("CREATE FUNCTION find_product(pname TEXT) RETURNS INTEGER AS 'SELECT id FROM products WHERE name = $1'");
    assertSuccess(r24, "CREATE FUNCTION find_product succeeds");

    var r25 = exec.executeSql("SELECT find_product('Widget')");
    assertSuccess(r25, "find_product('Widget') succeeds");
    assertEq(val(r25, 0, 0), "1", "find_product('Widget') = 1");

    // Test 30: Multiple calls
    var r26 = exec.executeSql("SELECT find_product('Gadget')");
    assertEq(val(r26, 0, 0), "2", "find_product('Gadget') = 2");

    //=========================================================================
    // 10. OVERLOADING (SAME NAME, DIFFERENT PARAM COUNT)
    //=========================================================================
    section("Function Overloading");

    // Test 31: Same name, different param count is allowed
    var r27 = exec.executeSql("CREATE FUNCTION calc(x INTEGER) RETURNS INTEGER AS 'SELECT $1 * 10'");
    assertSuccess(r27, "CREATE FUNCTION calc(x) succeeds");

    var r28 = exec.executeSql("CREATE FUNCTION calc(x INTEGER, y INTEGER) RETURNS INTEGER AS 'SELECT $1 + $2'");
    assertSuccess(r28, "CREATE FUNCTION calc(x,y) succeeds (overload)");

    // Test 32: Call 1-arg version
    var r29 = exec.executeSql("SELECT calc(5)");
    assertSuccess(r29, "SELECT calc(5) succeeds");
    assertEq(val(r29, 0, 0), "50", "calc(5) = 50 (1-arg version)");

    // Test 33: Call 2-arg version
    var r30 = exec.executeSql("SELECT calc(5, 7)");
    assertSuccess(r30, "SELECT calc(5, 7) succeeds");
    assertEq(val(r30, 0, 0), "12", "calc(5, 7) = 12 (2-arg version)");

    //=========================================================================
    // 11. BOOLEAN RETURN TYPE
    //=========================================================================
    section("Boolean Functions");

    // Test 34: Boolean return
    var r31 = exec.executeSql("CREATE FUNCTION is_expensive(pid INTEGER) RETURNS BOOLEAN AS 'SELECT CASE WHEN price > 100 THEN 1 ELSE 0 END FROM products WHERE id = $1'");
    assertSuccess(r31, "CREATE FUNCTION is_expensive succeeds");

    var r32 = exec.executeSql("SELECT is_expensive(2)");
    assertSuccess(r32, "is_expensive(2) succeeds");
    assertEq(val(r32, 0, 0), "1", "is_expensive(2) = 1 (Gadget costs 200)");

    var r33 = exec.executeSql("SELECT is_expensive(1)");
    assertEq(val(r33, 0, 0), "0", "is_expensive(1) = 0 (Widget costs 100, not > 100)");

    //=========================================================================
    // 12. SHOW FUNCTIONS DETAILS
    //=========================================================================
    section("Show Functions Details");

    var r34 = exec.executeSql("SHOW FUNCTIONS");
    assertSuccess(r34, "SHOW FUNCTIONS succeeds");
    // Verify columns: function_name, parameters, return_type
    assert(r34.columnNames.count() == 3, "SHOW FUNCTIONS has 3 columns");
    assertEq(r34.columnNames.get(0), "function_name", "Column 0 = function_name");
    assertEq(r34.columnNames.get(1), "parameters", "Column 1 = parameters");
    assertEq(r34.columnNames.get(2), "return_type", "Column 2 = return_type");

    //=========================================================================
    // 13. FUNCTION WITH LANGUAGE CLAUSE
    //=========================================================================
    section("LANGUAGE Clause");

    // Test 35: Function with LANGUAGE SQL clause
    var r35 = exec.executeSql("CREATE FUNCTION square(n INTEGER) RETURNS INTEGER LANGUAGE SQL AS 'SELECT $1 * $1'");
    assertSuccess(r35, "CREATE FUNCTION with LANGUAGE SQL succeeds");

    var r36 = exec.executeSql("SELECT square(7)");
    assertSuccess(r36, "square(7) succeeds");
    assertEq(val(r36, 0, 0), "49", "square(7) = 49");

    //=========================================================================
    // RESULTS
    //=========================================================================
    printResults();
    return 0;
}
