// test_phase59_grouping_sets.zia — Phase 59: GROUPING SETS / ROLLUP / CUBE
// Tests for advanced GROUP BY features.

module test_phase59_grouping_sets;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (region TEXT, product TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES ('East', 'Widget', 100)");
    exec.executeSql("INSERT INTO sales VALUES ('East', 'Gadget', 200)");
    exec.executeSql("INSERT INTO sales VALUES ('West', 'Widget', 150)");
    exec.executeSql("INSERT INTO sales VALUES ('West', 'Gadget', 250)");
    exec.executeSql("INSERT INTO sales VALUES ('East', 'Widget', 50)");

    return exec;
}

//=========================================================================
// ROLLUP basic (2 columns)
//=========================================================================

func testRollup2() {
    section("ROLLUP (region, product)");

    var exec = setupExec();

    // ROLLUP(region, product) generates:
    //   (region, product) — full detail
    //   (region)          — subtotals per region
    //   ()                — grand total
    var r1 = exec.executeSql("SELECT region, product, SUM(amount) FROM sales GROUP BY ROLLUP (region, product)");
    assertSuccess(r1, "ROLLUP query");

    // Expected groups:
    // Detail: (East, Widget, 150), (East, Gadget, 200), (West, Widget, 150), (West, Gadget, 250)
    // Region subtotals: (East, NULL, 350), (West, NULL, 400)
    // Grand total: (NULL, NULL, 750)
    // Total = 4 + 2 + 1 = 7 rows
    assertRowCount(r1, 7, "7 rows: 4 detail + 2 subtotal + 1 grand");

    // Verify grand total row exists (both region and product are NULL)
    var foundGrand = false;
    var grandTotal = "";
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "NULL" {
            foundGrand = true;
            grandTotal = val(r1, ri, 2);
        }
        ri = ri + 1;
    }
    assert(foundGrand, "grand total row found");
    assertEq(grandTotal, "750", "grand total = 750");
}

//=========================================================================
// ROLLUP single column
//=========================================================================

func testRollup1() {
    section("ROLLUP (region)");

    var exec = setupExec();

    // ROLLUP(region) generates:
    //   (region) — per region
    //   ()       — grand total
    var r1 = exec.executeSql("SELECT region, SUM(amount) FROM sales GROUP BY ROLLUP (region)");
    assertSuccess(r1, "ROLLUP 1 col");
    // 2 regions + 1 grand total = 3 rows
    assertRowCount(r1, 3, "3 rows: 2 regions + grand total");

    // Find grand total
    var foundGrand = false;
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" {
            foundGrand = true;
            assertEq(val(r1, ri, 1), "750", "grand total = 750");
        }
        ri = ri + 1;
    }
    assert(foundGrand, "grand total row found");
}

//=========================================================================
// CUBE basic (2 columns)
//=========================================================================

func testCube2() {
    section("CUBE (region, product)");

    var exec = setupExec();

    // CUBE(region, product) generates all 2^2 = 4 subsets:
    //   ()                — grand total
    //   (region)          — subtotals per region
    //   (product)         — subtotals per product
    //   (region, product) — full detail
    var r1 = exec.executeSql("SELECT region, product, SUM(amount) FROM sales GROUP BY CUBE (region, product)");
    assertSuccess(r1, "CUBE query");

    // Expected groups:
    // (): 1 grand total
    // (region): 2 region groups
    // (product): 2 product groups
    // (region, product): 4 detail groups
    // Total = 1 + 2 + 2 + 4 = 9 rows
    assertRowCount(r1, 9, "9 rows: 4 detail + 2 region + 2 product + 1 grand");

    // Verify grand total
    var foundGrand = false;
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "NULL" {
            foundGrand = true;
            assertEq(val(r1, ri, 2), "750", "grand total = 750");
        }
        ri = ri + 1;
    }
    assert(foundGrand, "grand total row found");

    // Verify product subtotals exist (region = NULL, product != NULL)
    var widgetSubtotal = "";
    var gadgetSubtotal = "";
    ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "Widget" {
            widgetSubtotal = val(r1, ri, 2);
        }
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "Gadget" {
            gadgetSubtotal = val(r1, ri, 2);
        }
        ri = ri + 1;
    }
    assertEq(widgetSubtotal, "300", "Widget subtotal = 300");
    assertEq(gadgetSubtotal, "450", "Gadget subtotal = 450");
}

//=========================================================================
// GROUPING SETS explicit
//=========================================================================

func testGroupingSets() {
    section("GROUPING SETS explicit");

    var exec = setupExec();

    // GROUPING SETS ((region), (product), ())
    var r1 = exec.executeSql("SELECT region, product, SUM(amount) FROM sales GROUP BY GROUPING SETS ((region), (product), ())");
    assertSuccess(r1, "GROUPING SETS query");

    // (region): 2 groups (East, West)
    // (product): 2 groups (Widget, Gadget)
    // (): 1 grand total
    // Total = 5 rows
    assertRowCount(r1, 5, "5 rows: 2 region + 2 product + 1 grand");

    // Verify region subtotals (product should be NULL)
    var eastTotal = "";
    var westTotal = "";
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "East" && val(r1, ri, 1) == "NULL" {
            eastTotal = val(r1, ri, 2);
        }
        if val(r1, ri, 0) == "West" && val(r1, ri, 1) == "NULL" {
            westTotal = val(r1, ri, 2);
        }
        ri = ri + 1;
    }
    assertEq(eastTotal, "350", "East total = 350");
    assertEq(westTotal, "400", "West total = 400");
}

//=========================================================================
// GROUPING SETS with detail + grand total only
//=========================================================================

func testGroupingSetsDetailAndGrand() {
    section("GROUPING SETS detail + grand");

    var exec = setupExec();

    // GROUPING SETS ((region, product), ())
    var r1 = exec.executeSql("SELECT region, product, SUM(amount) FROM sales GROUP BY GROUPING SETS ((region, product), ())");
    assertSuccess(r1, "detail + grand");
    // 4 detail + 1 grand = 5
    assertRowCount(r1, 5, "5 rows: 4 detail + 1 grand");
}

//=========================================================================
// ROLLUP with COUNT
//=========================================================================

func testRollupCount() {
    section("ROLLUP with COUNT");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT region, COUNT(*) FROM sales GROUP BY ROLLUP (region)");
    assertSuccess(r1, "ROLLUP COUNT");
    assertRowCount(r1, 3, "3 rows");

    // Grand total count should be 5
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" {
            assertEq(val(r1, ri, 1), "5", "grand total count = 5");
        }
        ri = ri + 1;
    }
}

//=========================================================================
// CUBE with single column (same as ROLLUP for 1 col)
//=========================================================================

func testCube1() {
    section("CUBE (region) — same as ROLLUP for 1 col");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT region, SUM(amount) FROM sales GROUP BY CUBE (region)");
    assertSuccess(r1, "CUBE 1 col");
    // 2 regions + 1 grand = 3 rows (same as ROLLUP)
    assertRowCount(r1, 3, "3 rows");
}

//=========================================================================
// ROLLUP with 3 columns
//=========================================================================

func testRollup3() {
    section("ROLLUP (3 columns)");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (a TEXT, b TEXT, c TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES ('X', 'Y', 'Z', 10)");
    exec.executeSql("INSERT INTO data VALUES ('X', 'Y', 'W', 20)");
    exec.executeSql("INSERT INTO data VALUES ('X', 'M', 'Z', 30)");

    // ROLLUP(a, b, c) generates: (a,b,c), (a,b), (a), ()
    var r1 = exec.executeSql("SELECT a, b, c, SUM(val) FROM data GROUP BY ROLLUP (a, b, c)");
    assertSuccess(r1, "ROLLUP 3 cols");

    // Detail: 3 groups (X,Y,Z), (X,Y,W), (X,M,Z)
    // (a,b): 2 groups (X,Y), (X,M)
    // (a): 1 group (X)
    // (): 1 grand total
    // Total = 3 + 2 + 1 + 1 = 7
    assertRowCount(r1, 7, "7 rows");

    // Grand total
    var foundGrand = false;
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "NULL" && val(r1, ri, 2) == "NULL" {
            foundGrand = true;
            assertEq(val(r1, ri, 3), "60", "grand total = 60");
        }
        ri = ri + 1;
    }
    assert(foundGrand, "grand total exists");
}

//=========================================================================
// GROUPING SETS with empty set only
//=========================================================================

func testGroupingSetsGrandOnly() {
    section("GROUPING SETS (()) — grand total only");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT SUM(amount) FROM sales GROUP BY GROUPING SETS (())");
    assertSuccess(r1, "grand total only");
    assertRowCount(r1, 1, "1 row (grand total)");
    assertEq(val(r1, 0, 0), "750", "total = 750");
}

//=========================================================================
// ROLLUP with HAVING
//=========================================================================

func testRollupHaving() {
    section("ROLLUP with HAVING");

    var exec = setupExec();

    // Only include groups with SUM > 300
    var r1 = exec.executeSql("SELECT region, SUM(amount) FROM sales GROUP BY ROLLUP (region) HAVING SUM(amount) > 300");
    assertSuccess(r1, "ROLLUP HAVING");
    // East=350 (yes), West=400 (yes), Grand=750 (yes)
    assertRowCount(r1, 3, "3 rows with SUM > 300");
}

//=========================================================================
// ROLLUP with AVG
//=========================================================================

func testRollupAvg() {
    section("ROLLUP with AVG");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE scores (dept TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO scores VALUES ('A', 80)");
    exec.executeSql("INSERT INTO scores VALUES ('A', 90)");
    exec.executeSql("INSERT INTO scores VALUES ('B', 70)");
    exec.executeSql("INSERT INTO scores VALUES ('B', 100)");

    var r1 = exec.executeSql("SELECT dept, AVG(score) FROM scores GROUP BY ROLLUP (dept)");
    assertSuccess(r1, "ROLLUP AVG");
    assertRowCount(r1, 3, "2 depts + grand total");
}

//=========================================================================
// CUBE with 3 columns
//=========================================================================

func testCube3() {
    section("CUBE (3 columns)");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (a TEXT, b TEXT, c TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO data VALUES ('X', 'Y', 'Z', 10)");
    exec.executeSql("INSERT INTO data VALUES ('X', 'M', 'Z', 20)");

    // CUBE(a, b, c) generates 2^3 = 8 subsets
    // Detail: 2 groups
    // (a,b): 2 groups, (a,c): 2 groups, (b,c): 2 groups
    // (a): 1, (b): 2, (c): 1
    // (): 1
    var r1 = exec.executeSql("SELECT a, b, c, SUM(val) FROM data GROUP BY CUBE (a, b, c)");
    assertSuccess(r1, "CUBE 3 cols");
    // All groups with only 2 distinct source rows
    // Each subset produces distinct groups based on active columns
    // Too many to count precisely, but verify success and grand total
    var foundGrand = false;
    var ri = 0;
    while ri < r1.rowCount() {
        if val(r1, ri, 0) == "NULL" && val(r1, ri, 1) == "NULL" && val(r1, ri, 2) == "NULL" {
            foundGrand = true;
            assertEq(val(r1, ri, 3), "30", "grand total = 30");
        }
        ri = ri + 1;
    }
    assert(foundGrand, "grand total exists");
}

//=========================================================================
// GROUPING SETS single column sets
//=========================================================================

func testGroupingSetsSingleCols() {
    section("GROUPING SETS single column sets");

    var exec = setupExec();

    // GROUPING SETS ((region), (product)) — cross-dimension comparison
    var r1 = exec.executeSql("SELECT region, product, SUM(amount) FROM sales GROUP BY GROUPING SETS ((region), (product))");
    assertSuccess(r1, "single col sets");
    // (region): 2 groups, (product): 2 groups
    assertRowCount(r1, 4, "4 rows: 2 region + 2 product");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 59: GROUPING SETS / ROLLUP / CUBE ===");

    testRollup2();
    testRollup1();
    testCube2();
    testGroupingSets();
    testGroupingSetsDetailAndGrand();
    testRollupCount();
    testCube1();
    testRollup3();
    testGroupingSetsGrandOnly();
    testRollupHaving();
    testRollupAvg();
    testCube3();
    testGroupingSetsSingleCols();

    printResults();
}
