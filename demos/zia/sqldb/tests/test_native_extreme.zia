// test_native_extreme.zia â€” Extreme stress tests targeting obscure paths
// Part of ViperSQL
// Focuses on: table aliases in joins, mixed ORDER BY directions,
// expression chains, aggregate edge cases, multi-column GROUP BY,
// DELETE then re-INSERT patterns, and large-scale data integrity.

module test_native_extreme;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind String = Viper.String;
bind IO = Viper.IO;

bind "../executor";
bind "./test_common";

//=============================================================================
// EXTREME 1: Table aliases in FROM clause
//=============================================================================

func extreme1_table_aliases() {
    Terminal.Say("--- Extreme 1: Table aliases ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE customers (id INTEGER, name TEXT)");
    exec.executeSql("CREATE TABLE orders (id INTEGER, cust_id INTEGER, amount INTEGER)");

    exec.executeSql("INSERT INTO customers VALUES (1, 'Alice')");
    exec.executeSql("INSERT INTO customers VALUES (2, 'Bob')");
    exec.executeSql("INSERT INTO orders VALUES (100, 1, 50)");
    exec.executeSql("INSERT INTO orders VALUES (101, 1, 75)");
    exec.executeSql("INSERT INTO orders VALUES (102, 2, 30)");

    // Test with explicit JOIN ON syntax
    var r = exec.executeSql("SELECT customers.name, orders.amount FROM customers JOIN orders ON customers.id = orders.cust_id ORDER BY orders.amount DESC");
    assert(r.rowCount() == 3, "alias join: 3 rows");
    var row0 = r.getRow(0);
    if row0 != null {
        var rr = row0;
        assert(rr.getValue(0).toString() == "Alice", "alias join: highest amount is Alice");
        assert(rr.getValue(1).toString() == "75", "alias join: highest amount=75");
    }
}

//=============================================================================
// EXTREME 2: Mixed ASC/DESC in ORDER BY
//=============================================================================

func extreme2_mixed_sort_directions() {
    Terminal.Say("--- Extreme 2: Mixed ASC/DESC ORDER BY ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (name TEXT, category TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO products VALUES ('Widget', 'A', 100)");
    exec.executeSql("INSERT INTO products VALUES ('Gadget', 'A', 200)");
    exec.executeSql("INSERT INTO products VALUES ('Doohickey', 'B', 150)");
    exec.executeSql("INSERT INTO products VALUES ('Thingamajig', 'B', 50)");
    exec.executeSql("INSERT INTO products VALUES ('Whatchamacallit', 'A', 100)");

    // ORDER BY category ASC, price DESC
    var r = exec.executeSql("SELECT name, category, price FROM products ORDER BY category ASC, price DESC");
    assert(r.rowCount() == 5, "mixed-sort: 5 rows");

    // Category A first (ASC), within A: price DESC (200, 100, 100)
    var row0 = r.getRow(0);
    if row0 != null {
        var rr = row0;
        assert(rr.getValue(1).toString() == "A", "mixed-sort: first category=A");
        assert(rr.getValue(2).toString() == "200", "mixed-sort: first price=200 (Gadget)");
    }

    // Category B comes after A, within B: price DESC (150, 50)
    var row3 = r.getRow(3);
    if row3 != null {
        var rr = row3;
        assert(rr.getValue(1).toString() == "B", "mixed-sort: row3 category=B");
        assert(rr.getValue(2).toString() == "150", "mixed-sort: first B price=150");
    }
    var row4 = r.getRow(4);
    if row4 != null {
        var rr = row4;
        assert(rr.getValue(2).toString() == "50", "mixed-sort: last price=50");
    }
}

//=============================================================================
// EXTREME 3: Multi-column GROUP BY
//=============================================================================

func extreme3_multi_column_groupby() {
    Terminal.Say("--- Extreme 3: Multi-column GROUP BY ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE events (year INTEGER, month INTEGER, category TEXT, count INTEGER)");
    exec.executeSql("INSERT INTO events VALUES (2024, 1, 'A', 10)");
    exec.executeSql("INSERT INTO events VALUES (2024, 1, 'A', 20)");
    exec.executeSql("INSERT INTO events VALUES (2024, 1, 'B', 5)");
    exec.executeSql("INSERT INTO events VALUES (2024, 2, 'A', 15)");
    exec.executeSql("INSERT INTO events VALUES (2025, 1, 'A', 30)");
    exec.executeSql("INSERT INTO events VALUES (2025, 1, 'A', 10)");

    // GROUP BY year, month, category
    var r = exec.executeSql("SELECT year, month, category, SUM(count) FROM events GROUP BY year, month, category ORDER BY year ASC, month ASC, category ASC");
    assert(r.rowCount() == 4, "multi-grp: 4 groups");

    // Group 1: 2024, 1, A -> SUM=30
    var row0 = r.getRow(0);
    if row0 != null {
        var rr = row0;
        assert(rr.getValue(0).toString() == "2024", "multi-grp: row0 year=2024");
        assert(rr.getValue(1).toString() == "1", "multi-grp: row0 month=1");
        assert(rr.getValue(2).toString() == "A", "multi-grp: row0 cat=A");
        assert(rr.getValue(3).toString() == "30", "multi-grp: row0 sum=30");
    }

    // Group 2: 2024, 1, B -> SUM=5
    var row1 = r.getRow(1);
    if row1 != null {
        var rr = row1;
        assert(rr.getValue(2).toString() == "B", "multi-grp: row1 cat=B");
        assert(rr.getValue(3).toString() == "5", "multi-grp: row1 sum=5");
    }

    // Group 4: 2025, 1, A -> SUM=40
    var row3 = r.getRow(3);
    if row3 != null {
        var rr = row3;
        assert(rr.getValue(0).toString() == "2025", "multi-grp: row3 year=2025");
        assert(rr.getValue(3).toString() == "40", "multi-grp: row3 sum=40");
    }
}

//=============================================================================
// EXTREME 4: DELETE all then re-INSERT
//=============================================================================

func extreme4_delete_reinsert() {
    Terminal.Say("--- Extreme 4: DELETE all + re-INSERT ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE cycle (id INTEGER, val TEXT)");

    // 3 cycles of fill + empty + refill
    var cycle = 0;
    while cycle < 3 {
        // Fill with 100 rows
        var i = 0;
        while i < 100 {
            exec.executeSql("INSERT INTO cycle VALUES (" + Fmt.Int(cycle * 1000 + i) + ", 'cycle_" + Fmt.Int(cycle) + "_row_" + Fmt.Int(i) + "')");
            i = i + 1;
        }

        var r1 = exec.executeSql("SELECT COUNT(*) FROM cycle");
        var row1 = r1.getRow(0);
        if row1 != null {
            var rr = row1;
            var expected = Fmt.Int(100);
            assert(rr.getValue(0).toString() == expected, "cycle " + Fmt.Int(cycle) + ": 100 rows after fill");
        }

        // Delete all
        exec.executeSql("DELETE FROM cycle");

        var r2 = exec.executeSql("SELECT COUNT(*) FROM cycle");
        var row2 = r2.getRow(0);
        if row2 != null {
            var rr = row2;
            assert(rr.getValue(0).toString() == "0", "cycle " + Fmt.Int(cycle) + ": 0 rows after delete");
        }

        cycle = cycle + 1;
    }

    // Final fill
    var i = 0;
    while i < 50 {
        exec.executeSql("INSERT INTO cycle VALUES (" + Fmt.Int(i) + ", 'final_" + Fmt.Int(i) + "')");
        i = i + 1;
    }
    var rf = exec.executeSql("SELECT COUNT(*) FROM cycle");
    var rowf = rf.getRow(0);
    if rowf != null {
        var rr = rowf;
        assert(rr.getValue(0).toString() == "50", "cycle final: 50 rows");
    }
}

//=============================================================================
// EXTREME 5: Complex WHERE with nested AND/OR
//=============================================================================

func extreme5_complex_where() {
    Terminal.Say("--- Extreme 5: Complex WHERE ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE data (id INTEGER, a INTEGER, b INTEGER, c TEXT)");
    var i = 0;
    while i < 100 {
        exec.executeSql("INSERT INTO data VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i % 10) + ", " + Fmt.Int(i / 10) + ", '" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // (a > 5 AND b < 3) OR (a < 2 AND b > 7)
    var r = exec.executeSql("SELECT COUNT(*) FROM data WHERE (a > 5 AND b < 3) OR (a < 2 AND b > 7)");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        // a > 5 AND b < 3: a in {6,7,8,9}, b in {0,1,2} -> b=i/10, so i in 0..29 with a in {6..9}
        // For b=0 (i=0..9): a=i%10, a>5 means i in {6,7,8,9} = 4 rows
        // For b=1 (i=10..19): a=i%10, a>5 means i in {16,17,18,19} = 4 rows
        // For b=2 (i=20..29): a=i%10, a>5 means i in {26,27,28,29} = 4 rows
        // Total for first clause: 12
        // a < 2 AND b > 7: a in {0,1}, b in {8,9}
        // For b=8 (i=80..89): a=i%10, a<2 means i in {80,81} = 2 rows
        // For b=9 (i=90..99): a=i%10, a<2 means i in {90,91} = 2 rows
        // Total for second clause: 4
        // Grand total: 16
        assert(rr.getValue(0).toString() == "16", "complex where: 16 matches");
    }

    // NOT condition
    var r2 = exec.executeSql("SELECT COUNT(*) FROM data WHERE NOT (a = 0)");
    var row2 = r2.getRow(0);
    if row2 != null {
        var rr = row2;
        // a = 0 for i in {0,10,20,30,40,50,60,70,80,90} = 10 rows
        // NOT: 100 - 10 = 90
        assert(rr.getValue(0).toString() == "90", "complex where: NOT gives 90");
    }
}

//=============================================================================
// EXTREME 6: JOIN with ORDER BY and LIMIT
//=============================================================================

func extreme6_join_order_limit() {
    Terminal.Say("--- Extreme 6: JOIN + ORDER BY + LIMIT ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE artists (id INTEGER, name TEXT)");
    exec.executeSql("CREATE TABLE songs (id INTEGER, artist_id INTEGER, title TEXT, plays INTEGER)");

    exec.executeSql("INSERT INTO artists VALUES (1, 'Alpha')");
    exec.executeSql("INSERT INTO artists VALUES (2, 'Beta')");
    exec.executeSql("INSERT INTO artists VALUES (3, 'Gamma')");

    exec.executeSql("INSERT INTO songs VALUES (1, 1, 'Song_A1', 1000)");
    exec.executeSql("INSERT INTO songs VALUES (2, 1, 'Song_A2', 500)");
    exec.executeSql("INSERT INTO songs VALUES (3, 2, 'Song_B1', 2000)");
    exec.executeSql("INSERT INTO songs VALUES (4, 2, 'Song_B2', 100)");
    exec.executeSql("INSERT INTO songs VALUES (5, 3, 'Song_G1', 1500)");

    // Top 3 songs with artist names
    var r = exec.executeSql("SELECT artists.name, songs.title, songs.plays FROM artists JOIN songs ON artists.id = songs.artist_id ORDER BY songs.plays DESC LIMIT 3");
    assert(r.rowCount() == 3, "join-lim: 3 rows (LIMIT 3)");
    var row0 = r.getRow(0);
    if row0 != null {
        var rr = row0;
        assert(rr.getValue(2).toString() == "2000", "join-lim: top song 2000 plays");
        assert(rr.getValue(0).toString() == "Beta", "join-lim: top song by Beta");
    }
    var row2 = r.getRow(2);
    if row2 != null {
        var rr = row2;
        assert(rr.getValue(2).toString() == "1000", "join-lim: 3rd song 1000 plays");
    }
}

//=============================================================================
// EXTREME 7: Aggregate with ALL rows having same group key
//=============================================================================

func extreme7_single_group() {
    Terminal.Say("--- Extreme 7: Single group aggregate ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE mono (category TEXT, val INTEGER)");
    var i = 0;
    while i < 200 {
        exec.executeSql("INSERT INTO mono VALUES ('same', " + Fmt.Int(i) + ")");
        i = i + 1;
    }

    var r = exec.executeSql("SELECT category, COUNT(*), SUM(val), MIN(val), MAX(val), AVG(val) FROM mono GROUP BY category");
    assert(r.rowCount() == 1, "single-grp: 1 group");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        assert(rr.getValue(0).toString() == "same", "single-grp: category=same");
        assert(rr.getValue(1).toString() == "200", "single-grp: count=200");
        // SUM(0..199) = 199*200/2 = 19900
        assert(rr.getValue(2).toString() == "19900", "single-grp: sum=19900");
        assert(rr.getValue(3).toString() == "0", "single-grp: min=0");
        assert(rr.getValue(4).toString() == "199", "single-grp: max=199");
        assert(rr.getValue(5).toString() == "99.5", "single-grp: avg=99.5");
    }
}

//=============================================================================
// EXTREME 8: Heavy UPDATE with expression
//=============================================================================

func extreme8_update_expressions() {
    Terminal.Say("--- Extreme 8: UPDATE with expressions ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE bank (id INTEGER, balance INTEGER, interest_rate INTEGER)");
    var i = 0;
    while i < 100 {
        exec.executeSql("INSERT INTO bank VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(1000 + i * 10) + ", " + Fmt.Int(2 + i % 5) + ")");
        i = i + 1;
    }

    // Apply interest: balance = balance + balance * interest_rate / 100
    exec.executeSql("UPDATE bank SET balance = balance + balance * interest_rate / 100");

    // Check specific rows
    // id=0: balance=1000, rate=2 -> 1000 + 1000*2/100 = 1000 + 20 = 1020
    var r = exec.executeSql("SELECT balance FROM bank WHERE id = 0");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        assert(rr.getValue(0).toString() == "1020", "upd-expr: id=0 balance=1020");
    }

    // id=50: balance=1500, rate=2 -> 1500 + 1500*2/100 = 1500 + 30 = 1530
    var r2 = exec.executeSql("SELECT balance FROM bank WHERE id = 50");
    var row2 = r2.getRow(0);
    if row2 != null {
        var rr = row2;
        assert(rr.getValue(0).toString() == "1530", "upd-expr: id=50 balance=1530");
    }

    // id=3: balance=1030, rate=5 -> 1030 + 1030*5/100 = 1030 + 51 = 1081
    var r3 = exec.executeSql("SELECT balance FROM bank WHERE id = 3");
    var row3 = r3.getRow(0);
    if row3 != null {
        var rr = row3;
        assert(rr.getValue(0).toString() == "1081", "upd-expr: id=3 balance=1081");
    }
}

//=============================================================================
// EXTREME 9: SELECT with OFFSET (pagination)
//=============================================================================

func extreme9_pagination() {
    Terminal.Say("--- Extreme 9: LIMIT + OFFSET pagination ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE pages (id INTEGER, val TEXT)");
    var i = 0;
    while i < 50 {
        exec.executeSql("INSERT INTO pages VALUES (" + Fmt.Int(i) + ", 'item_" + Fmt.Int(i) + "')");
        i = i + 1;
    }

    // Page 1: LIMIT 10 OFFSET 0
    var r1 = exec.executeSql("SELECT id FROM pages ORDER BY id ASC LIMIT 10 OFFSET 0");
    assert(r1.rowCount() == 10, "page1: 10 rows");
    var row0 = r1.getRow(0);
    if row0 != null {
        var rr = row0;
        assert(rr.getValue(0).toString() == "0", "page1: starts at 0");
    }

    // Page 3: LIMIT 10 OFFSET 20
    var r3 = exec.executeSql("SELECT id FROM pages ORDER BY id ASC LIMIT 10 OFFSET 20");
    assert(r3.rowCount() == 10, "page3: 10 rows");
    var row30 = r3.getRow(0);
    if row30 != null {
        var rr = row30;
        assert(rr.getValue(0).toString() == "20", "page3: starts at 20");
    }
    var rowLast = r3.getRow(9);
    if rowLast != null {
        var rr = rowLast;
        assert(rr.getValue(0).toString() == "29", "page3: ends at 29");
    }

    // Last page: LIMIT 10 OFFSET 45 -> only 5 rows left
    var r5 = exec.executeSql("SELECT id FROM pages ORDER BY id ASC LIMIT 10 OFFSET 45");
    assert(r5.rowCount() == 5, "page-last: 5 rows (45..49)");
}

//=============================================================================
// EXTREME 10: Data integrity under interleaved operations
//=============================================================================

func extreme10_interleaved_ops() {
    Terminal.Say("--- Extreme 10: Interleaved operations ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE accounts (id INTEGER, name TEXT, balance INTEGER)");
    exec.executeSql("CREATE TABLE transfers (from_id INTEGER, to_id INTEGER, amount INTEGER)");

    // Create 10 accounts with balance 1000
    var i = 0;
    while i < 10 {
        exec.executeSql("INSERT INTO accounts VALUES (" + Fmt.Int(i) + ", 'user_" + Fmt.Int(i) + "', 1000)");
        i = i + 1;
    }

    // Simulate 50 transfers
    i = 0;
    while i < 50 {
        var fromId = i % 10;
        var toId = (i + 3) % 10;
        var amount = 10 + i;

        // Record transfer
        exec.executeSql("INSERT INTO transfers VALUES (" + Fmt.Int(fromId) + ", " + Fmt.Int(toId) + ", " + Fmt.Int(amount) + ")");

        // Debit from
        exec.executeSql("UPDATE accounts SET balance = balance - " + Fmt.Int(amount) + " WHERE id = " + Fmt.Int(fromId));

        // Credit to
        exec.executeSql("UPDATE accounts SET balance = balance + " + Fmt.Int(amount) + " WHERE id = " + Fmt.Int(toId));

        i = i + 1;
    }

    // Total balance should still be 10000 (conservation)
    var r = exec.executeSql("SELECT SUM(balance) FROM accounts");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        assert(rr.getValue(0).toString() == "10000", "interleaved: total balance conserved (10000)");
    }

    // 50 transfer records
    var r2 = exec.executeSql("SELECT COUNT(*) FROM transfers");
    var row2 = r2.getRow(0);
    if row2 != null {
        var rr = row2;
        assert(rr.getValue(0).toString() == "50", "interleaved: 50 transfers");
    }

    // Sum of transfers should equal sum of debits
    var r3 = exec.executeSql("SELECT SUM(amount) FROM transfers");
    var row3 = r3.getRow(0);
    if row3 != null {
        var rr = row3;
        // SUM(10+i for i=0..49) = 50*10 + 49*50/2 = 500 + 1225 = 1725
        assert(rr.getValue(0).toString() == "1725", "interleaved: total transferred=1725");
    }
}

//=============================================================================
// EXTREME 11: COUNT DISTINCT
//=============================================================================

func extreme11_count_distinct() {
    Terminal.Say("--- Extreme 11: COUNT DISTINCT ---");
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE visits (user_id INTEGER, page TEXT, ts INTEGER)");
    var i = 0;
    while i < 200 {
        exec.executeSql("INSERT INTO visits VALUES (" + Fmt.Int(i % 20) + ", 'page_" + Fmt.Int(i % 5) + "', " + Fmt.Int(i) + ")");
        i = i + 1;
    }

    // 20 unique users
    var r = exec.executeSql("SELECT COUNT(DISTINCT user_id) FROM visits");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        assert(rr.getValue(0).toString() == "20", "count-dist: 20 unique users");
    }

    // 5 unique pages
    var r2 = exec.executeSql("SELECT COUNT(DISTINCT page) FROM visits");
    var row2 = r2.getRow(0);
    if row2 != null {
        var rr = row2;
        assert(rr.getValue(0).toString() == "5", "count-dist: 5 unique pages");
    }
}

//=============================================================================
// EXTREME 12: Rapid CREATE/DROP TABLE stress
//=============================================================================

func extreme12_create_drop_stress() {
    Terminal.Say("--- Extreme 12: CREATE/DROP stress ---");
    var exec = new Executor();
    exec.init();

    // Create and drop 50 tables rapidly
    var i = 0;
    while i < 50 {
        exec.executeSql("CREATE TABLE tmp_" + Fmt.Int(i) + " (id INTEGER, val TEXT)");
        exec.executeSql("INSERT INTO tmp_" + Fmt.Int(i) + " VALUES (" + Fmt.Int(i) + ", 'test')");
        exec.executeSql("DROP TABLE tmp_" + Fmt.Int(i));
        i = i + 1;
    }

    // Create a final table to verify everything still works
    exec.executeSql("CREATE TABLE final_table (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO final_table VALUES (1, 'survived')");
    var r = exec.executeSql("SELECT name FROM final_table WHERE id = 1");
    assert(r.rowCount() == 1, "create-drop: table survives after 50 cycles");
    var row = r.getRow(0);
    if row != null {
        var rr = row;
        assert(rr.getValue(0).toString() == "survived", "create-drop: value correct");
    }
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Terminal.Say("=== Native Extreme Tests ===");

    extreme1_table_aliases();
    extreme2_mixed_sort_directions();
    extreme3_multi_column_groupby();
    extreme4_delete_reinsert();
    extreme5_complex_where();
    extreme6_join_order_limit();
    extreme7_single_group();
    extreme8_update_expressions();
    extreme9_pagination();
    extreme10_interleaved_ops();
    extreme11_count_distinct();
    extreme12_create_drop_stress();

    printResults();
}
