// test_phase42_insert.zia — Phase 42: INSERT Improvements
// Tests for INSERT ... DEFAULT VALUES and standalone VALUES query.

module test_phase42_insert;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// INSERT ... DEFAULT VALUES — basic
//=========================================================================

func testDefaultValuesBasic() {
    section("INSERT DEFAULT VALUES basic");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE def_t (id INTEGER DEFAULT 0, name TEXT DEFAULT 'unknown', score REAL DEFAULT 3.14)");

    var r1 = exec.executeSql("INSERT INTO def_t DEFAULT VALUES");
    assertSuccess(r1, "INSERT DEFAULT VALUES");

    var r2 = exec.executeSql("SELECT id, name, score FROM def_t");
    assertSuccess(r2, "select after default insert");
    assertRowCount(r2, 1, "1 row inserted");
    assertEq(val(r2, 0, 0), "0", "id is 0");
    assertEq(val(r2, 0, 1), "unknown", "name is unknown");
    assertEq(val(r2, 0, 2), "3.14", "score is 3.14");
}

//=========================================================================
// INSERT ... DEFAULT VALUES — with autoincrement
//=========================================================================

func testDefaultValuesAutoIncrement() {
    section("INSERT DEFAULT VALUES with autoincrement");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE auto_t (id INTEGER PRIMARY KEY AUTOINCREMENT, val TEXT DEFAULT 'auto')");

    var r1 = exec.executeSql("INSERT INTO auto_t DEFAULT VALUES");
    assertSuccess(r1, "1st default insert");

    var r2 = exec.executeSql("INSERT INTO auto_t DEFAULT VALUES");
    assertSuccess(r2, "2nd default insert");

    var r3 = exec.executeSql("SELECT id, val FROM auto_t ORDER BY id");
    assertSuccess(r3, "select auto rows");
    assertRowCount(r3, 2, "2 rows");
    assertEq(val(r3, 0, 0), "1", "id 1");
    assertEq(val(r3, 0, 1), "auto", "val auto");
    assertEq(val(r3, 1, 0), "2", "id 2");
    assertEq(val(r3, 1, 1), "auto", "val auto row 2");
}

//=========================================================================
// INSERT ... DEFAULT VALUES — no defaults (NULLs)
//=========================================================================

func testDefaultValuesNulls() {
    section("INSERT DEFAULT VALUES with nulls");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE null_t (a INTEGER, b TEXT)");

    var r1 = exec.executeSql("INSERT INTO null_t DEFAULT VALUES");
    assertSuccess(r1, "default insert no defaults");

    var r2 = exec.executeSql("SELECT a, b FROM null_t");
    assertSuccess(r2, "select null row");
    assertEq(val(r2, 0, 0), "NULL", "a is NULL");
    assertEq(val(r2, 0, 1), "NULL", "b is NULL");
}

//=========================================================================
// INSERT ... DEFAULT VALUES — NOT NULL constraint fails
//=========================================================================

func testDefaultValuesNotNull() {
    section("INSERT DEFAULT VALUES with NOT NULL");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nn_t (id INTEGER NOT NULL, name TEXT DEFAULT 'ok')");

    // Should fail: id has NOT NULL but no default
    var r1 = exec.executeSql("INSERT INTO nn_t DEFAULT VALUES");
    assertFailure(r1, "NOT NULL constraint blocks default insert");
}

//=========================================================================
// INSERT ... DEFAULT VALUES — with RETURNING
//=========================================================================

func testDefaultValuesReturning() {
    section("INSERT DEFAULT VALUES RETURNING");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE ret_t (id INTEGER PRIMARY KEY AUTOINCREMENT, label TEXT DEFAULT 'item')");

    var r1 = exec.executeSql("INSERT INTO ret_t DEFAULT VALUES RETURNING id, label");
    assertSuccess(r1, "default insert returning");
    assertRowCount(r1, 1, "1 returned row");
    assertEq(val(r1, 0, 0), "1", "returned id");
    assertEq(val(r1, 0, 1), "item", "returned label");
}

//=========================================================================
// Standalone VALUES query — basic
//=========================================================================

func testStandaloneValues() {
    section("Standalone VALUES query");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("VALUES (1, 'hello', 3.14)");
    assertSuccess(r1, "standalone values");
    assertRowCount(r1, 1, "1 row");
    assertColumnCount(r1, 3, "3 columns");
    assertEq(val(r1, 0, 0), "1", "col1 is 1");
    assertEq(val(r1, 0, 1), "hello", "col2 is hello");
    assertEq(val(r1, 0, 2), "3.14", "col3 is 3.14");
}

//=========================================================================
// Standalone VALUES query — multiple rows
//=========================================================================

func testStandaloneValuesMultiRow() {
    section("Standalone VALUES multi-row");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("VALUES (1, 'a'), (2, 'b'), (3, 'c')");
    assertSuccess(r1, "multi-row values");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "1", "row0 col1");
    assertEq(val(r1, 0, 1), "a", "row0 col2");
    assertEq(val(r1, 1, 0), "2", "row1 col1");
    assertEq(val(r1, 1, 1), "b", "row1 col2");
    assertEq(val(r1, 2, 0), "3", "row2 col1");
    assertEq(val(r1, 2, 1), "c", "row2 col2");
}

//=========================================================================
// Standalone VALUES query — with expressions
//=========================================================================

func testStandaloneValuesExpressions() {
    section("Standalone VALUES with expressions");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("VALUES (1 + 2, 10 * 5)");
    assertSuccess(r1, "values with expressions");
    assertEq(val(r1, 0, 0), "3", "1+2=3");
    assertEq(val(r1, 0, 1), "50", "10*5=50");
}

//=========================================================================
// Standalone VALUES query — with NULL
//=========================================================================

func testStandaloneValuesNull() {
    section("Standalone VALUES with NULL");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("VALUES (1, NULL, 'text')");
    assertSuccess(r1, "values with null");
    assertEq(val(r1, 0, 0), "1", "col1");
    assertEq(val(r1, 0, 1), "NULL", "col2 null");
    assertEq(val(r1, 0, 2), "text", "col3 text");
}

//=========================================================================
// Standalone VALUES — column names
//=========================================================================

func testStandaloneValuesColumnNames() {
    section("Standalone VALUES column names");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("VALUES (42)");
    assertSuccess(r1, "single value");
    assertEq(r1.columnNames.get(0), "column1", "column name is column1");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 42: INSERT Improvements ===");

    testDefaultValuesBasic();
    testDefaultValuesAutoIncrement();
    testDefaultValuesNulls();
    testDefaultValuesNotNull();
    testDefaultValuesReturning();
    testStandaloneValues();
    testStandaloneValuesMultiRow();
    testStandaloneValuesExpressions();
    testStandaloneValuesNull();
    testStandaloneValuesColumnNames();

    printResults();
}
