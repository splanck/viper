// test_phase13_privileges.zia — Tests for GRANT/REVOKE & Privilege System (Phase 13)
// Part of ViperSQL Test Suite
//
// Tests privilege checking, GRANT/REVOKE syntax, ownership model,
// superuser bypass, PUBLIC grants, SHOW GRANTS, TABLE_PRIVILEGES view.

module test_phase13_privileges;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "./test_common";
bind "../executor";
bind "../server";
bind "../result";
bind "../types";

//=============================================================================
// HELPER
//=============================================================================

func makeTestExecutor() -> Executor {
    var server = new DatabaseServer();
    server.init();
    var exec = new Executor();
    exec.initWithServer(server, 1);
    return exec;
}

//=============================================================================
// TEST: Superuser (admin) has full access
//=============================================================================

func testSuperuserAccess() {
    Terminal.Say("Testing superuser access...");
    var exec = makeTestExecutor();

    // Admin creates a table and has full access
    var r1 = exec.executeSql("CREATE TABLE items (id INTEGER, name TEXT)");
    assertSuccess(r1, "Admin CREATE TABLE succeeds");

    var r2 = exec.executeSql("INSERT INTO items VALUES (1, 'apple')");
    assertSuccess(r2, "Admin INSERT succeeds");

    var r3 = exec.executeSql("SELECT * FROM items");
    assertSuccess(r3, "Admin SELECT succeeds");

    var r4 = exec.executeSql("UPDATE items SET name = 'banana' WHERE id = 1");
    assertSuccess(r4, "Admin UPDATE succeeds");

    var r5 = exec.executeSql("DELETE FROM items WHERE id = 1");
    assertSuccess(r5, "Admin DELETE succeeds");

    var r6 = exec.executeSql("DROP TABLE items");
    assertSuccess(r6, "Admin DROP TABLE succeeds");
}

//=============================================================================
// TEST: Permission denied without GRANT
//=============================================================================

func testPermissionDenied() {
    Terminal.Say("Testing permission denied...");
    var exec = makeTestExecutor();

    // Admin creates table and user
    exec.executeSql("CREATE TABLE secrets (id INTEGER, data TEXT)");
    exec.executeSql("INSERT INTO secrets VALUES (1, 'classified')");
    exec.executeSql("CREATE USER bob PASSWORD 'bob123'");

    // Switch to bob
    exec.setCurrentUser("bob");

    // Bob should be denied all operations
    var r1 = exec.executeSql("SELECT * FROM secrets");
    assertFailure(r1, "Bob SELECT denied without GRANT");

    var r2 = exec.executeSql("INSERT INTO secrets VALUES (2, 'hack')");
    assertFailure(r2, "Bob INSERT denied without GRANT");

    var r3 = exec.executeSql("UPDATE secrets SET data = 'hacked' WHERE id = 1");
    assertFailure(r3, "Bob UPDATE denied without GRANT");

    var r4 = exec.executeSql("DELETE FROM secrets WHERE id = 1");
    assertFailure(r4, "Bob DELETE denied without GRANT");
}

//=============================================================================
// TEST: GRANT SELECT
//=============================================================================

func testGrantSelect() {
    Terminal.Say("Testing GRANT SELECT...");
    var exec = makeTestExecutor();

    // Admin creates table and user
    exec.executeSql("CREATE TABLE products (id INTEGER, name TEXT, price REAL)");
    exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 9.99)");
    exec.executeSql("CREATE USER alice PASSWORD 'alice123'");

    // GRANT SELECT to alice
    var r1 = exec.executeSql("GRANT SELECT ON products TO alice");
    assertSuccess(r1, "GRANT SELECT succeeds");
    assertMessage(r1, "GRANT", "GRANT message correct");

    // Switch to alice
    exec.setCurrentUser("alice");

    // Alice can SELECT
    var r2 = exec.executeSql("SELECT * FROM products");
    assertSuccess(r2, "Alice SELECT succeeds after GRANT");
    assertRowCount(r2, 1, "Alice sees 1 row");

    // Alice still can't INSERT
    var r3 = exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 19.99)");
    assertFailure(r3, "Alice INSERT still denied (only SELECT granted)");
}

//=============================================================================
// TEST: GRANT multiple privileges
//=============================================================================

func testGrantMultiple() {
    Terminal.Say("Testing GRANT multiple privileges...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE logs (id INTEGER, msg TEXT)");
    exec.executeSql("CREATE USER charlie PASSWORD 'charlie123'");

    // GRANT INSERT, UPDATE
    var r1 = exec.executeSql("GRANT INSERT, UPDATE ON logs TO charlie");
    assertSuccess(r1, "GRANT INSERT, UPDATE succeeds");

    exec.setCurrentUser("charlie");

    // Charlie can INSERT
    var r2 = exec.executeSql("INSERT INTO logs VALUES (1, 'entry')");
    assertSuccess(r2, "Charlie INSERT succeeds");

    // Charlie can UPDATE
    var r3 = exec.executeSql("UPDATE logs SET msg = 'updated' WHERE id = 1");
    assertSuccess(r3, "Charlie UPDATE succeeds");

    // Charlie can't SELECT
    var r4 = exec.executeSql("SELECT * FROM logs");
    assertFailure(r4, "Charlie SELECT denied (not granted)");

    // Charlie can't DELETE
    var r5 = exec.executeSql("DELETE FROM logs WHERE id = 1");
    assertFailure(r5, "Charlie DELETE denied (not granted)");
}

//=============================================================================
// TEST: GRANT ALL
//=============================================================================

func testGrantAll() {
    Terminal.Say("Testing GRANT ALL...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE data (id INTEGER, val TEXT)");
    exec.executeSql("CREATE USER dave PASSWORD 'dave123'");

    var r1 = exec.executeSql("GRANT ALL ON data TO dave");
    assertSuccess(r1, "GRANT ALL succeeds");

    exec.setCurrentUser("dave");

    // Dave can do everything
    var r2 = exec.executeSql("INSERT INTO data VALUES (1, 'test')");
    assertSuccess(r2, "Dave INSERT succeeds with ALL");

    var r3 = exec.executeSql("SELECT * FROM data");
    assertSuccess(r3, "Dave SELECT succeeds with ALL");

    var r4 = exec.executeSql("UPDATE data SET val = 'changed' WHERE id = 1");
    assertSuccess(r4, "Dave UPDATE succeeds with ALL");

    var r5 = exec.executeSql("DELETE FROM data WHERE id = 1");
    assertSuccess(r5, "Dave DELETE succeeds with ALL");
}

//=============================================================================
// TEST: REVOKE
//=============================================================================

func testRevoke() {
    Terminal.Say("Testing REVOKE...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE files (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO files VALUES (1, 'doc.txt')");
    exec.executeSql("CREATE USER eve PASSWORD 'eve123'");
    exec.executeSql("GRANT ALL ON files TO eve");

    // Eve can SELECT initially
    exec.setCurrentUser("eve");
    var r1 = exec.executeSql("SELECT * FROM files");
    assertSuccess(r1, "Eve SELECT succeeds before REVOKE");

    // Admin revokes SELECT
    exec.setCurrentUser("admin");
    var r2 = exec.executeSql("REVOKE SELECT ON files FROM eve");
    assertSuccess(r2, "REVOKE SELECT succeeds");
    assertMessage(r2, "REVOKE", "REVOKE message correct");

    // Eve can no longer SELECT
    exec.setCurrentUser("eve");
    var r3 = exec.executeSql("SELECT * FROM files");
    assertFailure(r3, "Eve SELECT denied after REVOKE");

    // Eve can still INSERT (only SELECT was revoked)
    var r4 = exec.executeSql("INSERT INTO files VALUES (2, 'pic.png')");
    assertSuccess(r4, "Eve INSERT still works (not revoked)");
}

//=============================================================================
// TEST: REVOKE ALL
//=============================================================================

func testRevokeAll() {
    Terminal.Say("Testing REVOKE ALL...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE archive (id INTEGER)");
    exec.executeSql("CREATE USER frank PASSWORD 'frank123'");
    exec.executeSql("GRANT ALL ON archive TO frank");

    exec.setCurrentUser("frank");
    var r1 = exec.executeSql("INSERT INTO archive VALUES (1)");
    assertSuccess(r1, "Frank INSERT succeeds before REVOKE ALL");

    exec.setCurrentUser("admin");
    var r2 = exec.executeSql("REVOKE ALL ON archive FROM frank");
    assertSuccess(r2, "REVOKE ALL succeeds");

    exec.setCurrentUser("frank");
    var r3 = exec.executeSql("SELECT * FROM archive");
    assertFailure(r3, "Frank SELECT denied after REVOKE ALL");

    var r4 = exec.executeSql("INSERT INTO archive VALUES (2)");
    assertFailure(r4, "Frank INSERT denied after REVOKE ALL");
}

//=============================================================================
// TEST: Owner implicit access
//=============================================================================

func testOwnerAccess() {
    Terminal.Say("Testing owner implicit access...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE USER grace PASSWORD 'grace123'");
    exec.setCurrentUser("grace");

    // Grace creates a table — she is the owner
    var r1 = exec.executeSql("CREATE TABLE grace_data (id INTEGER, val TEXT)");
    assertSuccess(r1, "Grace CREATE TABLE succeeds");

    // Owner has full access without explicit GRANT
    var r2 = exec.executeSql("INSERT INTO grace_data VALUES (1, 'mine')");
    assertSuccess(r2, "Owner INSERT succeeds");

    var r3 = exec.executeSql("SELECT * FROM grace_data");
    assertSuccess(r3, "Owner SELECT succeeds");

    var r4 = exec.executeSql("UPDATE grace_data SET val = 'updated' WHERE id = 1");
    assertSuccess(r4, "Owner UPDATE succeeds");

    var r5 = exec.executeSql("DELETE FROM grace_data WHERE id = 1");
    assertSuccess(r5, "Owner DELETE succeeds");
}

//=============================================================================
// TEST: PUBLIC grants
//=============================================================================

func testPublicGrant() {
    Terminal.Say("Testing PUBLIC grants...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE public_data (id INTEGER, info TEXT)");
    exec.executeSql("INSERT INTO public_data VALUES (1, 'public info')");
    exec.executeSql("CREATE USER henry PASSWORD 'henry123'");

    // GRANT SELECT to PUBLIC
    var r1 = exec.executeSql("GRANT SELECT ON public_data TO PUBLIC");
    assertSuccess(r1, "GRANT to PUBLIC succeeds");

    // Henry gets access via PUBLIC
    exec.setCurrentUser("henry");
    var r2 = exec.executeSql("SELECT * FROM public_data");
    assertSuccess(r2, "Henry SELECT succeeds via PUBLIC");

    // Henry still can't INSERT (only SELECT granted to PUBLIC)
    var r3 = exec.executeSql("INSERT INTO public_data VALUES (2, 'sneaky')");
    assertFailure(r3, "Henry INSERT denied (PUBLIC only has SELECT)");
}

//=============================================================================
// TEST: Non-owner can't GRANT
//=============================================================================

func testNonOwnerGrant() {
    Terminal.Say("Testing non-owner GRANT denied...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE admin_table (id INTEGER)");
    exec.executeSql("CREATE USER ivan PASSWORD 'ivan123'");
    exec.executeSql("CREATE USER jane PASSWORD 'jane123'");

    // Grant SELECT to ivan
    exec.executeSql("GRANT SELECT ON admin_table TO ivan");

    // Ivan tries to GRANT to jane — should fail (not owner)
    exec.setCurrentUser("ivan");
    var r1 = exec.executeSql("GRANT SELECT ON admin_table TO jane");
    assertFailure(r1, "Non-owner GRANT fails");
}

//=============================================================================
// TEST: DDL privilege checks (DROP TABLE, ALTER TABLE by non-owner)
//=============================================================================

func testDdlPrivileges() {
    Terminal.Say("Testing DDL privilege checks...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE protected (id INTEGER, name TEXT)");
    exec.executeSql("CREATE USER kyle PASSWORD 'kyle123'");
    exec.executeSql("GRANT ALL ON protected TO kyle");

    exec.setCurrentUser("kyle");

    // Kyle has ALL DML privileges but is NOT owner — can't DROP
    var r1 = exec.executeSql("DROP TABLE protected");
    assertFailure(r1, "Non-owner DROP TABLE denied");

    // Kyle can't ALTER TABLE either
    var r2 = exec.executeSql("ALTER TABLE protected ADD COLUMN extra TEXT");
    assertFailure(r2, "Non-owner ALTER TABLE denied");
}

//=============================================================================
// TEST: DROP TABLE cleans up privileges
//=============================================================================

func testDropTableCleanup() {
    Terminal.Say("Testing DROP TABLE privilege cleanup...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE ephemeral (id INTEGER)");
    exec.executeSql("CREATE USER lisa PASSWORD 'lisa123'");
    exec.executeSql("GRANT SELECT ON ephemeral TO lisa");

    // Verify grant exists
    exec.setCurrentUser("lisa");
    var r1 = exec.executeSql("SELECT * FROM ephemeral");
    assertSuccess(r1, "Lisa SELECT succeeds before drop");

    // Admin drops the table
    exec.setCurrentUser("admin");
    exec.executeSql("DROP TABLE ephemeral");

    // Recreate table — lisa should NOT have access (old grants cleaned up)
    exec.executeSql("CREATE TABLE ephemeral (id INTEGER)");
    exec.setCurrentUser("lisa");
    var r2 = exec.executeSql("SELECT * FROM ephemeral");
    assertFailure(r2, "Lisa SELECT denied on recreated table (old grants cleaned up)");
}

//=============================================================================
// TEST: DROP USER cleans up privileges
//=============================================================================

func testDropUserCleanup() {
    Terminal.Say("Testing DROP USER privilege cleanup...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE user_data (id INTEGER)");
    exec.executeSql("CREATE USER temp_user PASSWORD 'temp'");
    exec.executeSql("GRANT ALL ON user_data TO temp_user");

    // Drop the user — their privileges should be cleaned up
    exec.executeSql("DROP USER temp_user");

    // Verify grants table doesn't have stale entries
    var r1 = exec.executeSql("SELECT * FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES");
    assertSuccess(r1, "TABLE_PRIVILEGES query succeeds");
    // Should have 0 rows (temp_user's grants were cleaned up)
    assertRowCount(r1, 0, "No stale privileges after DROP USER");
}

//=============================================================================
// TEST: SHOW GRANTS
//=============================================================================

func testShowGrants() {
    Terminal.Say("Testing SHOW GRANTS...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE t1 (id INTEGER)");
    exec.executeSql("CREATE TABLE t2 (id INTEGER)");
    exec.executeSql("CREATE USER mary PASSWORD 'mary123'");
    exec.executeSql("GRANT SELECT ON t1 TO mary");
    exec.executeSql("GRANT INSERT, UPDATE ON t2 TO mary");

    var r1 = exec.executeSql("SHOW GRANTS FOR mary");
    assertSuccess(r1, "SHOW GRANTS succeeds");
    assert(r1.columnNames.count() == 3, "SHOW GRANTS has 3 columns");
    assert(r1.rows.count() >= 2, "SHOW GRANTS shows at least 2 entries for mary");
}

//=============================================================================
// TEST: INFORMATION_SCHEMA.TABLE_PRIVILEGES view
//=============================================================================

func testTablePrivilegesView() {
    Terminal.Say("Testing TABLE_PRIVILEGES view...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE viewed (id INTEGER)");
    exec.executeSql("CREATE USER nick PASSWORD 'nick123'");
    exec.executeSql("GRANT SELECT, INSERT ON viewed TO nick");

    var r1 = exec.executeSql("SELECT * FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES");
    assertSuccess(r1, "TABLE_PRIVILEGES query succeeds");
    assert(r1.columnNames.count() == 4, "TABLE_PRIVILEGES has 4 columns");
    assert(r1.columnNames.get(0) == "grantor", "First column is grantor");
    assert(r1.columnNames.get(1) == "grantee", "Second column is grantee");
    assert(r1.columnNames.get(2) == "table_name", "Third column is table_name");
    assert(r1.columnNames.get(3) == "privilege_type", "Fourth column is privilege_type");
    // SELECT and INSERT = 2 rows
    assertRowCount(r1, 2, "2 privilege rows (SELECT + INSERT)");
}

//=============================================================================
// TEST: GRANT syntax errors
//=============================================================================

func testSyntaxErrors() {
    Terminal.Say("Testing GRANT/REVOKE syntax errors...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE stbl (id INTEGER)");
    exec.executeSql("CREATE USER suser PASSWORD 'suser123'");

    // Missing ON
    var r1 = exec.executeSql("GRANT SELECT stbl TO suser");
    assertFailure(r1, "GRANT without ON fails");

    // Missing TO
    var r2 = exec.executeSql("GRANT SELECT ON stbl suser");
    assertFailure(r2, "GRANT without TO fails");

    // Non-existent table
    var r3 = exec.executeSql("GRANT SELECT ON nonexistent TO suser");
    assertFailure(r3, "GRANT on non-existent table fails");

    // Non-existent user
    var r4 = exec.executeSql("GRANT SELECT ON stbl TO nonexistent");
    assertFailure(r4, "GRANT to non-existent user fails");

    // Missing FROM in REVOKE
    var r5 = exec.executeSql("REVOKE SELECT ON stbl suser");
    assertFailure(r5, "REVOKE without FROM fails");
}

//=============================================================================
// TEST: GRANT ALL PRIVILEGES syntax
//=============================================================================

func testGrantAllPrivileges() {
    Terminal.Say("Testing GRANT ALL PRIVILEGES syntax...");
    var exec = makeTestExecutor();

    exec.executeSql("CREATE TABLE full_access (id INTEGER, val TEXT)");
    exec.executeSql("CREATE USER oscar PASSWORD 'oscar123'");

    var r1 = exec.executeSql("GRANT ALL PRIVILEGES ON full_access TO oscar");
    assertSuccess(r1, "GRANT ALL PRIVILEGES succeeds");

    exec.setCurrentUser("oscar");
    var r2 = exec.executeSql("INSERT INTO full_access VALUES (1, 'test')");
    assertSuccess(r2, "Oscar INSERT succeeds with ALL PRIVILEGES");

    var r3 = exec.executeSql("SELECT * FROM full_access");
    assertSuccess(r3, "Oscar SELECT succeeds with ALL PRIVILEGES");
}

//=============================================================================
// ENTRY POINT
//=============================================================================

func main() -> Integer {
    Terminal.Say("=== Phase 13: GRANT/REVOKE & Privilege System Tests ===");

    testSuperuserAccess();
    testPermissionDenied();
    testGrantSelect();
    testGrantMultiple();
    testGrantAll();
    testRevoke();
    testRevokeAll();
    testOwnerAccess();
    testPublicGrant();
    testNonOwnerGrant();
    testDdlPrivileges();
    testDropTableCleanup();
    testDropUserCleanup();
    testShowGrants();
    testTablePrivilegesView();
    testSyntaxErrors();
    testGrantAllPrivileges();

    printResults();
    return 0;
}
