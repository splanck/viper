// test_auth.zia — Tests for User Authentication (Phase 10)
// Part of ViperSQL
//
// Tests CREATE USER, DROP USER, ALTER USER, SHOW USERS,
// and sys.users system view.

module test_auth;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind String = Viper.String;

bind "../executor";
bind "../server";
bind "../result";
bind "../types";

//=============================================================================
// TEST HARNESS
//=============================================================================

var passed: Integer;
var failed: Integer;

func assert(cond: Boolean, msg: String) {
    if cond {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

func assertResult(result: QueryResult, msg: String) {
    assert(result.success, msg);
}

func assertError(result: QueryResult, msg: String) {
    assert(result.success == false, msg);
}

func assertMessage(result: QueryResult, expected: String, msg: String) {
    assert(result.message == expected, msg);
}

func assertRowCount(result: QueryResult, expected: Integer, msg: String) {
    assert(result.rows.count() == expected, msg);
}

//=============================================================================
// HELPER
//=============================================================================

func makeTestExecutor() -> Executor {
    var server = new DatabaseServer();
    server.init();
    var exec = new Executor();
    exec.initWithServer(server, 1);
    return exec;
}

//=============================================================================
// TESTS — CREATE USER
//=============================================================================

func testCreateUser() {
    Terminal.Say("Testing CREATE USER...");
    var exec = makeTestExecutor();

    // Default admin user should exist
    var r1 = exec.executeSql("SHOW USERS");
    assertResult(r1, "SHOW USERS succeeds");
    assert(r1.rows.count() >= 1, "At least 1 user (admin)");

    // Create a new user
    var r2 = exec.executeSql("CREATE USER testuser PASSWORD 'mypass123'");
    assertResult(r2, "CREATE USER succeeds");
    assertMessage(r2, "User 'testuser' created", "CREATE USER message correct");

    // Verify user appears in SHOW USERS
    var r3 = exec.executeSql("SHOW USERS");
    assertResult(r3, "SHOW USERS after create");
    assert(r3.rows.count() >= 2, "At least 2 users after create");

    // Duplicate user fails
    var r4 = exec.executeSql("CREATE USER testuser PASSWORD 'other'");
    assertError(r4, "Duplicate CREATE USER fails");

    // Create another user
    var r5 = exec.executeSql("CREATE USER readonly PASSWORD 'read'");
    assertResult(r5, "Create second user succeeds");
}

//=============================================================================
// TESTS — DROP USER
//=============================================================================

func testDropUser() {
    Terminal.Say("Testing DROP USER...");
    var exec = makeTestExecutor();

    // Create a user, then drop it
    exec.executeSql("CREATE USER tempuser PASSWORD 'temp'");
    var r1 = exec.executeSql("DROP USER tempuser");
    assertResult(r1, "DROP USER succeeds");
    assertMessage(r1, "User 'tempuser' dropped", "DROP USER message correct");

    // Verify user is gone
    var r2 = exec.executeSql("SHOW USERS");
    var found = false;
    var i = 0;
    while i < r2.rows.count() {
        if r2.rows.get(i).getValue(0).toString() == "tempuser" {
            found = true;
        }
        i = i + 1;
    }
    assert(found == false, "Dropped user not in SHOW USERS");

    // Drop non-existent user fails
    var r3 = exec.executeSql("DROP USER nonexistent");
    assertError(r3, "DROP non-existent user fails");

    // Cannot drop admin
    var r4 = exec.executeSql("DROP USER admin");
    assertError(r4, "Cannot drop admin user");
}

//=============================================================================
// TESTS — ALTER USER
//=============================================================================

func testAlterUser() {
    Terminal.Say("Testing ALTER USER...");
    var exec = makeTestExecutor();

    // Create a user
    exec.executeSql("CREATE USER alice PASSWORD 'oldpass'");

    // Change password
    var r1 = exec.executeSql("ALTER USER alice PASSWORD 'newpass'");
    assertResult(r1, "ALTER USER PASSWORD succeeds");
    assertMessage(r1, "User 'alice' updated", "ALTER USER message correct");

    // Verify password changed via server
    var canVerify = exec.server.verifyPassword("alice", "newpass");
    assert(canVerify, "New password works after ALTER USER");

    var oldFails = exec.server.verifyPassword("alice", "oldpass");
    assert(oldFails == false, "Old password fails after ALTER USER");

    // ALTER USER with SET keyword
    var r2 = exec.executeSql("ALTER USER alice SET PASSWORD 'finalpass'");
    assertResult(r2, "ALTER USER SET PASSWORD succeeds");
    var canVerify2 = exec.server.verifyPassword("alice", "finalpass");
    assert(canVerify2, "SET PASSWORD works");

    // ALTER non-existent user fails
    var r3 = exec.executeSql("ALTER USER nobody PASSWORD 'x'");
    assertError(r3, "ALTER non-existent user fails");
}

//=============================================================================
// TESTS — SHOW USERS
//=============================================================================

func testShowUsers() {
    Terminal.Say("Testing SHOW USERS...");
    var exec = makeTestExecutor();

    // Default: only admin
    var r1 = exec.executeSql("SHOW USERS");
    assertResult(r1, "SHOW USERS succeeds");
    assert(r1.columnNames.count() == 1, "SHOW USERS has 1 column");
    assert(r1.columnNames.get(0) == "username", "Column name is 'username'");
    assertRowCount(r1, 1, "Default: 1 user (admin)");
    assert(r1.rows.get(0).getValue(0).toString() == "admin", "First user is admin");

    // Add users and verify count
    exec.executeSql("CREATE USER user1 PASSWORD 'p1'");
    exec.executeSql("CREATE USER user2 PASSWORD 'p2'");
    exec.executeSql("CREATE USER user3 PASSWORD 'p3'");

    var r2 = exec.executeSql("SHOW USERS");
    assertRowCount(r2, 4, "4 users after creating 3");

    // Drop one and verify count
    exec.executeSql("DROP USER user2");
    var r3 = exec.executeSql("SHOW USERS");
    assertRowCount(r3, 3, "3 users after dropping 1");
}

//=============================================================================
// TESTS — sys.users system view
//=============================================================================

func testSysUsersView() {
    Terminal.Say("Testing sys.users system view...");
    var exec = makeTestExecutor();

    // Query sys.users
    var r1 = exec.executeSql("SELECT * FROM sys.users");
    assertResult(r1, "SELECT FROM sys.users succeeds");
    assert(r1.columnNames.count() == 2, "sys.users has 2 columns");
    assert(r1.columnNames.get(0) == "username", "First column is username");
    assert(r1.columnNames.get(1) == "is_superuser", "Second column is is_superuser");
    assertRowCount(r1, 1, "Default: 1 user in sys.users");
    assert(r1.rows.get(0).getValue(1).toString() == "YES", "admin is superuser");

    // Create non-admin user
    exec.executeSql("CREATE USER bob PASSWORD 'bob123'");
    var r2 = exec.executeSql("SELECT * FROM sys.users");
    assertRowCount(r2, 2, "2 users in sys.users after create");
}

//=============================================================================
// TESTS — Password verification via server
//=============================================================================

func testPasswordVerification() {
    Terminal.Say("Testing password verification...");
    var server = new DatabaseServer();
    server.init();

    // Default admin user
    assert(server.userExists("admin"), "admin exists");
    assert(server.verifyPassword("admin", "admin"), "admin password correct");
    assert(server.verifyPassword("admin", "wrong") == false, "admin wrong password fails");

    // Create user
    assert(server.createUser("test", "secret"), "Create user succeeds");
    assert(server.userExists("test"), "New user exists");
    assert(server.verifyPassword("test", "secret"), "New user password correct");
    assert(server.verifyPassword("test", "bad") == false, "New user wrong password fails");

    // Non-existent user
    assert(server.userExists("nobody") == false, "Non-existent user doesn't exist");
    assert(server.verifyPassword("nobody", "x") == false, "Non-existent user verify fails");

    // Change password
    assert(server.changePassword("test", "newsecret"), "Change password succeeds");
    assert(server.verifyPassword("test", "newsecret"), "New password works");
    assert(server.verifyPassword("test", "secret") == false, "Old password fails");

    // User count
    assert(server.userCount() == 2, "User count is 2");

    // Drop user
    assert(server.dropUser("test"), "Drop user succeeds");
    assert(server.userExists("test") == false, "Dropped user doesn't exist");
    assert(server.userCount() == 1, "User count is 1 after drop");

    // List users
    var users = server.listUsers();
    assert(users.count() == 1, "List has 1 user");
    assert(users.get(0) == "admin", "Remaining user is admin");
}

//=============================================================================
// TESTS — SQL syntax errors
//=============================================================================

func testSyntaxErrors() {
    Terminal.Say("Testing auth SQL syntax errors...");
    var exec = makeTestExecutor();

    // CREATE USER without password
    var r1 = exec.executeSql("CREATE USER nopass");
    assertError(r1, "CREATE USER without PASSWORD fails");

    // DROP USER without name
    var r2 = exec.executeSql("DROP USER");
    assertError(r2, "DROP USER without name fails");

    // ALTER USER without PASSWORD
    var r3 = exec.executeSql("ALTER USER admin");
    assertError(r3, "ALTER USER without PASSWORD fails");

    // ALTER USER with invalid syntax
    var r4 = exec.executeSql("ALTER USER admin RENAME 'x'");
    assertError(r4, "ALTER USER with invalid keyword fails");
}

//=============================================================================
// ENTRY POINT
//=============================================================================

func start() {
    Terminal.Say("=== Phase 10: User Authentication Tests ===");
    Terminal.Say("");

    passed = 0;
    failed = 0;

    testCreateUser();
    testDropUser();
    testAlterUser();
    testShowUsers();
    testSysUsersView();
    testPasswordVerification();
    testSyntaxErrors();

    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
    if failed == 0 {
        Terminal.Say("ALL TESTS PASSED");
    }
}
