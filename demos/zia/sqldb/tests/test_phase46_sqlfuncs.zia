// test_phase46_sqlfuncs.zia â€” Phase 46: SQL Standard Expressions
// Tests for EXTRACT, POSITION, SUBSTRING FROM/FOR, TRIM extended syntax.

module test_phase46_sqlfuncs;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// EXTRACT(field FROM source)
//=========================================================================

func testExtractYear() {
    section("EXTRACT YEAR");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dates_t (id INTEGER, dt TIMESTAMP)");
    exec.executeSql("INSERT INTO dates_t VALUES (1, TIMESTAMP('2024-06-15 14:30:00'))");

    var r1 = exec.executeSql("SELECT EXTRACT(YEAR FROM dt) FROM dates_t WHERE id = 1");
    assertSuccess(r1, "EXTRACT YEAR");
    assertEq(val(r1, 0, 0), "2024", "year is 2024");
}

func testExtractMonth() {
    section("EXTRACT MONTH");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dates_m (id INTEGER, dt TIMESTAMP)");
    exec.executeSql("INSERT INTO dates_m VALUES (1, TIMESTAMP('2024-06-15 14:30:00'))");

    var r1 = exec.executeSql("SELECT EXTRACT(MONTH FROM dt) FROM dates_m WHERE id = 1");
    assertSuccess(r1, "EXTRACT MONTH");
    assertEq(val(r1, 0, 0), "6", "month is 6");
}

func testExtractDay() {
    section("EXTRACT DAY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dates_d (id INTEGER, dt TIMESTAMP)");
    exec.executeSql("INSERT INTO dates_d VALUES (1, TIMESTAMP('2024-06-15 14:30:00'))");

    var r1 = exec.executeSql("SELECT EXTRACT(DAY FROM dt) FROM dates_d WHERE id = 1");
    assertSuccess(r1, "EXTRACT DAY");
    assertEq(val(r1, 0, 0), "15", "day is 15");
}

func testExtractHour() {
    section("EXTRACT HOUR");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dates_h (id INTEGER, dt TIMESTAMP)");
    exec.executeSql("INSERT INTO dates_h VALUES (1, TIMESTAMP('2024-06-15 14:30:00'))");

    var r1 = exec.executeSql("SELECT EXTRACT(HOUR FROM dt) FROM dates_h WHERE id = 1");
    assertSuccess(r1, "EXTRACT HOUR");
    assertEq(val(r1, 0, 0), "14", "hour is 14");
}

func testExtractMinute() {
    section("EXTRACT MINUTE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dates_mi (id INTEGER, dt TIMESTAMP)");
    exec.executeSql("INSERT INTO dates_mi VALUES (1, TIMESTAMP('2024-06-15 14:30:45'))");

    var r1 = exec.executeSql("SELECT EXTRACT(MINUTE FROM dt) FROM dates_mi WHERE id = 1");
    assertSuccess(r1, "EXTRACT MINUTE");
    assertEq(val(r1, 0, 0), "30", "minute is 30");
}

//=========================================================================
// POSITION(substr IN str)
//=========================================================================

func testPositionBasic() {
    section("POSITION basic");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT POSITION('world' IN 'hello world')");
    assertSuccess(r1, "POSITION");
    assertEq(val(r1, 0, 0), "7", "world at position 7");
}

func testPositionNotFound() {
    section("POSITION not found");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT POSITION('xyz' IN 'hello world')");
    assertSuccess(r1, "POSITION not found");
    assertEq(val(r1, 0, 0), "0", "not found returns 0");
}

func testPositionInTable() {
    section("POSITION in table");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE pos_t (id INTEGER, email TEXT)");
    exec.executeSql("INSERT INTO pos_t VALUES (1, 'user@example.com')");
    exec.executeSql("INSERT INTO pos_t VALUES (2, 'noemail')");

    var r1 = exec.executeSql("SELECT email, POSITION('@' IN email) FROM pos_t ORDER BY id");
    assertSuccess(r1, "POSITION in table");
    assertEq(val(r1, 0, 1), "5", "@ at position 5");
    assertEq(val(r1, 1, 1), "0", "no @ returns 0");
}

//=========================================================================
// SUBSTRING(str FROM pos FOR len)
//=========================================================================

func testSubstringFrom() {
    section("SUBSTRING FROM");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT SUBSTRING('hello world' FROM 7)");
    assertSuccess(r1, "SUBSTRING FROM");
    assertEq(val(r1, 0, 0), "world", "from 7 gives world");
}

func testSubstringFromFor() {
    section("SUBSTRING FROM FOR");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT SUBSTRING('hello world' FROM 1 FOR 5)");
    assertSuccess(r1, "SUBSTRING FROM FOR");
    assertEq(val(r1, 0, 0), "hello", "first 5 chars");
}

func testSubstringComma() {
    section("SUBSTRING comma syntax");

    var exec = new Executor();
    exec.init();

    // Traditional comma syntax should still work
    var r1 = exec.executeSql("SELECT SUBSTRING('hello world', 7, 5)");
    assertSuccess(r1, "SUBSTRING comma");
    assertEq(val(r1, 0, 0), "world", "substr with commas");
}

//=========================================================================
// TRIM extended syntax
//=========================================================================

func testTrimLeading() {
    section("TRIM LEADING");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT TRIM(LEADING 'x' FROM 'xxxhelloxxx')");
    assertSuccess(r1, "TRIM LEADING");
    assertEq(val(r1, 0, 0), "helloxxx", "leading x trimmed");
}

func testTrimTrailing() {
    section("TRIM TRAILING");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT TRIM(TRAILING 'x' FROM 'xxxhelloxxx')");
    assertSuccess(r1, "TRIM TRAILING");
    assertEq(val(r1, 0, 0), "xxxhello", "trailing x trimmed");
}

func testTrimBoth() {
    section("TRIM BOTH");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT TRIM(BOTH 'x' FROM 'xxxhelloxxx')");
    assertSuccess(r1, "TRIM BOTH");
    assertEq(val(r1, 0, 0), "hello", "both x trimmed");
}

func testTrimSimple() {
    section("TRIM simple");

    var exec = new Executor();
    exec.init();

    // Simple TRIM should still work (trim whitespace)
    var r1 = exec.executeSql("SELECT TRIM('  hello  ')");
    assertSuccess(r1, "TRIM simple");
    assertEq(val(r1, 0, 0), "hello", "whitespace trimmed");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 46: SQL Standard Expressions ===");

    testExtractYear();
    testExtractMonth();
    testExtractDay();
    testExtractHour();
    testExtractMinute();
    testPositionBasic();
    testPositionNotFound();
    testPositionInTable();
    testSubstringFrom();
    testSubstringFromFor();
    testSubstringComma();
    testTrimLeading();
    testTrimTrailing();
    testTrimBoth();
    testTrimSimple();

    printResults();
}
