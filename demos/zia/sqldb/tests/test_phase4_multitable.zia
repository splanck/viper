// test_phase4_multitable.zia — Phase 4: Multi-table UPDATE/DELETE Tests
// Tests for UPDATE...FROM and DELETE...USING

module test_phase4_multitable;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";

bind "../executor";
bind "../types";

func main() -> Integer {
    Terminal.Say("=== Phase 4: Multi-table UPDATE/DELETE Tests ===");

    var exec = new Executor();
    exec.init();

    //=========================================================================
    // Setup test data
    //=========================================================================
    assertSuccess(exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, price INTEGER, category TEXT)"), "create products");
    assertSuccess(exec.executeSql("INSERT INTO products VALUES (1, 'Widget', 100, 'A')"), "prod 1");
    assertSuccess(exec.executeSql("INSERT INTO products VALUES (2, 'Gadget', 200, 'B')"), "prod 2");
    assertSuccess(exec.executeSql("INSERT INTO products VALUES (3, 'Doohickey', 150, 'A')"), "prod 3");
    assertSuccess(exec.executeSql("INSERT INTO products VALUES (4, 'Thingamajig', 300, 'C')"), "prod 4");

    assertSuccess(exec.executeSql("CREATE TABLE price_updates (product_id INTEGER, new_price INTEGER)"), "create price_updates");
    assertSuccess(exec.executeSql("INSERT INTO price_updates VALUES (1, 120)"), "update 1");
    assertSuccess(exec.executeSql("INSERT INTO price_updates VALUES (3, 175)"), "update 2");

    //=========================================================================
    // Test 1: UPDATE...FROM basic
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- UPDATE...FROM ---");

    var r = exec.executeSql("UPDATE products SET price = pu.new_price FROM price_updates pu WHERE products.id = pu.product_id");
    assertSuccess(r, "UPDATE...FROM");
    assert(r.rowsAffected == 2, "2 rows updated: " + Fmt.Int(r.rowsAffected));

    r = exec.executeSql("SELECT price FROM products WHERE id = 1");
    assert(val(r, 0, 0) == "120", "Widget price updated to 120: " + val(r, 0, 0));

    r = exec.executeSql("SELECT price FROM products WHERE id = 3");
    assert(val(r, 0, 0) == "175", "Doohickey price updated to 175: " + val(r, 0, 0));

    // Unaffected rows unchanged
    r = exec.executeSql("SELECT price FROM products WHERE id = 2");
    assert(val(r, 0, 0) == "200", "Gadget price unchanged: " + val(r, 0, 0));

    r = exec.executeSql("SELECT price FROM products WHERE id = 4");
    assert(val(r, 0, 0) == "300", "Thingamajig price unchanged: " + val(r, 0, 0));

    //=========================================================================
    // Test 2: UPDATE...FROM with calculation
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- UPDATE...FROM with calculation ---");

    assertSuccess(exec.executeSql("CREATE TABLE discounts (category TEXT, discount INTEGER)"), "create discounts");
    assertSuccess(exec.executeSql("INSERT INTO discounts VALUES ('A', 10)"), "discount A");
    assertSuccess(exec.executeSql("INSERT INTO discounts VALUES ('B', 20)"), "discount B");

    r = exec.executeSql("UPDATE products SET price = products.price - d.discount FROM discounts d WHERE products.category = d.category");
    assertSuccess(r, "UPDATE...FROM with calculation");

    r = exec.executeSql("SELECT price FROM products WHERE id = 1");
    assert(val(r, 0, 0) == "110", "Widget: 120 - 10 = 110: " + val(r, 0, 0));

    r = exec.executeSql("SELECT price FROM products WHERE id = 2");
    assert(val(r, 0, 0) == "180", "Gadget: 200 - 20 = 180: " + val(r, 0, 0));

    r = exec.executeSql("SELECT price FROM products WHERE id = 3");
    assert(val(r, 0, 0) == "165", "Doohickey: 175 - 10 = 165: " + val(r, 0, 0));

    // Category C has no discount — should be unchanged
    r = exec.executeSql("SELECT price FROM products WHERE id = 4");
    assert(val(r, 0, 0) == "300", "Thingamajig unchanged (no discount): " + val(r, 0, 0));

    //=========================================================================
    // Test 3: UPDATE...FROM no matches
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- UPDATE...FROM no matches ---");

    assertSuccess(exec.executeSql("CREATE TABLE empty_updates (product_id INTEGER, new_price INTEGER)"), "create empty_updates");

    r = exec.executeSql("UPDATE products SET price = 999 FROM empty_updates eu WHERE products.id = eu.product_id");
    assertSuccess(r, "UPDATE...FROM no matches");
    assert(r.rowsAffected == 0, "0 rows updated with empty source");

    //=========================================================================
    // DELETE...USING
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- DELETE...USING ---");

    assertSuccess(exec.executeSql("CREATE TABLE orders (id INTEGER PRIMARY KEY, product_id INTEGER, qty INTEGER)"), "create orders");
    assertSuccess(exec.executeSql("INSERT INTO orders VALUES (1, 1, 5)"), "order 1");
    assertSuccess(exec.executeSql("INSERT INTO orders VALUES (2, 2, 3)"), "order 2");
    assertSuccess(exec.executeSql("INSERT INTO orders VALUES (3, 3, 7)"), "order 3");
    assertSuccess(exec.executeSql("INSERT INTO orders VALUES (4, 4, 2)"), "order 4");
    assertSuccess(exec.executeSql("INSERT INTO orders VALUES (5, 1, 1)"), "order 5");

    assertSuccess(exec.executeSql("CREATE TABLE discontinued (product_id INTEGER)"), "create discontinued");
    assertSuccess(exec.executeSql("INSERT INTO discontinued VALUES (2)"), "disc 1");
    assertSuccess(exec.executeSql("INSERT INTO discontinued VALUES (4)"), "disc 2");

    // Test 4: DELETE...USING basic
    r = exec.executeSql("DELETE FROM orders USING discontinued d WHERE orders.product_id = d.product_id");
    assertSuccess(r, "DELETE...USING");
    assert(r.rowsAffected == 2, "2 orders deleted: " + Fmt.Int(r.rowsAffected));

    r = exec.executeSql("SELECT COUNT(*) FROM orders");
    assert(val(r, 0, 0) == "3", "3 orders remain: " + val(r, 0, 0));

    r = exec.executeSql("SELECT id FROM orders ORDER BY id");
    assert(val(r, 0, 0) == "1", "order 1 remains");
    assert(val(r, 1, 0) == "3", "order 3 remains");
    assert(val(r, 2, 0) == "5", "order 5 remains");

    // Test 5: DELETE...USING no matches
    assertSuccess(exec.executeSql("CREATE TABLE no_match (product_id INTEGER)"), "create no_match");
    assertSuccess(exec.executeSql("INSERT INTO no_match VALUES (999)"), "no_match entry");

    r = exec.executeSql("DELETE FROM orders USING no_match nm WHERE orders.product_id = nm.product_id");
    assertSuccess(r, "DELETE...USING no matches");
    assert(r.rowsAffected == 0, "0 orders deleted with no match");

    r = exec.executeSql("SELECT COUNT(*) FROM orders");
    assert(val(r, 0, 0) == "3", "still 3 orders");

    // Test 6: DELETE...USING with FROM table name (no alias)
    assertSuccess(exec.executeSql("CREATE TABLE to_remove (product_id INTEGER)"), "create to_remove");
    assertSuccess(exec.executeSql("INSERT INTO to_remove VALUES (3)"), "to_remove entry");

    r = exec.executeSql("DELETE FROM orders USING to_remove WHERE orders.product_id = to_remove.product_id");
    assertSuccess(r, "DELETE...USING without alias");
    assert(r.rowsAffected == 1, "1 order deleted: " + Fmt.Int(r.rowsAffected));

    r = exec.executeSql("SELECT COUNT(*) FROM orders");
    assert(val(r, 0, 0) == "2", "2 orders remain: " + val(r, 0, 0));

    //=========================================================================
    // Test 7: UPDATE...FROM with CTE
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("--- UPDATE...FROM with CTE ---");

    assertSuccess(exec.executeSql("CREATE TABLE inventory (id INTEGER PRIMARY KEY, item TEXT, stock INTEGER)"), "create inventory");
    assertSuccess(exec.executeSql("INSERT INTO inventory VALUES (1, 'Apples', 50)"), "inv 1");
    assertSuccess(exec.executeSql("INSERT INTO inventory VALUES (2, 'Bananas', 30)"), "inv 2");
    assertSuccess(exec.executeSql("INSERT INTO inventory VALUES (3, 'Cherries', 20)"), "inv 3");

    assertSuccess(exec.executeSql("CREATE TABLE shipments (item_id INTEGER, quantity INTEGER)"), "create shipments");
    assertSuccess(exec.executeSql("INSERT INTO shipments VALUES (1, 10)"), "ship 1");
    assertSuccess(exec.executeSql("INSERT INTO shipments VALUES (2, 5)"), "ship 2");
    assertSuccess(exec.executeSql("INSERT INTO shipments VALUES (1, 15)"), "ship 3");

    // Use CTE to aggregate shipments, then update inventory
    r = exec.executeSql("WITH total_shipped AS (SELECT item_id, SUM(quantity) AS total FROM shipments GROUP BY item_id) UPDATE inventory SET stock = inventory.stock - ts.total FROM total_shipped ts WHERE inventory.id = ts.item_id");
    assertSuccess(r, "UPDATE...FROM with CTE");

    r = exec.executeSql("SELECT stock FROM inventory WHERE id = 1");
    assert(val(r, 0, 0) == "25", "Apples: 50 - 25 = 25: " + val(r, 0, 0));

    r = exec.executeSql("SELECT stock FROM inventory WHERE id = 2");
    assert(val(r, 0, 0) == "25", "Bananas: 30 - 5 = 25: " + val(r, 0, 0));

    r = exec.executeSql("SELECT stock FROM inventory WHERE id = 3");
    assert(val(r, 0, 0) == "20", "Cherries unchanged: " + val(r, 0, 0));

    //=========================================================================
    // Summary
    //=========================================================================
    printResults();
    return 0;
}
