// test_phase54_filter.zia â€” Phase 54: FILTER Clause for Aggregates
// Tests for aggregate FILTER (WHERE ...) clause.

module test_phase54_filter;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupData() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (id INTEGER, product TEXT, amount INTEGER, region TEXT)");
    exec.executeSql("INSERT INTO sales VALUES (1, 'Widget', 100, 'North')");
    exec.executeSql("INSERT INTO sales VALUES (2, 'Gadget', 200, 'South')");
    exec.executeSql("INSERT INTO sales VALUES (3, 'Widget', 150, 'North')");
    exec.executeSql("INSERT INTO sales VALUES (4, 'Gadget', 300, 'North')");
    exec.executeSql("INSERT INTO sales VALUES (5, 'Widget', 50, 'South')");
    exec.executeSql("INSERT INTO sales VALUES (6, 'Doohickey', 75, 'South')");
    return exec;
}

//=========================================================================
// COUNT with FILTER
//=========================================================================

func testCountFilter() {
    section("COUNT FILTER");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT COUNT(*) FILTER (WHERE region = 'North') FROM sales");
    assertSuccess(r1, "COUNT FILTER");
    assertEq(val(r1, 0, 0), "3", "3 North sales");

    var r2 = exec.executeSql("SELECT COUNT(*) FILTER (WHERE region = 'South') FROM sales");
    assertEq(val(r2, 0, 0), "3", "3 South sales");

    var r3 = exec.executeSql("SELECT COUNT(*) FILTER (WHERE product = 'Widget') FROM sales");
    assertEq(val(r3, 0, 0), "3", "3 Widget sales");
}

//=========================================================================
// SUM with FILTER
//=========================================================================

func testSumFilter() {
    section("SUM FILTER");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT SUM(amount) FILTER (WHERE region = 'North') FROM sales");
    assertSuccess(r1, "SUM FILTER");
    // North: 100 + 150 + 300 = 550
    assertEq(val(r1, 0, 0), "550", "North sum = 550");

    var r2 = exec.executeSql("SELECT SUM(amount) FILTER (WHERE region = 'South') FROM sales");
    // South: 200 + 50 + 75 = 325
    assertEq(val(r2, 0, 0), "325", "South sum = 325");
}

//=========================================================================
// AVG with FILTER
//=========================================================================

func testAvgFilter() {
    section("AVG FILTER");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT AVG(amount) FILTER (WHERE product = 'Widget') FROM sales");
    assertSuccess(r1, "AVG FILTER");
    // Widget amounts: 100, 150, 50 = avg 100
    assertEq(val(r1, 0, 0), "100", "Widget avg = 100");
}

//=========================================================================
// MIN/MAX with FILTER
//=========================================================================

func testMinMaxFilter() {
    section("MIN/MAX FILTER");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT MIN(amount) FILTER (WHERE region = 'North') FROM sales");
    assertSuccess(r1, "MIN FILTER");
    assertEq(val(r1, 0, 0), "100", "North min = 100");

    var r2 = exec.executeSql("SELECT MAX(amount) FILTER (WHERE region = 'North') FROM sales");
    assertEq(val(r2, 0, 0), "300", "North max = 300");
}

//=========================================================================
// Multiple aggregates with different filters
//=========================================================================

func testMultipleFilters() {
    section("Multiple filters");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT COUNT(*) FILTER (WHERE region = 'North'), COUNT(*) FILTER (WHERE region = 'South') FROM sales");
    assertSuccess(r1, "multiple filters");
    assertEq(val(r1, 0, 0), "3", "North count");
    assertEq(val(r1, 0, 1), "3", "South count");
}

//=========================================================================
// FILTER with GROUP BY
//=========================================================================

func testFilterGroupBy() {
    section("FILTER with GROUP BY");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT product, COUNT(*) FILTER (WHERE region = 'North') FROM sales GROUP BY product ORDER BY product");
    assertSuccess(r1, "FILTER GROUP BY");
    // Doohickey: 0 North, Gadget: 1 North, Widget: 2 North
    assertRowCount(r1, 3, "3 product groups");
    assertEq(val(r1, 0, 0), "Doohickey", "Doohickey");
    assertEq(val(r1, 0, 1), "0", "Doohickey 0 North");
    assertEq(val(r1, 1, 0), "Gadget", "Gadget");
    assertEq(val(r1, 1, 1), "1", "Gadget 1 North");
    assertEq(val(r1, 2, 0), "Widget", "Widget");
    assertEq(val(r1, 2, 1), "2", "Widget 2 North");
}

//=========================================================================
// Aggregate without FILTER alongside one with FILTER
//=========================================================================

func testMixedFilterNoFilter() {
    section("Mixed filter/no-filter");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT COUNT(*), COUNT(*) FILTER (WHERE amount > 100) FROM sales");
    assertSuccess(r1, "mixed filter");
    assertEq(val(r1, 0, 0), "6", "total count = 6");
    // amount > 100: 200, 150, 300 = 3
    assertEq(val(r1, 0, 1), "3", "filtered count = 3");
}

//=========================================================================
// FILTER with complex condition
//=========================================================================

func testComplexFilter() {
    section("Complex FILTER condition");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT SUM(amount) FILTER (WHERE region = 'North' AND product = 'Widget') FROM sales");
    assertSuccess(r1, "complex filter");
    // North + Widget: 100 + 150 = 250
    assertEq(val(r1, 0, 0), "250", "North Widget sum = 250");
}

//=========================================================================
// FILTER returning no matches
//=========================================================================

func testFilterNoMatch() {
    section("FILTER no matches");

    var exec = setupData();

    var r1 = exec.executeSql("SELECT COUNT(*) FILTER (WHERE region = 'East') FROM sales");
    assertSuccess(r1, "no match filter");
    assertEq(val(r1, 0, 0), "0", "0 East sales");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 54: FILTER Clause ===");

    testCountFilter();
    testSumFilter();
    testAvgFilter();
    testMinMaxFilter();
    testMultipleFilters();
    testFilterGroupBy();
    testMixedFilterNoFilter();
    testComplexFilter();
    testFilterNoMatch();

    printResults();
}
