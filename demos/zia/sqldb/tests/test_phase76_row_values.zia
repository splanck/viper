// test_phase76_row_values.zia — Phase 76: Row Value Constructors
// Tests: (a, b) comparisons, (a, b) IN ((x, y), ...), lexicographic ordering

module test_phase76_row_values;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// 1. Basic row value equality
//=========================================================================

func testRowValueEquality() {
    section("Row Value — equality comparisons");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t1 (a INTEGER, b INTEGER, c TEXT)");
    exec.executeSql("INSERT INTO t1 VALUES (1, 2, 'x')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 4, 'y')");
    exec.executeSql("INSERT INTO t1 VALUES (1, 4, 'z')");
    exec.executeSql("INSERT INTO t1 VALUES (3, 2, 'w')");

    // (a, b) = (1, 2) — should match one row
    var r = exec.executeSql("SELECT c FROM t1 WHERE (a, b) = (1, 2)");
    assertSuccess(r, "row value = filter");
    assertRowCount(r, 1, "row value = returns 1 row");
    assertEq(val(r, 0, 0), "x", "row value = correct row");

    // (a, b) = (3, 4) — should match one row
    r = exec.executeSql("SELECT c FROM t1 WHERE (a, b) = (3, 4)");
    assertSuccess(r, "row value = second");
    assertRowCount(r, 1, "row value = second returns 1");
    assertEq(val(r, 0, 0), "y", "row value = second correct");

    // (a, b) != (1, 2) — should match 3 rows
    r = exec.executeSql("SELECT c FROM t1 WHERE (a, b) <> (1, 2)");
    assertSuccess(r, "row value <> filter");
    assertRowCount(r, 3, "row value <> returns 3 rows");
}

//=========================================================================
// 2. Row value IN list
//=========================================================================

func testRowValueIn() {
    section("Row Value — IN list");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t2 (x INTEGER, y INTEGER, label TEXT)");
    exec.executeSql("INSERT INTO t2 VALUES (1, 1, 'a')");
    exec.executeSql("INSERT INTO t2 VALUES (1, 2, 'b')");
    exec.executeSql("INSERT INTO t2 VALUES (2, 1, 'c')");
    exec.executeSql("INSERT INTO t2 VALUES (2, 2, 'd')");
    exec.executeSql("INSERT INTO t2 VALUES (3, 3, 'e')");

    // (x, y) IN ((1, 2), (2, 1))
    var r = exec.executeSql("SELECT label FROM t2 WHERE (x, y) IN ((1, 2), (2, 1))");
    assertSuccess(r, "row value IN list");
    assertRowCount(r, 2, "row value IN returns 2 rows");
    assertEq(val(r, 0, 0), "b", "row value IN first match");
    assertEq(val(r, 1, 0), "c", "row value IN second match");

    // (x, y) IN ((3, 3)) — single tuple
    r = exec.executeSql("SELECT label FROM t2 WHERE (x, y) IN ((3, 3))");
    assertSuccess(r, "row value IN single tuple");
    assertRowCount(r, 1, "row value IN single returns 1");
    assertEq(val(r, 0, 0), "e", "row value IN single correct");

    // (x, y) IN ((9, 9)) — no match
    r = exec.executeSql("SELECT label FROM t2 WHERE (x, y) IN ((9, 9))");
    assertSuccess(r, "row value IN no match");
    assertRowCount(r, 0, "row value IN no match returns 0");
}

//=========================================================================
// 3. Row value lexicographic ordering
//=========================================================================

func testRowValueOrdering() {
    section("Row Value — lexicographic ordering");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t3 (a INTEGER, b INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO t3 VALUES (1, 1, 'p')");
    exec.executeSql("INSERT INTO t3 VALUES (1, 2, 'q')");
    exec.executeSql("INSERT INTO t3 VALUES (1, 3, 'r')");
    exec.executeSql("INSERT INTO t3 VALUES (2, 1, 's')");
    exec.executeSql("INSERT INTO t3 VALUES (2, 2, 't')");
    exec.executeSql("INSERT INTO t3 VALUES (3, 1, 'u')");

    // (a, b) < (2, 1) — lexicographic: (1,1), (1,2), (1,3)
    var r = exec.executeSql("SELECT name FROM t3 WHERE (a, b) < (2, 1)");
    assertSuccess(r, "row value < filter");
    assertRowCount(r, 3, "(a,b) < (2,1) returns 3 rows");

    // (a, b) <= (2, 1) — includes (2,1) itself: (1,1), (1,2), (1,3), (2,1)
    r = exec.executeSql("SELECT name FROM t3 WHERE (a, b) <= (2, 1)");
    assertSuccess(r, "row value <= filter");
    assertRowCount(r, 4, "(a,b) <= (2,1) returns 4 rows");

    // (a, b) > (2, 1) — (2,2), (3,1)
    r = exec.executeSql("SELECT name FROM t3 WHERE (a, b) > (2, 1)");
    assertSuccess(r, "row value > filter");
    assertRowCount(r, 2, "(a,b) > (2,1) returns 2 rows");

    // (a, b) >= (2, 1) — (2,1), (2,2), (3,1)
    r = exec.executeSql("SELECT name FROM t3 WHERE (a, b) >= (2, 1)");
    assertSuccess(r, "row value >= filter");
    assertRowCount(r, 3, "(a,b) >= (2,1) returns 3 rows");
}

//=========================================================================
// 4. Three-element row values
//=========================================================================

func testThreeElementRow() {
    section("Row Value — three elements");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t4 (a INTEGER, b INTEGER, c INTEGER)");
    exec.executeSql("INSERT INTO t4 VALUES (1, 2, 3)");
    exec.executeSql("INSERT INTO t4 VALUES (1, 2, 4)");
    exec.executeSql("INSERT INTO t4 VALUES (1, 3, 1)");
    exec.executeSql("INSERT INTO t4 VALUES (2, 1, 1)");

    // (a, b, c) = (1, 2, 3)
    var r = exec.executeSql("SELECT * FROM t4 WHERE (a, b, c) = (1, 2, 3)");
    assertSuccess(r, "3-element row = filter");
    assertRowCount(r, 1, "3-element row = returns 1 row");
    assertEq(val(r, 0, 2), "3", "3-element row = correct c");

    // (a, b, c) < (1, 3, 0) — (1,2,3) and (1,2,4) since (1,2) < (1,3) lexicographically
    r = exec.executeSql("SELECT * FROM t4 WHERE (a, b, c) < (1, 3, 0)");
    assertSuccess(r, "3-element row < filter");
    assertRowCount(r, 2, "(a,b,c) < (1,3,0) returns 2 rows");
}

//=========================================================================
// 5. Row value with expressions
//=========================================================================

func testRowValueExpressions() {
    section("Row Value — with expressions");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE t5 (a INTEGER, b INTEGER)");
    exec.executeSql("INSERT INTO t5 VALUES (1, 2)");
    exec.executeSql("INSERT INTO t5 VALUES (3, 4)");
    exec.executeSql("INSERT INTO t5 VALUES (5, 6)");

    // (a + 1, b) = (4, 4) — matches row (3, 4) since a+1=4
    var r = exec.executeSql("SELECT a, b FROM t5 WHERE (a + 1, b) = (4, 4)");
    assertSuccess(r, "row value with expression");
    assertRowCount(r, 1, "expr row value returns 1");
    assertEq(val(r, 0, 0), "3", "expr row value correct a");
}

//=========================================================================
// MAIN
//=========================================================================

func main() -> Integer {
    Terminal.Say("=== Phase 76: Row Value Constructors ===");

    testRowValueEquality();
    testRowValueIn();
    testRowValueOrdering();
    testThreeElementRow();
    testRowValueExpressions();

    printResults();
    return 0;
}
