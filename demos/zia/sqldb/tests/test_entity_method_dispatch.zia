// test_entity_method_dispatch.zia — Entity Field Method Dispatch Test
// Part of ViperSQL Test Suite
//
// Validates that calling methods on entity fields works correctly.
// Originally written to reproduce BUG-FE-007 where calling a method
// on an entity's field (e.g., engine.wal.isEnabled()) would fail.
//
// Dependencies: storage/wal.zia, types.zia, table.zia, schema.zia
// Related bugs: BUG-FE-007 (entity field method dispatch)

module test_entity_method_dispatch;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;
bind String = Viper.String;
bind IO = Viper.IO;

bind "./test_common";
bind "../storage/page";
bind "../storage/serializer";
bind "../storage/wal";
bind "../types";
bind "../table";
bind "../schema";

// Entity that has a WALManager field — same pattern as StorageEngine
entity TestEngine {
    expose WALManager wal;
    expose Boolean isPersistent;

    expose func init() {
        wal = new WALManager();
        wal.init();
        isPersistent = false;
    }

    expose func doInsert() -> Boolean {
        // This call on the entity field triggered BUG-FE-007
        if wal.isEnabled() {
            return true;
        } else {
            return false;
        }
    }
}

func testEntityFieldMethodCall() {
    section("Entity field method dispatch");

    var engine = new TestEngine();
    engine.init();

    // WAL is not enabled by default
    assertFalse(engine.doInsert(), "doInsert returns false when WAL disabled");
    assertFalse(engine.wal.isEnabled(), "WAL not enabled by default");
}

func main() -> Integer {
    Terminal.Say("=== Entity Field Method Dispatch Tests ===");

    testEntityFieldMethodCall();

    printResults();
    return 0;
}
