// test_phase36_arrays.zia â€” Phase 36: Array Type & Functions
// Tests for ARRAY constructor, array functions, and TYPEOF support.

module test_phase36_arrays;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// ARRAY constructor
//=========================================================================

func testArrayConstructor() {
    section("ARRAY constructor");

    var exec = new Executor();
    exec.init();

    // Basic integer array
    var r1 = exec.executeSql("SELECT ARRAY[1, 2, 3]");
    assertSuccess(r1, "ARRAY[1,2,3] succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "{1,2,3}", "integer array value");

    // Text array
    var r2 = exec.executeSql("SELECT ARRAY['hello', 'world']");
    assertSuccess(r2, "text array succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "{hello,world}", "text array value");

    // Empty array
    var r3 = exec.executeSql("SELECT ARRAY[]");
    assertSuccess(r3, "empty array succeeds");
    var v3 = val(r3, 0, 0);
    assertEq(v3, "{}", "empty array value");

    // Mixed types
    var r4 = exec.executeSql("SELECT ARRAY[1, 'two', 3]");
    assertSuccess(r4, "mixed array succeeds");
    var v4 = val(r4, 0, 0);
    assertEq(v4, "{1,two,3}", "mixed array value");

    // TYPEOF for arrays
    var r5 = exec.executeSql("SELECT TYPEOF(ARRAY[1, 2, 3])");
    assertSuccess(r5, "TYPEOF array succeeds");
    var v5 = val(r5, 0, 0);
    assertEq(v5, "array", "TYPEOF returns array");
}

//=========================================================================
// ARRAY_LENGTH
//=========================================================================

func testArrayLength() {
    section("ARRAY_LENGTH");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_LENGTH(ARRAY[10, 20, 30], 1)");
    assertSuccess(r1, "ARRAY_LENGTH succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "3", "length of 3-element array");

    var r2 = exec.executeSql("SELECT ARRAY_LENGTH(ARRAY[], 1)");
    assertSuccess(r2, "empty array length succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "0", "length of empty array");

    var r3 = exec.executeSql("SELECT ARRAY_LENGTH(ARRAY['a', 'b', 'c', 'd', 'e'], 1)");
    assertSuccess(r3, "5-element array length");
    var v3 = val(r3, 0, 0);
    assertEq(v3, "5", "length is 5");
}

//=========================================================================
// ARRAY_UPPER / ARRAY_LOWER
//=========================================================================

func testArrayBounds() {
    section("ARRAY_UPPER / ARRAY_LOWER");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_UPPER(ARRAY[10, 20, 30], 1)");
    assertSuccess(r1, "ARRAY_UPPER succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "3", "upper bound is 3");

    var r2 = exec.executeSql("SELECT ARRAY_LOWER(ARRAY[10, 20, 30], 1)");
    assertSuccess(r2, "ARRAY_LOWER succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "1", "lower bound is 1");
}

//=========================================================================
// ARRAY_TO_STRING
//=========================================================================

func testArrayToString() {
    section("ARRAY_TO_STRING");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_TO_STRING(ARRAY[1, 2, 3], ', ')");
    assertSuccess(r1, "ARRAY_TO_STRING succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "1, 2, 3", "joined with comma-space");

    var r2 = exec.executeSql("SELECT ARRAY_TO_STRING(ARRAY['a', 'b', 'c'], '-')");
    assertSuccess(r2, "ARRAY_TO_STRING text succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "a-b-c", "joined with dash");
}

//=========================================================================
// ARRAY_APPEND / ARRAY_PREPEND
//=========================================================================

func testArrayAppendPrepend() {
    section("ARRAY_APPEND / ARRAY_PREPEND");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_APPEND(ARRAY[1, 2], 3)");
    assertSuccess(r1, "ARRAY_APPEND succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "{1,2,3}", "appended 3");

    var r2 = exec.executeSql("SELECT ARRAY_PREPEND(0, ARRAY[1, 2])");
    assertSuccess(r2, "ARRAY_PREPEND succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "{0,1,2}", "prepended 0");
}

//=========================================================================
// ARRAY_CAT
//=========================================================================

func testArrayCat() {
    section("ARRAY_CAT");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_CAT(ARRAY[1, 2], ARRAY[3, 4])");
    assertSuccess(r1, "ARRAY_CAT succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "{1,2,3,4}", "concatenated arrays");
}

//=========================================================================
// ARRAY_REMOVE
//=========================================================================

func testArrayRemove() {
    section("ARRAY_REMOVE");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_REMOVE(ARRAY[1, 2, 3, 2], 2)");
    assertSuccess(r1, "ARRAY_REMOVE succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "{1,3}", "removed all 2s");
}

//=========================================================================
// ARRAY_POSITION
//=========================================================================

func testArrayPosition() {
    section("ARRAY_POSITION");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ARRAY_POSITION(ARRAY[10, 20, 30], 20)");
    assertSuccess(r1, "ARRAY_POSITION succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "2", "position of 20 is 2");

    var r2 = exec.executeSql("SELECT ARRAY_POSITION(ARRAY[10, 20, 30], 99)");
    assertSuccess(r2, "ARRAY_POSITION not found");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "NULL", "not found returns NULL");
}

//=========================================================================
// ARRAY in table columns
//=========================================================================

func testArrayInTable() {
    section("ARRAY in table columns");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE arr_test (id INTEGER, tags TEXT)");
    exec.executeSql("INSERT INTO arr_test VALUES (1, '{red,green,blue}')");
    exec.executeSql("INSERT INTO arr_test VALUES (2, '{alpha,beta}')");

    // Use array functions on text columns containing array format
    var r1 = exec.executeSql("SELECT id, ARRAY_LENGTH(tags, 1) FROM arr_test WHERE id = 1");
    assertSuccess(r1, "ARRAY_LENGTH on column succeeds");
    // The column value is text, not SQL_ARRAY, so ARRAY_LENGTH may not work directly
    // This tests the function's handling of text values that look like arrays
}

//=========================================================================
// Array with expressions
//=========================================================================

func testArrayWithExpressions() {
    section("ARRAY with expressions");

    var exec = new Executor();
    exec.init();

    // Array with arithmetic
    var r1 = exec.executeSql("SELECT ARRAY[1 + 1, 2 * 3, 10 - 3]");
    assertSuccess(r1, "ARRAY with expressions succeeds");
    var v1 = val(r1, 0, 0);
    assertEq(v1, "{2,6,7}", "expressions evaluated");

    // Array with string concatenation
    var r2 = exec.executeSql("SELECT ARRAY_LENGTH(ARRAY[1, 2, 3, 4, 5], 1)");
    assertSuccess(r2, "nested array function succeeds");
    var v2 = val(r2, 0, 0);
    assertEq(v2, "5", "nested length is 5");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 36: Array Type & Functions ===");

    testArrayConstructor();
    testArrayLength();
    testArrayBounds();
    testArrayToString();
    testArrayAppendPrepend();
    testArrayCat();
    testArrayRemove();
    testArrayPosition();
    testArrayInTable();
    testArrayWithExpressions();

    printResults();
}
