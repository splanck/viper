// test_phase45_alter_col.zia — Phase 45: ALTER TABLE Column Modifications
// Tests for ALTER COLUMN SET DEFAULT, DROP DEFAULT, SET NOT NULL, DROP NOT NULL, TYPE.

module test_phase45_alter_col;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// ALTER COLUMN SET DEFAULT
//=========================================================================

func testSetDefault() {
    section("ALTER COLUMN SET DEFAULT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE def_t (id INTEGER, name TEXT)");

    // Set default on column
    var r1 = exec.executeSql("ALTER TABLE def_t ALTER COLUMN name SET DEFAULT 'unnamed'");
    assertSuccess(r1, "SET DEFAULT");

    // Insert without name — should use default
    exec.executeSql("INSERT INTO def_t (id) VALUES (1)");
    var r2 = exec.executeSql("SELECT name FROM def_t WHERE id = 1");
    assertEq(val(r2, 0, 0), "unnamed", "default value used");
}

//=========================================================================
// ALTER COLUMN SET DEFAULT with integer
//=========================================================================

func testSetDefaultInt() {
    section("ALTER COLUMN SET DEFAULT integer");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dint_t (id INTEGER, score INTEGER)");

    exec.executeSql("ALTER TABLE dint_t ALTER COLUMN score SET DEFAULT 100");
    exec.executeSql("INSERT INTO dint_t (id) VALUES (1)");

    var r1 = exec.executeSql("SELECT score FROM dint_t WHERE id = 1");
    assertEq(val(r1, 0, 0), "100", "integer default");
}

//=========================================================================
// ALTER COLUMN DROP DEFAULT
//=========================================================================

func testDropDefault() {
    section("ALTER COLUMN DROP DEFAULT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dd_t (id INTEGER, val TEXT DEFAULT 'hello')");

    // Drop default
    var r1 = exec.executeSql("ALTER TABLE dd_t ALTER COLUMN val DROP DEFAULT");
    assertSuccess(r1, "DROP DEFAULT");

    // Insert without val — should be NULL now
    exec.executeSql("INSERT INTO dd_t (id) VALUES (1)");
    var r2 = exec.executeSql("SELECT val FROM dd_t WHERE id = 1");
    assertEq(val(r2, 0, 0), "NULL", "NULL after drop default");
}

//=========================================================================
// ALTER COLUMN SET NOT NULL
//=========================================================================

func testSetNotNull() {
    section("ALTER COLUMN SET NOT NULL");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nn_t (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO nn_t VALUES (1, 'alice')");

    // Set NOT NULL — should succeed (no NULLs in column)
    var r1 = exec.executeSql("ALTER TABLE nn_t ALTER COLUMN name SET NOT NULL");
    assertSuccess(r1, "SET NOT NULL");

    // Insert with NULL should now fail
    var r2 = exec.executeSql("INSERT INTO nn_t VALUES (2, NULL)");
    assertFailure(r2, "NULL rejected after SET NOT NULL");
}

//=========================================================================
// ALTER COLUMN SET NOT NULL fails with existing NULLs
//=========================================================================

func testSetNotNullFails() {
    section("SET NOT NULL with NULLs fails");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE nnf_t (id INTEGER, name TEXT)");
    exec.executeSql("INSERT INTO nnf_t VALUES (1, NULL)");

    var r1 = exec.executeSql("ALTER TABLE nnf_t ALTER COLUMN name SET NOT NULL");
    assertFailure(r1, "SET NOT NULL fails with existing NULLs");
}

//=========================================================================
// ALTER COLUMN DROP NOT NULL
//=========================================================================

func testDropNotNull() {
    section("ALTER COLUMN DROP NOT NULL");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dnn_t (id INTEGER, name TEXT NOT NULL)");
    exec.executeSql("INSERT INTO dnn_t VALUES (1, 'alice')");

    // Drop NOT NULL
    var r1 = exec.executeSql("ALTER TABLE dnn_t ALTER COLUMN name DROP NOT NULL");
    assertSuccess(r1, "DROP NOT NULL");

    // Insert with NULL should now succeed
    var r2 = exec.executeSql("INSERT INTO dnn_t VALUES (2, NULL)");
    assertSuccess(r2, "NULL accepted after DROP NOT NULL");
}

//=========================================================================
// ALTER COLUMN TYPE
//=========================================================================

func testAlterType() {
    section("ALTER COLUMN TYPE");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE type_t (id INTEGER, val TEXT)");

    var r1 = exec.executeSql("ALTER TABLE type_t ALTER COLUMN val TYPE INTEGER");
    assertSuccess(r1, "ALTER TYPE");

    // DESCRIBE should show new type
    var r2 = exec.executeSql("DESCRIBE type_t");
    assertSuccess(r2, "DESCRIBE after ALTER TYPE");
}

//=========================================================================
// ALTER COLUMN nonexistent column
//=========================================================================

func testAlterNonexistent() {
    section("ALTER nonexistent column");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE noex_t (id INTEGER)");

    var r1 = exec.executeSql("ALTER TABLE noex_t ALTER COLUMN no_such SET DEFAULT 0");
    assertFailure(r1, "nonexistent column fails");
}

//=========================================================================
// ALTER COLUMN without COLUMN keyword
//=========================================================================

func testAlterNoColumnKeyword() {
    section("ALTER without COLUMN keyword");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE ncol_t (id INTEGER, val TEXT)");

    // ALTER TABLE t ALTER val SET DEFAULT 'x' (no COLUMN keyword)
    var r1 = exec.executeSql("ALTER TABLE ncol_t ALTER val SET DEFAULT 'test'");
    assertSuccess(r1, "ALTER without COLUMN keyword");

    exec.executeSql("INSERT INTO ncol_t (id) VALUES (1)");
    var r2 = exec.executeSql("SELECT val FROM ncol_t WHERE id = 1");
    assertEq(val(r2, 0, 0), "test", "default applied");
}

//=========================================================================
// Multiple ALTER COLUMN operations
//=========================================================================

func testMultipleAlters() {
    section("Multiple ALTER operations");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE multi_t (id INTEGER, score INTEGER, label TEXT)");

    exec.executeSql("ALTER TABLE multi_t ALTER COLUMN score SET DEFAULT 50");
    exec.executeSql("ALTER TABLE multi_t ALTER COLUMN label SET DEFAULT 'n/a'");
    exec.executeSql("ALTER TABLE multi_t ALTER COLUMN score SET NOT NULL");

    // Insert with defaults
    exec.executeSql("INSERT INTO multi_t (id) VALUES (1)");
    var r1 = exec.executeSql("SELECT score, label FROM multi_t WHERE id = 1");
    assertEq(val(r1, 0, 0), "50", "score default 50");
    assertEq(val(r1, 0, 1), "n/a", "label default n/a");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 45: ALTER TABLE Column Modifications ===");

    testSetDefault();
    testSetDefaultInt();
    testDropDefault();
    testSetNotNull();
    testSetNotNullFails();
    testDropNotNull();
    testAlterType();
    testAlterNonexistent();
    testAlterNoColumnKeyword();
    testMultipleAlters();

    printResults();
}
