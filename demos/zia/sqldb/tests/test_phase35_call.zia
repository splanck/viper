// test_phase35_call.zia — Phase 35: DO Blocks & CALL
// Tests for CALL stored function execution.

module test_phase35_call;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// CALL basic
//=========================================================================

func testCallVoidFunction() {
    section("CALL void function");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE call_t (id INTEGER, name TEXT)");

    // Create a void function that inserts a row
    exec.executeSql("CREATE FUNCTION add_user(p_id INTEGER, p_name TEXT) RETURNS VOID AS 'INSERT INTO call_t VALUES ($1, $2)'");

    var r1 = exec.executeSql("CALL add_user(1, 'Alice')");
    assertSuccess(r1, "CALL void function succeeds");
    assertTrue(stringContains(r1.message, "CALL"), "CALL message");

    // Verify the row was inserted
    var r2 = exec.executeSql("SELECT * FROM call_t");
    assertEqInt(r2.rows.count(), 1, "One row inserted by CALL");
    assertEq(val(r2, 0, 1), "Alice", "Alice inserted");
}

func testCallReturningFunction() {
    section("CALL function returning rows");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE call_r (id INTEGER, name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO call_r VALUES (1, 'Alice', 80)");
    exec.executeSql("INSERT INTO call_r VALUES (2, 'Bob', 90)");
    exec.executeSql("INSERT INTO call_r VALUES (3, 'Carol', 70)");

    exec.executeSql("CREATE FUNCTION get_high_scores(min_score INTEGER) RETURNS TEXT AS 'SELECT * FROM call_r WHERE score >= $1 ORDER BY score DESC'");

    var r1 = exec.executeSql("CALL get_high_scores(80)");
    assertSuccess(r1, "CALL returning function succeeds");
    assertEqInt(r1.rows.count(), 2, "Returns 2 high-scoring rows");
}

func testCallMultipleArgs() {
    section("CALL with multiple arguments");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE call_multi (id INTEGER, val INTEGER)");

    exec.executeSql("CREATE FUNCTION add_range(start_val INTEGER, end_val INTEGER) RETURNS VOID AS 'INSERT INTO call_multi SELECT id, id * 10 FROM (SELECT 1 as id) WHERE $1 <= $2'");

    // Simple test — call function with params
    exec.executeSql("CREATE FUNCTION ins_one(p_id INTEGER, p_val INTEGER) RETURNS VOID AS 'INSERT INTO call_multi VALUES ($1, $2)'");

    exec.executeSql("CALL ins_one(1, 100)");
    exec.executeSql("CALL ins_one(2, 200)");
    exec.executeSql("CALL ins_one(3, 300)");

    var r1 = exec.executeSql("SELECT * FROM call_multi ORDER BY id");
    assertEqInt(r1.rows.count(), 3, "Three rows inserted via CALL");
    assertEq(val(r1, 0, 1), "100", "First val is 100");
    assertEq(val(r1, 2, 1), "300", "Third val is 300");
}

func testCallNoArgs() {
    section("CALL with no arguments");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE call_na (id INTEGER)");
    exec.executeSql("INSERT INTO call_na VALUES (1)");
    exec.executeSql("INSERT INTO call_na VALUES (2)");

    exec.executeSql("CREATE FUNCTION count_all() RETURNS INTEGER AS 'SELECT COUNT(*) as cnt FROM call_na'");

    var r1 = exec.executeSql("CALL count_all()");
    assertSuccess(r1, "CALL no-arg function succeeds");
    assertEqInt(r1.rows.count(), 1, "Returns 1 row");
    assertEq(val(r1, 0, 0), "2", "Count is 2");
}

func testCallNonexistent() {
    section("CALL nonexistent function");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("CALL nosuch_func()");
    assertTrue(r1.success == false, "CALL nonexistent function fails");
}

func testCallUpdateFunction() {
    section("CALL update function");

    var exec = new Executor();
    exec.init();
    exec.executeSql("CREATE TABLE call_upd (id INTEGER, status TEXT)");
    exec.executeSql("INSERT INTO call_upd VALUES (1, 'pending')");
    exec.executeSql("INSERT INTO call_upd VALUES (2, 'pending')");

    exec.executeSql("CREATE FUNCTION set_status(p_id INTEGER, p_status TEXT) RETURNS VOID AS 'UPDATE call_upd SET status = $2 WHERE id = $1'");

    exec.executeSql("CALL set_status(1, 'active')");

    var r1 = exec.executeSql("SELECT * FROM call_upd ORDER BY id");
    assertEq(val(r1, 0, 1), "active", "Row 1 updated to active");
    assertEq(val(r1, 1, 1), "pending", "Row 2 still pending");
}

func main() -> Integer {
    Terminal.Say("=== Phase 35: DO Blocks & CALL ===");

    testCallVoidFunction();
    testCallReturningFunction();
    testCallMultipleArgs();
    testCallNoArgs();
    testCallNonexistent();
    testCallUpdateFunction();

    printResults();
    return 0;
}
