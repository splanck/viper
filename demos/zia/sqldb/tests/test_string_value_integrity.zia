// test_string_value_integrity.zia â€” String Value Integrity Tests
// Part of ViperSQL Test Suite
//
// Verifies that string values in table rows are not corrupted by
// subsequent query operations. Originally written to reproduce BUG-002
// where SELECT/WHERE/ORDER BY operations could corrupt stored string data.
//
// Dependencies: executor.zia, types.zia
// Related bugs: BUG-002 (string value corruption after queries)

module test_string_value_integrity;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

// Verify that all 3 names are intact in the users table.
func verifyNames(exec: Executor, label: String) {
    var r = exec.executeSql("SELECT name FROM users ORDER BY id");
    assertSuccess(r, label + " query succeeds");
    assertRowCount(r, 3, label + " returns 3 rows");
    assertEq(val(r, 0, 0), "Alice", label + " row 0 = Alice");
    assertEq(val(r, 1, 0), "Bob", label + " row 1 = Bob");
    assertEq(val(r, 2, 0), "Charlie", label + " row 2 = Charlie");
}

func testIntegrityAfterQueries(exec: Executor) {
    section("String integrity after various queries");

    // Baseline: verify names after insert
    verifyNames(exec, "after INSERT");

    // After SELECT *
    exec.executeSql("SELECT * FROM users");
    verifyNames(exec, "after SELECT *");

    // After SELECT with WHERE
    exec.executeSql("SELECT * FROM users WHERE age > 25");
    verifyNames(exec, "after WHERE");

    // After SELECT with compound WHERE
    exec.executeSql("SELECT * FROM users WHERE age > 25 AND city = 'NYC'");
    verifyNames(exec, "after compound WHERE");

    // After SELECT * ORDER BY
    exec.executeSql("SELECT * FROM users ORDER BY age");
    verifyNames(exec, "after ORDER BY");

    // After SELECT specific columns
    exec.executeSql("SELECT name FROM users");
    verifyNames(exec, "after SELECT name");

    // After SELECT specific columns with WHERE
    exec.executeSql("SELECT name FROM users WHERE city = 'NYC'");
    verifyNames(exec, "after SELECT name WHERE");

    // After SELECT specific columns ORDER BY
    exec.executeSql("SELECT name, age FROM users ORDER BY age");
    verifyNames(exec, "after SELECT name,age ORDER BY");
}

func main() -> Integer {
    Terminal.Say("=== String Value Integrity Tests ===");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE users (id INTEGER, name TEXT, age INTEGER, city TEXT)");
    exec.executeSql("INSERT INTO users VALUES (1, 'Alice', 30, 'NYC')");
    exec.executeSql("INSERT INTO users VALUES (2, 'Bob', 25, 'LA')");
    exec.executeSql("INSERT INTO users VALUES (3, 'Charlie', 35, 'NYC')");

    testIntegrityAfterQueries(exec);

    printResults();
    return 0;
}
