// test_phase18_sequences.zia — Phase 18: Sequence Tests
// Tests for CREATE SEQUENCE, DROP SEQUENCE, ALTER SEQUENCE, SHOW SEQUENCES,
// NEXTVAL, CURRVAL, SETVAL functions, cycling, descending sequences,
// and sequence usage in INSERT statements.

module test_phase18_sequences;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";
bind "../sequence";

func main() -> Integer {
    Terminal.Say("=== Phase 18: Sequence Tests ===");

    //=========================================================================
    // 1. SEQUENCE ENTITY BASICS
    //=========================================================================
    section("Sequence Entity");

    // Test 1: Create a default sequence
    var seq = new Sequence();
    seq.initWithName("test_seq");
    assertEq(seq.name, "test_seq", "Sequence name = test_seq");
    assertEqInt(seq.startValue, 1, "Default start = 1");
    assertEqInt(seq.incrementBy, 1, "Default increment = 1");
    assertEqInt(seq.minValue, 1, "Default min = 1");
    assert(seq.cycle == false, "Default cycle = false");

    // Test 2: First NEXTVAL returns startValue
    var v1 = seq.nextVal();
    assertEqInt(v1, 1, "First nextVal = 1 (start)");

    // Test 3: Subsequent NEXTVAL increments
    var v2 = seq.nextVal();
    assertEqInt(v2, 2, "Second nextVal = 2");
    var v3 = seq.nextVal();
    assertEqInt(v3, 3, "Third nextVal = 3");

    // Test 4: CURRVAL returns current value
    var cv = seq.currVal();
    assertEqInt(cv, 3, "currVal = 3 (after 3 calls)");

    // Test 5: CURRVAL before first NEXTVAL returns error sentinel
    var seq2 = new Sequence();
    seq2.initWithName("s2");
    var cv2 = seq2.currVal();
    assert(cv2 <= 0 - 2147483646, "currVal before nextVal = error sentinel");

    // Test 6: SETVAL sets the value
    seq2.setVal(100, true);
    assertEqInt(seq2.currVal(), 100, "After setVal(100,true), currVal = 100");
    var v6 = seq2.nextVal();
    assertEqInt(v6, 101, "After setVal(100,true), nextVal = 101");

    // Test 7: SETVAL with isCalled=false
    seq2.setVal(50, false);
    var v7 = seq2.nextVal();
    assertEqInt(v7, 50, "After setVal(50,false), nextVal = 50 (returns the set value)");

    //=========================================================================
    // 2. SEQUENCE ENTITY — CUSTOM OPTIONS
    //=========================================================================
    section("Sequence Custom Options");

    // Test 8: Custom start, increment
    var seq3 = new Sequence();
    seq3.initFull("s3", 10, 5, 1, 100, false);
    var v8 = seq3.nextVal();
    assertEqInt(v8, 10, "Custom start=10: first nextVal = 10");
    var v9 = seq3.nextVal();
    assertEqInt(v9, 15, "Increment=5: second nextVal = 15");
    var v10 = seq3.nextVal();
    assertEqInt(v10, 20, "Third nextVal = 20");

    // Test 9: NO CYCLE — sequence exhaustion
    var seq4 = new Sequence();
    seq4.initFull("s4", 98, 1, 1, 100, false);
    assertEqInt(seq4.nextVal(), 98, "Start at 98");
    assertEqInt(seq4.nextVal(), 99, "99");
    assertEqInt(seq4.nextVal(), 100, "100 (max)");
    var exhausted = seq4.nextVal();
    assert(exhausted <= 0 - 2147483646, "NO CYCLE: exhausted returns sentinel");

    // Test 10: CYCLE — wraps around
    var seq5 = new Sequence();
    seq5.initFull("s5", 98, 1, 1, 100, true);
    assertEqInt(seq5.nextVal(), 98, "Cycle seq start at 98");
    assertEqInt(seq5.nextVal(), 99, "99");
    assertEqInt(seq5.nextVal(), 100, "100 (max)");
    assertEqInt(seq5.nextVal(), 1, "CYCLE: wraps to minValue=1");
    assertEqInt(seq5.nextVal(), 2, "Continues from 2");

    // Test 11: Descending sequence
    var seq6 = new Sequence();
    seq6.initFull("s6", 5, -1, 1, 10, false);
    assertEqInt(seq6.nextVal(), 5, "Desc start=5");
    assertEqInt(seq6.nextVal(), 4, "4");
    assertEqInt(seq6.nextVal(), 3, "3");
    assertEqInt(seq6.nextVal(), 2, "2");
    assertEqInt(seq6.nextVal(), 1, "1 (min)");
    var descExhausted = seq6.nextVal();
    assert(descExhausted <= 0 - 2147483646, "Desc NO CYCLE: exhausted");

    // Test 12: Descending with CYCLE
    var seq7 = new Sequence();
    seq7.initFull("s7", 3, -1, 1, 5, true);
    assertEqInt(seq7.nextVal(), 3, "Desc cycle start=3");
    assertEqInt(seq7.nextVal(), 2, "2");
    assertEqInt(seq7.nextVal(), 1, "1 (min)");
    assertEqInt(seq7.nextVal(), 5, "CYCLE: wraps to maxValue=5");
    assertEqInt(seq7.nextVal(), 4, "4");

    //=========================================================================
    // 3. SEQUENCE MANAGER
    //=========================================================================
    section("Sequence Manager");

    var mgr = new SequenceManager();
    mgr.init();
    assertEqInt(mgr.count(), 0, "Empty manager has 0 sequences");

    // Test 13: Add sequences
    var sa = new Sequence();
    sa.initWithName("alpha");
    var sb = new Sequence();
    sb.initWithName("beta");
    var err1 = mgr.addSequence(sa);
    assertEq(err1, "", "Add alpha: no error");
    var err2 = mgr.addSequence(sb);
    assertEq(err2, "", "Add beta: no error");
    assertEqInt(mgr.count(), 2, "Manager has 2 sequences");

    // Test 14: Duplicate detection
    var sa2 = new Sequence();
    sa2.initWithName("alpha");
    var errDup = mgr.addSequence(sa2);
    assert(errDup != "", "Duplicate alpha: error returned");

    // Test 15: Find sequence
    var found = mgr.findSequence("alpha");
    assert(found != null, "Find alpha: found");
    var notFound = mgr.findSequence("gamma");
    assert(notFound == null, "Find gamma: not found");

    // Test 16: Drop sequence
    var dropOk = mgr.dropSequence("beta");
    assert(dropOk == true, "Drop beta: success");
    assertEqInt(mgr.count(), 1, "Manager has 1 sequence after drop");
    var dropFail = mgr.dropSequence("beta");
    assert(dropFail == false, "Drop beta again: fails");

    //=========================================================================
    // 4. CREATE SEQUENCE SQL
    //=========================================================================
    section("CREATE SEQUENCE SQL");

    var exec = new Executor();
    exec.init();

    // Test 17: Basic CREATE SEQUENCE
    var r1 = exec.executeSql("CREATE SEQUENCE user_id_seq");
    assertSuccess(r1, "CREATE SEQUENCE user_id_seq");

    // Test 18: CREATE SEQUENCE with options
    var r2 = exec.executeSql("CREATE SEQUENCE order_seq START WITH 1000 INCREMENT BY 10");
    assertSuccess(r2, "CREATE SEQUENCE order_seq START WITH 1000 INCREMENT BY 10");

    // Test 19: Duplicate sequence error
    var r3 = exec.executeSql("CREATE SEQUENCE user_id_seq");
    assertFailure(r3, "Duplicate CREATE SEQUENCE fails");

    // Test 20: CREATE SEQUENCE with all options
    var r4 = exec.executeSql("CREATE SEQUENCE full_seq START 5 INCREMENT 2 MINVALUE 1 MAXVALUE 100 CYCLE");
    assertSuccess(r4, "CREATE SEQUENCE with all options");

    // Test 21: CREATE SEQUENCE with NO CYCLE
    var r5 = exec.executeSql("CREATE SEQUENCE nc_seq START 1 MAXVALUE 5 NO CYCLE");
    assertSuccess(r5, "CREATE SEQUENCE with NO CYCLE");

    //=========================================================================
    // 5. NEXTVAL / CURRVAL / SETVAL SQL FUNCTIONS
    //=========================================================================
    section("NEXTVAL / CURRVAL / SETVAL");

    // Test 22: NEXTVAL returns start value
    var r6 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertSuccess(r6, "SELECT NEXTVAL");
    assertEq(val(r6, 0, 0), "1", "NEXTVAL user_id_seq first call = 1");

    // Test 23: NEXTVAL increments
    var r7 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(r7, 0, 0), "2", "NEXTVAL user_id_seq second call = 2");

    // Test 24: CURRVAL returns current
    var r8 = exec.executeSql("SELECT CURRVAL('user_id_seq')");
    assertSuccess(r8, "SELECT CURRVAL");
    assertEq(val(r8, 0, 0), "2", "CURRVAL user_id_seq = 2");

    // Test 25: NEXTVAL with custom start
    var r9 = exec.executeSql("SELECT NEXTVAL('order_seq')");
    assertEq(val(r9, 0, 0), "1000", "NEXTVAL order_seq first = 1000");

    // Test 26: NEXTVAL with custom increment
    var r10 = exec.executeSql("SELECT NEXTVAL('order_seq')");
    assertEq(val(r10, 0, 0), "1010", "NEXTVAL order_seq second = 1010 (incr 10)");

    // Test 27: SETVAL
    var r11 = exec.executeSql("SELECT SETVAL('user_id_seq', 50)");
    assertSuccess(r11, "SELECT SETVAL");
    assertEq(val(r11, 0, 0), "50", "SETVAL returns 50");

    // Test 28: CURRVAL after SETVAL
    var r12 = exec.executeSql("SELECT CURRVAL('user_id_seq')");
    assertEq(val(r12, 0, 0), "50", "CURRVAL after SETVAL = 50");

    // Test 29: NEXTVAL after SETVAL
    var r13 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(r13, 0, 0), "51", "NEXTVAL after SETVAL(50) = 51");

    // Test 30: NEXTVAL for nonexistent sequence returns NULL
    var r14 = exec.executeSql("SELECT NEXTVAL('no_such_seq')");
    assertEq(val(r14, 0, 0), "NULL", "NEXTVAL nonexistent = NULL");

    //=========================================================================
    // 6. SEQUENCE WITH CYCLE
    //=========================================================================
    section("Sequence CYCLE");

    // full_seq: START 5, INCREMENT 2, MINVALUE 1, MAXVALUE 100, CYCLE
    var r15 = exec.executeSql("SELECT NEXTVAL('full_seq')");
    assertEq(val(r15, 0, 0), "5", "full_seq first = 5");
    var r16 = exec.executeSql("SELECT NEXTVAL('full_seq')");
    assertEq(val(r16, 0, 0), "7", "full_seq second = 7 (incr 2)");

    // Test exhaustion with NO CYCLE
    // nc_seq: START 1, MAXVALUE 5, NO CYCLE
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 1
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 2
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 3
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 4
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 5
    var rExhaust = exec.executeSql("SELECT NEXTVAL('nc_seq')");
    assertEq(val(rExhaust, 0, 0), "NULL", "NO CYCLE exhausted = NULL");

    //=========================================================================
    // 7. DROP SEQUENCE SQL
    //=========================================================================
    section("DROP SEQUENCE SQL");

    // Test: DROP SEQUENCE
    var rd1 = exec.executeSql("DROP SEQUENCE order_seq");
    assertSuccess(rd1, "DROP SEQUENCE order_seq");

    // Test: DROP nonexistent
    var rd2 = exec.executeSql("DROP SEQUENCE nonexistent");
    assertFailure(rd2, "DROP nonexistent SEQUENCE fails");

    // Test: NEXTVAL after drop returns NULL
    var rd3 = exec.executeSql("SELECT NEXTVAL('order_seq')");
    assertEq(val(rd3, 0, 0), "NULL", "NEXTVAL after drop = NULL");

    //=========================================================================
    // 8. ALTER SEQUENCE SQL
    //=========================================================================
    section("ALTER SEQUENCE SQL");

    // Alter nonexistent
    var ra1 = exec.executeSql("ALTER SEQUENCE no_seq RESTART");
    assertFailure(ra1, "ALTER nonexistent SEQUENCE fails");

    // ALTER SEQUENCE RESTART
    // user_id_seq is at 51 from earlier
    var ra2 = exec.executeSql("ALTER SEQUENCE user_id_seq RESTART");
    assertSuccess(ra2, "ALTER SEQUENCE RESTART");
    var ra3 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(ra3, 0, 0), "1", "RESTART: nextval = startValue = 1");

    // ALTER SEQUENCE RESTART WITH value
    var ra4 = exec.executeSql("ALTER SEQUENCE user_id_seq RESTART WITH 100");
    assertSuccess(ra4, "ALTER SEQUENCE RESTART WITH 100");
    var ra5 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(ra5, 0, 0), "100", "RESTART WITH 100: nextval = 100");

    // ALTER SEQUENCE INCREMENT BY
    var ra6 = exec.executeSql("ALTER SEQUENCE user_id_seq INCREMENT BY 5");
    assertSuccess(ra6, "ALTER SEQUENCE INCREMENT BY 5");
    var ra7 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(ra7, 0, 0), "105", "After INCREMENT BY 5: nextval = 105");

    // ALTER SEQUENCE CYCLE
    var ra8 = exec.executeSql("ALTER SEQUENCE nc_seq CYCLE");
    assertSuccess(ra8, "ALTER SEQUENCE CYCLE");
    // nc_seq was exhausted at MAXVALUE 5, now with CYCLE it should wrap
    var ra9 = exec.executeSql("ALTER SEQUENCE nc_seq RESTART WITH 4");
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 4
    exec.executeSql("SELECT NEXTVAL('nc_seq')");  // 5
    var ra10 = exec.executeSql("SELECT NEXTVAL('nc_seq')");
    assertEq(val(ra10, 0, 0), "1", "After ALTER CYCLE, wraps to 1");

    //=========================================================================
    // 9. SHOW SEQUENCES SQL
    //=========================================================================
    section("SHOW SEQUENCES SQL");

    var rs1 = exec.executeSql("SHOW SEQUENCES");
    assertSuccess(rs1, "SHOW SEQUENCES");
    // Should have user_id_seq, full_seq, nc_seq (order_seq was dropped)
    assertRowCount(rs1, 3, "3 sequences remain");

    //=========================================================================
    // 10. SEQUENCES IN INSERT STATEMENTS
    //=========================================================================
    section("Sequences in INSERT");

    exec.executeSql("CREATE TABLE items (id INTEGER, name TEXT)");
    exec.executeSql("CREATE SEQUENCE item_id_seq START WITH 100");

    // Test: Use NEXTVAL in INSERT
    var ri1 = exec.executeSql("INSERT INTO items VALUES (NEXTVAL('item_id_seq'), 'Widget')");
    assertSuccess(ri1, "INSERT with NEXTVAL");
    var ri2 = exec.executeSql("INSERT INTO items VALUES (NEXTVAL('item_id_seq'), 'Gadget')");
    assertSuccess(ri2, "INSERT with NEXTVAL 2");
    var ri3 = exec.executeSql("INSERT INTO items VALUES (NEXTVAL('item_id_seq'), 'Doohickey')");
    assertSuccess(ri3, "INSERT with NEXTVAL 3");

    // Verify IDs
    var rsel = exec.executeSql("SELECT id, name FROM items ORDER BY id");
    assertEq(val(rsel, 0, 0), "100", "First item id = 100");
    assertEq(val(rsel, 0, 1), "Widget", "First item name");
    assertEq(val(rsel, 1, 0), "101", "Second item id = 101");
    assertEq(val(rsel, 2, 0), "102", "Third item id = 102");

    //=========================================================================
    // 11. MULTIPLE SEQUENCES
    //=========================================================================
    section("Multiple Sequences");

    exec.executeSql("CREATE SEQUENCE seq_a START 1 INCREMENT 1");
    exec.executeSql("CREATE SEQUENCE seq_b START 1000 INCREMENT 100");

    // Interleaved use
    var ma1 = exec.executeSql("SELECT NEXTVAL('seq_a')");
    assertEq(val(ma1, 0, 0), "1", "seq_a first = 1");
    var mb1 = exec.executeSql("SELECT NEXTVAL('seq_b')");
    assertEq(val(mb1, 0, 0), "1000", "seq_b first = 1000");
    var ma2 = exec.executeSql("SELECT NEXTVAL('seq_a')");
    assertEq(val(ma2, 0, 0), "2", "seq_a second = 2");
    var mb2 = exec.executeSql("SELECT NEXTVAL('seq_b')");
    assertEq(val(mb2, 0, 0), "1100", "seq_b second = 1100");

    //=========================================================================
    // 12. SEQUENCES WITH TRANSACTIONS
    //=========================================================================
    section("Sequences with Transactions");

    exec.executeSql("CREATE SEQUENCE txn_seq START 1");
    exec.executeSql("CREATE TABLE txn_items (id INTEGER, val TEXT)");

    exec.executeSql("BEGIN");
    exec.executeSql("INSERT INTO txn_items VALUES (NEXTVAL('txn_seq'), 'a')");
    exec.executeSql("INSERT INTO txn_items VALUES (NEXTVAL('txn_seq'), 'b')");
    exec.executeSql("ROLLBACK");

    // After rollback, sequence should NOT roll back (per PostgreSQL behavior)
    // The row inserts are rolled back but sequence values are consumed
    var rtxn = exec.executeSql("SELECT NEXTVAL('txn_seq')");
    assertEq(val(rtxn, 0, 0), "3", "Sequence not rolled back: nextval = 3");

    // But the rows should be gone
    var rcount = exec.executeSql("SELECT COUNT(*) FROM txn_items");
    assertEq(val(rcount, 0, 0), "0", "Rows rolled back: count = 0");

    //=========================================================================
    // 13. DESCENDING SEQUENCE VIA SQL
    //=========================================================================
    section("Descending Sequence SQL");

    var rd4 = exec.executeSql("CREATE SEQUENCE countdown START WITH 10 INCREMENT BY -1 MINVALUE 1 MAXVALUE 10");
    assertSuccess(rd4, "CREATE descending SEQUENCE");

    var rdn1 = exec.executeSql("SELECT NEXTVAL('countdown')");
    assertEq(val(rdn1, 0, 0), "10", "Countdown first = 10");
    var rdn2 = exec.executeSql("SELECT NEXTVAL('countdown')");
    assertEq(val(rdn2, 0, 0), "9", "Countdown second = 9");
    var rdn3 = exec.executeSql("SELECT NEXTVAL('countdown')");
    assertEq(val(rdn3, 0, 0), "8", "Countdown third = 8");

    //=========================================================================
    // 14. NEXTVAL IN EXPRESSIONS
    //=========================================================================
    section("NEXTVAL in Expressions");

    exec.executeSql("CREATE SEQUENCE expr_seq START 10 INCREMENT 10");

    // NEXTVAL in arithmetic expression
    var re1 = exec.executeSql("SELECT NEXTVAL('expr_seq') + 5");
    assertEq(val(re1, 0, 0), "15", "NEXTVAL(10) + 5 = 15");

    // NEXTVAL in WHERE clause (as a function, gets evaluated)
    exec.executeSql("CREATE TABLE nums (n INTEGER)");
    exec.executeSql("INSERT INTO nums VALUES (20)");
    exec.executeSql("INSERT INTO nums VALUES (30)");
    exec.executeSql("INSERT INTO nums VALUES (40)");
    // expr_seq is at 10, next will be 20
    var re2 = exec.executeSql("SELECT n FROM nums WHERE n = NEXTVAL('expr_seq')");
    assertSuccess(re2, "NEXTVAL in WHERE");
    // Note: NEXTVAL was called once for the WHERE eval with n=20, returns 20
    assertEq(val(re2, 0, 0), "20", "WHERE n = NEXTVAL (20) matches row 20");

    //=========================================================================
    // 15. EDGE CASES
    //=========================================================================
    section("Edge Cases");

    // Sequence with increment > 1 approaching max
    exec.executeSql("CREATE SEQUENCE jump_seq START 7 INCREMENT 3 MAXVALUE 10 NO CYCLE");
    var ej1 = exec.executeSql("SELECT NEXTVAL('jump_seq')");
    assertEq(val(ej1, 0, 0), "7", "Jump seq first = 7");
    var ej2 = exec.executeSql("SELECT NEXTVAL('jump_seq')");
    assertEq(val(ej2, 0, 0), "10", "Jump seq second = 10 (7+3)");
    var ej3 = exec.executeSql("SELECT NEXTVAL('jump_seq')");
    assertEq(val(ej3, 0, 0), "NULL", "Jump seq exhausted (10+3 > 10)");

    // SETVAL via SQL
    exec.executeSql("SELECT SETVAL('user_id_seq', 999)");
    var es1 = exec.executeSql("SELECT CURRVAL('user_id_seq')");
    assertEq(val(es1, 0, 0), "999", "SETVAL to 999 via SQL, CURRVAL = 999");

    // SETVAL with 3rd arg (is_called = false)
    exec.executeSql("SELECT SETVAL('user_id_seq', 500, 0)");
    var es2 = exec.executeSql("SELECT NEXTVAL('user_id_seq')");
    assertEq(val(es2, 0, 0), "500", "SETVAL(500, false): nextval = 500");

    // =========================================================================

    printResults();
    return 0;
}
