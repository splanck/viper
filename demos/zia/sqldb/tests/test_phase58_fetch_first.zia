// test_phase58_fetch_first.zia — Phase 58: FETCH FIRST / OFFSET-FETCH syntax
// Tests for SQL-standard FETCH FIRST N ROWS ONLY and OFFSET N ROWS syntax.

module test_phase58_fetch_first;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Setup helper
//=========================================================================

func setupExec() -> Executor {
    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE items (id INTEGER, name TEXT, price INTEGER)");
    exec.executeSql("INSERT INTO items VALUES (1, 'Apple', 100)");
    exec.executeSql("INSERT INTO items VALUES (2, 'Banana', 50)");
    exec.executeSql("INSERT INTO items VALUES (3, 'Cherry', 200)");
    exec.executeSql("INSERT INTO items VALUES (4, 'Date', 150)");
    exec.executeSql("INSERT INTO items VALUES (5, 'Elderberry', 300)");
    exec.executeSql("INSERT INTO items VALUES (6, 'Fig', 75)");
    exec.executeSql("INSERT INTO items VALUES (7, 'Grape', 125)");

    return exec;
}

//=========================================================================
// FETCH FIRST N ROWS ONLY (basic)
//=========================================================================

func testFetchFirst() {
    section("FETCH FIRST N ROWS ONLY");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id FETCH FIRST 3 ROWS ONLY");
    assertSuccess(r1, "FETCH FIRST 3 ROWS ONLY");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "1", "row 0 id");
    assertEq(val(r1, 0, 1), "Apple", "row 0 name");
    assertEq(val(r1, 1, 0), "2", "row 1 id");
    assertEq(val(r1, 2, 0), "3", "row 2 id");
}

//=========================================================================
// FETCH NEXT N ROWS ONLY (synonym for FIRST)
//=========================================================================

func testFetchNext() {
    section("FETCH NEXT N ROWS ONLY");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id FETCH NEXT 2 ROWS ONLY");
    assertSuccess(r1, "FETCH NEXT 2 ROWS ONLY");
    assertRowCount(r1, 2, "2 rows");
    assertEq(val(r1, 0, 0), "1", "row 0 id");
    assertEq(val(r1, 1, 0), "2", "row 1 id");
}

//=========================================================================
// FETCH FIRST 1 ROW ONLY (singular ROW)
//=========================================================================

func testFetchSingleRow() {
    section("FETCH FIRST 1 ROW ONLY");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id FETCH FIRST 1 ROW ONLY");
    assertSuccess(r1, "FETCH FIRST 1 ROW ONLY");
    assertRowCount(r1, 1, "1 row");
    assertEq(val(r1, 0, 0), "1", "first row");
    assertEq(val(r1, 0, 1), "Apple", "Apple");
}

//=========================================================================
// OFFSET N ROWS FETCH FIRST M ROWS ONLY (combined)
//=========================================================================

func testOffsetFetch() {
    section("OFFSET N ROWS FETCH FIRST M ROWS ONLY");

    var exec = setupExec();

    // Skip 2, take 3 → rows 3,4,5
    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id OFFSET 2 ROWS FETCH FIRST 3 ROWS ONLY");
    assertSuccess(r1, "OFFSET 2 FETCH FIRST 3");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 0), "3", "row 0 = id 3");
    assertEq(val(r1, 0, 1), "Cherry", "Cherry");
    assertEq(val(r1, 1, 0), "4", "row 1 = id 4");
    assertEq(val(r1, 1, 1), "Date", "Date");
    assertEq(val(r1, 2, 0), "5", "row 2 = id 5");
    assertEq(val(r1, 2, 1), "Elderberry", "Elderberry");
}

//=========================================================================
// OFFSET N ROWS without FETCH (just skip)
//=========================================================================

func testOffsetOnly() {
    section("OFFSET N ROWS only");

    var exec = setupExec();

    // Skip first 5, get remaining 2
    var r1 = exec.executeSql("SELECT id, name FROM items ORDER BY id OFFSET 5 ROWS");
    assertSuccess(r1, "OFFSET 5 ROWS");
    assertRowCount(r1, 2, "2 rows remaining");
    assertEq(val(r1, 0, 0), "6", "row 0 = id 6");
    assertEq(val(r1, 0, 1), "Fig", "Fig");
    assertEq(val(r1, 1, 0), "7", "row 1 = id 7");
    assertEq(val(r1, 1, 1), "Grape", "Grape");
}

//=========================================================================
// FETCH FIRST with ORDER BY DESC
//=========================================================================

func testFetchWithOrderByDesc() {
    section("FETCH FIRST with ORDER BY DESC");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, name, price FROM items ORDER BY price DESC FETCH FIRST 3 ROWS ONLY");
    assertSuccess(r1, "ORDER BY DESC FETCH FIRST 3");
    assertRowCount(r1, 3, "3 rows");
    assertEq(val(r1, 0, 1), "Elderberry", "most expensive");
    assertEq(val(r1, 1, 1), "Cherry", "second");
    assertEq(val(r1, 2, 1), "Date", "third");
}

//=========================================================================
// FETCH FIRST with WHERE
//=========================================================================

func testFetchWithWhere() {
    section("FETCH FIRST with WHERE");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id, name FROM items WHERE price > 100 ORDER BY id FETCH FIRST 2 ROWS ONLY");
    assertSuccess(r1, "WHERE + FETCH FIRST 2");
    assertRowCount(r1, 2, "2 rows");
    // price > 100: Cherry(200), Date(150), Elderberry(300), Grape(125)
    assertEq(val(r1, 0, 0), "3", "Cherry id");
    assertEq(val(r1, 0, 1), "Cherry", "Cherry");
    assertEq(val(r1, 1, 0), "4", "Date id");
    assertEq(val(r1, 1, 1), "Date", "Date");
}

//=========================================================================
// FETCH FIRST larger than result set
//=========================================================================

func testFetchLargerThanResult() {
    section("FETCH FIRST larger than result set");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id FROM items FETCH FIRST 100 ROWS ONLY");
    assertSuccess(r1, "FETCH FIRST 100");
    assertRowCount(r1, 7, "only 7 rows exist");
}

//=========================================================================
// OFFSET beyond result set
//=========================================================================

func testOffsetBeyondResults() {
    section("OFFSET beyond result set");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id FROM items OFFSET 10 ROWS FETCH FIRST 5 ROWS ONLY");
    assertSuccess(r1, "OFFSET 10 FETCH FIRST 5");
    assertRowCount(r1, 0, "0 rows (offset beyond data)");
}

//=========================================================================
// OFFSET 0 (no skip)
//=========================================================================

func testOffsetZero() {
    section("OFFSET 0 ROWS");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id FROM items ORDER BY id OFFSET 0 ROWS FETCH FIRST 3 ROWS ONLY");
    assertSuccess(r1, "OFFSET 0 FETCH FIRST 3");
    assertRowCount(r1, 3, "3 rows from start");
    assertEq(val(r1, 0, 0), "1", "id 1");
    assertEq(val(r1, 1, 0), "2", "id 2");
    assertEq(val(r1, 2, 0), "3", "id 3");
}

//=========================================================================
// LIMIT syntax still works (regression check)
//=========================================================================

func testLimitStillWorks() {
    section("LIMIT syntax (regression)");

    var exec = setupExec();

    var r1 = exec.executeSql("SELECT id FROM items ORDER BY id LIMIT 3");
    assertSuccess(r1, "LIMIT 3");
    assertRowCount(r1, 3, "3 rows via LIMIT");
    assertEq(val(r1, 0, 0), "1", "id 1");
    assertEq(val(r1, 2, 0), "3", "id 3");

    var r2 = exec.executeSql("SELECT id FROM items ORDER BY id LIMIT 3 OFFSET 2");
    assertSuccess(r2, "LIMIT 3 OFFSET 2");
    assertRowCount(r2, 3, "3 rows via LIMIT OFFSET");
    assertEq(val(r2, 0, 0), "3", "id 3");
    assertEq(val(r2, 1, 0), "4", "id 4");
    assertEq(val(r2, 2, 0), "5", "id 5");
}

//=========================================================================
// FETCH FIRST with GROUP BY
//=========================================================================

func testFetchWithGroupBy() {
    section("FETCH FIRST with GROUP BY");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE sales (category TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO sales VALUES ('A', 100)");
    exec.executeSql("INSERT INTO sales VALUES ('B', 200)");
    exec.executeSql("INSERT INTO sales VALUES ('A', 150)");
    exec.executeSql("INSERT INTO sales VALUES ('C', 300)");
    exec.executeSql("INSERT INTO sales VALUES ('B', 250)");

    var r1 = exec.executeSql("SELECT category, SUM(amount) FROM sales GROUP BY category ORDER BY category FETCH FIRST 2 ROWS ONLY");
    assertSuccess(r1, "GROUP BY + FETCH FIRST 2");
    assertRowCount(r1, 2, "2 groups");
    assertEq(val(r1, 0, 0), "A", "group A");
    assertEq(val(r1, 0, 1), "250", "A sum");
    assertEq(val(r1, 1, 0), "B", "group B");
    assertEq(val(r1, 1, 1), "450", "B sum");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 58: FETCH FIRST / OFFSET-FETCH Syntax ===");

    testFetchFirst();
    testFetchNext();
    testFetchSingleRow();
    testOffsetFetch();
    testOffsetOnly();
    testFetchWithOrderByDesc();
    testFetchWithWhere();
    testFetchLargerThanResult();
    testOffsetBeyondResults();
    testOffsetZero();
    testLimitStillWorks();
    testFetchWithGroupBy();

    printResults();
}
