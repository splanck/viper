// test_phase5_hashjoin.zia — Phase 5: Hash Join Tests
// Tests for hash-based INNER JOIN optimization

module test_phase5_hashjoin;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "../executor";
bind "../types";

var passCount = 0;
var failCount = 0;

func assert(condition: Boolean, msg: String) {
    if condition {
        passCount = passCount + 1;
    } else {
        Terminal.Say("FAIL: " + msg);
        failCount = failCount + 1;
    }
}

func check(result: QueryResult, label: String) {
    if result.success == false {
        Terminal.Say("FAIL: " + label + " => " + result.message);
        failCount = failCount + 1;
    } else {
        passCount = passCount + 1;
    }
}

func val(result: QueryResult, row: Integer, col: Integer) -> String {
    var r = result.getRow(row);
    if r == null { return "NULL_ROW"; }
    var rr = r;
    return rr.getValue(col).toString();
}

func contains(s: String, sub: String) -> Boolean {
    var sLen = String.Length(s);
    var subLen = String.Length(sub);
    if subLen > sLen { return false; }
    var i = 0;
    while i <= sLen - subLen {
        if String.Substring(s, i, subLen) == sub {
            return true;
        }
        i = i + 1;
    }
    return false;
}

func main() {
    Terminal.Say("=== Phase 5: Hash Join Tests ===");

    var exec = new Executor();
    exec.init();

    //=========================================================================
    // Setup test data
    //=========================================================================
    Terminal.Say("--- Setup ---");

    check(exec.executeSql("CREATE TABLE departments (id INTEGER PRIMARY KEY, name TEXT, budget INTEGER)"), "create departments");
    check(exec.executeSql("INSERT INTO departments VALUES (1, 'Engineering', 500000)"), "dept 1");
    check(exec.executeSql("INSERT INTO departments VALUES (2, 'Marketing', 200000)"), "dept 2");
    check(exec.executeSql("INSERT INTO departments VALUES (3, 'Sales', 300000)"), "dept 3");
    check(exec.executeSql("INSERT INTO departments VALUES (4, 'HR', 150000)"), "dept 4");

    check(exec.executeSql("CREATE TABLE employees (id INTEGER PRIMARY KEY, name TEXT, dept_id INTEGER, salary INTEGER)"), "create employees");
    check(exec.executeSql("INSERT INTO employees VALUES (1, 'Alice', 1, 90000)"), "emp 1");
    check(exec.executeSql("INSERT INTO employees VALUES (2, 'Bob', 2, 70000)"), "emp 2");
    check(exec.executeSql("INSERT INTO employees VALUES (3, 'Carol', 1, 95000)"), "emp 3");
    check(exec.executeSql("INSERT INTO employees VALUES (4, 'Dave', 3, 65000)"), "emp 4");
    check(exec.executeSql("INSERT INTO employees VALUES (5, 'Eve', 2, 72000)"), "emp 5");
    check(exec.executeSql("INSERT INTO employees VALUES (6, 'Frank', 1, 88000)"), "emp 6");
    check(exec.executeSql("INSERT INTO employees VALUES (7, 'Grace', 3, 67000)"), "emp 7");
    check(exec.executeSql("INSERT INTO employees VALUES (8, 'Hank', 5, 60000)"), "emp 8 (no dept)");

    check(exec.executeSql("CREATE TABLE projects (id INTEGER PRIMARY KEY, name TEXT, dept_id INTEGER, lead_id INTEGER)"), "create projects");
    check(exec.executeSql("INSERT INTO projects VALUES (1, 'ProjectA', 1, 1)"), "proj 1");
    check(exec.executeSql("INSERT INTO projects VALUES (2, 'ProjectB', 2, 2)"), "proj 2");
    check(exec.executeSql("INSERT INTO projects VALUES (3, 'ProjectC', 1, 3)"), "proj 3");
    check(exec.executeSql("INSERT INTO projects VALUES (4, 'ProjectD', 3, 4)"), "proj 4");

    //=========================================================================
    // 1. Basic INNER JOIN (should use hash join)
    //=========================================================================
    Terminal.Say("--- Basic INNER JOIN ---");

    var r1 = exec.executeSql("SELECT e.name, d.name FROM employees e INNER JOIN departments d ON e.dept_id = d.id");
    check(r1, "inner join");
    // Employee 8 (dept_id=5) should NOT appear (no matching department)
    assert(r1.rowCount() == 7, "should get 7 rows (employee 8 excluded), got " + Fmt.Int(r1.rowCount()));

    // Verify Alice is in Engineering
    var foundAliceEng = false;
    var i = 0;
    while i < r1.rowCount() {
        if val(r1, i, 0) == "Alice" && val(r1, i, 1) == "Engineering" {
            foundAliceEng = true;
        }
        i = i + 1;
    }
    assert(foundAliceEng, "Alice should be in Engineering");

    //=========================================================================
    // 2. INNER JOIN with WHERE clause
    //=========================================================================
    Terminal.Say("--- INNER JOIN with WHERE ---");

    var r2 = exec.executeSql("SELECT e.name, d.name, e.salary FROM employees e INNER JOIN departments d ON e.dept_id = d.id WHERE e.salary > 80000");
    check(r2, "inner join with where");
    // Alice=90000, Carol=95000, Frank=88000 — all in Engineering
    assert(r2.rowCount() == 3, "should get 3 high-salary employees, got " + Fmt.Int(r2.rowCount()));

    //=========================================================================
    // 3. INNER JOIN with aggregates
    //=========================================================================
    Terminal.Say("--- INNER JOIN with Aggregates ---");

    var r3 = exec.executeSql("SELECT d.name, COUNT(*), SUM(e.salary) FROM employees e INNER JOIN departments d ON e.dept_id = d.id GROUP BY d.name");
    check(r3, "inner join with group by");
    assert(r3.rowCount() >= 3, "should have at least 3 departments, got " + Fmt.Int(r3.rowCount()));

    // Find Engineering: 3 employees, total = 90000+95000+88000 = 273000
    var foundEng = false;
    i = 0;
    while i < r3.rowCount() {
        if val(r3, i, 0) == "Engineering" {
            foundEng = true;
            assert(val(r3, i, 1) == "3", "Engineering should have 3 employees, got " + val(r3, i, 1));
            assert(val(r3, i, 2) == "273000", "Engineering total = 273000, got " + val(r3, i, 2));
        }
        i = i + 1;
    }
    assert(foundEng, "should find Engineering department");

    //=========================================================================
    // 4. LEFT JOIN still works (not hash join)
    //=========================================================================
    Terminal.Say("--- LEFT JOIN (nested loop) ---");

    var r4 = exec.executeSql("SELECT e.name, d.name FROM employees e LEFT JOIN departments d ON e.dept_id = d.id");
    check(r4, "left join");
    // All 8 employees should appear, employee 8 with NULL department
    assert(r4.rowCount() == 8, "left join should get 8 rows, got " + Fmt.Int(r4.rowCount()));

    // Employee 8 (Hank) should have NULL department
    var foundHankNull = false;
    i = 0;
    while i < r4.rowCount() {
        if val(r4, i, 0) == "Hank" {
            if val(r4, i, 1) == "NULL" {
                foundHankNull = true;
            }
        }
        i = i + 1;
    }
    assert(foundHankNull, "Hank should have NULL department in LEFT JOIN");

    //=========================================================================
    // 5. RIGHT JOIN still works
    //=========================================================================
    Terminal.Say("--- RIGHT JOIN (nested loop) ---");

    var r5 = exec.executeSql("SELECT e.name, d.name FROM employees e RIGHT JOIN departments d ON e.dept_id = d.id");
    check(r5, "right join");
    // HR has no employees, so should have NULL employee name
    var foundHRNull = false;
    i = 0;
    while i < r5.rowCount() {
        if val(r5, i, 1) == "HR" && val(r5, i, 0) == "NULL" {
            foundHRNull = true;
        }
        i = i + 1;
    }
    assert(foundHRNull, "HR should have NULL employee in RIGHT JOIN");

    //=========================================================================
    // 6. Hash join correctness with larger data
    //=========================================================================
    Terminal.Say("--- Large Data Hash Join ---");

    check(exec.executeSql("CREATE TABLE big_left (id INTEGER PRIMARY KEY, key_col INTEGER, val TEXT)"), "create big_left");
    check(exec.executeSql("CREATE TABLE big_right (id INTEGER PRIMARY KEY, key_col INTEGER, info TEXT)"), "create big_right");

    i = 1;
    while i <= 50 {
        check(exec.executeSql("INSERT INTO big_left VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i % 10) + ", 'L" + Fmt.Int(i) + "')"), "big_left " + Fmt.Int(i));
        i = i + 1;
    }
    i = 1;
    while i <= 20 {
        check(exec.executeSql("INSERT INTO big_right VALUES (" + Fmt.Int(i) + ", " + Fmt.Int(i % 10) + ", 'R" + Fmt.Int(i) + "')"), "big_right " + Fmt.Int(i));
        i = i + 1;
    }

    var r6 = exec.executeSql("SELECT COUNT(*) FROM big_left l INNER JOIN big_right r ON l.key_col = r.key_col");
    check(r6, "large hash join count");
    // Each left row (50 rows, keys 0-9, 5 per key) matches each right row (20 rows, keys 0-9, 2 per key)
    // Per key: 5 left * 2 right = 10 matches. 10 keys * 10 matches = 100
    var joinCount = val(r6, 0, 0);
    assert(joinCount == "100", "50x20 hash join should produce 100 rows, got " + joinCount);

    //=========================================================================
    // 7. Hash join with no matches
    //=========================================================================
    Terminal.Say("--- No Matches ---");

    check(exec.executeSql("CREATE TABLE t1 (id INTEGER PRIMARY KEY, key_col INTEGER)"), "create t1");
    check(exec.executeSql("CREATE TABLE t2 (id INTEGER PRIMARY KEY, key_col INTEGER)"), "create t2");
    check(exec.executeSql("INSERT INTO t1 VALUES (1, 100)"), "t1 row 1");
    check(exec.executeSql("INSERT INTO t2 VALUES (1, 200)"), "t2 row 1");

    var r7 = exec.executeSql("SELECT * FROM t1 INNER JOIN t2 ON t1.key_col = t2.key_col");
    check(r7, "no match join");
    assert(r7.rowCount() == 0, "should get 0 rows when no match, got " + Fmt.Int(r7.rowCount()));

    //=========================================================================
    // 8. Hash join with duplicate keys
    //=========================================================================
    Terminal.Say("--- Duplicate Keys ---");

    check(exec.executeSql("CREATE TABLE dup_left (id INTEGER PRIMARY KEY, k INTEGER)"), "create dup_left");
    check(exec.executeSql("CREATE TABLE dup_right (id INTEGER PRIMARY KEY, k INTEGER)"), "create dup_right");
    check(exec.executeSql("INSERT INTO dup_left VALUES (1, 10)"), "dup_l 1");
    check(exec.executeSql("INSERT INTO dup_left VALUES (2, 10)"), "dup_l 2");
    check(exec.executeSql("INSERT INTO dup_left VALUES (3, 10)"), "dup_l 3");
    check(exec.executeSql("INSERT INTO dup_right VALUES (1, 10)"), "dup_r 1");
    check(exec.executeSql("INSERT INTO dup_right VALUES (2, 10)"), "dup_r 2");

    var r8 = exec.executeSql("SELECT * FROM dup_left INNER JOIN dup_right ON dup_left.k = dup_right.k");
    check(r8, "dup key join");
    assert(r8.rowCount() == 6, "3 left * 2 right = 6 rows, got " + Fmt.Int(r8.rowCount()));

    //=========================================================================
    // 9. INNER JOIN with ORDER BY
    //=========================================================================
    Terminal.Say("--- INNER JOIN with ORDER BY ---");

    var r9 = exec.executeSql("SELECT e.name, e.salary FROM employees e INNER JOIN departments d ON e.dept_id = d.id ORDER BY e.salary DESC");
    check(r9, "join with order by");
    assert(r9.rowCount() == 7, "ordered join should get 7 rows");
    // First row should be highest salary (Carol=95000)
    assert(val(r9, 0, 0) == "Carol", "highest salary is Carol, got " + val(r9, 0, 0));
    assert(val(r9, 0, 1) == "95000", "Carol's salary = 95000, got " + val(r9, 0, 1));

    //=========================================================================
    // 10. EXPLAIN shows join info
    //=========================================================================
    Terminal.Say("--- EXPLAIN Join ---");

    var r10 = exec.executeSql("EXPLAIN SELECT * FROM employees e INNER JOIN departments d ON e.dept_id = d.id");
    check(r10, "explain join");
    assert(r10.rowCount() > 0, "explain should have output");

    //=========================================================================
    // Summary
    //=========================================================================
    Terminal.Say("");
    Terminal.Say("=== Phase 5 Hash Join: " + Fmt.Int(passCount) + " passed, " + Fmt.Int(failCount) + " failed ===");
}
