// test_phase39_ctas.zia — Phase 39: CREATE TABLE AS SELECT
// Tests for CTAS (Create Table As Select) and SELECT INTO.

module test_phase39_ctas;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// CREATE TABLE AS SELECT — basic
//=========================================================================

func testCtasBasic() {
    section("CREATE TABLE AS SELECT — basic");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE source (id INTEGER, name TEXT, score INTEGER)");
    exec.executeSql("INSERT INTO source VALUES (1, 'Alice', 90)");
    exec.executeSql("INSERT INTO source VALUES (2, 'Bob', 80)");
    exec.executeSql("INSERT INTO source VALUES (3, 'Charlie', 95)");

    // Basic CTAS
    var r1 = exec.executeSql("CREATE TABLE high_scores AS SELECT name, score FROM source WHERE score >= 85");
    assertSuccess(r1, "CTAS succeeds");
    assertTrue(stringContains(r1.message, "2"), "created with 2 rows");

    // Query the new table
    var r2 = exec.executeSql("SELECT name, score FROM high_scores ORDER BY name");
    assertSuccess(r2, "SELECT from CTAS table");
    assertEqInt(r2.rows.count(), 2, "2 rows in new table");
    assertEq(val(r2, 0, 0), "Alice", "first row name");
    assertEq(val(r2, 0, 1), "90", "first row score");
    assertEq(val(r2, 1, 0), "Charlie", "second row name");

    // New table is independent of source
    exec.executeSql("INSERT INTO source VALUES (4, 'Diana', 99)");
    var r3 = exec.executeSql("SELECT COUNT(*) FROM high_scores");
    assertEq(val(r3, 0, 0), "2", "CTAS table is independent snapshot");
}

//=========================================================================
// CTAS with aggregation
//=========================================================================

func testCtasAggregation() {
    section("CTAS with aggregation");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE orders (region TEXT, amount INTEGER)");
    exec.executeSql("INSERT INTO orders VALUES ('North', 100)");
    exec.executeSql("INSERT INTO orders VALUES ('North', 200)");
    exec.executeSql("INSERT INTO orders VALUES ('South', 150)");

    var r1 = exec.executeSql("CREATE TABLE region_summary AS SELECT region, SUM(amount), COUNT(*) FROM orders GROUP BY region ORDER BY region");
    assertSuccess(r1, "CTAS with GROUP BY");

    var r2 = exec.executeSql("SELECT * FROM region_summary ORDER BY region");
    assertSuccess(r2, "query CTAS with aggregation");
    assertEqInt(r2.rows.count(), 2, "2 regions");
    assertEq(val(r2, 0, 0), "North", "first region");
    assertEq(val(r2, 0, 1), "300", "north total");
}

//=========================================================================
// CTAS with all rows
//=========================================================================

func testCtasAllRows() {
    section("CTAS with all rows");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE original (x INTEGER, y TEXT)");
    exec.executeSql("INSERT INTO original VALUES (1, 'a')");
    exec.executeSql("INSERT INTO original VALUES (2, 'b')");
    exec.executeSql("INSERT INTO original VALUES (3, 'c')");

    // Copy all rows
    var r1 = exec.executeSql("CREATE TABLE copy_t AS SELECT * FROM original");
    assertSuccess(r1, "CTAS SELECT * succeeds");

    var r2 = exec.executeSql("SELECT COUNT(*) FROM copy_t");
    assertEq(val(r2, 0, 0), "3", "all 3 rows copied");

    // Modify original and verify independence
    exec.executeSql("DELETE FROM original WHERE x = 1");
    var r3 = exec.executeSql("SELECT COUNT(*) FROM copy_t");
    assertEq(val(r3, 0, 0), "3", "copy still has 3 rows");
}

//=========================================================================
// CREATE TEMPORARY TABLE AS SELECT
//=========================================================================

func testCtasTemporary() {
    section("CREATE TEMPORARY TABLE AS SELECT");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE base_t (id INTEGER, val TEXT)");
    exec.executeSql("INSERT INTO base_t VALUES (1, 'hello')");
    exec.executeSql("INSERT INTO base_t VALUES (2, 'world')");

    var r1 = exec.executeSql("CREATE TEMPORARY TABLE temp_copy AS SELECT * FROM base_t");
    assertSuccess(r1, "CREATE TEMP TABLE AS succeeds");

    var r2 = exec.executeSql("SELECT COUNT(*) FROM temp_copy");
    assertEq(val(r2, 0, 0), "2", "temp table has 2 rows");
}

//=========================================================================
// CTAS error handling
//=========================================================================

func testCtasErrors() {
    section("CTAS error handling");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE existing_t (id INTEGER)");

    // Table already exists
    var r1 = exec.executeSql("CREATE TABLE existing_t AS SELECT 1");
    assertFailure(r1, "CTAS fails for existing table");
    assertTrue(stringContains(r1.message, "already exists"), "already exists error");

    // Invalid query
    var r2 = exec.executeSql("CREATE TABLE bad_ctas AS SELECT * FROM nonexistent_table");
    assertFailure(r2, "CTAS with bad query fails");
}

//=========================================================================
// Normal CREATE TABLE still works
//=========================================================================

func testNormalCreateTableStillWorks() {
    section("Normal CREATE TABLE still works");

    var exec = new Executor();
    exec.init();

    // Normal CREATE TABLE should still work
    var r1 = exec.executeSql("CREATE TABLE normal_t (id INTEGER PRIMARY KEY, name TEXT NOT NULL)");
    assertSuccess(r1, "normal CREATE TABLE works");

    exec.executeSql("INSERT INTO normal_t VALUES (1, 'test')");
    var r2 = exec.executeSql("SELECT * FROM normal_t");
    assertSuccess(r2, "query normal table");
    assertEq(val(r2, 0, 1), "test", "data intact");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 39: CTAS & Table Utilities ===");

    testCtasBasic();
    testCtasAggregation();
    testCtasAllRows();
    testCtasTemporary();
    testCtasErrors();
    testNormalCreateTableStillWorks();

    printResults();
}
