// test_phase67_introspection.zia — Phase 67: SHOW INDEXES, SHOW COLUMNS, CREATE TABLE LIKE
// Schema introspection and table cloning features.

module test_phase67_introspection;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// SHOW INDEXES — all indexes
//=========================================================================

func testShowIndexesAll() {
    section("SHOW INDEXES (all)");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT, email TEXT)");
    exec.executeSql("CREATE INDEX idx_name ON users (name)");
    exec.executeSql("CREATE UNIQUE INDEX idx_email ON users (email)");
    exec.executeSql("CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, amount INTEGER)");
    exec.executeSql("CREATE INDEX idx_user_id ON orders (user_id)");

    var r1 = exec.executeSql("SHOW INDEXES");
    assertSuccess(r1, "SHOW INDEXES succeeds");
    assertRowCount(r1, 3, "3 indexes total");

    // Check column names
    assertEq(r1.columnNames.get(0), "index_name", "Col 0 is index_name");
    assertEq(r1.columnNames.get(1), "table_name", "Col 1 is table_name");
    assertEq(r1.columnNames.get(2), "columns", "Col 2 is columns");
    assertEq(r1.columnNames.get(3), "is_unique", "Col 3 is is_unique");
}

//=========================================================================
// SHOW INDEXES FROM tablename
//=========================================================================

func testShowIndexesFrom() {
    section("SHOW INDEXES FROM table");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, category TEXT, price INTEGER)");
    exec.executeSql("CREATE INDEX idx_prod_name ON products (name)");
    exec.executeSql("CREATE INDEX idx_prod_cat ON products (category)");
    exec.executeSql("CREATE UNIQUE INDEX idx_prod_id ON products (id)");
    exec.executeSql("CREATE TABLE other (x INTEGER)");
    exec.executeSql("CREATE INDEX idx_other ON other (x)");

    var r1 = exec.executeSql("SHOW INDEXES FROM products");
    assertSuccess(r1, "SHOW INDEXES FROM products");
    assertRowCount(r1, 3, "3 indexes on products");

    // Check first index
    assertEq(val(r1, 0, 0), "idx_prod_name", "First index name");
    assertEq(val(r1, 0, 1), "products", "Table name is products");
    assertEq(val(r1, 0, 2), "name", "Columns is 'name'");
    assertEq(val(r1, 0, 3), "NO", "idx_prod_name is not unique");

    // Check unique index
    assertEq(val(r1, 2, 0), "idx_prod_id", "Third index name");
    assertEq(val(r1, 2, 3), "YES", "idx_prod_id is unique");
}

//=========================================================================
// SHOW INDEXES — non-existent table
//=========================================================================

func testShowIndexesNonexistent() {
    section("SHOW INDEXES non-existent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW INDEXES FROM nonexistent");
    assertFailure(r1, "SHOW INDEXES FROM non-existent errors");
}

//=========================================================================
// SHOW INDEXES — table with no indexes
//=========================================================================

func testShowIndexesEmpty() {
    section("SHOW INDEXES empty");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE empty_tbl (id INTEGER, name TEXT)");

    var r1 = exec.executeSql("SHOW INDEXES FROM empty_tbl");
    assertSuccess(r1, "SHOW INDEXES FROM empty table succeeds");
    assertRowCount(r1, 0, "0 indexes on empty_tbl");
}

//=========================================================================
// SHOW INDEXES — composite index
//=========================================================================

func testShowIndexesComposite() {
    section("SHOW INDEXES composite");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE events (id INTEGER, year INTEGER, month INTEGER, day INTEGER)");
    exec.executeSql("CREATE INDEX idx_date ON events (year, month, day)");

    var r1 = exec.executeSql("SHOW INDEXES FROM events");
    assertSuccess(r1, "SHOW INDEXES with composite");
    assertRowCount(r1, 1, "1 composite index");
    assertEq(val(r1, 0, 2), "year, month, day", "Composite columns listed");
}

//=========================================================================
// SHOW COLUMNS FROM tablename
//=========================================================================

func testShowColumns() {
    section("SHOW COLUMNS FROM table");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE employees (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, email TEXT UNIQUE, salary INTEGER DEFAULT 50000, active BOOLEAN)");

    var r1 = exec.executeSql("SHOW COLUMNS FROM employees");
    assertSuccess(r1, "SHOW COLUMNS succeeds");
    assertRowCount(r1, 5, "5 columns");

    // Check column headers
    assertEq(r1.columnNames.get(0), "column_name", "Header 0");
    assertEq(r1.columnNames.get(1), "data_type", "Header 1");
    assertEq(r1.columnNames.get(2), "is_nullable", "Header 2");
    assertEq(r1.columnNames.get(3), "column_default", "Header 3");
    assertEq(r1.columnNames.get(4), "is_primary_key", "Header 4");

    // Check id column
    assertEq(val(r1, 0, 0), "id", "Col 0 name");
    assertEq(val(r1, 0, 1), "INTEGER", "Col 0 type");
    assertEq(val(r1, 0, 4), "YES", "id is primary key");

    // Check name column
    assertEq(val(r1, 1, 0), "name", "Col 1 name");
    assertEq(val(r1, 1, 1), "TEXT", "Col 1 type");
    assertEq(val(r1, 1, 2), "NO", "name is not nullable");

    // Check email column
    assertEq(val(r1, 2, 0), "email", "Col 2 name");

    // Check salary column with default
    assertEq(val(r1, 3, 0), "salary", "Col 3 name");
    assertEq(val(r1, 3, 3), "50000", "salary default is 50000");
    assertEq(val(r1, 3, 4), "NO", "salary is not PK");

    // Check boolean column
    assertEq(val(r1, 4, 0), "active", "Col 4 name");
    assertEq(val(r1, 4, 1), "BOOLEAN", "Col 4 type");
    assertEq(val(r1, 4, 2), "YES", "active is nullable");
}

//=========================================================================
// SHOW COLUMNS — non-existent table
//=========================================================================

func testShowColumnsNonexistent() {
    section("SHOW COLUMNS non-existent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SHOW COLUMNS FROM nonexistent");
    assertFailure(r1, "SHOW COLUMNS FROM non-existent errors");
}

//=========================================================================
// CREATE TABLE ... LIKE
//=========================================================================

func testCreateTableLike() {
    section("CREATE TABLE LIKE");

    var exec = new Executor();
    exec.init();

    // Create source table with various constraints
    exec.executeSql("CREATE TABLE source (id INTEGER PRIMARY KEY, name TEXT NOT NULL, score INTEGER DEFAULT 100, email TEXT UNIQUE)");
    exec.executeSql("INSERT INTO source VALUES (1, 'Alice', 95, 'alice@test.com')");

    // Clone structure
    var r1 = exec.executeSql("CREATE TABLE clone (LIKE source)");
    assertSuccess(r1, "CREATE TABLE LIKE succeeds");

    // Verify clone has same columns
    var r2 = exec.executeSql("SHOW COLUMNS FROM clone");
    assertSuccess(r2, "SHOW COLUMNS on clone");
    assertRowCount(r2, 4, "Clone has 4 columns");
    assertEq(val(r2, 0, 0), "id", "Clone col 0 is id");
    assertEq(val(r2, 0, 1), "INTEGER", "Clone col 0 type");
    assertEq(val(r2, 0, 4), "YES", "Clone id is PK");
    assertEq(val(r2, 1, 0), "name", "Clone col 1 is name");
    assertEq(val(r2, 1, 2), "NO", "Clone name is NOT NULL");
    assertEq(val(r2, 2, 3), "100", "Clone score default is 100");

    // Clone should be empty (no data copied)
    var r3 = exec.executeSql("SELECT * FROM clone");
    assertSuccess(r3, "SELECT from clone");
    assertRowCount(r3, 0, "Clone has no rows");

    // Can insert into clone independently
    exec.executeSql("INSERT INTO clone VALUES (10, 'Bob', 80, 'bob@test.com')");
    var r4 = exec.executeSql("SELECT * FROM clone");
    assertRowCount(r4, 1, "Clone has 1 row after insert");
    assertEq(val(r4, 0, 1), "Bob", "Clone data correct");
}

//=========================================================================
// CREATE TABLE LIKE — non-existent source
//=========================================================================

func testCreateTableLikeNonexistent() {
    section("CREATE TABLE LIKE non-existent");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("CREATE TABLE clone (LIKE nonexistent)");
    assertFailure(r1, "LIKE non-existent source errors");
}

//=========================================================================
// CREATE TABLE LIKE — duplicate name
//=========================================================================

func testCreateTableLikeDuplicate() {
    section("CREATE TABLE LIKE duplicate");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE original (id INTEGER, name TEXT)");

    var r1 = exec.executeSql("CREATE TABLE original (LIKE original)");
    assertFailure(r1, "LIKE with duplicate name errors");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 67: SHOW INDEXES, SHOW COLUMNS, CREATE TABLE LIKE ===");

    testShowIndexesAll();
    testShowIndexesFrom();
    testShowIndexesNonexistent();
    testShowIndexesEmpty();
    testShowIndexesComposite();
    testShowColumns();
    testShowColumnsNonexistent();
    testCreateTableLike();
    testCreateTableLikeNonexistent();
    testCreateTableLikeDuplicate();

    printResults();
}
