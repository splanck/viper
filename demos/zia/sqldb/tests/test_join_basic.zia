// test_join_basic.zia â€” Basic JOIN Operation Tests
// Part of ViperSQL Test Suite
//
// Tests LEFT JOIN (nested loop path) and INNER JOIN (hash join path)
// with a simple two-table employee/department schema.
//
// Dependencies: executor.zia, types.zia

module test_join_basic;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

func testLeftJoin(exec: Executor) {
    section("LEFT JOIN (nested loop)");

    var r = exec.executeSql("SELECT e.name, d.name FROM emp e LEFT JOIN dept d ON e.dept_id = d.id");
    assertSuccess(r, "LEFT JOIN executes");
    assertRowCount(r, 1, "LEFT JOIN returns 1 row");
    assertEq(val(r, 0, 0), "Alice", "LEFT JOIN employee name");
    assertEq(val(r, 0, 1), "Eng", "LEFT JOIN department name");
}

func testInnerJoin(exec: Executor) {
    section("INNER JOIN (hash join)");

    var r = exec.executeSql("SELECT e.name, d.name FROM emp e INNER JOIN dept d ON e.dept_id = d.id");
    assertSuccess(r, "INNER JOIN executes");
    assertRowCount(r, 1, "INNER JOIN returns 1 row");
    assertEq(val(r, 0, 0), "Alice", "INNER JOIN employee name");
    assertEq(val(r, 0, 1), "Eng", "INNER JOIN department name");
}

func main() -> Integer {
    Terminal.Say("=== Basic JOIN Operation Tests ===");

    var exec = new Executor();
    exec.init();

    exec.executeSql("CREATE TABLE dept (id INTEGER PRIMARY KEY, name TEXT)");
    exec.executeSql("INSERT INTO dept VALUES (1, 'Eng')");
    exec.executeSql("CREATE TABLE emp (id INTEGER PRIMARY KEY, name TEXT, dept_id INTEGER)");
    exec.executeSql("INSERT INTO emp VALUES (1, 'Alice', 1)");

    testLeftJoin(exec);
    testInnerJoin(exec);

    printResults();
    return 0;
}
