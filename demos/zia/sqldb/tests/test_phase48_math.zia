// test_phase48_math.zia — Phase 48: Math Functions
// Tests for trig, logarithmic, and integer math functions.

module test_phase48_math;

bind Terminal = Viper.Terminal;
bind String = Viper.String;
bind Fmt = Viper.Fmt;

bind "./test_common";
bind "../executor";
bind "../types";

//=========================================================================
// Trigonometric functions
//=========================================================================

func testSinCosTan() {
    section("SIN/COS/TAN");

    var exec = new Executor();
    exec.init();

    // SIN(0) = 0
    var r1 = exec.executeSql("SELECT SIN(0)");
    assertSuccess(r1, "SIN(0)");
    assertEq(val(r1, 0, 0), "0", "sin(0) = 0");

    // COS(0) = 1
    var r2 = exec.executeSql("SELECT COS(0)");
    assertSuccess(r2, "COS(0)");
    assertEq(val(r2, 0, 0), "1", "cos(0) = 1");

    // TAN(0) = 0
    var r3 = exec.executeSql("SELECT TAN(0)");
    assertSuccess(r3, "TAN(0)");
    assertEq(val(r3, 0, 0), "0", "tan(0) = 0");
}

//=========================================================================
// Inverse trig
//=========================================================================

func testInverseTrig() {
    section("ASIN/ACOS/ATAN");

    var exec = new Executor();
    exec.init();

    // ASIN(0) = 0
    var r1 = exec.executeSql("SELECT ASIN(0)");
    assertSuccess(r1, "ASIN(0)");
    assertEq(val(r1, 0, 0), "0", "asin(0) = 0");

    // ACOS(1) = 0
    var r2 = exec.executeSql("SELECT ACOS(1)");
    assertSuccess(r2, "ACOS(1)");
    assertEq(val(r2, 0, 0), "0", "acos(1) = 0");

    // ATAN(0) = 0
    var r3 = exec.executeSql("SELECT ATAN(0)");
    assertSuccess(r3, "ATAN(0)");
    assertEq(val(r3, 0, 0), "0", "atan(0) = 0");

    // ATAN2(0, 1) = 0
    var r4 = exec.executeSql("SELECT ATAN2(0, 1)");
    assertSuccess(r4, "ATAN2(0,1)");
    assertEq(val(r4, 0, 0), "0", "atan2(0,1) = 0");
}

//=========================================================================
// DEGREES / RADIANS
//=========================================================================

func testDegreesRadians() {
    section("DEGREES/RADIANS");

    var exec = new Executor();
    exec.init();

    // DEGREES(PI()) should be ~180
    var r1 = exec.executeSql("SELECT DEGREES(PI())");
    assertSuccess(r1, "DEGREES(PI)");
    // Check it starts with "180"
    var v1 = val(r1, 0, 0);
    assertTrue(stringContains(v1, "180"), "degrees(pi) ~ 180");

    // RADIANS(180) should be ~PI
    var r2 = exec.executeSql("SELECT RADIANS(180)");
    assertSuccess(r2, "RADIANS(180)");
    var v2 = val(r2, 0, 0);
    assertTrue(stringContains(v2, "3.14"), "radians(180) ~ pi");
}

//=========================================================================
// TRUNC
//=========================================================================

func testTrunc() {
    section("TRUNC");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT TRUNC(3.7)");
    assertSuccess(r1, "TRUNC(3.7)");
    assertEq(val(r1, 0, 0), "3", "trunc(3.7) = 3");

    var r2 = exec.executeSql("SELECT TRUNC(-3.7)");
    assertSuccess(r2, "TRUNC(-3.7)");
    assertEq(val(r2, 0, 0), "-3", "trunc(-3.7) = -3");
}

//=========================================================================
// CBRT — cube root
//=========================================================================

func testCbrt() {
    section("CBRT");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT CBRT(27)");
    assertSuccess(r1, "CBRT(27)");
    assertEq(val(r1, 0, 0), "3", "cbrt(27) = 3");

    var r2 = exec.executeSql("SELECT CBRT(8)");
    assertSuccess(r2, "CBRT(8)");
    assertEq(val(r2, 0, 0), "2", "cbrt(8) = 2");
}

//=========================================================================
// GCD / LCM
//=========================================================================

func testGcdLcm() {
    section("GCD/LCM");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT GCD(12, 8)");
    assertSuccess(r1, "GCD");
    assertEq(val(r1, 0, 0), "4", "gcd(12,8) = 4");

    var r2 = exec.executeSql("SELECT LCM(4, 6)");
    assertSuccess(r2, "LCM");
    assertEq(val(r2, 0, 0), "12", "lcm(4,6) = 12");

    var r3 = exec.executeSql("SELECT GCD(0, 5)");
    assertEq(val(r3, 0, 0), "5", "gcd(0,5) = 5");

    var r4 = exec.executeSql("SELECT LCM(0, 5)");
    assertEq(val(r4, 0, 0), "0", "lcm(0,5) = 0");
}

//=========================================================================
// DIV — integer division
//=========================================================================

func testDiv() {
    section("DIV");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT DIV(17, 5)");
    assertSuccess(r1, "DIV");
    assertEq(val(r1, 0, 0), "3", "17 div 5 = 3");

    var r2 = exec.executeSql("SELECT DIV(10, 3)");
    assertEq(val(r2, 0, 0), "3", "10 div 3 = 3");

    // Division by zero returns NULL
    var r3 = exec.executeSql("SELECT DIV(5, 0)");
    assertEq(val(r3, 0, 0), "NULL", "div by 0 = NULL");
}

//=========================================================================
// ABS for REAL values
//=========================================================================

func testAbsReal() {
    section("ABS real");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT ABS(-5)");
    assertEq(val(r1, 0, 0), "5", "abs(-5) = 5");

    var r2 = exec.executeSql("SELECT ABS(5)");
    assertEq(val(r2, 0, 0), "5", "abs(5) = 5");
}

//=========================================================================
// Existing functions still work
//=========================================================================

func testExistingMath() {
    section("Existing math functions");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT POWER(2, 10)");
    assertEq(val(r1, 0, 0), "1024", "2^10 = 1024");

    var r2 = exec.executeSql("SELECT SQRT(144)");
    assertSuccess(r2, "SQRT");
    assertEq(val(r2, 0, 0), "12", "sqrt(144) = 12");

    var r3 = exec.executeSql("SELECT CEIL(3.2)");
    assertEq(val(r3, 0, 0), "4", "ceil(3.2) = 4");

    var r4 = exec.executeSql("SELECT FLOOR(3.7)");
    assertEq(val(r4, 0, 0), "3", "floor(3.7) = 3");

    var r5 = exec.executeSql("SELECT MOD(17, 5)");
    assertEq(val(r5, 0, 0), "2", "17 mod 5 = 2");

    var r6 = exec.executeSql("SELECT SIGN(-42)");
    assertEq(val(r6, 0, 0), "-1", "sign(-42) = -1");

    var r7 = exec.executeSql("SELECT PI()");
    assertSuccess(r7, "PI");
    assertTrue(stringContains(val(r7, 0, 0), "3.14"), "pi starts with 3.14");
}

//=========================================================================
// GREATEST / LEAST
//=========================================================================

func testGreatestLeast() {
    section("GREATEST/LEAST");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT GREATEST(3, 7, 1, 9, 2)");
    assertSuccess(r1, "GREATEST");
    assertEq(val(r1, 0, 0), "9", "greatest = 9");

    var r2 = exec.executeSql("SELECT LEAST(3, 7, 1, 9, 2)");
    assertSuccess(r2, "LEAST");
    assertEq(val(r2, 0, 0), "1", "least = 1");
}

//=========================================================================
// NULL handling
//=========================================================================

func testNullHandling() {
    section("Math NULL handling");

    var exec = new Executor();
    exec.init();

    var r1 = exec.executeSql("SELECT SIN(NULL)");
    assertEq(val(r1, 0, 0), "NULL", "sin(null) = null");

    var r2 = exec.executeSql("SELECT SQRT(NULL)");
    assertEq(val(r2, 0, 0), "NULL", "sqrt(null) = null");

    var r3 = exec.executeSql("SELECT GCD(NULL, 5)");
    assertEq(val(r3, 0, 0), "NULL", "gcd(null,5) = null");
}

//=========================================================================
// MAIN
//=========================================================================

func main() {
    Terminal.Say("=== Phase 48: Math Functions ===");

    testSinCosTan();
    testInverseTrig();
    testDegreesRadians();
    testTrunc();
    testCbrt();
    testGcdLcm();
    testDiv();
    testAbsReal();
    testExistingMath();
    testGreatestLeast();
    testNullHandling();

    printResults();
}
