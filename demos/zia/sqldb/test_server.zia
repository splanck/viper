// test_server.zia - Network Server Tests
// Part of ViperSQL - Phase 6 Testing
// Note: These tests test the server components without actual networking

module test_server;

bind "./server/sql_server";
bind "./types";

//=============================================================================
// TEST HARNESS
//=============================================================================

var testsPassed = 0;
var testsFailed = 0;

func assert(condition: Boolean, testName: String) {
    if condition {
        testsPassed = testsPassed + 1;
        Viper.Terminal.Say("[PASS] " + testName);
    } else {
        testsFailed = testsFailed + 1;
        Viper.Terminal.Say("[FAIL] " + testName);
    }
}

func printSummary() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("===========================================");
    Viper.Terminal.Say("SERVER TEST SUMMARY");
    Viper.Terminal.Say("===========================================");
    Viper.Terminal.Say("Passed: " + Viper.Fmt.Int(testsPassed));
    Viper.Terminal.Say("Failed: " + Viper.Fmt.Int(testsFailed));
    Viper.Terminal.Say("Total:  " + Viper.Fmt.Int(testsPassed + testsFailed));
    Viper.Terminal.Say("===========================================");
}

//=============================================================================
// CLIENT SESSION TESTS
//=============================================================================

func testClientSessionInit() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("--- ClientSession Tests ---");

    var session = new ClientSession();
    session.init();

    assert(session.sessionId == 0, "ClientSession init sets sessionId to 0");
    assert(session.authenticated == false, "ClientSession init not authenticated");
    assert(session.inTransaction == false, "ClientSession init not in transaction");
}

func testClientSessionWithId() {
    var session = new ClientSession();
    session.initWithId(42, "192.168.1.1");

    assert(session.sessionId == 42, "ClientSession stores sessionId");
    assert(session.clientHost == "192.168.1.1", "ClientSession stores clientHost");
}

func testClientSessionToString() {
    var session = new ClientSession();
    session.initWithId(10, "localhost");
    session.username = "testuser";

    var str = session.toString();
    assert(stringContains(str, "10"), "ClientSession toString includes ID");
}

//=============================================================================
// QUERY RESULT TESTS
//=============================================================================

func testServerQueryResultInit() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("--- ServerQueryResult Tests ---");

    var result = new ServerQueryResult();
    result.init();

    assert(result.success == true, "ServerQueryResult init is successful");
    assert(result.columnCount() == 0, "ServerQueryResult init has 0 columns");
    assert(result.rowCount() == 0, "ServerQueryResult init has 0 rows");
}

func testServerQueryResultSetError() {
    var result = new ServerQueryResult();
    result.init();
    result.setError("Test error message");

    assert(result.success == false, "ServerQueryResult error sets success to false");
    assert(result.errorMessage == "Test error message", "ServerQueryResult stores error message");
}

func testServerQueryResultAddColumn() {
    var result = new ServerQueryResult();
    result.init();

    result.addColumn("id", "INTEGER");
    result.addColumn("name", "TEXT");

    assert(result.columnCount() == 2, "ServerQueryResult has 2 columns");
    assert(result.columnNames.get(0) == "id", "First column is 'id'");
    assert(result.columnNames.get(1) == "name", "Second column is 'name'");
    assert(result.columnTypes.get(0) == "INTEGER", "First column type is INTEGER");
}

func testServerQueryResultAddRow() {
    var result = new ServerQueryResult();
    result.init();

    result.addColumn("id", "INTEGER");
    result.addColumn("name", "TEXT");

    var row1: List[String] = [];
    row1.add("1");
    row1.add("Alice");
    result.addRow(row1);

    var row2: List[String] = [];
    row2.add("2");
    row2.add("Bob");
    result.addRow(row2);

    assert(result.rowCount() == 2, "ServerQueryResult has 2 rows");
    assert(result.rows.get(0).get(0) == "1", "First row, first col is '1'");
    assert(result.rows.get(0).get(1) == "Alice", "First row, second col is 'Alice'");
    assert(result.rows.get(1).get(0) == "2", "Second row, first col is '2'");
}

//=============================================================================
// SQL SERVER TESTS
//=============================================================================

func testSqlServerInit() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("--- SqlServer Tests ---");

    var server = new SqlServer();
    server.init();

    assert(server.port == DEFAULT_PORT, "SqlServer init sets default port");
    assert(server.running == false, "SqlServer init is not running");
    assert(server.getConnectionCount() == 0, "SqlServer init has 0 connections");
    assert(server.getQueryCount() == 0, "SqlServer init has 0 queries");
}

func testSqlServerWithPort() {
    var server = new SqlServer();
    server.initWithPort(3306);

    assert(server.port == 3306, "SqlServer stores custom port");
}

func testSqlServerStats() {
    var server = new SqlServer();
    server.init();

    var stats = server.getStats();
    assert(stringContains(stats, "ViperSQL"), "Stats includes server name");
    assert(stringContains(stats, "Port"), "Stats includes port info");
}

func testSqlServerExecutor() {
    var server = new SqlServer();
    server.init();

    // Test that executor is initialized
    // We can test by creating a table and querying it
    var result1 = server.executor.executeSql("CREATE TABLE test_srv (id INTEGER, name TEXT)");
    assert(result1.success == true, "Server executor can CREATE TABLE");

    var result2 = server.executor.executeSql("INSERT INTO test_srv VALUES (1, 'Test')");
    assert(result2.success == true, "Server executor can INSERT");

    var result3 = server.executor.executeSql("SELECT * FROM test_srv");
    assert(result3.success == true, "Server executor can SELECT");
    assert(result3.rows.count() == 1, "Server executor returns correct rows");
}

//=============================================================================
// INTEGRATION TESTS
//=============================================================================

func testServerQueryExecution() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("--- Integration Tests ---");

    var server = new SqlServer();
    server.init();

    // Create a session
    var session = new ClientSession();
    session.initWithId(1, "localhost");
    session.authenticated = true;

    // Execute queries through executor
    server.executor.executeSql("CREATE TABLE users (id INTEGER, name TEXT)");
    server.executor.executeSql("INSERT INTO users VALUES (1, 'Alice')");
    server.executor.executeSql("INSERT INTO users VALUES (2, 'Bob')");

    var result = server.executor.executeSql("SELECT * FROM users ORDER BY id");
    assert(result.success == true, "Integration: SELECT succeeds");
    assert(result.rows.count() == 2, "Integration: Returns 2 rows");
}

func testServerMultipleQueries() {
    var server = new SqlServer();
    server.init();

    // Execute multiple queries
    server.executor.executeSql("CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT)");
    server.executor.executeSql("INSERT INTO products VALUES (1, 'Widget')");
    server.executor.executeSql("INSERT INTO products VALUES (2, 'Gadget')");
    server.executor.executeSql("UPDATE products SET name = 'Super Widget' WHERE id = 1");

    var result = server.executor.executeSql("SELECT name FROM products WHERE id = 1");
    assert(result.success == true, "Multiple queries: SELECT succeeds");
    assert(result.rows.count() == 1, "Multiple queries: Returns 1 row");

    var row = result.rows.get(0);
    assert(row.getValue(0).textValue == "Super Widget", "Multiple queries: Update was applied");
}

func testServerDatabaseOperations() {
    var server = new SqlServer();
    server.init();

    // Test database operations
    var result1 = server.executor.executeSql("CREATE DATABASE testdb");
    assert(result1.success == true, "Database: CREATE DATABASE succeeds");

    var result2 = server.executor.executeSql("USE testdb");
    assert(result2.success == true, "Database: USE database succeeds");

    var result3 = server.executor.executeSql("CREATE TABLE test_tbl (x INTEGER)");
    assert(result3.success == true, "Database: CREATE TABLE in new db succeeds");
}

//=============================================================================
// CONSTANTS TESTS
//=============================================================================

func testConstants() {
    Viper.Terminal.Say("");
    Viper.Terminal.Say("--- Constants Tests ---");

    assert(DEFAULT_PORT == 5432, "DEFAULT_PORT is 5432");
    assert(MAX_QUERY_SIZE == 65536, "MAX_QUERY_SIZE is 64KB");
    assert(MSG_QUERY == 81, "MSG_QUERY is 'Q' (81)");
    assert(MSG_TERMINATE == 88, "MSG_TERMINATE is 'X' (88)");
}

//=============================================================================
// MAIN
//=============================================================================

func main() {
    Viper.Terminal.Say("===========================================");
    Viper.Terminal.Say("VIPERSQL NETWORK SERVER TESTS");
    Viper.Terminal.Say("===========================================");

    // ClientSession tests
    testClientSessionInit();
    testClientSessionWithId();
    testClientSessionToString();

    // ServerQueryResult tests
    testServerQueryResultInit();
    testServerQueryResultSetError();
    testServerQueryResultAddColumn();
    testServerQueryResultAddRow();

    // SqlServer tests
    testSqlServerInit();
    testSqlServerWithPort();
    testSqlServerStats();
    testSqlServerExecutor();

    // Integration tests
    testServerQueryExecution();
    testServerMultipleQueries();
    testServerDatabaseOperations();

    // Constants tests
    testConstants();

    printSummary();
}
