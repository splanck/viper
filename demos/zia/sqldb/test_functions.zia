// test_functions.viper - Test SQL functions
module test_functions;

bind Terminal = Viper.Terminal;
bind Fmt = Viper.Fmt;

bind "./executor";

Integer passed = 0;
Integer failed = 0;

func assert(condition: Boolean, msg: String) {
    if condition {
        passed = passed + 1;
        Terminal.Say("  PASS: " + msg);
    } else {
        failed = failed + 1;
        Terminal.Say("  FAIL: " + msg);
    }
}

func assertValue(result: QueryResult, expected: String, msg: String) {
    if result.rowCount() > 0 {
        var row = result.getRow(0);
        if row != null {
            var r = row;
            var val = r.getValue(0);
            var actual = val.toString();
            if actual == expected {
                passed = passed + 1;
                Terminal.Say("  PASS: " + msg + " = " + actual);
            } else {
                failed = failed + 1;
                Terminal.Say("  FAIL: " + msg + " expected '" + expected + "' got '" + actual + "'");
            }
            return;
        }
    }
    failed = failed + 1;
    Terminal.Say("  FAIL: " + msg + " - no result");
}

func main() {
    var exec = new Executor();
    exec.init();

    Terminal.Say("=== SQL Functions Tests ===");
    Terminal.Say("");

    // Create test table
    exec.executeSql("CREATE TABLE test (id INTEGER, name TEXT, val INTEGER)");
    exec.executeSql("INSERT INTO test VALUES (1, 'Hello World', 42)");
    exec.executeSql("INSERT INTO test VALUES (2, '  spaces  ', -10)");

    // String Functions
    Terminal.Say("Testing String Functions...");

    var r1 = exec.executeSql("SELECT UPPER(name) FROM test WHERE id = 1");
    assertValue(r1, "HELLO WORLD", "UPPER");

    var r2 = exec.executeSql("SELECT LOWER(name) FROM test WHERE id = 1");
    assertValue(r2, "hello world", "LOWER");

    var r3 = exec.executeSql("SELECT LENGTH(name) FROM test WHERE id = 1");
    assertValue(r3, "11", "LENGTH");

    var r4 = exec.executeSql("SELECT SUBSTR(name, 1, 5) FROM test WHERE id = 1");
    assertValue(r4, "Hello", "SUBSTR with length");

    var r5 = exec.executeSql("SELECT SUBSTR(name, 7) FROM test WHERE id = 1");
    assertValue(r5, "World", "SUBSTR without length");

    var r6 = exec.executeSql("SELECT TRIM(name) FROM test WHERE id = 2");
    assertValue(r6, "spaces", "TRIM");

    var r7 = exec.executeSql("SELECT LTRIM(name) FROM test WHERE id = 2");
    assertValue(r7, "spaces  ", "LTRIM");

    var r8 = exec.executeSql("SELECT RTRIM(name) FROM test WHERE id = 2");
    assertValue(r8, "  spaces", "RTRIM");

    var r9 = exec.executeSql("SELECT REPLACE(name, 'World', 'Viper') FROM test WHERE id = 1");
    assertValue(r9, "Hello Viper", "REPLACE");

    var r10 = exec.executeSql("SELECT CONCAT(name, '!') FROM test WHERE id = 1");
    assertValue(r10, "Hello World!", "CONCAT");

    var r11 = exec.executeSql("SELECT INSTR(name, 'World') FROM test WHERE id = 1");
    assertValue(r11, "7", "INSTR found");

    var r12 = exec.executeSql("SELECT INSTR(name, 'xyz') FROM test WHERE id = 1");
    assertValue(r12, "0", "INSTR not found");

    // Math Functions
    Terminal.Say("");
    Terminal.Say("Testing Math Functions...");

    var r13 = exec.executeSql("SELECT ABS(val) FROM test WHERE id = 2");
    assertValue(r13, "10", "ABS of negative");

    var r14 = exec.executeSql("SELECT ABS(val) FROM test WHERE id = 1");
    assertValue(r14, "42", "ABS of positive");

    var r15 = exec.executeSql("SELECT MOD(val, 5) FROM test WHERE id = 1");
    assertValue(r15, "2", "MOD");

    var r16 = exec.executeSql("SELECT MIN(10, 20) FROM test WHERE id = 1");
    assertValue(r16, "10", "MIN of two values");

    var r17 = exec.executeSql("SELECT MAX(10, 20) FROM test WHERE id = 1");
    assertValue(r17, "20", "MAX of two values");

    // Null/Conditional Functions
    Terminal.Say("");
    Terminal.Say("Testing Null/Conditional Functions...");

    var r18 = exec.executeSql("SELECT COALESCE(val, 0) FROM test WHERE id = 1");
    assertValue(r18, "42", "COALESCE with non-null");

    var r19 = exec.executeSql("SELECT IFNULL(val, 99) FROM test WHERE id = 1");
    assertValue(r19, "42", "IFNULL with non-null");

    var r20 = exec.executeSql("SELECT NULLIF(val, 42) FROM test WHERE id = 1");
    assertValue(r20, "NULL", "NULLIF when equal");

    var r21 = exec.executeSql("SELECT NULLIF(val, 0) FROM test WHERE id = 1");
    assertValue(r21, "42", "NULLIF when not equal");

    var r22 = exec.executeSql("SELECT IIF(val > 0, 'positive', 'not positive') FROM test WHERE id = 1");
    assertValue(r22, "positive", "IIF true condition");

    var r23 = exec.executeSql("SELECT IIF(val > 0, 'positive', 'not positive') FROM test WHERE id = 2");
    assertValue(r23, "not positive", "IIF false condition");

    var r24 = exec.executeSql("SELECT TYPEOF(val) FROM test WHERE id = 1");
    assertValue(r24, "integer", "TYPEOF integer");

    var r25 = exec.executeSql("SELECT TYPEOF(name) FROM test WHERE id = 1");
    assertValue(r25, "text", "TYPEOF text");

    // Print results
    Terminal.Say("");
    Terminal.Say("=== Results ===");
    Terminal.Say("Passed: " + Fmt.Int(passed));
    Terminal.Say("Failed: " + Fmt.Int(failed));
}
