// Viper Web Server - Configuration Module
// Parses configuration from file or uses defaults
module config;

bind Viper.IO;
bind Viper.String;

// ============================================================================
// CONFIGURATION VALUES (set by config_load or defaults)
// ============================================================================

var cfg_port: Integer;
var cfg_webroot: String;
var cfg_workers: Integer;
var cfg_log_level: Integer;
var cfg_index_file: String;

// ============================================================================
// DEFAULT VALUES
// ============================================================================

final CFG_DEFAULT_PORT = 8080;
final CFG_DEFAULT_WEBROOT = "./www";
final CFG_DEFAULT_WORKERS = 4;
final CFG_DEFAULT_LOG_LEVEL = 1;  // LOG_INFO
final CFG_DEFAULT_INDEX = "index.html";
final CFG_FILENAME = "server.conf";

// ============================================================================
// CONFIGURATION LOADING
// ============================================================================

// Initialize configuration with defaults
func config_init() {
    cfg_port = CFG_DEFAULT_PORT;
    cfg_webroot = CFG_DEFAULT_WEBROOT;
    cfg_workers = CFG_DEFAULT_WORKERS;
    cfg_log_level = CFG_DEFAULT_LOG_LEVEL;
    cfg_index_file = CFG_DEFAULT_INDEX;
}

// Load configuration from file, returns true if file was found and parsed
func config_load(configPath: String) -> Boolean {
    // Initialize defaults first
    config_init();

    // Check if config file exists
    if IO.File.Exists(configPath) == false {
        return false;
    }

    // Read the file
    var content = IO.File.ReadAllText(configPath);
    var len = String.Length(content);
    if len == 0 {
        return false;
    }

    // Parse line by line
    var lineStart = 0;
    var i = 0;
    while i <= len {
        var atEnd = i == len;
        var isNewline = false;

        if atEnd == false {
            var ch = String.Substring(content, i, 1);
            isNewline = ch == "\n" || ch == "\r";
        }

        if isNewline || atEnd {
            if i > lineStart {
                var lineLen = i - lineStart;
                var line = String.Substring(content, lineStart, lineLen);
                config_parseLine(line);
            }
            // Skip \r\n sequence
            if atEnd == false {
                var ch = String.Substring(content, i, 1);
                if ch == "\r" && i + 1 < len {
                    var next = String.Substring(content, i + 1, 1);
                    if next == "\n" {
                        i = i + 1;
                    }
                }
            }
            lineStart = i + 1;
        }
        i = i + 1;
    }

    return true;
}

// Parse a single configuration line
func config_parseLine(line: String) {
    var len = String.Length(line);
    if len == 0 {
        return;
    }

    // Skip comments (lines starting with #)
    var firstChar = String.Substring(line, 0, 1);
    if firstChar == "#" {
        return;
    }

    // Find = separator
    var eqPos = -1;
    var i = 0;
    while i < len {
        var ch = String.Substring(line, i, 1);
        if ch == "=" {
            eqPos = i;
            break;
        }
        i = i + 1;
    }

    if eqPos <= 0 {
        return;  // No key found
    }

    // Extract key and value
    var key = config_trim(String.Substring(line, 0, eqPos));
    var valueLen = len - eqPos - 1;
    var value = "";
    if valueLen > 0 {
        value = config_trim(String.Substring(line, eqPos + 1, valueLen));
    }

    // Set configuration based on key
    if key == "port" {
        cfg_port = config_parseInt(value, CFG_DEFAULT_PORT);
    } else if key == "webroot" {
        cfg_webroot = value;
    } else if key == "workers" {
        cfg_workers = config_parseInt(value, CFG_DEFAULT_WORKERS);
    } else if key == "log_level" {
        cfg_log_level = config_parseLogLevel(value);
    } else if key == "index_file" {
        cfg_index_file = value;
    }
    // Unknown keys are silently ignored
}

// Trim whitespace from string
func config_trim(s: String) -> String {
    var len = String.Length(s);
    if len == 0 {
        return s;
    }

    // Find start (skip leading whitespace)
    var start = 0;
    while start < len {
        var ch = String.Substring(s, start, 1);
        if ch != " " && ch != "\t" {
            break;
        }
        start = start + 1;
    }

    // Find end (skip trailing whitespace)
    var end = len;
    while end > start {
        var ch = String.Substring(s, end - 1, 1);
        if ch != " " && ch != "\t" {
            break;
        }
        end = end - 1;
    }

    if start >= end {
        return "";
    }

    return String.Substring(s, start, end - start);
}

// Parse integer from string with default
func config_parseInt(s: String, defaultVal: Integer) -> Integer {
    var len = String.Length(s);
    if len == 0 {
        return defaultVal;
    }

    var result = 0;
    var i = 0;
    while i < len {
        var ch = String.Substring(s, i, 1);
        var digit = charToDigit(ch);
        if digit < 0 {
            return defaultVal;  // Invalid character
        }
        result = result * 10 + digit;
        i = i + 1;
    }

    return result;
}

// Parse log level from string (DEBUG, INFO, WARN, ERROR or numeric)
func config_parseLogLevel(s: String) -> Integer {
    if s == "DEBUG" || s == "debug" || s == "0" {
        return 0;
    }
    if s == "INFO" || s == "info" || s == "1" {
        return 1;
    }
    if s == "WARN" || s == "warn" || s == "2" {
        return 2;
    }
    if s == "ERROR" || s == "error" || s == "3" {
        return 3;
    }
    return CFG_DEFAULT_LOG_LEVEL;
}

// ============================================================================
// HELPER: char to digit (shared with main.zia via bind)
// ============================================================================

func charToDigit(c: String) -> Integer {
    if c == "0" { return 0; }
    if c == "1" { return 1; }
    if c == "2" { return 2; }
    if c == "3" { return 3; }
    if c == "4" { return 4; }
    if c == "5" { return 5; }
    if c == "6" { return 6; }
    if c == "7" { return 7; }
    if c == "8" { return 8; }
    if c == "9" { return 9; }
    return -1;
}
