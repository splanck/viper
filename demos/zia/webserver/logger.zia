// Viper Web Server - Thread-Safe Logger
// Provides logging with levels, timestamps, and request tracking
module logger;

bind Viper.Terminal;
bind Viper.Time;
bind Viper.Threads;
bind Viper.Collections;
bind Viper.Fmt;

// ============================================================================
// LOG LEVELS
// ============================================================================

final LOG_DEBUG = 0;
final LOG_INFO = 1;
final LOG_WARN = 2;
final LOG_ERROR = 3;

// Current log level (messages below this level are ignored)
var log_level: Integer;

// Monitor object for thread-safe logging
var log_monitor: List[Integer];

// ============================================================================
// INITIALIZATION
// ============================================================================

func log_init(level: Integer) {
    log_level = level;
    // Create a dummy list to use as monitor object
    log_monitor = Collections.List.New();
}

// ============================================================================
// INTERNAL HELPERS
// ============================================================================

func log_levelName(level: Integer) -> String {
    if level == LOG_DEBUG {
        return "DEBUG";
    }
    if level == LOG_INFO {
        return "INFO";
    }
    if level == LOG_WARN {
        return "WARN";
    }
    if level == LOG_ERROR {
        return "ERROR";
    }
    return "?????";
}

func log_pad2(n: Integer) -> String {
    if n < 10 {
        return "0" + Fmt.Int(n);
    }
    return Fmt.Int(n);
}

func log_pad3(n: Integer) -> String {
    if n < 10 {
        return "00" + Fmt.Int(n);
    }
    if n < 100 {
        return "0" + Fmt.Int(n);
    }
    return Fmt.Int(n);
}

func log_timestamp() -> String {
    var now = Time.DateTime.Now();
    var ms = Time.DateTime.NowMs() % 1000;

    var year = Time.DateTime.Year(now);
    var month = Time.DateTime.Month(now);
    var day = Time.DateTime.Day(now);
    var hour = Time.DateTime.Hour(now);
    var minute = Time.DateTime.Minute(now);
    var second = Time.DateTime.Second(now);

    // Format: YYYY-MM-DD HH:MM:SS.mmm
    var ts = Fmt.Int(year) + "-";
    ts = ts + log_pad2(month) + "-";
    ts = ts + log_pad2(day) + " ";
    ts = ts + log_pad2(hour) + ":";
    ts = ts + log_pad2(minute) + ":";
    ts = ts + log_pad2(second) + ".";
    ts = ts + log_pad3(ms);

    return ts;
}

// ============================================================================
// CORE LOGGING
// ============================================================================

func log_write(level: Integer, message: String) {
    if level < log_level {
        return;
    }

    var line = "[" + log_timestamp() + "] [" + log_levelName(level) + "] " + message;

    // Thread-safe output
    Threads.Monitor.Enter(log_monitor);
    Terminal.Say(line);
    Threads.Monitor.Exit(log_monitor);
}

// ============================================================================
// PUBLIC LOGGING FUNCTIONS
// ============================================================================

func log_debug(message: String) {
    log_write(LOG_DEBUG, message);
}

func log_info(message: String) {
    log_write(LOG_INFO, message);
}

func log_warn(message: String) {
    log_write(LOG_WARN, message);
}

func log_error(message: String) {
    log_write(LOG_ERROR, message);
}

// ============================================================================
// REQUEST LOGGING
// ============================================================================

// Log an HTTP request with timing
// Format: CLIENT_IP METHOD PATH STATUS SIZE DURATION_MS
func log_request(clientIp: String, method: String, path: String,
                 status: Integer, size: Integer, durationMs: Integer) {
    var msg = clientIp + " " + method + " " + path + " ";
    msg = msg + Fmt.Int(status) + " ";
    msg = msg + Fmt.Int(size) + " ";
    msg = msg + Fmt.Int(durationMs) + "ms";

    // Use appropriate log level based on status
    if status >= 500 {
        log_write(LOG_ERROR, msg);
    } else if status >= 400 {
        log_write(LOG_WARN, msg);
    } else {
        log_write(LOG_INFO, msg);
    }
}

// Get current time in milliseconds for duration tracking
func log_startTimer() -> Integer {
    return Time.Clock.Ticks();
}

// Calculate elapsed time in milliseconds
func log_elapsed(startTime: Integer) -> Integer {
    return Time.Clock.Ticks() - startTime;
}
