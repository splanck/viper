// Viper Web Server - Router Module
// Provides URL routing and query string parsing for dynamic content
module router;

// ============================================================================
// ROUTE IDs
// ============================================================================

// Route IDs for known routes
final ROUTE_ID_NONE = 0;
final ROUTE_ID_STATUS = 1;
final ROUTE_ID_ECHO = 2;
final ROUTE_ID_TIME = 3;

// ============================================================================
// INITIALIZATION
// ============================================================================

var router_initialized: Integer;

func router_init() {
    router_initialized = 1;
}

func router_getCount() -> Integer {
    // Return count of registered routes
    return 3;
}

// ============================================================================
// QUERY STRING PARSING
// ============================================================================

// Extract query string from path (everything after ?)
// Returns empty string if no query string
func router_extractQuery(fullPath: String) -> String {
    var len = Viper.String.Length(fullPath);
    var i = 0;

    while i < len {
        var ch = Viper.String.Substring(fullPath, i, 1);
        if ch == "?" {
            if i + 1 < len {
                return Viper.String.Substring(fullPath, i + 1, len - i - 1);
            }
            return "";
        }
        i = i + 1;
    }

    return "";
}

// Extract path portion (everything before ?)
func router_extractPath(fullPath: String) -> String {
    var len = Viper.String.Length(fullPath);
    var i = 0;

    while i < len {
        var ch = Viper.String.Substring(fullPath, i, 1);
        if ch == "?" {
            return Viper.String.Substring(fullPath, 0, i);
        }
        i = i + 1;
    }

    return fullPath;
}

// Get a query parameter value by name
// Returns empty string if not found
func router_getQueryParam(query: String, name: String) -> String {
    var queryLen = Viper.String.Length(query);
    var nameLen = Viper.String.Length(name);

    if queryLen == 0 || nameLen == 0 {
        return "";
    }

    var i = 0;
    while i < queryLen {
        // Check if we're at start of a parameter (start of string or after &)
        var atStart = i == 0;
        if i > 0 {
            var prevCh = Viper.String.Substring(query, i - 1, 1);
            atStart = prevCh == "&";
        }

        if atStart {
            // Check if this parameter matches our name
            var remaining = queryLen - i;
            if remaining >= nameLen + 1 {
                var potentialName = Viper.String.Substring(query, i, nameLen);
                var nextCh = Viper.String.Substring(query, i + nameLen, 1);

                if potentialName == name && nextCh == "=" {
                    // Found the parameter, extract value until & or end
                    var valueStart = i + nameLen + 1;
                    var valueEnd = valueStart;

                    while valueEnd < queryLen {
                        var ch = Viper.String.Substring(query, valueEnd, 1);
                        if ch == "&" {
                            break;
                        }
                        valueEnd = valueEnd + 1;
                    }

                    if valueEnd > valueStart {
                        return Viper.String.Substring(query, valueStart, valueEnd - valueStart);
                    }
                    return "";
                }
            }
        }

        i = i + 1;
    }

    return "";
}

// ============================================================================
// ROUTE MATCHING
// ============================================================================

// Find matching route and return route ID, or ROUTE_ID_NONE if no match
// Uses direct string comparison for performance
func router_findRoute(fullPath: String) -> Integer {
    var path = router_extractPath(fullPath);

    // Check each registered route
    if path == "/api/status" {
        return ROUTE_ID_STATUS;
    }
    if path == "/api/echo" {
        return ROUTE_ID_ECHO;
    }
    if path == "/api/time" {
        return ROUTE_ID_TIME;
    }

    return ROUTE_ID_NONE;
}

// Check if a route exists for the given path
func router_hasRoute(fullPath: String) -> Boolean {
    return router_findRoute(fullPath) != ROUTE_ID_NONE;
}
