// =============================================================================
// CENTIPEDE - Score Popup System
// =============================================================================
// Shows floating score text when enemies are killed
// Classic arcade game feature for visual feedback
// =============================================================================

module popup;

bind "./config";
bind "./utils";

bind Viper.Graphics;
bind Viper.Fmt;

// =============================================================================
// SCORE POPUP ENTITY - Floating score text
// =============================================================================

entity ScorePopup {
    hide Integer screenX;
    hide Integer screenY;
    hide Integer points;
    hide Integer lifetime;
    hide Integer maxLifetime;
    hide Boolean active;

    expose func init() {
        screenX = 0;
        screenY = 0;
        points = 0;
        lifetime = 0;
        maxLifetime = 45;
        active = false;
    }

    expose func spawn(x: Integer, y: Integer, pts: Integer) {
        screenX = x;
        screenY = y;
        points = pts;
        lifetime = maxLifetime;
        active = true;
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func update() {
        if !active {
            return;
        }

        // Float upward
        screenY = screenY - 1;

        // Reduce lifetime
        lifetime = lifetime - 1;
        if lifetime <= 0 {
            active = false;
        }
    }

    expose func draw(canvas: Canvas) {
        if !active {
            return;
        }

        // Choose color based on points
        var color = config.COLOR_WHITE;
        if points >= 1000 {
            color = config.COLOR_YELLOW;
        } else if points >= 100 {
            color = config.COLOR_CYAN;
        }

        // Draw the score text
        canvas.Text(screenX - 12, screenY, Int(points), color);
    }
}

// =============================================================================
// POPUP MANAGER ENTITY - Manages multiple score popups
// =============================================================================

entity PopupManager {
    hide List[ScorePopup] popups;
    hide Integer maxPopups;

    expose func init() {
        popups = [];
        maxPopups = 20;

        // Pre-allocate popup pool
        for i in 0..maxPopups {
            var p = new ScorePopup();
            popups.add(p);
        }
    }

    expose func spawn(x: Integer, y: Integer, points: Integer) {
        for p in popups {
            if !p.isActive() {
                p.spawn(x, y, points);
                return;
            }
        }
    }

    expose func update() {
        for p in popups {
            if p.isActive() {
                p.update();
            }
        }
    }

    expose func draw(canvas: Canvas) {
        for p in popups {
            if p.isActive() {
                p.draw(canvas);
            }
        }
    }

    expose func clear() {
        for p in popups {
            p.init();
        }
    }
}

