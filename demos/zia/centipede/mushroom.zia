// =============================================================================
// CENTIPEDE - Mushroom Field
// =============================================================================
// Uses Grid2D for efficient 2D tile storage
// Mushrooms have 4 health and change color as damaged
// =============================================================================

module mushroom;

bind "./config";
bind "./utils";

bind Viper.Game;
bind Viper.Graphics;
bind Viper.Random;

// =============================================================================
// MUSHROOM FIELD ENTITY - The game board with mushrooms
// =============================================================================

entity MushroomField {
    hide Grid2D grid;         // Stores mushroom health (0-4)
    hide Grid2D poisoned;     // Tracks poisoned mushrooms
    hide Integer totalMushrooms;

    expose func init() {
        grid = Grid2D.New(config.GRID_WIDTH, config.GRID_HEIGHT, 0);
        poisoned = Grid2D.New(config.GRID_WIDTH, config.GRID_HEIGHT, 0);
        totalMushrooms = 0;
    }

    expose func generateMushrooms(count: Integer) {
        var placed = 0;
        var attempts = 0;
        var maxAttempts = count * 10;

        while placed < count && attempts < maxAttempts {
            // Place mushrooms in the mushroom zone (not in player zone or top row)
            var x = NextInt(config.GRID_WIDTH);
            var y = config.MUSHROOM_ZONE_TOP + NextInt(config.MUSHROOM_ZONE_BOTTOM - config.MUSHROOM_ZONE_TOP - 6);

            if grid.Get(x, y) == 0 {
                grid.Set(x, y, config.MUSHROOM_MAX_HEALTH);
                totalMushrooms = totalMushrooms + 1;
                placed = placed + 1;
            }
            attempts = attempts + 1;
        }
    }

    expose func getHealth(x: Integer, y: Integer) -> Integer {
        if !grid.InBounds(x, y) {
            return 0;
        }
        return grid.Get(x, y);
    }

    expose func setHealth(x: Integer, y: Integer, health: Integer) {
        if grid.InBounds(x, y) {
            var oldHealth = grid.Get(x, y);
            grid.Set(x, y, health);

            // Track mushroom count
            if oldHealth == 0 && health > 0 {
                totalMushrooms = totalMushrooms + 1;
            } else if oldHealth > 0 && health == 0 {
                totalMushrooms = totalMushrooms - 1;
            }
        }
    }

    expose func hasMushroom(x: Integer, y: Integer) -> Boolean {
        return self.getHealth(x, y) > 0;
    }

    expose func damageMushroom(x: Integer, y: Integer) -> Boolean {
        var health = self.getHealth(x, y);
        if health > 0 {
            health = health - 1;
            self.setHealth(x, y, health);
            return true;
        }
        return false;
    }

    expose func createMushroom(x: Integer, y: Integer) {
        if grid.InBounds(x, y) && grid.Get(x, y) == 0 {
            grid.Set(x, y, config.MUSHROOM_MAX_HEALTH);
            totalMushrooms = totalMushrooms + 1;
        }
    }

    expose func isPoisoned(x: Integer, y: Integer) -> Boolean {
        if !poisoned.InBounds(x, y) {
            return false;
        }
        return poisoned.Get(x, y) != 0;
    }

    expose func setPoisoned(x: Integer, y: Integer, isPoisonedVal: Boolean) {
        if poisoned.InBounds(x, y) {
            if isPoisonedVal {
                poisoned.Set(x, y, 1);
            } else {
                poisoned.Set(x, y, 0);
            }
        }
    }

    expose func countMushroomsInZone(startY: Integer, endY: Integer) -> Integer {
        var count = 0;
        for y in startY..endY {
            for x in 0..config.GRID_WIDTH {
                if grid.InBounds(x, y) && grid.Get(x, y) > 0 {
                    count = count + 1;
                }
            }
        }
        return count;
    }

    expose func restoreAllMushrooms() {
        // Called when player dies - restore damaged mushrooms
        for y in 0..config.GRID_HEIGHT {
            for x in 0..config.GRID_WIDTH {
                var health = grid.Get(x, y);
                if health > 0 && health < config.MUSHROOM_MAX_HEALTH {
                    grid.Set(x, y, config.MUSHROOM_MAX_HEALTH);
                }
            }
        }
    }

    expose func draw(canvas: Canvas) {
        for y in 0..config.GRID_HEIGHT {
            for x in 0..config.GRID_WIDTH {
                var health = grid.Get(x, y);
                if health > 0 {
                    self.drawMushroom(canvas, x, y, health, self.isPoisoned(x, y));
                }
            }
        }
    }

    hide func drawMushroom(canvas: Canvas, gridX: Integer, gridY: Integer, health: Integer, isPoisonedMush: Boolean) {
        var screenX = utils.gridToScreenX(gridX);
        var screenY = utils.gridToScreenY(gridY);
        var centerX = screenX + config.TILE_SIZE / 2;
        var centerY = screenY + config.TILE_SIZE / 2;

        // Choose color based on health
        var color = config.COLOR_MUSHROOM_4;
        if isPoisonedMush {
            color = config.COLOR_POISONED;
        } else if health == 3 {
            color = config.COLOR_MUSHROOM_3;
        } else if health == 2 {
            color = config.COLOR_MUSHROOM_2;
        } else if health == 1 {
            color = config.COLOR_MUSHROOM_1;
        }

        // Draw mushroom cap (circle)
        var radius = config.TILE_SIZE / 2 - 2;
        if health <= 2 {
            radius = radius - 1;
        }
        if health == 1 {
            radius = radius - 1;
        }

        canvas.Disc(centerX, centerY - 2, radius, color);

        // Draw mushroom stem (small rectangle)
        if health >= 3 {
            var stemWidth = 4;
            var stemHeight = 4;
            canvas.Box(centerX - stemWidth / 2, centerY + radius - 4, stemWidth, stemHeight, color);
        }
    }
}

