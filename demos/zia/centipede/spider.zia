// =============================================================================
// CENTIPEDE - Spider Entity
// =============================================================================
// Erratic enemy that bounces around the player zone
// Destroys mushrooms it touches
// Worth different points based on distance when shot
// =============================================================================

module spider;

bind "./config";
bind "./utils";
bind "./mushroom";

// =============================================================================
// SPIDER ENTITY - Erratic bouncing enemy
// =============================================================================

entity Spider {
    hide Integer screenX;
    hide Integer screenY;
    hide Integer dirX;
    hide Integer dirY;
    hide Boolean active;
    hide Viper.Game.Timer moveTimer;
    hide Integer animFrame;

    expose func init() {
        screenX = 0;
        screenY = 0;
        dirX = 1;
        dirY = 1;
        active = false;
        moveTimer = Viper.Game.Timer.New();
        animFrame = 0;
    }

    expose func spawn() {
        // Spawn from left or right side, in player zone
        if Viper.Random.NextInt(2) == 0 {
            screenX = 0;
            dirX = 1;
        } else {
            screenX = config.SCREEN_WIDTH - config.TILE_SIZE;
            dirX = -1;
        }

        // Random Y in player zone
        var minY = config.PLAYER_ZONE_TOP * config.TILE_SIZE;
        var maxY = config.SCREEN_HEIGHT - config.TILE_SIZE * 2;
        screenY = minY + Viper.Random.NextInt(maxY - minY);

        dirY = Viper.Random.NextInt(2) * 2 - 1;  // -1 or 1
        active = true;
        moveTimer.StartRepeating(config.SPIDER_MOVE_DELAY);
        animFrame = 0;
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func kill() {
        active = false;
    }

    expose func update(field: mushroom.MushroomField) {
        if !active {
            return;
        }

        if moveTimer.Update() {
            animFrame = animFrame + 1;

            // Erratic movement
            var speed = 6;
            screenX = screenX + dirX * speed;

            // Randomly change vertical direction
            if Viper.Random.NextInt(5) == 0 {
                dirY = -dirY;
            }
            if Viper.Random.NextInt(3) == 0 {
                screenY = screenY + dirY * speed;
            }

            // Bounce off vertical bounds (player zone)
            var minY = config.PLAYER_ZONE_TOP * config.TILE_SIZE;
            var maxY = config.SCREEN_HEIGHT - config.TILE_SIZE;
            if screenY < minY {
                screenY = minY;
                dirY = 1;
            }
            if screenY > maxY {
                screenY = maxY;
                dirY = -1;
            }

            // Exit when reaching screen edge
            if screenX < -config.TILE_SIZE || screenX > config.SCREEN_WIDTH {
                active = false;
            }

            // Destroy mushrooms in path
            var gridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
            var gridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);
            if field.hasMushroom(gridX, gridY) {
                field.setHealth(gridX, gridY, 0);
            }
        }
    }

    expose func checkCollision(gridX: Integer, gridY: Integer) -> Boolean {
        if !active {
            return false;
        }

        var myGridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
        var myGridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);

        return myGridX == gridX && myGridY == gridY;
    }

    expose func getGridX() -> Integer {
        return utils.screenToGridX(screenX + config.TILE_SIZE / 2);
    }

    expose func getGridY() -> Integer {
        return utils.screenToGridY(screenY + config.TILE_SIZE / 2);
    }

    expose func draw(canvas: Viper.Graphics.Canvas) {
        if !active {
            return;
        }

        var centerX = screenX + config.TILE_SIZE / 2;
        var centerY = screenY + config.TILE_SIZE / 2;

        // Spider body
        canvas.Disc(centerX, centerY, config.TILE_SIZE / 2, config.COLOR_SPIDER);

        // Spider legs (animated)
        var legOffset = 3;
        if animFrame % 4 < 2 {
            legOffset = 5;
        }

        // Draw 4 pairs of legs
        var legColor = config.COLOR_BROWN;
        // Top left
        canvas.Line(centerX - 4, centerY - 2, centerX - 4 - legOffset, centerY - 6, legColor);
        // Top right
        canvas.Line(centerX + 4, centerY - 2, centerX + 4 + legOffset, centerY - 6, legColor);
        // Bottom left
        canvas.Line(centerX - 4, centerY + 2, centerX - 4 - legOffset, centerY + 6, legColor);
        // Bottom right
        canvas.Line(centerX + 4, centerY + 2, centerX + 4 + legOffset, centerY + 6, legColor);

        // Eyes
        canvas.Disc(centerX - 3, centerY - 3, 2, config.COLOR_RED);
        canvas.Disc(centerX + 3, centerY - 3, 2, config.COLOR_RED);
    }
}

