// =============================================================================
// CENTIPEDE - Flea Entity
// =============================================================================
// Drops down from the top, creating mushrooms in its path
// Spawns when there are few mushrooms in the player zone
// Takes 2 hits to kill
// =============================================================================

module flea;

bind "./config";
bind "./utils";
bind "./mushroom";

// =============================================================================
// FLEA ENTITY - Mushroom-dropping enemy
// =============================================================================

entity Flea {
    hide Integer screenX;
    hide Integer screenY;
    hide Boolean active;
    hide Integer health;
    hide Viper.Game.Timer moveTimer;
    hide Integer animFrame;
    hide Boolean fast;  // Speeds up after first hit

    expose func init() {
        screenX = 0;
        screenY = 0;
        active = false;
        health = 2;
        moveTimer = Viper.Game.Timer.New();
        animFrame = 0;
        fast = false;
    }

    expose func spawn() {
        // Spawn from random X at top of screen
        var gridX = Viper.Random.NextInt(config.GRID_WIDTH);
        screenX = utils.gridToScreenX(gridX);
        screenY = 0;
        active = true;
        health = 2;
        fast = false;
        moveTimer.StartRepeating(config.FLEA_MOVE_DELAY);
        animFrame = 0;
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func hit() -> Boolean {
        health = health - 1;
        if health <= 0 {
            active = false;
            return true;  // Killed
        }
        // Speed up after first hit
        fast = true;
        return false;  // Still alive
    }

    expose func update(field: mushroom.MushroomField) {
        if !active {
            return;
        }

        if moveTimer.Update() {
            animFrame = animFrame + 1;

            // Move down
            var speed = 8;
            if fast {
                speed = 14;
            }
            screenY = screenY + speed;

            // Create mushroom randomly while falling
            if Viper.Random.NextInt(3) == 0 {
                var gridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
                var gridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);

                if gridY >= config.MUSHROOM_ZONE_TOP && gridY < config.MUSHROOM_ZONE_BOTTOM {
                    if !field.hasMushroom(gridX, gridY) {
                        field.createMushroom(gridX, gridY);
                    }
                }
            }

            // Deactivate when off screen
            if screenY > config.SCREEN_HEIGHT {
                active = false;
            }
        }
    }

    expose func checkCollision(gridX: Integer, gridY: Integer) -> Boolean {
        if !active {
            return false;
        }

        var myGridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
        var myGridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);

        return myGridX == gridX && myGridY == gridY;
    }

    expose func getGridX() -> Integer {
        return utils.screenToGridX(screenX + config.TILE_SIZE / 2);
    }

    expose func getGridY() -> Integer {
        return utils.screenToGridY(screenY + config.TILE_SIZE / 2);
    }

    expose func draw(canvas: Viper.Graphics.Canvas) {
        if !active {
            return;
        }

        var centerX = screenX + config.TILE_SIZE / 2;
        var centerY = screenY + config.TILE_SIZE / 2;

        // Flea body (oval shape)
        canvas.Disc(centerX, centerY, config.TILE_SIZE / 2 - 1, config.COLOR_FLEA);

        // Legs (animated)
        var legSpread = 3;
        if animFrame % 2 == 0 {
            legSpread = 5;
        }

        var legColor = config.COLOR_BROWN;
        // Left legs
        canvas.Line(centerX - 2, centerY + 2, centerX - legSpread, centerY + 8, legColor);
        canvas.Line(centerX - 4, centerY, centerX - legSpread - 2, centerY + 4, legColor);
        // Right legs
        canvas.Line(centerX + 2, centerY + 2, centerX + legSpread, centerY + 8, legColor);
        canvas.Line(centerX + 4, centerY, centerX + legSpread + 2, centerY + 4, legColor);

        // Eyes
        canvas.Disc(centerX - 2, centerY - 3, 2, config.COLOR_WHITE);
        canvas.Disc(centerX + 2, centerY - 3, 2, config.COLOR_WHITE);
    }
}

