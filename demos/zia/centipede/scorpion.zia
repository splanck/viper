// =============================================================================
// CENTIPEDE - Scorpion Entity
// =============================================================================
// Moves horizontally across the screen
// Poisons mushrooms it touches (causing centipede to dive)
// Worth 1000 points
// =============================================================================

module scorpion;

bind "./config";
bind "./utils";
bind "./mushroom";

bind Viper.Game;
bind Viper.Graphics;
bind Viper.Random;

// =============================================================================
// SCORPION ENTITY - Mushroom-poisoning enemy
// =============================================================================

entity Scorpion {
    hide Integer screenX;
    hide Integer screenY;
    hide Integer direction;  // -1 for left, 1 for right
    hide Boolean active;
    hide Timer moveTimer;
    hide Integer animFrame;

    expose func init() {
        screenX = 0;
        screenY = 0;
        direction = 1;
        active = false;
        moveTimer = Timer.New();
        animFrame = 0;
    }

    expose func spawn() {
        // Spawn from left or right side
        if NextInt(2) == 0 {
            screenX = -config.TILE_SIZE;
            direction = 1;
        } else {
            screenX = config.SCREEN_WIDTH;
            direction = -1;
        }

        // Random Y in upper part of screen (not player zone)
        var minY = config.MUSHROOM_ZONE_TOP * config.TILE_SIZE;
        var maxY = config.PLAYER_ZONE_TOP * config.TILE_SIZE - config.TILE_SIZE * 4;
        if maxY < minY {
            maxY = minY + config.TILE_SIZE * 4;
        }
        var gridY = config.MUSHROOM_ZONE_TOP + NextInt((maxY - minY) / config.TILE_SIZE);
        screenY = utils.gridToScreenY(gridY);

        active = true;
        moveTimer.StartRepeating(config.SCORPION_MOVE_DELAY);
        animFrame = 0;
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func kill() {
        active = false;
    }

    expose func update(field: mushroom.MushroomField) {
        if !active {
            return;
        }

        if moveTimer.Update() {
            animFrame = animFrame + 1;

            // Move horizontally
            var speed = 4;
            screenX = screenX + direction * speed;

            // Poison mushrooms in path
            var gridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
            var gridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);

            if field.hasMushroom(gridX, gridY) {
                field.setPoisoned(gridX, gridY, true);
            }

            // Deactivate when off screen
            if direction > 0 && screenX > config.SCREEN_WIDTH + config.TILE_SIZE {
                active = false;
            } else if direction < 0 && screenX < -config.TILE_SIZE * 2 {
                active = false;
            }
        }
    }

    expose func checkCollision(gridX: Integer, gridY: Integer) -> Boolean {
        if !active {
            return false;
        }

        var myGridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
        var myGridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);

        return myGridX == gridX && myGridY == gridY;
    }

    expose func getGridX() -> Integer {
        return utils.screenToGridX(screenX + config.TILE_SIZE / 2);
    }

    expose func getGridY() -> Integer {
        return utils.screenToGridY(screenY + config.TILE_SIZE / 2);
    }

    expose func draw(canvas: Canvas) {
        if !active {
            return;
        }

        var centerX = screenX + config.TILE_SIZE / 2;
        var centerY = screenY + config.TILE_SIZE / 2;

        // Scorpion body (elongated)
        canvas.Disc(centerX, centerY, config.TILE_SIZE / 2 - 1, config.COLOR_SCORPION);

        // Tail (curved up)
        var tailX = centerX - direction * 6;
        canvas.Disc(tailX, centerY - 4, 4, config.COLOR_SCORPION);
        canvas.Disc(tailX - direction * 2, centerY - 8, 3, config.COLOR_SCORPION);

        // Stinger
        var stingerX = tailX - direction * 3;
        canvas.Line(stingerX, centerY - 10, stingerX + direction * 2, centerY - 6, config.COLOR_RED);

        // Pincers
        var pincerX = centerX + direction * 8;
        canvas.Line(centerX + direction * 4, centerY - 2, pincerX, centerY - 5, config.COLOR_SCORPION);
        canvas.Line(centerX + direction * 4, centerY + 2, pincerX, centerY + 5, config.COLOR_SCORPION);

        // Legs (animated)
        var legOffset = 2;
        if animFrame % 4 < 2 {
            legOffset = 4;
        }

        var legColor = config.COLOR_BROWN;
        // Left side legs
        canvas.Line(centerX - 2, centerY + 3, centerX - legOffset - 2, centerY + 7, legColor);
        canvas.Line(centerX + 2, centerY + 3, centerX + legOffset + 2, centerY + 7, legColor);

        // Eyes
        canvas.Disc(centerX + direction * 3, centerY - 2, 2, config.COLOR_WHITE);
    }
}

