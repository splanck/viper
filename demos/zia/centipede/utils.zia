// =============================================================================
// CENTIPEDE - Utility Functions
// =============================================================================
// Helper functions for coordinate conversion, math, and input handling
// =============================================================================

module utils;

bind "./config";

bind Viper.Graphics;

// =============================================================================
// COORDINATE CONVERSION
// =============================================================================

func gridToScreenX(gridX: Integer) -> Integer {
    return gridX * config.TILE_SIZE;
}

func gridToScreenY(gridY: Integer) -> Integer {
    return gridY * config.TILE_SIZE;
}

func screenToGridX(screenX: Integer) -> Integer {
    return screenX / config.TILE_SIZE;
}

func screenToGridY(screenY: Integer) -> Integer {
    return screenY / config.TILE_SIZE;
}

// =============================================================================
// MATH UTILITIES
// =============================================================================

func abs(x: Integer) -> Integer {
    if x < 0 {
        return -x;
    }
    return x;
}

func min(a: Integer, b: Integer) -> Integer {
    if a < b {
        return a;
    }
    return b;
}

func max(a: Integer, b: Integer) -> Integer {
    if a > b {
        return a;
    }
    return b;
}

func clamp(value: Integer, minVal: Integer, maxVal: Integer) -> Integer {
    if value < minVal {
        return minVal;
    }
    if value > maxVal {
        return maxVal;
    }
    return value;
}

func manhattanDistance(x1: Integer, y1: Integer, x2: Integer, y2: Integer) -> Integer {
    return abs(x1 - x2) + abs(y1 - y2);
}

func squaredDistance(x1: Integer, y1: Integer, x2: Integer, y2: Integer) -> Integer {
    var dx = x1 - x2;
    var dy = y1 - y2;
    return dx * dx + dy * dy;
}

// =============================================================================
// DIRECTION UTILITIES
// =============================================================================

func getDirX(dir: Integer) -> Integer {
    if dir == config.DIR_LEFT {
        return -1;
    } else if dir == config.DIR_RIGHT {
        return 1;
    }
    return 0;
}

func getDirY(dir: Integer) -> Integer {
    if dir == config.DIR_UP {
        return -1;
    } else if dir == config.DIR_DOWN {
        return 1;
    }
    return 0;
}

func getOppositeDirection(dir: Integer) -> Integer {
    if dir == config.DIR_LEFT {
        return config.DIR_RIGHT;
    } else if dir == config.DIR_RIGHT {
        return config.DIR_LEFT;
    } else if dir == config.DIR_UP {
        return config.DIR_DOWN;
    } else if dir == config.DIR_DOWN {
        return config.DIR_UP;
    }
    return config.DIR_NONE;
}

// =============================================================================
// COLLISION UTILITIES
// =============================================================================

func rectsOverlap(x1: Integer, y1: Integer, w1: Integer, h1: Integer,
                  x2: Integer, y2: Integer, w2: Integer, h2: Integer) -> Boolean {
    if x1 + w1 <= x2 { return false; }
    if x2 + w2 <= x1 { return false; }
    if y1 + h1 <= y2 { return false; }
    if y2 + h2 <= y1 { return false; }
    return true;
}

func pointInRect(px: Integer, py: Integer,
                 rx: Integer, ry: Integer, rw: Integer, rh: Integer) -> Boolean {
    return px >= rx && px < rx + rw && py >= ry && py < ry + rh;
}

// =============================================================================
// INPUT HELPERS (using canvas.KeyHeld directly)
// =============================================================================
// Note: canvas.KeyHeld() returns Integer (0 or 1), so we compare to 0

func isKeyHeld(canvas: Canvas, keyCode: Integer) -> Boolean {
    return canvas.KeyHeld(keyCode) != 0;
}

func isUpHeld(canvas: Canvas) -> Boolean {
    if canvas.KeyHeld(config.KEY_UP) != 0 { return true; }
    if canvas.KeyHeld(config.KEY_W) != 0 { return true; }
    return false;
}

func isDownHeld(canvas: Canvas) -> Boolean {
    if canvas.KeyHeld(config.KEY_DOWN) != 0 { return true; }
    if canvas.KeyHeld(config.KEY_S) != 0 { return true; }
    return false;
}

func isLeftHeld(canvas: Canvas) -> Boolean {
    if canvas.KeyHeld(config.KEY_LEFT) != 0 { return true; }
    if canvas.KeyHeld(config.KEY_A) != 0 { return true; }
    return false;
}

func isRightHeld(canvas: Canvas) -> Boolean {
    if canvas.KeyHeld(config.KEY_RIGHT) != 0 { return true; }
    if canvas.KeyHeld(config.KEY_D) != 0 { return true; }
    return false;
}

func isFireHeld(canvas: Canvas) -> Boolean {
    return canvas.KeyHeld(config.KEY_SPACE) != 0;
}

func isEscapeHeld(canvas: Canvas) -> Boolean {
    return canvas.KeyHeld(config.KEY_ESCAPE) != 0;
}

func isEnterHeld(canvas: Canvas) -> Boolean {
    return canvas.KeyHeld(config.KEY_ENTER) != 0;
}

func isPauseHeld(canvas: Canvas) -> Boolean {
    return canvas.KeyHeld(config.KEY_P) != 0;
}

func isRestartHeld(canvas: Canvas) -> Boolean {
    return canvas.KeyHeld(config.KEY_R) != 0;
}

