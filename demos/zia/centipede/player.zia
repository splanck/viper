// =============================================================================
// CENTIPEDE - Player Entity
// =============================================================================
// Player ship that moves in the bottom zone and fires bullets upward
// Uses direct canvas.KeyHeld() for responsive input
// =============================================================================

module player;

bind "./config";
bind "./utils";
bind "./mushroom";

// =============================================================================
// BULLET ENTITY - Player's projectile
// =============================================================================

entity Bullet {
    hide Integer screenX;
    hide Integer screenY;
    hide Boolean active;

    expose func init() {
        screenX = 0;
        screenY = 0;
        active = false;
    }

    expose func fire(x: Integer, y: Integer) {
        screenX = x;
        screenY = y;
        active = true;
    }

    expose func update() -> Boolean {
        if active {
            screenY = screenY - config.BULLET_SPEED;
            if screenY < 0 {
                active = false;
                return true;  // Bullet went off screen
            }
        }
        return false;
    }

    expose func isActive() -> Boolean {
        return active;
    }

    expose func destroy() {
        active = false;
    }

    expose func getScreenX() -> Integer {
        return screenX;
    }

    expose func getScreenY() -> Integer {
        return screenY;
    }

    expose func getGridX() -> Integer {
        return utils.screenToGridX(screenX + config.TILE_SIZE / 2);
    }

    expose func getGridY() -> Integer {
        return utils.screenToGridY(screenY);
    }

    expose func draw(canvas: Viper.Graphics.Canvas) {
        if active {
            var bulletWidth = 4;
            var bulletHeight = 12;
            canvas.Box(screenX + config.TILE_SIZE / 2 - bulletWidth / 2, screenY,
                       bulletWidth, bulletHeight, config.COLOR_BULLET);
        }
    }
}

// =============================================================================
// PLAYER ENTITY - The player's ship
// =============================================================================

entity Player {
    hide Integer screenX;
    hide Integer screenY;
    hide Bullet bullet;
    hide Viper.Game.Timer fireCooldown;
    hide Boolean canFire;

    // Starting position (for reset)
    hide Integer startX;
    hide Integer startY;

    expose func init() {
        // Start in center of player zone
        startX = (config.GRID_WIDTH / 2) * config.TILE_SIZE;
        startY = (config.GRID_HEIGHT - 3) * config.TILE_SIZE;
        screenX = startX;
        screenY = startY;

        // Initialize bullet
        bullet = new Bullet();
        bullet.init();

        // Initialize fire cooldown
        fireCooldown = Viper.Game.Timer.New();
        canFire = true;
    }

    expose func reset() {
        screenX = startX;
        screenY = startY;
        bullet.destroy();
        canFire = true;
    }

    expose func update(canvas: Viper.Graphics.Canvas, field: mushroom.MushroomField) {
        // Handle movement input
        var moveX = 0;
        var moveY = 0;

        if utils.isLeftHeld(canvas) {
            moveX = -config.PLAYER_SPEED;
        } else if utils.isRightHeld(canvas) {
            moveX = config.PLAYER_SPEED;
        }

        if utils.isUpHeld(canvas) {
            moveY = -config.PLAYER_SPEED;
        } else if utils.isDownHeld(canvas) {
            moveY = config.PLAYER_SPEED;
        }

        // Apply movement with bounds checking
        var newX = screenX + moveX;
        var newY = screenY + moveY;

        // Horizontal bounds
        if newX < 0 {
            newX = 0;
        }
        if newX > config.SCREEN_WIDTH - config.TILE_SIZE {
            newX = config.SCREEN_WIDTH - config.TILE_SIZE;
        }

        // Vertical bounds (player zone only)
        var minY = config.PLAYER_ZONE_TOP * config.TILE_SIZE;
        var maxY = config.SCREEN_HEIGHT - config.TILE_SIZE;
        if newY < minY {
            newY = minY;
        }
        if newY > maxY {
            newY = maxY;
        }

        // Check mushroom collision before moving
        var gridX = utils.screenToGridX(newX + config.TILE_SIZE / 2);
        var gridY = utils.screenToGridY(newY + config.TILE_SIZE / 2);

        if !field.hasMushroom(gridX, gridY) {
            screenX = newX;
            screenY = newY;
        } else {
            // Try horizontal movement only
            gridX = utils.screenToGridX(newX + config.TILE_SIZE / 2);
            gridY = utils.screenToGridY(screenY + config.TILE_SIZE / 2);
            if !field.hasMushroom(gridX, gridY) {
                screenX = newX;
            }

            // Try vertical movement only
            gridX = utils.screenToGridX(screenX + config.TILE_SIZE / 2);
            gridY = utils.screenToGridY(newY + config.TILE_SIZE / 2);
            if !field.hasMushroom(gridX, gridY) {
                screenY = newY;
            }
        }

        // Handle firing
        fireCooldown.Update();
        if fireCooldown.IsExpired {
            canFire = true;
        }

        if utils.isFireHeld(canvas) && canFire && !bullet.isActive() {
            bullet.fire(screenX, screenY - 4);
            canFire = false;
            fireCooldown.Start(config.PLAYER_FIRE_COOLDOWN);
        }

        // Update bullet
        bullet.update();
    }

    expose func getScreenX() -> Integer {
        return screenX;
    }

    expose func getScreenY() -> Integer {
        return screenY;
    }

    expose func getGridX() -> Integer {
        return utils.screenToGridX(screenX + config.TILE_SIZE / 2);
    }

    expose func getGridY() -> Integer {
        return utils.screenToGridY(screenY + config.TILE_SIZE / 2);
    }

    expose func isBulletActive() -> Boolean {
        return bullet.isActive();
    }

    expose func getBulletGridX() -> Integer {
        return bullet.getGridX();
    }

    expose func getBulletGridY() -> Integer {
        return bullet.getGridY();
    }

    expose func destroyBullet() {
        bullet.destroy();
    }

    expose func draw(canvas: Viper.Graphics.Canvas) {
        // Draw player ship
        var centerX = screenX + config.TILE_SIZE / 2;
        var centerY = screenY + config.TILE_SIZE / 2;

        // Draw ship body (triangular shape using disc and box)
        canvas.Disc(centerX, centerY, config.TILE_SIZE / 2 - 2, config.COLOR_PLAYER);

        // Draw gun barrel
        canvas.Box(centerX - 2, screenY - 2, 4, 8, config.COLOR_PLAYER_GUN);

        // Draw bullet
        bullet.draw(canvas);
    }
}

