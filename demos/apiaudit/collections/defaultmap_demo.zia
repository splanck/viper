// defaultmap_demo.zia - Comprehensive API audit for Viper.Collections.DefaultMap
// Tests: New(default_value), Get, Set, Has, Remove, Keys, GetDefault, Clear, Len

module DefaultMapDemo;

bind Viper.Collections;
bind Viper.Core;
bind Viper.Terminal;
bind Viper.Fmt;

func start() {
    Say("=== DefaultMap API Audit ===");

    // --- New ---
    Say("--- New ---");
    var dm = DefaultMap.New(Box.Str("N/A"));
    SayInt(dm.Len);       // 0

    // --- Set / Len ---
    Say("--- Set / Len ---");
    dm.Set("name", Box.Str("Alice"));
    dm.Set("city", Box.Str("Boston"));
    dm.Set("role", Box.Str("Engineer"));
    SayInt(dm.Len);       // 3

    // --- Get (existing key) ---
    Say("--- Get (existing) ---");
    Say(Box.ToStr(dm.Get("name")));   // Alice
    Say(Box.ToStr(dm.Get("city")));   // Boston

    // --- Get (missing key returns default) ---
    Say("--- Get (missing) ---");
    Say(Box.ToStr(dm.Get("email")));  // N/A
    Say(Box.ToStr(dm.Get("phone")));  // N/A

    // --- Has ---
    Say("--- Has ---");
    SayBool(dm.Has("name"));   // 1
    SayBool(dm.Has("email"));  // 0 (Get did not insert)

    // --- GetDefault ---
    Say("--- GetDefault ---");
    Say(Box.ToStr(dm.GetDefault()));  // N/A

    // --- Set (update existing) ---
    Say("--- Set (update) ---");
    dm.Set("name", Box.Str("Bob"));
    Say(Box.ToStr(dm.Get("name")));   // Bob
    SayInt(dm.Len);                   // 3

    // --- Keys ---
    Say("--- Keys ---");
    var keys = dm.Keys();
    SayInt(keys.Len);                 // 3

    // --- Remove ---
    Say("--- Remove ---");
    SayInt(dm.Remove("city"));        // 1
    SayBool(dm.Has("city"));          // 0
    SayInt(dm.Len);                   // 2
    SayInt(dm.Remove("city"));        // 0
    Say(Box.ToStr(dm.Get("city")));   // N/A (returns default now)

    // --- Clear ---
    Say("--- Clear ---");
    dm.Clear();
    SayInt(dm.Len);                   // 0
    Say(Box.ToStr(dm.Get("name")));   // N/A (returns default)

    // --- New with integer default ---
    Say("--- New (integer default) ---");
    var dm2 = DefaultMap.New(Box.I64(0));
    dm2.Set("count", Box.I64(42));
    SayInt(Box.ToI64(dm2.Get("count")));    // 42
    SayInt(Box.ToI64(dm2.Get("missing"))); // 0

    Say("=== DefaultMap audit complete ===");
}
