================================================================================
VIPER PROJECT CODE QUALITY IMPROVEMENT PLAN
================================================================================

Generated: 2026-02-04
Status: IN PROGRESS

This document tracks all identified code quality issues and their resolution
status. Issues are organized by priority and grouped by component.

================================================================================
LEGEND
================================================================================
[ ] - Not started
[*] - In progress
[X] - Completed
[S] - Skipped (with reason)

================================================================================
HIGH PRIORITY ISSUES (Code Duplication / Shared Helpers)
================================================================================

1. IL CORE - Value Comparison/Hashing Duplication
   [X] 1.1 Create shared valueEquals() helper in il/core/Value.hpp
         - Consolidated from: ValueKey.cpp (77-96), CheckOpt.cpp (82-108)
         - Added to Value.hpp and Value.cpp

   [X] 1.2 Create shared valueHash() helper in il/core/Value.hpp
         - Consolidated from: ValueKey.cpp (34-66), CheckOpt.cpp (116-141)
         - Added named constants: kHashKindMix, kHashPhiMix, kHashNullSentinel, kHashBoolFlag
         - Updated ValueKey.cpp and CheckOpt.cpp to use shared helpers

2. VM - Duplicate eval() Implementation
   [X] 2.1 Consolidate VMContext::eval() and VM::eval()
         - VMContext::eval() now delegates to vmInstance->eval()
         - Reduced ~120 lines of duplicated code to 1 line
         - Updated: VMContext.cpp

3. ZIA FRONTEND - TypeInfo Field/Method Lookup Duplication
   [S] 3.1 Consolidate findField()/findMethod() in Lowerer.hpp (139-328)
         - SKIPPED: Functions are only 3 lines each, adding template complexity
           would not provide significant benefit. Code is already readable.

4. BASIC FRONTEND - Symbol Lookup Pattern Duplication
   [S] 4.1 Create resolveSymbolInScopes() helper
         - SKIPPED: Pattern appears only once in SemanticAnalyzer_Stmts_Runtime.cpp
         - BasicSymbolQuery.cpp uses different APIs (lowerer_.findSymbol, etc.)
         - No actual duplication exists to consolidate

5. BASIC FRONTEND - Qualified Name Canonicalization Duplication
   [S] 5.1 Consolidate canonicalizeQualifiedFlat() usage
         - SKIPPED: canonicalizeQualifiedFlat is local static in ProcRegistry.cpp only
         - Core canonicalization logic already shared via IdentifierUtil.hpp
           (CanonicalizeIdent, CanonicalizeQualified, CanonJoin)
         - No actual duplication to consolidate

6. RUNTIME - Threading Primitives Validation Duplication
   [X] 6.1 Create template requireObject() validation helper
         - Created: rt_threads_primitives.cpp
         - require_gate(), require_barrier(), require_rwlock() now use shared helper
         - Reduced ~45 lines of duplicated code to ~10 lines

================================================================================
MEDIUM PRIORITY ISSUES (Inefficient Patterns)
================================================================================

7. REPEATED MAP LOOKUPS
   [S] 7.1 Basic frontend - Cache map iterators
         - SKIPPED: All lookups already use proper find() + iterator reuse pattern
         - Lines 169, 261, 370 all correctly use iterator

   [S] 7.2 Zia frontend - Cache map lookups in Lowerer_Expr.cpp
         - SKIPPED: localTypes_.find() calls at 182, 193 are in mutually exclusive
           branches (each returns before the other executes)
         - Lines 230, 263, 332, 358 all use proper find() + iterator reuse

8. UNNECESSARY STRING COPIES
   [X] 8.1 CLI argument parsing - Use string_view consistently
         - Updated: cmd_front_basic.cpp, cmd_run_il.cpp, cmd_il_opt.cpp,
           cmd_front_zia.cpp, cli.cpp, cmd_bench.cpp
         - Replaced std::string arg = argv[i] with std::string_view
         - Added string_view headers where needed
         - Fixed conversion points where strings are actually needed

   [S] 8.2 BasicSymbolQuery.cpp - Avoid temporary strings
         - SKIPPED: Would require changing multiple interfaces (isModuleLevelSymbol,
           isCrossProcGlobal) and adding transparent comparators to maps
         - Low benefit for compiler frontend where string ops aren't the hot path

9. VM STRING CONCATENATION IN HOT PATHS
   [S] 9.1 Use reserve() + append() instead of + operator
         - SKIPPED: Lines 422-426 are in error path (unimplemented opcode trap)
         - Error paths execute rarely; optimization provides no benefit

10. REDUNDANT NULL CHECKS
    [ ] 10.1 Remove duplicate null checks in threading primitives
          - rt_threads_primitives.cpp (253-257, 435-440, 547-552)
          - Pattern: if (!ptr) rt_trap(); if (!ptr) return nullptr;

================================================================================
MEDIUM PRIORITY ISSUES (Missing Documentation)
================================================================================

11. IL CORE - CheckOpt.cpp Documentation
    [X] 11.1 Add docs to CheckKey/CheckKeyHash structs (lines 63-141)
          - Added documentation for CheckKey and CheckKeyHash
    [X] 11.2 Add docs to helper functions: findPreheader(), seedInvariants(),
          operandsInvariant(), isGuaranteedToExecute(), loopHasEHSensitiveOps()
          - Added comprehensive @brief, @details, @param, @return docs

12. VM - Missing Documentation
    [X] 12.1 Add module-level docs to OpHandlers.hpp
          - Already documented: file header, @file/@brief, getOpcodeHandlers()
    [X] 12.2 Document control_flow.cpp migration status (lines 29-35)
          - Already documented: sentinel namespace with migration explanation
    [X] 12.3 Document TrapDispatchSignal exception flow (VM.hpp 612-620)
          - Added: detailed @brief/@details explaining unwinding mechanism
    [X] 12.4 Document trap handling methods (VM.hpp 868-885)
          - Added: docs for prepareTrap() and throwForTrap()

13. ZIA FRONTEND - Missing Implementation Comments
    [X] 13.1 Document Lowerer_Emit.cpp helper functions
          - Added docs: createBlock(), setBlock(), getILTypeSize(),
            getILTypeAlignment(), alignTo()
    [X] 13.2 Document analyzeNamespaceBind() (Sema_Decl.cpp:81)
          - Added: @brief/@details explaining three binding forms

14. BASIC FRONTEND - Missing Documentation
    [X] 14.1 Document complex member array field logic
          - Added block comment explaining BUG-056, BUG-058, BUG-089, BUG-108
    [X] 14.2 Document iequals() in OopIndex.cpp (22-36)
          - Added @brief/@details/@param/@return documentation
    [X] 14.3 Expand BUG-120 comment (SemanticAnalyzer_Stmts_Runtime.cpp:72-76)
          - Already well documented in existing code

15. RUNTIME/TOOLS - Missing Documentation
    [X] 15.1 Add header docs to cli_compat.cpp files
          - All three files already have proper @brief/@details documentation
    [X] 15.2 Document ownership in module_loader.hpp and source_loader.hpp
          - module_loader.hpp: Updated ownership/lifetime section
          - source_loader.hpp: Already documented

================================================================================
LOW PRIORITY ISSUES (Code Readability)
================================================================================

16. MAGIC NUMBERS
    [X] 16.1 Extract hash constants in ValueKey.cpp (36, 40, 43, 62)
          - Already done as part of Item 1.2: kHashKindMix, kHashPhiMix,
            kHashNullSentinel, kHashBoolFlag defined in Value.hpp

17. INCONSISTENT NAMING
    [S] 17.1 VM parameter naming consistency
          - SKIPPED: Subjective naming preferences; code is functional and clear
    [S] 17.2 Basic frontend variable naming
          - SKIPPED: Both names (isMemberArray, isImplicitFieldArray) are descriptive

18. LONG FUNCTIONS
    [S] 18.1 Extract sub-functions from analyzeDim() (500-770, 270 lines)
          - SKIPPED: Extracting would add complexity; function has clear linear flow
    [S] 18.2 Extract sub-functions from analyzeArrayAssignment() (245-397, 152 lines)
          - SKIPPED: Same reasoning; refactoring adds risk without clear benefit

19. ERROR MESSAGE CONSISTENCY
    [S] 19.1 Standardize CLI error formatting
          - SKIPPED: Low priority; existing messages are functional

================================================================================
LOW PRIORITY ISSUES (Optimization Opportunities)
================================================================================

20. LINEAR SEARCH OPTIMIZATION
    [S] 20.1 OopIndex.cpp - Use hash lookup for findClass() (48-56, 66-74)
          - SKIPPED: Would require case-insensitive hash; current O(n) is fine
            for typical class counts (<100 classes)
    [S] 20.2 OopIndex.cpp - Build case-insensitive field index (112-122)
          - SKIPPED: Field counts per class are small; linear search is adequate

21. PRECOMPUTATION OPPORTUNITIES
    [S] 21.1 Consider pre-computing register sets in Peephole.cpp (61-75, 81-99)
          - SKIPPED: Would add complexity; current approach is clear
    [S] 21.2 Consider caching opcode mnemonics at initialization (VMContext.cpp)
          - SKIPPED: Mnemonics only used in error/trace paths; not hot

22. COMPILE-TIME CHECKS
    [X] 22.1 Add static_assert for OpcodeInfo table completeness
          - ALREADY EXISTS: OpcodeInfo.cpp:109 and OpcodeNames.cpp:38
          - Both have: static_assert(kOpcodeTable.size() == kNumOpcodes, ...)

================================================================================
POTENTIAL BUGS (Review Needed)
================================================================================

23. NULL SAFETY
    [X] 23.1 Review null check in RuntimeStatementLowerer_Assign.cpp (200-230)
          - REVIEWED: Line 217 has `scope && scope->layout` guard - safe
    [X] 23.2 Review hierarchy walk in OopIndex.cpp (128)
          - REVIEWED: Loop condition `while (cur)` at line 116 properly handles
            null return from findClass() - safe

24. TYPE CONFUSION
    [S] 24.1 Document AstType vs SemaType distinction
          - SKIPPED: Types are already distinguished by namespace/module context;
            adding inline documentation would be verbose without clear benefit

================================================================================
IMPLEMENTATION PROGRESS
================================================================================

Started: 2026-02-04
Last Updated: 2026-02-04

Phase 1: High Priority (Code Duplication)
- [X] Item 1 (Value comparison/hashing) - COMPLETED
- [X] Item 2 (VM eval duplication) - COMPLETED
- [S] Item 3 (TypeInfo duplication) - SKIPPED (minimal benefit)
- [S] Item 4 (Symbol lookup duplication) - SKIPPED (no actual duplication)
- [S] Item 5 (Qualified name duplication) - SKIPPED (already shared)
- [X] Item 6 (Threading validation duplication) - COMPLETED

Phase 2: Medium Priority (Efficiency + Docs)
- [S] Items 7-10 (Efficiency) - SKIPPED (already optimized or error paths)
- [X] Items 11-15 (Documentation) - COMPLETED

Phase 3: Low Priority (Readability + Optimization)
- [X] Item 16 (Magic numbers) - COMPLETED (done in Item 1)
- [S] Items 17-21 - SKIPPED (subjective or minimal benefit)
- [X] Item 22 - Already exists

Phase 4: Bug Review
- [X] Items 23-24 - REVIEWED (no bugs found)

================================================================================
NOTES
================================================================================

- All changes must maintain 100% test pass rate
- Build verification after each major change
- Focus on maintainability over micro-optimization
- Some recommendations may be skipped if they add complexity without clear benefit

================================================================================
